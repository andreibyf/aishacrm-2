name: Docker Release

on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install Doppler CLI (with fallback)
        timeout-minutes: 10
        run: |
          echo "Installing Doppler CLI with fallback mechanisms..."
          
          # Method 1: Try the official action approach
          if curl -Ls --connect-timeout 10 --max-time 30 https://cli.doppler.com/install.sh | sudo sh; then
            echo "✓ Doppler CLI installed via official script"
          else
            echo "⚠ Official script failed, trying fallback..."
            
            # Method 2: Direct binary download with retry
            MAX_RETRIES=3
            RETRY_COUNT=0
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              RETRY_COUNT=$((RETRY_COUNT + 1))
              echo "Attempt $RETRY_COUNT of $MAX_RETRIES..."
              
              if curl -Ls --connect-timeout 10 --max-time 60 \
                   https://github.com/DopplerHQ/cli/releases/latest/download/doppler_linux_amd64.tar.gz \
                   -o /tmp/doppler.tar.gz; then
                sudo tar -xzf /tmp/doppler.tar.gz -C /usr/local/bin
                sudo chmod +x /usr/local/bin/doppler
                echo "✓ Doppler CLI installed via GitHub releases"
                break
              fi
              
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                sleep $((RETRY_COUNT * 3))
              else
                echo "ERROR: Failed to install Doppler CLI after $MAX_RETRIES attempts"
                exit 1
              fi
            done
          fi

      # Other steps go here...

  deploy-production:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install Doppler CLI (with fallback)
        timeout-minutes: 10
        run: |
          echo "Installing Doppler CLI with fallback mechanisms..."
          
          # Method 1: Try the official action approach
          if curl -Ls --connect-timeout 10 --max-time 30 https://cli.doppler.com/install.sh | sudo sh; then
            echo "✓ Doppler CLI installed via official script"
          else
            echo "⚠ Official script failed, trying fallback..."
            
            # Method 2: Direct binary download with retry
            MAX_RETRIES=3
            RETRY_COUNT=0
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              RETRY_COUNT=$((RETRY_COUNT + 1))
              echo "Attempt $RETRY_COUNT of $MAX_RETRIES..."
              
              if curl -Ls --connect-timeout 10 --max-time 60 \
                   https://github.com/DopplerHQ/cli/releases/latest/download/doppler_linux_amd64.tar.gz \
                   -o /tmp/doppler.tar.gz; then
                sudo tar -xzf /tmp/doppler.tar.gz -C /usr/local/bin
                sudo chmod +x /usr/local/bin/doppler
                echo "✓ Doppler CLI installed via GitHub releases"
                break
              fi
              
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                sleep $((RETRY_COUNT * 3))
              else
                echo "ERROR: Failed to install Doppler CLI after $MAX_RETRIES attempts"
                exit 1
              fi
            done
          fi

      # Other steps go here...