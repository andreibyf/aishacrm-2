name: Test Alignment Report

on:
  schedule:
    - cron: '0 6 * * 1'  # Mondays at 06:00 UTC
  workflow_dispatch:  # Manual trigger
  pull_request:  # Optional: validate on test changes
    paths:
      - 'src/**/*.test.{js,jsx,ts,tsx}'
      - 'backend/__tests__/**'
      - 'tests/**'
      - 'scripts/test-alignment-report.cjs'

permissions:
  contents: read
  issues: write

jobs:
  test-alignment:
    name: Generate Test Alignment Report
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for file modification dates

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Run test alignment report (JSON)
        id: report_json
        run: |
          node scripts/test-alignment-report.cjs --format json > test-alignment.json
          cat test-alignment.json
        continue-on-error: true

      - name: Run test alignment report (Markdown)
        run: |
          node scripts/test-alignment-report.cjs --format markdown > test-alignment.md

      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: test-alignment-reports
          path: |
            test-alignment.json
            test-alignment.md
          retention-days: 90

      - name: Parse report summary
        id: summary
        run: |
          node -e "
          const fs = require('fs');
          const report = JSON.parse(fs.readFileSync('test-alignment.json', 'utf8'));
          const s = report.summary;
          console.log('coverage=' + s.coveragePercentage);
          console.log('orphaned=' + s.orphanedTests);
          console.log('outdated=' + s.outdatedTests);
          console.log('missing_assertions=' + s.missingAssertions);
          console.log('broken_deps=' + s.brokenDependencies);
          const total = s.orphanedTests + s.outdatedTests + s.missingAssertions + s.brokenDependencies;
          console.log('total_issues=' + total);
          console.log('severity=' + (s.brokenDependencies > 0 || s.coveragePercentage < 40 ? 'critical' : total > 20 ? 'high' : total > 10 ? 'medium' : 'low'));
          " >> $GITHUB_OUTPUT

      - name: Create or update issue
        if: steps.summary.outputs.total_issues > 0
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportMd = fs.readFileSync('test-alignment.md', 'utf8');
            const summary = {
              coverage: '${{ steps.summary.outputs.coverage }}',
              orphaned: '${{ steps.summary.outputs.orphaned }}',
              outdated: '${{ steps.summary.outputs.outdated }}',
              missingAssertions: '${{ steps.summary.outputs.missing_assertions }}',
              brokenDeps: '${{ steps.summary.outputs.broken_deps }}',
              totalIssues: '${{ steps.summary.outputs.total_issues }}',
              severity: '${{ steps.summary.outputs.severity }}'
            };

            const title = 'ðŸ“Š Weekly Test Alignment Report';
            const labels = ['test-alignment', 'automated', summary.severity];
            
            const checkMark = 'âœ…';
            const warningSign = 'âš ï¸';
            const crossMark = 'âŒ';
            
            const coverageStatus = summary.coverage >= 80 ? checkMark + ' Good' : 
                                   summary.coverage >= 60 ? warningSign + ' Fair' : 
                                   crossMark + ' Poor';
            const orphanedStatus = summary.orphaned == 0 ? checkMark : warningSign;
            const outdatedStatus = summary.outdated == 0 ? checkMark : 
                                   summary.outdated > 10 ? crossMark : warningSign;
            const assertionsStatus = summary.missingAssertions == 0 ? checkMark : warningSign;
            const depsStatus = summary.brokenDeps == 0 ? checkMark : crossMark + ' Critical';
            
            const body = '# ðŸ“Š Weekly Test Alignment Report\n\n' +
              '**Report Date:** ' + new Date().toISOString().split('T')[0] + '\n' +
              '**Workflow Run:** [#' + context.runNumber + '](' + context.payload.repository.html_url + '/actions/runs/' + context.runId + ')\n\n' +
              '## Summary\n\n' +
              '| Metric | Count | Status |\n' +
              '|--------|-------|--------|\n' +
              '| Coverage | ' + summary.coverage + '% | ' + coverageStatus + ' |\n' +
              '| Orphaned Tests | ' + summary.orphaned + ' | ' + orphanedStatus + ' |\n' +
              '| Outdated Tests | ' + summary.outdated + ' | ' + outdatedStatus + ' |\n' +
              '| Missing Assertions | ' + summary.missingAssertions + ' | ' + assertionsStatus + ' |\n' +
              '| Broken Dependencies | ' + summary.brokenDeps + ' | ' + depsStatus + ' |\n\n' +
              '---\n\n' +
              reportMd + '\n\n' +
              '---\n\n' +
              '**Auto-generated by [Test Alignment Workflow](' + context.payload.repository.html_url + '/actions/runs/' + context.runId + ')**\n';

            // Find existing issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'test-alignment',
              state: 'open'
            });

            const existingIssue = issues.data.find(i => i.title === title);

            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: body,
                labels: labels
              });
              console.log('Updated issue #' + existingIssue.number);
            } else {
              // Create new issue
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: labels
              });
              console.log('Created issue #' + issue.data.number);
            }

      - name: Close issue if no problems
        if: steps.summary.outputs.total_issues == 0
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'ðŸ“Š Weekly Test Alignment Report';
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'test-alignment',
              state: 'open'
            });

            const existingIssue = issues.data.find(i => i.title === title);
            
            if (existingIssue) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                state: 'closed',
                body: existingIssue.body + '\n\n---\n\nâœ… **All tests aligned!** Closed automatically on ' + new Date().toISOString().split('T')[0]
              });
              console.log(`Closed issue #${existingIssue.number} - all tests aligned`);
            }

      - name: Add workflow summary
        if: always()
        run: |
          echo "## ðŸ“Š Test Alignment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Coverage | ${{ steps.summary.outputs.coverage }}% |" >> $GITHUB_STEP_SUMMARY
          echo "| Total Issues | ${{ steps.summary.outputs.total_issues }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Severity | ${{ steps.summary.outputs.severity }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat test-alignment.md >> $GITHUB_STEP_SUMMARY || echo "Full report in artifacts" >> $GITHUB_STEP_SUMMARY
