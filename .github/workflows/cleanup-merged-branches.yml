# Automatic Branch Cleanup Workflow
#
# Purpose: Automatically deletes feature branches after their pull requests are merged
# Trigger: When a PR is closed and merged to any branch
# Safety:  - Only deletes if PR was actually merged (not just closed)
#          - Never deletes protected branches (main, master, develop)
#          - Only deletes branches from same repo (not forks)
#          - Handles errors gracefully (404, 422)
# Output:  - Adds comment to PR confirming deletion
#          - Logs all actions to workflow summary
#
# This complements the manual cleanup scripts:
#   - scripts/maintenance/cleanup-branches.sh
#   - scripts/maintenance/cleanup-branches.ps1

name: Cleanup Merged Branches

on:
  pull_request:
    types: [closed]

permissions:
  contents: write       # Required to delete branches
  pull-requests: write  # Required to add PR comments

jobs:
  delete-branch:
    name: Delete merged branch
    runs-on: ubuntu-latest
    if: |
      github.event.pull_request.merged == true &&
      github.event.pull_request.head.repo.full_name == github.repository &&
      !contains(fromJson('["main", "master", "develop"]'), github.event.pull_request.head.ref)
    steps:
      - name: Delete merged branch
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const branchName = pr.head.ref;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            core.info(`PR #${pr.number} "${pr.title}" was merged`);
            core.info(`Source branch: ${branchName}`);
            core.info(`Target branch: ${pr.base.ref}`);
            
            // Double-check we're not deleting protected branches
            const protectedBranches = ['main', 'master', 'develop'];
            if (protectedBranches.includes(branchName)) {
              core.warning(`‚ö†Ô∏è Branch "${branchName}" is protected and will not be deleted`);
              return;
            }
            
            try {
              // Delete the branch
              await github.rest.git.deleteRef({
                owner: owner,
                repo: repo,
                ref: `heads/${branchName}`
              });
              
              core.info(`‚úÖ Successfully deleted branch: ${branchName}`);
              
              // Add a comment to the PR confirming deletion
              await github.rest.issues.createComment({
                owner: owner,
                repo: repo,
                issue_number: pr.number,
                body: `üßπ Branch \`${branchName}\` has been automatically deleted after merge.`
              });
              
              // Add summary
              core.summary
                .addHeading('üßπ Branch Cleanup Complete')
                .addRaw(`Successfully deleted branch: **${branchName}**`, true)
                .addRaw(`PR: #${pr.number} - ${pr.title}`, true)
                .write();
              
            } catch (error) {
              // Branch might already be deleted or user doesn't have permissions
              if (error.status === 404) {
                core.warning(`Branch "${branchName}" not found - may have been already deleted`);
              } else if (error.status === 422) {
                core.warning(`Cannot delete branch "${branchName}" - it may be the repository default branch`);
              } else {
                core.setFailed(`Failed to delete branch "${branchName}": ${error.message}`);
                throw error;
              }
            }
