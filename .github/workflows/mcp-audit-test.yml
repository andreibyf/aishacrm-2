name: MCP Audit Test

on:
  workflow_dispatch: {}
  pull_request:
    branches: [ main ]

jobs:
  run-audit-test:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies (braid-mcp-node-server)
        working-directory: braid-mcp-node-server
        run: npm ci

      - name: Apply DB migrations (optional)
        working-directory: .
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          RUN_MIGRATIONS: ${{ secrets.RUN_MIGRATIONS }}
        run: |
          set -euo pipefail
          if [ -z "${DATABASE_URL:-}" ] || [ "${RUN_MIGRATIONS:-}" != "true" ]; then
            echo "Skipping migrations: set secrets.DATABASE_URL and RUN_MIGRATIONS=true to enable."
            exit 0
          fi
          echo "Applying migration backend/migrations/053_add_audit_log_request_id.sql against DATABASE_URL"
          apt-get update && apt-get install -y postgresql-client
          psql "${DATABASE_URL}" -f backend/migrations/053_add_audit_log_request_id.sql

      - name: Start MCP server and run audit test
        working-directory: braid-mcp-node-server
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          # Optional: set TENANT_ID to a known tenant UUID or slug. If not provided,
          # the test will attempt to auto-detect a tenant in the Supabase project.
          TENANT_ID: ${{ secrets.TENANT_ID }}
          MCP_URL: http://localhost:8000
        run: |
          set -euo pipefail
          # Start server in background
          npm run dev &
          # Wait for local server to accept connections (wait up to 30s)
          npx wait-on http://localhost:8000 || (echo 'Server did not become ready in time' && exit 2)
          # Run the audit test script (exits non-zero on failure)
          node ./scripts/test-mcp-audit.js
