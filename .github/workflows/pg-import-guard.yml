name: Prevent 'pg' Imports in Routes

on:
  push:
  pull_request:

jobs:
  check-pg-imports:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Scan backend for disallowed 'pg' imports
        shell: bash
        run: |
          set -e
          echo "Scanning for disallowed 'pg' imports in backend (excluding migrations, scripts, and utility files)..."
          
          # Scan backend/routes and backend/middleware (strict enforcement)
          violations=$(grep -RInE "from\\s+['\"]pg['\"]|require\\(['\"]pg['\"]\\)|import\\(['\"]pg['\"]\\)" \
            backend/routes \
            backend/middleware \
            backend/lib \
            backend/modules \
            backend/workers \
            2>/dev/null || true)
          
          if [ -n "$violations" ]; then
            echo "::error ::Found 'pg' imports in backend core directories:"
            echo "$violations"
            echo ""
            echo "All database access must use Supabase API (backend/lib/supabase-db.js)."
            exit 1
          fi
          
          echo "âœ“ No 'pg' imports found in backend core directories. Good to go!"
