name: Copilot code review

on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]

permissions:
  contents: read
  pull-requests: write

jobs:
  request-copilot-review:
    name: Request Copilot review
    runs-on: ubuntu-latest
    if: |
      github.event.pull_request.draft == false &&
      (github.event.pull_request.base.ref == github.event.repository.default_branch || github.event.pull_request.base.ref == 'main') &&
      !contains(toJson(github.event.pull_request.labels), 'no-copilot')
    steps:
      - name: Request Copilot review via API
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            core.info(`Requesting Copilot review for PR #${pr.number} (${pr.title})`);
            try {
              // Request a Copilot code review for this PR.
              // Requires Copilot for PRs enabled for this repo/org.
              await github.request('POST /repos/{owner}/{repo}/pulls/{pull_number}/copilot/reviews', {
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number
              });
              core.info('Copilot review requested.');
            } catch (err) {
              core.warning(`Copilot review request failed: ${err?.message || err}`);
              core.warning('Ensure Copilot PR reviews are enabled for this repository/organization.');
            }

