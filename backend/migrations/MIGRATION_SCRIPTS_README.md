# Migration Scripts Documentation

## Overview

This directory contains database migration files for the Aisha CRM schema. All migrations are applied in sequential order.

## Legacy Tenant ID Migration Scripts

The following scripts in the parent `backend/` directory are **ONE-TIME USE TOOLS** for the tenant UUID migration:

### Generator Scripts (Backend Root)

These scripts generate SQL migration files by analyzing the current schema:

- **`backend/generate-index-migration.js`** 
  - Generates `110_replace_legacy_indexes.sql`
  - Scans for indexes using deprecated `tenant_id_text`/`tenant_id_legacy`
  - Creates replacement SQL using `tenant_id` (UUID)
  - **Status:** Tool for Phase 2 migration (not yet applied)

- **`backend/generate-rls-migration.js`**
  - Generates `111_replace_legacy_rls_policies.sql`
  - Scans for RLS policies using deprecated columns
  - Creates replacement policies using `tenant_id` (UUID)
  - **Status:** Tool for Phase 3 migration (not yet applied)

### Helper Scripts (Backend Root)

- **`backend/apply-migration-096.js`**
  - Makes `tenant_id_text` nullable on all tables
  - **Status:** ✅ Applied (historical)

- **`backend/apply-migration-099.js`**
  - Makes `tenant_id_legacy` nullable on specific tables
  - **Status:** ✅ Applied (historical)

- **`backend/cleanup-legacy-tenants.js`**
  - Removes test data with legacy text-based tenant IDs
  - **Status:** ✅ Active cleanup script (safe to run anytime)

## Migration Status

### ✅ Completed Migrations

1. **096_tenant_id_text_nullable.sql** - Made `tenant_id_text` nullable
2. **099_tenant_id_legacy_nullable.sql** - Made `tenant_id_legacy` nullable  
3. **105_backfill_utility_tables_tenant_uuid.sql** - Backfilled UUID values

### ⏳ Pending Migrations

These migrations are **planned but not yet applied**:

1. **110_replace_legacy_indexes.sql** (Phase 2)
   - Replace ~100+ indexes from `tenant_id_text` → `tenant_id` (UUID)
   - Generated by `generate-index-migration.js`
   - **Impact:** Performance improvement, reduced index bloat
   - **Deployment:** Use `CREATE INDEX CONCURRENTLY` during low-traffic window

2. **111_replace_legacy_rls_policies.sql** (Phase 3)
   - Replace 13+ RLS policies from `tenant_id_text` → `tenant_id` (UUID)
   - Generated by `generate-rls-migration.js`
   - **Impact:** Security hardening, consistent tenant isolation
   - **Deployment:** Test thoroughly in staging first

3. **112_drop_legacy_tenant_columns.sql** (Phase 4 - FINAL)
   - Drop `tenant_id_text` and `tenant_id_legacy` columns
   - **Prerequisites:** Phases 2 & 3 complete, verified in production
   - **Impact:** Final cleanup, ~500MB disk space reclaimed

## Current State (As of January 2026)

### Application Code
- ✅ All routes use `tenant_id` (UUID) exclusively
- ✅ No frontend code references legacy columns
- ✅ RLS policies in new migrations use UUID pattern

### Database Schema
- ⚠️ Legacy columns still exist (nullable, deprecated)
- ⚠️ Many indexes still reference `tenant_id_text`
- ⚠️ Some RLS policies still use `tenant_id_text`
- ✅ All `tenant_id` (UUID) columns populated and indexed

## Developer Guidelines

### For New Migrations

**DO:**
- ✅ Use `tenant_id` (UUID) for all new tables
- ✅ Create indexes on `tenant_id` for performance
- ✅ Use UUID-based RLS policies: `tenant_id IN (SELECT tenant_uuid FROM users WHERE id = auth.uid())`

**DON'T:**
- ❌ Reference `tenant_id_text` or `tenant_id_legacy` in new code
- ❌ Create indexes on deprecated columns
- ❌ Add `tenant_id_text` to new tables

### For Schema Changes

If you need to modify tenant-related schema:
1. Read `TENANT_ID_CLEANUP_PLAN.md` for context
2. Ensure changes use `tenant_id` (UUID) only
3. Update migration checklist in the plan

## Reference Documentation

- **`TENANT_ID_CLEANUP_PLAN.md`** - Detailed migration roadmap
- **`DEPLOYMENT_CHECKLIST.md`** - Pre/post-deployment validation steps
- **`.github/copilot-instructions.md`** - Tenant UUID rules for AI assistants

## Questions?

Contact the development team lead or refer to the `TENANT_ID_CLEANUP_PLAN.md` for the complete migration strategy.
