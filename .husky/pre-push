#!/bin/sh
# ============================================================
# Pre-push hook: lint + build + tests
# Runs before git push. Blocks push if anything fails.
# Skip with: git push --no-verify
# ============================================================

set -e

echo ""
echo "╔══════════════════════════════════════════════╗"
echo "║        PRE-PUSH CHECKS (v4.7.0+)            ║"
echo "╚══════════════════════════════════════════════╝"
echo ""

# ── 1. Lint ──────────────────────────────────────────
echo "▶ [1/4] Running ESLint..."
if npm run lint -- --max-warnings 9999; then
  echo "✅ Lint passed"
else
  echo ""
  echo "❌ LINT FAILED — fix errors above before pushing"
  exit 1
fi
echo ""

# ── 2. Build ─────────────────────────────────────────
echo "▶ [2/4] Running build..."
if npm run build:ci; then
  echo "✅ Build passed"
else
  echo ""
  echo "❌ BUILD FAILED — fix errors above before pushing"
  exit 1
fi
echo ""

# ── 3. Frontend Tests (Vitest) ───────────────────────
echo "▶ [3/4] Running frontend tests (Vitest)..."
VITEST_JSON=$(mktemp -t vitest.XXXXXX 2>/dev/null || mktemp 2>/dev/null || echo "/tmp/vitest-$$.json")
VITEST_LOG=$(mktemp -t vitest-log.XXXXXX 2>/dev/null || mktemp 2>/dev/null || echo "/tmp/vitest-log-$$.txt")
trap 'rm -f "$VITEST_JSON" "$VITEST_LOG"' EXIT

vitest_zero_failures() {
  [ -f "$VITEST_JSON" ] && grep -q '"numFailedTests":0' "$VITEST_JSON" 2>/dev/null && grep -q '"numFailedTestSuites":0' "$VITEST_JSON" 2>/dev/null
}

set +e
env -u NODE_OPTIONS ./node_modules/.bin/vitest run --pool=forks --reporter=verbose --reporter=json --outputFile="$VITEST_JSON" 2>&1 | tee "$VITEST_LOG"
VITEST_EXIT=$?
set -e

if [ $VITEST_EXIT -eq 0 ]; then
  echo "✅ Frontend tests passed"
elif vitest_zero_failures; then
  echo "⚠️  Vitest exited with code $VITEST_EXIT but reported 0 test failures"
  echo "✅ Frontend tests passed (0 failures)"
elif grep -qi 'failed to find the runner\|Timeout starting .*runner' "$VITEST_LOG"; then
  echo "⚠️  Vitest runner bootstrap failed — retrying once in safe mode..."
  set +e
  env -u NODE_OPTIONS ./node_modules/.bin/vitest run --pool=forks --maxWorkers=1 --reporter=verbose --reporter=json --outputFile="$VITEST_JSON" 2>&1 | tee "$VITEST_LOG"
  VITEST_EXIT=$?
  set -e

  if [ $VITEST_EXIT -eq 0 ]; then
    echo "✅ Frontend tests passed on retry"
  elif vitest_zero_failures; then
    echo "⚠️  Vitest exited with code $VITEST_EXIT on retry but reported 0 test failures"
    echo "✅ Frontend tests passed (0 failures)"
  elif grep -qi 'failed to find the runner\|Timeout starting .*runner' "$VITEST_LOG"; then
    echo "⚠️  Runner flake persisted — executing fallback safe frontend runner (file-by-file)..."
    bash scripts/run-tests-safe.sh
    if [ -s "./test-results/failed-tests.txt" ] || [ -s "./test-results/skipped-tests.txt" ]; then
      echo ""
      echo "❌ FRONTEND TESTS FAILED — fallback runner reported failures/timeouts"
      exit 1
    fi
    echo "✅ Frontend tests passed via fallback safe runner"
  else
    echo ""
    echo "❌ FRONTEND TESTS FAILED — fix errors above before pushing"
    exit 1
  fi
else
  echo ""
  echo "❌ FRONTEND TESTS FAILED — fix errors above before pushing"
  exit 1
fi
rm -f "$VITEST_JSON" "$VITEST_LOG"
echo ""

# ── 4. Backend Tests (Docker) ────────────────────────
echo "▶ [4/4] Running backend tests..."
if docker ps --filter "name=aishacrm-backend" --filter "status=running" -q | grep -q .; then
  echo "   (running in Docker container aishacrm-backend)"
  if docker exec aishacrm-backend npm test 2>&1; then
    echo "✅ Backend tests passed"
  else
    echo ""
    echo "⚠️  Backend tests failed — retrying once (Node.js IPC fluke workaround)..."
    echo ""
    if docker exec aishacrm-backend npm test 2>&1; then
      echo "✅ Backend tests passed on retry"
    else
      echo ""
      echo "❌ BACKEND TESTS FAILED — fix errors above before pushing"
      exit 1
    fi
  fi
else
  echo "   ⚠️  Docker container aishacrm-backend not running — skipping backend tests"
  echo "   To run: docker compose up -d backend"
fi
echo ""

echo "╔══════════════════════════════════════════════╗"
echo "║           ✅ ALL CHECKS PASSED               ║"
echo "╚══════════════════════════════════════════════╝"
echo ""
