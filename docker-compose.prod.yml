services:
  # Redis/Valkey - Ephemeral memory layer for agent sessions
  redis-memory:
    image: redis:7-alpine
    container_name: aishacrm-redis-memory
    restart: unless-stopped
    ports:
      - "127.0.0.1:6379:6379"
    volumes:
      - redis_memory_data:/data
    command: redis-server --save 60 1 --loglevel warning --maxmemory 256mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD-SHELL", "redis-cli ping | grep PONG"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 5s

  # Redis Cache - API response caching
  redis-cache:
    image: redis:7-alpine
    container_name: aishacrm-redis-cache
    restart: unless-stopped
    ports:
      - "127.0.0.1:6380:6379"
    volumes:
      - redis_cache_data:/data
    command: redis-server --save "" --loglevel warning --maxmemory 512mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD-SHELL", "redis-cli ping | grep PONG"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 5s

  # Backend API
  backend:
    image: ghcr.io/andreibyf/aishacrm-2-backend:v1.0.41
    container_name: aishacrm-backend
    restart: unless-stopped
    depends_on:
      redis-memory:
        condition: service_healthy
      redis-cache:
        condition: service_healthy
    ports:
      - "127.0.0.1:4001:3001"
    env_file:
      - .env
    environment:
      - NODE_ENV=production
      - NODE_OPTIONS=${NODE_OPTIONS:---dns-result-order=ipv4first}
      - PORT=${PORT:-3001}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-http://localhost:4000}
      - PGSSLMODE=require
      - REDIS_URL=redis://redis-memory:6379
      - REDIS_CACHE_URL=redis://redis-cache:6379
      - SYSTEM_TENANT_ID=${SYSTEM_TENANT_ID:-a11dfb63-4b18-4eb8-872e-747af2e37c46}
      - TENANT_RESOLVE_CACHE_TTL_MS=${TENANT_RESOLVE_CACHE_TTL_MS:-300000}
      # IDR Configuration
      - IDR_WHITELIST_IPS=${IDR_WHITELIST_IPS:-}
      - IDR_EMERGENCY_SECRET=${IDR_EMERGENCY_SECRET:-}
      # Production Safety Guard - Allow writes in production
      - ALLOW_PRODUCTION_WRITES=${ALLOW_PRODUCTION_WRITES:-true}
      - RATE_LIMIT_MAX=${RATE_LIMIT_MAX:-300}
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:3001/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # MCP Server
  mcp:
    image: ghcr.io/andreibyf/aishacrm-mcp:latest
    container_name: aishacrm-mcp
    restart: unless-stopped
    ports:
      - "127.0.0.1:4002:8000"
    env_file:
      - .env
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:8000/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s

  # Frontend
  frontend:
    image: ghcr.io/andreibyf/aishacrm-2-frontend:v1.0.43
    container_name: aishacrm-frontend
    restart: unless-stopped
    depends_on:
      backend:
        condition: service_started
    ports:
      - "4000:3000"
    env_file:
      - .env
    environment:
      - PORT=${FRONTEND_PORT:-3000}
      - VITE_SUPABASE_URL=${VITE_SUPABASE_URL}
      - VITE_SUPABASE_ANON_KEY=${VITE_SUPABASE_ANON_KEY}
      - VITE_AISHACRM_BACKEND_URL=${VITE_AISHACRM_BACKEND_URL}
      - VITE_CURRENT_BRANCH=${VITE_CURRENT_BRANCH:-main}
      - VITE_SYSTEM_TENANT_ID=${VITE_SYSTEM_TENANT_ID}
      - VITE_USER_HEARTBEAT_INTERVAL_MS=${VITE_USER_HEARTBEAT_INTERVAL_MS:-90000}
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:3000/ || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s

  # n8n - Workflow automation
  n8n:
    image: n8nio/n8n:latest
    container_name: aishacrm-n8n
    restart: unless-stopped
    ports:
      - "127.0.0.1:5678:5678"
    environment:
      - N8N_PORT=5678
      - N8N_HOST=0.0.0.0
      - GENERIC_TIMEZONE=UTC
      - N8N_DIAGNOSTICS_ENABLED=false
      - N8N_SECURE_COOKIE=false
      - N8N_SKIP_WEBHOOK_DEREGISTRATION_SHUTDOWN=true
      - N8N_HIRING_BANNER_ENABLED=false
      - N8N_BASIC_AUTH_ACTIVE=${N8N_BASIC_AUTH_ACTIVE:-false}
      - N8N_BASIC_AUTH_USER=${N8N_BASIC_AUTH_USER}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_BASIC_AUTH_PASSWORD}
    volumes:
      - n8n_data:/home/node/.n8n
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:5678/ || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s

volumes:
  redis_memory_data:
    driver: local
  redis_cache_data:
    driver: local
  n8n_data:
    driver: local
