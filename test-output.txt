TAP version 13
# ✓ Supabase DB client initialized with performance tracking
# ✓ Supabase DB client initialized (using centralized factory)
# [ModelRouter] Module loaded - LLM_PROVIDER=undefined
# Subtest: AI Triggers Worker
    # Subtest: TRIGGER_TYPES are properly defined
    ok 1 - TRIGGER_TYPES are properly defined
      ---
      duration_ms: 1304.239534
      ...
    # Subtest: Worker exports startAiTriggersWorker and stopAiTriggersWorker
    ok 2 - Worker exports startAiTriggersWorker and stopAiTriggersWorker
      ---
      duration_ms: 1.456659
      ...
    # Subtest: Worker exports triggerForTenant for manual triggering
    ok 3 - Worker exports triggerForTenant for manual triggering
      ---
      duration_ms: 0.323313
      ...
    # Subtest: Worker exports getPendingSuggestions
    ok 4 - Worker exports getPendingSuggestions
      ---
      duration_ms: 0.297492
      ...
    1..4
ok 1 - AI Triggers Worker
  ---
  duration_ms: 1504.420066
  type: 'suite'
  ...
# Subtest: Suggestions API
    # Subtest: GET /api/ai/suggestions returns 200 with tenant_id
    ok 1 - GET /api/ai/suggestions returns 200 with tenant_id
      ---
      duration_ms: 302.274569
      ...
    # Subtest: GET /api/ai/suggestions supports status filter
    ok 2 - GET /api/ai/suggestions supports status filter
      ---
      duration_ms: 245.994963
      ...
    # Subtest: GET /api/ai/suggestions supports trigger_id filter
    ok 3 - GET /api/ai/suggestions supports trigger_id filter
      ---
      duration_ms: 359.192809
      ...
    # Subtest: GET /api/ai/suggestions supports priority filter
    ok 4 - GET /api/ai/suggestions supports priority filter
      ---
      duration_ms: 266.544772
      ...
    # Subtest: GET /api/ai/suggestions supports pagination
    ok 5 - GET /api/ai/suggestions supports pagination
      ---
      duration_ms: 174.578546
      ...
    # Subtest: GET /api/ai/suggestions/stats returns statistics
    ok 6 - GET /api/ai/suggestions/stats returns statistics
      ---
      duration_ms: 120.020288
      ...
    1..6
ok 2 - Suggestions API
  ---
  duration_ms: 1471.734407
  type: 'suite'
  ...
# Subtest: Suggestion Actions
    # Subtest: POST /api/ai/suggestions/:id/approve updates status to approved
    ok 1 - POST /api/ai/suggestions/:id/approve updates status to approved
      ---
      duration_ms: 400.982523
      ...
    # Subtest: POST /api/ai/suggestions/:id/reject updates status to rejected
    ok 2 - POST /api/ai/suggestions/:id/reject updates status to rejected
      ---
      duration_ms: 187.170447
      ...
    1..2
ok 3 - Suggestion Actions
  ---
  duration_ms: 589.43938
  type: 'suite'
  ...
# Subtest: Trigger Detection Logic
    # Subtest: Lead stagnation detection threshold is 7 days
    ok 1 - Lead stagnation detection threshold is 7 days
      ---
      duration_ms: 0.869084
      ...
    # Subtest: Deal decay detection threshold is 14 days
    ok 2 - Deal decay detection threshold is 14 days
      ---
      duration_ms: 0.392052
      ...
    # Subtest: Hot opportunity detection requires 70% probability
    ok 3 - Hot opportunity detection requires 70% probability
      ---
      duration_ms: 0.522249
      ...
    1..3
ok 4 - Trigger Detection Logic
  ---
  duration_ms: 2.43935
  type: 'suite'
  ...
# Subtest: Suggestion Template Generation
    # Subtest: Template suggestions include required fields
    ok 1 - Template suggestions include required fields
      ---
      duration_ms: 197.994586
      ...
    1..1
ok 5 - Suggestion Template Generation
  ---
  duration_ms: 202.639554
  type: 'suite'
  ...
# Subtest: API key cleaning - removes newlines and tabs
ok 6 - API key cleaning - removes newlines and tabs
  ---
  duration_ms: 2.565836
  ...
# Subtest: API key cleaning - removes leading/trailing whitespace
ok 7 - API key cleaning - removes leading/trailing whitespace
  ---
  duration_ms: 0.367696
  ...
# Subtest: API key cleaning - handles multiple newlines
ok 8 - API key cleaning - handles multiple newlines
  ---
  duration_ms: 0.285297
  ...
# Subtest: API key cleaning - preserves valid key
ok 9 - API key cleaning - preserves valid key
  ---
  duration_ms: 0.370767
  ...
# Subtest: API key validation - accepts sk- prefix
ok 10 - API key validation - accepts sk- prefix
  ---
  duration_ms: 0.309764
  ...
# Subtest: API key validation - accepts reasonable length
ok 11 - API key validation - accepts reasonable length
  ---
  duration_ms: 3.186403
  ...
# Subtest: API key validation - rejects too short key
ok 12 - API key validation - rejects too short key
  ---
  duration_ms: 0.698011
  ...
# Subtest: API key validation - rejects wrong prefix
ok 13 - API key validation - rejects wrong prefix
  ---
  duration_ms: 0.31833
  ...
# Subtest: API key cleaning - handles CRLF line endings
ok 14 - API key cleaning - handles CRLF line endings
  ---
  duration_ms: 0.454202
  ...
# ✓ Supabase DB client initialized with performance tracking
# ✓ Supabase DB client initialized (using centralized factory)
# [Braid Scenarios] Supabase client initialized
# [Braid Scenarios] Found tenant: 6cb4c008-4847-426a-9a2e-918ad70e7b69
# [Braid Scenarios] Using TOOL_ACCESS_TOKEN for test execution
# [Braid Tool] Executing search_accounts {
#   braidPath: '/braid-llm-kit/examples/assistant/accounts.braid',
#   function: 'searchAccounts',
#   tenantUuid: '6cb4c008-4847-426a-9a2e-918ad70e7b69',
#   argsPreview: '["6cb4c008-4847-426a-9a2e-918ad70e7b69",null,5]'
# }
# [Braid Tool] Cache MISS for search_accounts {
#   cacheKey: 'braid:6cb4c008-4847-426a-9a2e-918ad70e7b69:search_accounts:5'
# }
# [Braid RT] http.get called with args: ["/api/v2/accounts",{"params":{"tenant_id":"6cb4c008-4847-426a-9a2e-918ad70e7b69","limit":5}}]
# [Braid HTTP GET] http://backend:3001/api/v2/accounts?tenant_id=6cb4c008-4847-426a-9a2e-918ad70e7b69&search=undefined&limit=5
# [Braid HTTP GET] Error: 401 {"status":"error","message":"Authentication required"}
# [Braid Tool] search_accounts completed {
#   resultTag: 'Err',
#   hasError: true,
#   errorType: undefined,
#   errorMsg: undefined,
#   resultCount: 'N/A',
#   resultPreview: 'N/A'
# }
# [Expected] search_accounts returned: undefined
# [Braid Tool] Executing search_contacts {
#   braidPath: '/braid-llm-kit/examples/assistant/contacts.braid',
#   function: 'searchContacts',
#   tenantUuid: '6cb4c008-4847-426a-9a2e-918ad70e7b69',
#   argsPreview: '["6cb4c008-4847-426a-9a2e-918ad70e7b69",null,5]'
# }
# [Braid Tool] Cache MISS for search_contacts {
#   cacheKey: 'braid:6cb4c008-4847-426a-9a2e-918ad70e7b69:search_contacts:5'
# }
# Subtest: Braid SDK Scenario Tests
    # Subtest: Retrieval Scenarios
        # Subtest: search_accounts retrieves accounts for tenant
        ok 1 - search_accounts retrieves accounts for tenant
          ---
          duration_ms: 162.936319
          ...
# [Braid RT] http.get called with args: ["/api/v2/contacts",{"params":{"tenant_id":"6cb4c008-4847-426a-9a2e-918ad70e7b69","limit":5}}]
# [Braid HTTP GET] http://backend:3001/api/v2/contacts?tenant_id=6cb4c008-4847-426a-9a2e-918ad70e7b69&search=undefined&limit=5
# [Braid HTTP GET] Error: 401 {"status":"error","message":"Authentication required"}
# [Braid Tool] search_contacts completed {
#   resultTag: 'Err',
#   hasError: true,
#   errorType: undefined,
#   errorMsg: undefined,
#   resultCount: 'N/A',
#   resultPreview: 'N/A'
# }
# [Braid Tool] Executing search_leads {
#   braidPath: '/braid-llm-kit/examples/assistant/leads.braid',
#   function: 'searchLeads',
#   tenantUuid: '6cb4c008-4847-426a-9a2e-918ad70e7b69',
#   argsPreview: '["6cb4c008-4847-426a-9a2e-918ad70e7b69",null,5]'
# }
# [Braid Tool] Cache MISS for search_leads {
#   cacheKey: 'braid:6cb4c008-4847-426a-9a2e-918ad70e7b69:search_leads:4208'
# }
        # Subtest: search_contacts retrieves contacts for tenant
        ok 2 - search_contacts retrieves contacts for tenant
          ---
          duration_ms: 81.730924
          ...
# [Braid RT] http.get called with args: ["/api/v2/leads",{"params":{"tenant_id":"6cb4c008-4847-426a-9a2e-918ad70e7b69","limit":5}}]
# [Braid HTTP GET] http://backend:3001/api/v2/leads?tenant_id=6cb4c008-4847-426a-9a2e-918ad70e7b69&limit=5&query=undefined
# [Braid HTTP GET] Response data keys: [ 'status', 'data' ]
# [Braid Tool] search_leads completed {
#   resultTag: 'Ok',
#   hasError: false,
#   errorType: undefined,
#   errorMsg: undefined,
#   resultCount: 0,
#   resultPreview: []
# }
# [Braid Tool] Cached search_leads result for 60s
# [Braid] No param order defined for searchOpportunities, passing as object
# [Braid Tool] Executing search_opportunities {
#   braidPath: '/braid-llm-kit/examples/assistant/opportunities.braid',
#   function: 'searchOpportunities',
#   tenantUuid: '6cb4c008-4847-426a-9a2e-918ad70e7b69',
#   argsPreview: '[{"limit":5,"tenant":"6cb4c008-4847-426a-9a2e-918ad70e7b69"}]'
# }
# [Braid Tool] Cache MISS for search_opportunities {
#   cacheKey: 'braid:6cb4c008-4847-426a-9a2e-918ad70e7b69:search_opportunit'
# }
        # Subtest: search_leads retrieves leads for tenant
        ok 3 - search_leads retrieves leads for tenant
          ---
          duration_ms: 134.017427
          ...
# [Braid RT] http.get called with args: ["/api/v2/opportunities",{"params":{"tenant_id":{"limit":5,"tenant":"6cb4c008-4847-426a-9a2e-918ad70e7b69"}}}]
# [Braid HTTP GET] http://backend:3001/api/v2/opportunities?tenant_id=6cb4c008-4847-426a-9a2e-918ad70e7b69&limit=undefined
# [Braid HTTP GET] Error: 401 {"status":"error","message":"Authentication required"}
# [Braid Tool] search_opportunities completed {
#   resultTag: 'Err',
#   hasError: true,
#   errorType: undefined,
#   errorMsg: undefined,
#   resultCount: 'N/A',
#   resultPreview: 'N/A'
# }
# [Braid Tool] Executing create_lead {
#   braidPath: '/braid-llm-kit/examples/assistant/leads.braid',
#   function: 'createLead',
#   tenantUuid: '6cb4c008-4847-426a-9a2e-918ad70e7b69',
#   argsPreview: '["6cb4c008-4847-426a-9a2e-918ad70e7b69",null,null,"braidtest1770243470677@example.com",null,"Braid Test Company","new","braid_test",null]'
# }
# [Braid HTTP] POST http://backend:3001/api/v2/leads {"tenant_id":"6cb4c008-4847-426a-9a2e-918ad70e7b69","email":"braidtest1770243470677@example.com","phone":"Braid Test Company","source":"new","status":"new","metadata":{}}
        # Subtest: search_opportunities retrieves opportunities for tenant
        ok 4 - search_opportunities retrieves opportunities for tenant
          ---
          duration_ms: 50.074224
          ...
        # Subtest: get_dashboard_metrics retrieves dashboard data
        ok 5 - get_dashboard_metrics retrieves dashboard data
          ---
          duration_ms: 1.876816
          ...
        1..5
    ok 1 - Retrieval Scenarios
      ---
      duration_ms: 433.606462
      type: 'suite'
      ...
# [Braid HTTP] POST error 400 {"status":"error","message":"first_name is required"}
# [Braid Tool] create_lead completed {
#   resultTag: 'Err',
#   hasError: true,
#   errorType: undefined,
#   errorMsg: undefined,
#   resultCount: 'N/A',
#   resultPreview: 'N/A'
# }
# [Create Lead] Error: undefined undefined
    # Subtest: CRUD Scenarios
        # Subtest: create_lead creates a new lead
        ok 1 - create_lead creates a new lead
          ---
          duration_ms: 54.875285
          ...
# [Braid Tool] Executing get_lead_details {
#   braidPath: '/braid-llm-kit/examples/assistant/leads.braid',
#   function: 'getLeadDetails',
#   tenantUuid: '6cb4c008-4847-426a-9a2e-918ad70e7b69',
#   argsPreview: '["6cb4c008-4847-426a-9a2e-918ad70e7b69","14e72a93-a392-4ce2-b940-b9da46b1a7e6"]'
# }
# [Braid Tool] Cache MISS for get_lead_details {
#   cacheKey: 'braid:6cb4c008-4847-426a-9a2e-918ad70e7b69:get_lead_details:'
# }
# [Braid RT] http.get called with args: ["/api/v2/leads/14e72a93-a392-4ce2-b940-b9da46b1a7e6",{"params":{"tenant_id":"6cb4c008-4847-426a-9a2e-918ad70e7b69"}}]
# [Braid HTTP GET] http://backend:3001/api/v2/leads/14e72a93-a392-4ce2-b940-b9da46b1a7e6?tenant_id=6cb4c008-4847-426a-9a2e-918ad70e7b69
# [Braid HTTP GET] Response data keys: [ 'status', 'data' ]
# [Braid Tool] get_lead_details completed {
#   resultTag: 'Ok',
#   hasError: false,
#   errorType: undefined,
#   errorMsg: undefined,
#   resultCount: 'N/A',
#   resultPreview: 'N/A'
# }
# [Braid Tool] Cached get_lead_details result for 180s
# [Braid Security] Tool execution DENIED - invalid or missing access token {
#   toolName: 'search_accounts',
#   hasToken: false,
#   tokenVerified: undefined,
#   tokenSource: undefined,
#   tenantId: '6cb4c008-4847-426a-9a2e-918ad70e7b69',
#   userId: '00000000-0000-0000-0000-000000000001'
# }
# [Braid Security] Tool execution DENIED - invalid or missing access token {
#   toolName: 'search_accounts',
#   hasToken: true,
#   tokenVerified: false,
#   tokenSource: 'fake',
#   tenantId: '6cb4c008-4847-426a-9a2e-918ad70e7b69',
#   userId: '00000000-0000-0000-0000-000000000001'
# }
# [Braid Tool] Executing search_accounts {
#   braidPath: '/braid-llm-kit/examples/assistant/accounts.braid',
#   function: 'searchAccounts',
#   tenantUuid: '6cb4c008-4847-426a-9a2e-918ad70e7b69',
#   argsPreview: '["6cb4c008-4847-426a-9a2e-918ad70e7b69",null,1]'
# }
# [Braid Tool] Cache MISS for search_accounts {
#   cacheKey: 'braid:6cb4c008-4847-426a-9a2e-918ad70e7b69:search_accounts:f'
# }
# [Braid RT] http.get called with args: ["/api/v2/accounts",{"params":{"tenant_id":"6cb4c008-4847-426a-9a2e-918ad70e7b69","limit":1}}]
# [Braid HTTP GET] http://backend:3001/api/v2/accounts?tenant_id=6cb4c008-4847-426a-9a2e-918ad70e7b69&search=undefined&limit=1
        # Subtest: get_lead_details retrieves a specific lead
        ok 2 - get_lead_details retrieves a specific lead
          ---
          duration_ms: 394.99061
          ...
        # Subtest: update_lead modifies an existing lead
        ok 3 - update_lead modifies an existing lead
          ---
          duration_ms: 0.78766
          ...
        1..3
    ok 2 - CRUD Scenarios
      ---
      duration_ms: 453.1198
      type: 'suite'
      ...
    # Subtest: Security Scenarios
        # Subtest: executeBraidTool rejects calls without access token
        ok 1 - executeBraidTool rejects calls without access token
          ---
          duration_ms: 1.409238
          ...
        # Subtest: executeBraidTool rejects invalid access token
        ok 2 - executeBraidTool rejects invalid access token
          ---
          duration_ms: 1.208046
          ...
        # Subtest: executeBraidTool rejects unknown tool names
        ok 3 - executeBraidTool rejects unknown tool names
          ---
          duration_ms: 0.705722
          ...
        1..3
    ok 3 - Security Scenarios
      ---
      duration_ms: 5.428768
      type: 'suite'
      ...
    # Subtest: Tool Registry Validation
        # Subtest: TOOL_REGISTRY contains expected CRM tools
        ok 1 - TOOL_REGISTRY contains expected CRM tools
          ---
          duration_ms: 0.838189
          ...
        # Subtest: Each registered tool has required metadata
        ok 2 - Each registered tool has required metadata
          ---
          duration_ms: 1.100632
          ...
        1..2
    ok 4 - Tool Registry Validation
      ---
      duration_ms: 2.399083
      type: 'suite'
      ...
# [Braid HTTP GET] Error: 401 {"status":"error","message":"Authentication required"}
# [Braid Tool] search_accounts completed {
#   resultTag: 'Err',
#   hasError: true,
#   errorType: undefined,
#   errorMsg: undefined,
#   resultCount: 'N/A',
#   resultPreview: 'N/A'
# }
# [Audit] Found 1 recent audit entries
    # Subtest: Audit Logging
        # Subtest: Tool execution creates audit log entries
        ok 1 - Tool execution creates audit log entries
          ---
          duration_ms: 624.636498
          ...
        1..1
    ok 5 - Audit Logging
      ---
      duration_ms: 625.039977
      type: 'suite'
      ...
    1..5
ok 15 - Braid SDK Scenario Tests
  ---
  duration_ms: 3259.263093
  type: 'suite'
  ...
# Subtest: /app/__tests__/ai/braidScenarios.test.js
not ok 3 - /app/__tests__/ai/braidScenarios.test.js
  ---
  duration_ms: 10002.751033
  location: '/app/__tests__/ai/braidScenarios.test.js:1:1'
  failureType: 'testTimeoutFailure'
  error: 'test timed out after 10000ms'
  code: 'ERR_TEST_FAILURE'
  ...
# ✓ Supabase DB client initialized with performance tracking
# ✓ Supabase DB client initialized (using centralized factory)
# Subtest: Braid Tool Execution
    # Subtest: Braid Graph API
        # Subtest: GET /api/braid/graph returns tool dependency graph
        ok 1 - GET /api/braid/graph returns tool dependency graph
          ---
          duration_ms: 146.182289
          ...
        # Subtest: GET /api/braid/graph/categories returns tool categories
        ok 2 - GET /api/braid/graph/categories returns tool categories
          ---
          duration_ms: 41.778059
          ...
        # Subtest: GET /api/braid/graph/tool/:name returns tool details
        ok 3 - GET /api/braid/graph/tool/:name returns tool details
          ---
          duration_ms: 15.94197
          ...
        # Subtest: GET /api/braid/graph/tool/:name/impact returns impact analysis
        ok 4 - GET /api/braid/graph/tool/:name/impact returns impact analysis
          ---
          duration_ms: 39.792072
          ...
        # Subtest: GET /api/braid/graph/validate checks for circular dependencies
        ok 5 - GET /api/braid/graph/validate checks for circular dependencies
          ---
          duration_ms: 14.167775
          ...
        # Subtest: GET /api/braid/graph/effects/:effect returns tools by effect
        ok 6 - GET /api/braid/graph/effects/:effect returns tools by effect
          ---
          duration_ms: 18.262967
          ...
        1..6
    ok 1 - Braid Graph API
      ---
      duration_ms: 282.714483
      type: 'suite'
      ...
    # Subtest: Retrieval Functions
        # Subtest: GET /api/v2/accounts returns accounts list
        ok 1 - GET /api/v2/accounts returns accounts list
          ---
          duration_ms: 445.677886
          ...
        # Subtest: GET /api/v2/contacts returns contacts list
        ok 2 - GET /api/v2/contacts returns contacts list
          ---
          duration_ms: 157.944557
          ...
        # Subtest: GET /api/v2/leads returns leads list
        ok 3 - GET /api/v2/leads returns leads list
          ---
          duration_ms: 171.736191
          ...
        # Subtest: GET /api/v2/opportunities returns opportunities list
        ok 4 - GET /api/v2/opportunities returns opportunities list
          ---
          duration_ms: 157.105027
          ...
        # Subtest: GET /api/v2/activities returns activities list
        ok 5 - GET /api/v2/activities returns activities list
          ---
          duration_ms: 102.474002
          ...
        # Subtest: Search endpoints support query parameters
        ok 6 - Search endpoints support query parameters
          ---
          duration_ms: 130.422065
          ...
        1..6
    ok 2 - Retrieval Functions
      ---
      duration_ms: 1176.429131
      type: 'suite'
      ...
    # Subtest: Navigation Functions
        # Subtest: AI routes are accessible
        ok 1 - AI routes are accessible
          ---
          duration_ms: 190.773304
          ...
        # Subtest: Braid graph endpoint is accessible
        ok 2 - Braid graph endpoint is accessible
          ---
          duration_ms: 48.638997
          ...
        1..2
    ok 3 - Navigation Functions
      ---
      duration_ms: 240.183385
      type: 'suite'
      ...
    # Subtest: Update Functions
        # Subtest: POST /api/leads creates a new lead
        ok 1 - POST /api/leads creates a new lead
          ---
          duration_ms: 43.418685
          ...
        # Subtest: PUT /api/leads/:id updates a lead
        ok 2 - PUT /api/leads/:id updates a lead
          ---
          duration_ms: 0.876203
          ...
        # Subtest: DELETE /api/leads/:id removes a lead
        ok 3 - DELETE /api/leads/:id removes a lead
          ---
          duration_ms: 0.730995
          ...
        1..3
    ok 4 - Update Functions
      ---
      duration_ms: 46.033944
      type: 'suite'
      ...
    # Subtest: Braid Metrics API
        # Subtest: GET /api/braid/metrics/tools returns tool metrics
        ok 1 - GET /api/braid/metrics/tools returns tool metrics
          ---
          duration_ms: 38.952102
          ...
        # Subtest: GET /api/braid/metrics/timeseries returns time series data
        ok 2 - GET /api/braid/metrics/timeseries returns time series data
          ---
          duration_ms: 6.995301
          ...
        1..2
    ok 5 - Braid Metrics API
      ---
      duration_ms: 46.551677
      type: 'suite'
      ...
    # Subtest: Braid Integration Module
        # Subtest: TOOL_CATEGORIES are properly defined
        ok 1 - TOOL_CATEGORIES are properly defined
          ---
          duration_ms: 1.147432
          ...
        # Subtest: TOOL_GRAPH contains tool definitions
        not ok 2 - TOOL_GRAPH contains tool definitions
          ---
          duration_ms: 2.024851
          location: '/app/__tests__/ai/braidToolExecution.test.js:309:5'
          failureType: 'testCodeFailure'
          error: 'Should have create_lead tool'
          code: 'ERR_ASSERTION'
          name: 'AssertionError'
          expected: true
          operator: '=='
          stack: |-
            TestContext.<anonymous> (file:///app/__tests__/ai/braidToolExecution.test.js:316:14)
            Test.runInAsyncScope (node:async_hooks:206:9)
            Test.run (node:internal/test_runner/test:796:25)
            async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
          ...
        # Subtest: getToolDependencies returns dependency object
        ok 3 - getToolDependencies returns dependency object
          ---
          duration_ms: 0.621894
          ...
        # Subtest: getToolDependents returns dependents object
        ok 4 - getToolDependents returns dependents object
          ---
          duration_ms: 1.223963
          ...
        # Subtest: getToolsByCategory returns tools in category
        ok 5 - getToolsByCategory returns tools in category
          ---
          duration_ms: 0.910451
          ...
        # Subtest: detectCircularDependencies returns validation result
        ok 6 - detectCircularDependencies returns validation result
          ---
          duration_ms: 0.798138
          ...
        # Subtest: getToolImpactAnalysis returns analysis for valid tool
        ok 7 - getToolImpactAnalysis returns analysis for valid tool
          ---
          duration_ms: 1.552765
          ...
        1..7
    not ok 6 - Braid Integration Module
      ---
      duration_ms: 644.610132
      type: 'suite'
      location: '/app/__tests__/ai/braidToolExecution.test.js:285:3'
      failureType: 'subtestsFailed'
      error: '1 subtest failed'
      code: 'ERR_TEST_FAILURE'
      ...
    1..6
not ok 17 - Braid Tool Execution
  ---
  duration_ms: 2626.566205
  type: 'suite'
  location: '/app/__tests__/ai/braidToolExecution.test.js:21:1'
  failureType: 'subtestsFailed'
  error: '1 subtest failed'
  code: 'ERR_TEST_FAILURE'
  ...
# Subtest: Conversation Context Tests
    # Subtest: System Prompt Enhancements
        # Subtest: BRAID_SYSTEM_PROMPT includes conversation continuity section
        not ok 1 - BRAID_SYSTEM_PROMPT includes conversation continuity section
          ---
          duration_ms: 959.086712
          location: '/app/__tests__/ai/conversationContext.test.js:19:5'
          failureType: 'testCodeFailure'
          error: 'System prompt should include conversation continuity section'
          code: 'ERR_ASSERTION'
          name: 'AssertionError'
          expected: true
          actual: false
          operator: '=='
          stack: |-
            TestContext.<anonymous> (file:///app/__tests__/ai/conversationContext.test.js:23:14)
            async Test.run (node:internal/test_runner/test:797:9)
            async Promise.all (index 0)
            async Suite.run (node:internal/test_runner/test:1135:7)
            async Promise.all (index 0)
            async Suite.run (node:internal/test_runner/test:1135:7)
            async Test.processPendingSubtests (node:internal/test_runner/test:526:7)
          ...
        # Subtest: System prompt includes suggest_next_actions trigger patterns
        not ok 2 - System prompt includes suggest_next_actions trigger patterns
          ---
          duration_ms: 7.451311
          location: '/app/__tests__/ai/conversationContext.test.js:44:5'
          failureType: 'testCodeFailure'
          error: 'System prompt should include trigger pattern: "What should I do next?"'
          code: 'ERR_ASSERTION'
          name: 'AssertionError'
          expected: true
          actual: false
          operator: '=='
          stack: |-
            TestContext.<anonymous> (file:///app/__tests__/ai/conversationContext.test.js:57:16)
            async Test.run (node:internal/test_runner/test:797:9)
            async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
          ...
        # Subtest: System prompt includes implicit reference handling examples
        not ok 3 - System prompt includes implicit reference handling examples
          ---
          duration_ms: 0.933542
          location: '/app/__tests__/ai/conversationContext.test.js:64:5'
          failureType: 'testCodeFailure'
          error: 'Should include warm leads example'
          code: 'ERR_ASSERTION'
          name: 'AssertionError'
          expected: true
          actual: false
          operator: '=='
          stack: |-
            TestContext.<anonymous> (file:///app/__tests__/ai/conversationContext.test.js:68:14)
            async Test.run (node:internal/test_runner/test:797:9)
            async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
          ...
        1..3
    not ok 1 - System Prompt Enhancements
      ---
      duration_ms: 970.008633
      type: 'suite'
      location: '/app/__tests__/ai/conversationContext.test.js:17:3'
      failureType: 'subtestsFailed'
      error: '3 subtests failed'
      code: 'ERR_TEST_FAILURE'
      stack: |-
        async Promise.all (index 0)
      ...
    # Subtest: Session Context Injection
        # Subtest: Session entities format includes all required fields
        ok 1 - Session entities format includes all required fields
          ---
          duration_ms: 0.904842
          ...
        # Subtest: Conversation summary format includes role and content preview
        ok 2 - Conversation summary format includes role and content preview
          ---
          duration_ms: 1.287956
          ...
        1..2
    ok 2 - Session Context Injection
      ---
      duration_ms: 2.911474
      type: 'suite'
      ...
    # Subtest: Suggest Next Actions Tool
        # Subtest: suggest_next_actions tool is properly defined
        ok 1 - suggest_next_actions tool is properly defined
          ---
          duration_ms: 259.52059
          ...
        # Subtest: suggest_next_actions analyzes entity state correctly
        ok 2 - suggest_next_actions analyzes entity state correctly
          ---
          duration_ms: 0.98647
          ...
        1..2
    ok 3 - Suggest Next Actions Tool
      ---
      duration_ms: 261.107821
      type: 'suite'
      ...
    # Subtest: Expected Behavior with Problem Statement Scenario
        # Subtest: System prompt should prevent "I'm not sure" responses
        not ok 1 - System prompt should prevent "I'm not sure" responses
          ---
          duration_ms: 1.316558
          location: '/app/__tests__/ai/conversationContext.test.js:208:5'
          failureType: 'testCodeFailure'
          error: `System prompt should explicitly forbid "I'm not sure" responses`
          code: 'ERR_ASSERTION'
          name: 'AssertionError'
          expected: true
          actual: false
          operator: '=='
          stack: |-
            TestContext.<anonymous> (file:///app/__tests__/ai/conversationContext.test.js:229:14)
            async Test.run (node:internal/test_runner/test:797:9)
            async Promise.all (index 0)
            async Suite.run (node:internal/test_runner/test:1135:7)
            async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
          ...
        # Subtest: System prompt should mandate suggest_next_actions for "next steps" questions
        not ok 2 - System prompt should mandate suggest_next_actions for "next steps" questions
          ---
          duration_ms: 1.384444
          location: '/app/__tests__/ai/conversationContext.test.js:235:5'
          failureType: 'testCodeFailure'
          error: 'System prompt should use mandatory language'
          code: 'ERR_ASSERTION'
          name: 'AssertionError'
          expected: true
          actual: false
          operator: '=='
          stack: |-
            TestContext.<anonymous> (file:///app/__tests__/ai/conversationContext.test.js:241:14)
            async Test.run (node:internal/test_runner/test:797:9)
            async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
          ...
        # Subtest: Implicit reference "I think I only have 1" should be handleable
        not ok 3 - Implicit reference "I think I only have 1" should be handleable
          ---
          duration_ms: 1.363719
          location: '/app/__tests__/ai/conversationContext.test.js:257:5'
          failureType: 'testCodeFailure'
          error: 'Should include the exact example from problem statement'
          code: 'ERR_ASSERTION'
          name: 'AssertionError'
          expected: true
          actual: false
          operator: '=='
          stack: |-
            TestContext.<anonymous> (file:///app/__tests__/ai/conversationContext.test.js:266:14)
            async Test.run (node:internal/test_runner/test:797:9)
            async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
          ...
        1..3
    not ok 4 - Expected Behavior with Problem Statement Scenario
      ---
      duration_ms: 6.716552
      type: 'suite'
      location: '/app/__tests__/ai/conversationContext.test.js:206:3'
      failureType: 'subtestsFailed'
      error: '3 subtests failed'
      code: 'ERR_TEST_FAILURE'
      ...
    1..4
not ok 18 - Conversation Context Tests
  ---
  duration_ms: 1245.787863
  type: 'suite'
  location: '/app/__tests__/ai/conversationContext.test.js:15:1'
  failureType: 'subtestsFailed'
  error: '2 subtests failed'
  code: 'ERR_TEST_FAILURE'
  ...
# Subtest: Entity Context Extraction Tests
    # Subtest: extractEntityContext Helper Function
        # Subtest: extracts lead_id from tool arguments
        ok 1 - extracts lead_id from tool arguments
          ---
          duration_ms: 5.758048
          ...
        # Subtest: extracts contact_id from tool with id argument and name pattern
        ok 2 - extracts contact_id from tool with id argument and name pattern
          ---
          duration_ms: 1.799063
          ...
        # Subtest: extracts multiple entity types from multiple tools
        ok 3 - extracts multiple entity types from multiple tools
          ---
          duration_ms: 0.943073
          ...
        # Subtest: returns empty object for empty tool interactions
        ok 4 - returns empty object for empty tool interactions
          ---
          duration_ms: 1.603731
          ...
        # Subtest: handles tools without entity IDs gracefully
        ok 5 - handles tools without entity IDs gracefully
          ---
          duration_ms: 0.547598
          ...
        1..5
    ok 1 - extractEntityContext Helper Function
      ---
      duration_ms: 16.411986
      type: 'suite'
      ...
    # Subtest: Metadata Structure
        # Subtest: expected metadata structure includes entity IDs at top level
        ok 1 - expected metadata structure includes entity IDs at top level
          ---
          duration_ms: 0.547654
          ...
        # Subtest: metadata does not include null or undefined entity IDs
        ok 2 - metadata does not include null or undefined entity IDs
          ---
          duration_ms: 0.466691
          ...
        1..2
    ok 2 - Metadata Structure
      ---
      duration_ms: 1.408706
      type: 'suite'
      ...
    # Subtest: Context Carry-Forward Logic
        # Subtest: extracts most recent entity context from message history
        ok 1 - extracts most recent entity context from message history
          ---
          duration_ms: 0.69028
          ...
        # Subtest: handles empty message history gracefully
        ok 2 - handles empty message history gracefully
          ---
          duration_ms: 0.428881
          ...
        1..2
    ok 3 - Context Carry-Forward Logic
      ---
      duration_ms: 1.430909
      type: 'suite'
      ...
    1..3
ok 19 - Entity Context Extraction Tests
  ---
  duration_ms: 21.209618
  type: 'suite'
  ...
# Subtest: Entity Context Integration Tests
    # Subtest: End-to-End Entity Context Flow
        # Subtest: Simulates conversation with lead context extraction and persistence
        ok 1 - Simulates conversation with lead context extraction and persistence
          ---
          duration_ms: 2.46642
          ...
        # Subtest: Simulates multi-turn conversation with context switching
        ok 2 - Simulates multi-turn conversation with context switching
          ---
          duration_ms: 3.590483
          ...
        # Subtest: Verifies entity extraction from create operations
        ok 3 - Verifies entity extraction from create operations
          ---
          duration_ms: 2.266163
          ...
        # Subtest: Handles mixed entity operations in single turn
        ok 4 - Handles mixed entity operations in single turn
          ---
          duration_ms: 1.521545
          ...
        1..4
    ok 1 - End-to-End Entity Context Flow
      ---
      duration_ms: 11.382975
      type: 'suite'
      ...
    # Subtest: Query Pattern Examples
        # Subtest: Demonstrates JSONB query patterns enabled by top-level entity IDs
        ok 1 - Demonstrates JSONB query patterns enabled by top-level entity IDs
          ---
          duration_ms: 0.611477
          ...
        1..1
    ok 2 - Query Pattern Examples
      ---
      duration_ms: 0.934926
      type: 'suite'
      ...
    1..2
ok 20 - Entity Context Integration Tests
  ---
  duration_ms: 15.292164
  type: 'suite'
  ...
# Subtest: Intent Classifier
    # Subtest: AI_SUGGEST_NEXT_ACTIONS intent
        # Subtest: matches direct "what should I do next" queries
        ok 1 - matches direct "what should I do next" queries
          ---
          duration_ms: 7.16796
          ...
        # Subtest: matches "what do you recommend/suggest" queries
        ok 2 - matches "what do you recommend/suggest" queries
          ---
          duration_ms: 1.516577
          ...
        # Subtest: matches "how should I/we proceed" queries
        ok 3 - matches "how should I/we proceed" queries
          ---
          duration_ms: 0.845855
          ...
        # Subtest: matches "next step" queries
        ok 4 - matches "next step" queries
          ---
          duration_ms: 1.183714
          ...
        # Subtest: matches "suggest/recommend action/step" queries
        ok 5 - matches "suggest/recommend action/step" queries
          ---
          duration_ms: 1.593912
          ...
        # Subtest: matches "what are my/our next steps" queries
        ok 6 - matches "what are my/our next steps" queries
          ---
          duration_ms: 1.110854
          ...
        # Subtest: matches specific "what do you think about" queries (with plan/strategy context)
        ok 7 - matches specific "what do you think about" queries (with plan/strategy context)
          ---
          duration_ms: 1.903744
          ...
        # Subtest: matches specific "what would you" queries (with entity/action context)
        ok 8 - matches specific "what would you" queries (with entity/action context)
          ---
          duration_ms: 1.389012
          ...
        # Subtest: matches "any suggestions/recommendations" queries
        ok 9 - matches "any suggestions/recommendations" queries
          ---
          duration_ms: 1.520357
          ...
        # Subtest: matches "how should/can/do I approach/handle" queries
        ok 10 - matches "how should/can/do I approach/handle" queries
          ---
          duration_ms: 3.067667
          ...
        # Subtest: matches "what is the/my best next move/action/step" queries
        ok 11 - matches "what is the/my best next move/action/step" queries
          ---
          duration_ms: 1.188985
          ...
        # Subtest: False positives prevention (negative test cases)
            # Subtest: does NOT match general "what do you think" without action context
            ok 1 - does NOT match general "what do you think" without action context
              ---
              duration_ms: 37.724528
              ...
            # Subtest: does NOT match general "what would you" without entity/action context
            ok 2 - does NOT match general "what would you" without entity/action context
              ---
              duration_ms: 0.851574
              ...
            # Subtest: does NOT match informational queries about entities
            ok 3 - does NOT match informational queries about entities
              ---
              duration_ms: 0.771364
              ...
            1..3
        ok 12 - False positives prevention (negative test cases)
          ---
          duration_ms: 40.15529
          type: 'suite'
          ...
        1..12
    ok 1 - AI_SUGGEST_NEXT_ACTIONS intent
      ---
      duration_ms: 71.942544
      type: 'suite'
      ...
    # Subtest: NOTE_LIST_FOR_RECORD intent
        # Subtest: matches "show/get/display/read notes" queries
        ok 1 - matches "show/get/display/read notes" queries
          ---
          duration_ms: 2.177901
          ...
        # Subtest: matches "show/get/display notes for/on/about" queries
        ok 2 - matches "show/get/display notes for/on/about" queries
          ---
          duration_ms: 0.762921
          ...
        # Subtest: matches "what are the notes" queries
        ok 3 - matches "what are the notes" queries
          ---
          duration_ms: 0.66702
          ...
        # Subtest: matches "last/latest/most recent note" queries
        ok 4 - matches "last/latest/most recent note" queries
          ---
          duration_ms: 0.942089
          ...
        # Subtest: matches "are there any notes" queries
        ok 5 - matches "are there any notes" queries
          ---
          duration_ms: 0.505842
          ...
        # Subtest: matches "check/see/view notes" queries
        ok 6 - matches "check/see/view notes" queries
          ---
          duration_ms: 0.596023
          ...
        # Subtest: Edge cases - pattern conflict prevention
            # Subtest: does NOT match NOTE_SEARCH patterns
            ok 1 - does NOT match NOTE_SEARCH patterns
              ---
              duration_ms: 0.468138
              ...
            # Subtest: does NOT match NOTE_CREATE patterns
            ok 2 - does NOT match NOTE_CREATE patterns
              ---
              duration_ms: 0.840411
              ...
            1..2
        ok 7 - Edge cases - pattern conflict prevention
          ---
          duration_ms: 1.600765
          type: 'suite'
          ...
        1..7
    ok 2 - NOTE_LIST_FOR_RECORD intent
      ---
      duration_ms: 9.116268
      type: 'suite'
      ...
    # Subtest: Edge cases and special scenarios
        # Subtest: handles null/undefined/empty input gracefully
        ok 1 - handles null/undefined/empty input gracefully
          ---
          duration_ms: 1.125663
          ...
        # Subtest: handles non-string input gracefully
        ok 2 - handles non-string input gracefully
          ---
          duration_ms: 0.488449
          ...
        # Subtest: returns null for unmatched patterns
        ok 3 - returns null for unmatched patterns
          ---
          duration_ms: 0.871632
          ...
        # Subtest: case insensitive matching
        ok 4 - case insensitive matching
          ---
          duration_ms: 2.383041
          ...
        # Subtest: handles messages with extra whitespace
        ok 5 - handles messages with extra whitespace
          ---
          duration_ms: 1.233585
          ...
        1..5
    ok 3 - Edge cases and special scenarios
      ---
      duration_ms: 6.756104
      type: 'suite'
      ...
    # Subtest: Priority ordering
        # Subtest: AI_SUGGEST_NEXT_ACTIONS has highest priority
        ok 1 - AI_SUGGEST_NEXT_ACTIONS has highest priority
          ---
          duration_ms: 3.58947
          ...
        1..1
    ok 4 - Priority ordering
      ---
      duration_ms: 4.269779
      type: 'suite'
      ...
    1..4
ok 21 - Intent Classifier
  ---
  duration_ms: 95.215651
  type: 'suite'
  ...
# Subtest: AI Memory System (RAG) - Phase 7
    # Subtest: Redaction Module
        # Subtest: should redact API keys and tokens
        ok 1 - should redact API keys and tokens
          ---
          duration_ms: 36.412389
          ...
        # Subtest: should preserve CRM data while redacting secrets
        ok 2 - should preserve CRM data while redacting secrets
          ---
          duration_ms: 1.687236
          ...
        1..2
    ok 1 - Redaction Module
      ---
      duration_ms: 41.731926
      type: 'suite'
      ...
    # Subtest: Chunker Module
        # Subtest: should split long text into chunks
        ok 1 - should split long text into chunks
          ---
          duration_ms: 9.716536
          ...
        # Subtest: should not chunk text shorter than maxChars
        ok 2 - should not chunk text shorter than maxChars
          ---
          duration_ms: 1.841072
          ...
        # Subtest: should create chunks with overlap
        ok 3 - should create chunks with overlap
          ---
          duration_ms: 0.676281
          ...
        1..3
    ok 2 - Chunker Module
      ---
      duration_ms: 13.737619
      type: 'suite'
      ...
    # Subtest: Memory Store - Tenant Isolation
        # Subtest: should prevent cross-tenant memory leakage
        ok 1 - should prevent cross-tenant memory leakage
          ---
          duration_ms: 0.714155
          ...
        # Subtest: should enforce RLS policies on ai_memory_chunks table
        ok 2 - should enforce RLS policies on ai_memory_chunks table
          ---
          duration_ms: 0.493238
          ...
        1..2
    ok 3 - Memory Store - Tenant Isolation
      ---
      duration_ms: 7.291796
      type: 'suite'
      ...
    # Subtest: Security - Prompt Injection Defense
        # Subtest: should inject memory with UNTRUSTED boundary marker
        ok 1 - should inject memory with UNTRUSTED boundary marker
          ---
          duration_ms: 2.046871
          ...
        # Subtest: should not execute malicious commands from stored memory
        ok 2 - should not execute malicious commands from stored memory
          ---
          duration_ms: 9.921227
          ...
        1..2
    ok 4 - Security - Prompt Injection Defense
      ---
      duration_ms: 12.413109
      type: 'suite'
      ...
    # Subtest: Retrieval Quality
        # Subtest: should return top-K most relevant memories
        ok 1 - should return top-K most relevant memories
          ---
          duration_ms: 1.577362
          ...
        # Subtest: should filter memories below similarity threshold
        ok 2 - should filter memories below similarity threshold
          ---
          duration_ms: 10.581289
          ...
        1..2
    ok 5 - Retrieval Quality
      ---
      duration_ms: 12.589179
      type: 'suite'
      ...
    # Subtest: Conversation Summaries
        # Subtest: should generate summaries for conversations
        ok 1 - should generate summaries for conversations
          ---
          duration_ms: 339.768488
          ...
        # Subtest: should extract key information in summaries
        ok 2 - should extract key information in summaries
          ---
          duration_ms: 0.368307
          ...
        # Subtest: should update summaries incrementally
        ok 3 - should update summaries incrementally
          ---
          duration_ms: 0.285029
          ...
        1..3
    ok 6 - Conversation Summaries
      ---
      duration_ms: 340.946721
      type: 'suite'
      ...
    # Subtest: Performance
        # Subtest: should retrieve memory in < 100ms for topK=8
        ok 1 - should retrieve memory in < 100ms for topK=8
          ---
          duration_ms: 0.317662
          ...
        # Subtest: should not block note/activity creation
        ok 2 - should not block note/activity creation
          ---
          duration_ms: 0.280405
          ...
        1..2
    ok 7 - Performance
      ---
      duration_ms: 0.813241
      type: 'suite'
      ...
# ✓ Supabase DB client initialized with performance tracking
    # Subtest: Environment Configuration
        # Subtest: should disable memory when MEMORY_ENABLED=false
        ok 1 - should disable memory when MEMORY_ENABLED=false
          ---
          duration_ms: 25.416703
          ...
        # Subtest: should use default config values when env vars missing
        not ok 2 - should use default config values when env vars missing
          ---
          duration_ms: 2.928684
          location: '/app/__tests__/ai/memory.test.js:212:5'
          failureType: 'testCodeFailure'
          error: |-
            Default maxChunkChars should be 2000
            
            3500 !== 2000
            
          code: 'ERR_ASSERTION'
          name: 'AssertionError'
          expected: 2000
          actual: 3500
          operator: 'strictEqual'
          stack: |-
            TestContext.<anonymous> (file:///app/__tests__/ai/memory.test.js:225:14)
            async Test.run (node:internal/test_runner/test:797:9)
            async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
          ...
        # Subtest: should override config values from environment
        ok 3 - should override config values from environment
          ---
          duration_ms: 0.387
          ...
        1..3
    not ok 8 - Environment Configuration
      ---
      duration_ms: 29.419133
      type: 'suite'
      location: '/app/__tests__/ai/memory.test.js:195:3'
      failureType: 'subtestsFailed'
      error: '1 subtest failed'
      code: 'ERR_TEST_FAILURE'
      ...
    # Subtest: Integration Tests - Cross-Tenant Isolation
        # Subtest: should not leak memory between tenants (mock test)
        ok 1 - should not leak memory between tenants (mock test)
          ---
          duration_ms: 0.363967
          ...
        # Subtest: should enforce tenant_id filter in all queries
        ok 2 - should enforce tenant_id filter in all queries
          ---
          duration_ms: 3.206709
          ...
        1..2
    ok 9 - Integration Tests - Cross-Tenant Isolation
      ---
      duration_ms: 3.76325
      type: 'suite'
      ...
    # Subtest: Integration Tests - Prompt Injection Mitigation
        # Subtest: should wrap memory content with UNTRUSTED boundary
        ok 1 - should wrap memory content with UNTRUSTED boundary
          ---
          duration_ms: 0.669993
          ...
        # Subtest: should redact sensitive content before storage
        ok 2 - should redact sensitive content before storage
          ---
          duration_ms: 1.271957
          ...
        1..2
    ok 10 - Integration Tests - Prompt Injection Mitigation
      ---
      duration_ms: 2.478551
      type: 'suite'
      ...
    # Subtest: Integration Tests - Performance Requirements
        # Subtest: should complete memory config retrieval in < 1ms
        ok 1 - should complete memory config retrieval in < 1ms
          ---
          duration_ms: 4.587405
          ...
        # Subtest: should chunk text efficiently
        ok 2 - should chunk text efficiently
          ---
          duration_ms: 2.42428
          ...
        1..2
    ok 11 - Integration Tests - Performance Requirements
      ---
      duration_ms: 7.262562
      type: 'suite'
      ...
    # Subtest: Integration Tests - Conversation Summaries
        # Subtest: should export summary functions
        ok 1 - should export summary functions
          ---
          duration_ms: 0.934014
          ...
        # Subtest: should return null for non-existent conversation
        ok 2 - should return null for non-existent conversation
          ---
          duration_ms: 462.202502
          ...
        # Subtest: should require conversationId and tenantId
        ok 3 - should require conversationId and tenantId
          ---
          duration_ms: 8.76202
          ...
        1..3
    ok 12 - Integration Tests - Conversation Summaries
      ---
      duration_ms: 472.391521
      type: 'suite'
      ...
    1..12
not ok 22 - AI Memory System (RAG) - Phase 7
  ---
  duration_ms: 952.269913
  type: 'suite'
  location: '/app/__tests__/ai/memory.test.js:19:1'
  failureType: 'subtestsFailed'
  error: '1 subtest failed'
  code: 'ERR_TEST_FAILURE'
  ...
# Subtest: Memory Gating
    # Subtest: shouldUseMemory
        # Subtest: default behavior (OFF unless triggered)
            # Subtest: should return false for generic questions
            ok 1 - should return false for generic questions
              ---
              duration_ms: 8.780633
              ...
            # Subtest: should return true for "last time" patterns
            ok 2 - should return true for "last time" patterns
              ---
              duration_ms: 1.098791
              ...
            # Subtest: should return true for "previous" patterns
            ok 3 - should return true for "previous" patterns
              ---
              duration_ms: 1.001774
              ...
            # Subtest: should return true for "remind me" patterns
            ok 4 - should return true for "remind me" patterns
              ---
              duration_ms: 1.212751
              ...
            # Subtest: should return true for "what did we" patterns
            ok 5 - should return true for "what did we" patterns
              ---
              duration_ms: 1.382441
              ...
            # Subtest: should return true for "recap" patterns
            ok 6 - should return true for "recap" patterns
              ---
              duration_ms: 1.087327
              ...
            # Subtest: should return true for "history" patterns
            ok 7 - should return true for "history" patterns
              ---
              duration_ms: 1.198816
              ...
            # Subtest: should return true for "follow up" patterns
            ok 8 - should return true for "follow up" patterns
              ---
              duration_ms: 1.80387
              ...
            # Subtest: should return true for "mentioned" patterns
            ok 9 - should return true for "mentioned" patterns
              ---
              duration_ms: 0.937911
              ...
            # Subtest: should return true for "earlier" patterns
            ok 10 - should return true for "earlier" patterns
              ---
              duration_ms: 1.348105
              ...
            # Subtest: should return true for "before" patterns
            ok 11 - should return true for "before" patterns
              ---
              duration_ms: 1.119201
              ...
            1..11
        ok 1 - default behavior (OFF unless triggered)
          ---
          duration_ms: 23.888952
          type: 'suite'
          ...
        # Subtest: environment overrides
            # Subtest: should return true when AI_MEMORY_ALWAYS_ON=true (with MEMORY_ENABLED)
            ok 1 - should return true when AI_MEMORY_ALWAYS_ON=true (with MEMORY_ENABLED)
              ---
              duration_ms: 1.245202
              ...
            # Subtest: should return false when AI_MEMORY_ALWAYS_ON=true but MEMORY_ENABLED=false
            ok 2 - should return false when AI_MEMORY_ALWAYS_ON=true but MEMORY_ENABLED=false
              ---
              duration_ms: 5.709313
              ...
            # Subtest: should return false when AI_MEMORY_ALWAYS_OFF=true
            ok 3 - should return false when AI_MEMORY_ALWAYS_OFF=true
              ---
              duration_ms: 1.175895
              ...
            # Subtest: should prioritize ALWAYS_OFF over everything
            ok 4 - should prioritize ALWAYS_OFF over everything
              ---
              duration_ms: 1.028147
              ...
            1..4
        ok 2 - environment overrides
          ---
          duration_ms: 14.088185
          type: 'suite'
          ...
        # Subtest: edge cases
            # Subtest: should handle empty string
            ok 1 - should handle empty string
              ---
              duration_ms: 0.637855
              ...
            # Subtest: should handle null/undefined
            ok 2 - should handle null/undefined
              ---
              duration_ms: 0.867645
              ...
            # Subtest: should be case-insensitive
            ok 3 - should be case-insensitive
              ---
              duration_ms: 8.147346
              ...
            1..3
        ok 3 - edge cases
          ---
          duration_ms: 10.437016
          type: 'suite'
          ...
        1..3
    ok 1 - shouldUseMemory
      ---
      duration_ms: 49.98481
      type: 'suite'
      ...
    # Subtest: shouldInjectConversationSummary
        # Subtest: should return false for short conversations
        ok 1 - should return false for short conversations
          ---
          duration_ms: 1.767865
          ...
        # Subtest: should return true for long conversations with trigger
        ok 2 - should return true for long conversations with trigger
          ---
          duration_ms: 1.286712
          ...
        # Subtest: should respect custom minMessages threshold
        ok 3 - should respect custom minMessages threshold
          ---
          duration_ms: 1.081626
          ...
        # Subtest: should return false without trigger even for long conversations
        ok 4 - should return false without trigger even for long conversations
          ---
          duration_ms: 8.547335
          ...
        1..4
    ok 2 - shouldInjectConversationSummary
      ---
      duration_ms: 17.396646
      type: 'suite'
      ...
    # Subtest: getMemoryConfig
        # Subtest: should return reduced defaults
        not ok 1 - should return reduced defaults
          ---
          duration_ms: 15.682811
          location: '/app/__tests__/ai/memoryGating.test.js:198:5'
          failureType: 'testCodeFailure'
          error: |-
            Expected values to be strictly equal:
            
            3500 !== 2000
            
          code: 'ERR_ASSERTION'
          name: 'AssertionError'
          expected: 2000
          actual: 3500
          operator: 'strictEqual'
          stack: |-
            TestContext.<anonymous> (file:///app/__tests__/ai/memoryGating.test.js:205:14)
            Test.runInAsyncScope (node:async_hooks:206:9)
            Test.run (node:internal/test_runner/test:796:25)
            async Promise.all (index 0)
            async Suite.run (node:internal/test_runner/test:1135:7)
            async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
          ...
        # Subtest: should respect environment overrides
        ok 2 - should respect environment overrides
          ---
          duration_ms: 5.752125
          ...
        1..2
    not ok 3 - getMemoryConfig
      ---
      duration_ms: 24.388177
      type: 'suite'
      location: '/app/__tests__/ai/memoryGating.test.js:197:3'
      failureType: 'subtestsFailed'
      error: '1 subtest failed'
      code: 'ERR_TEST_FAILURE'
      ...
    1..3
not ok 23 - Memory Gating
  ---
  duration_ms: 94.108153
  type: 'suite'
  location: '/app/__tests__/ai/memoryGating.test.js:19:1'
  failureType: 'subtestsFailed'
  error: '1 subtest failed'
  code: 'ERR_TEST_FAILURE'
  ...
# ✓ Supabase DB client initialized with performance tracking
# ✓ Supabase DB client initialized (using centralized factory)
# [R2 Artifact] Supabase client initialized
# [R2 Artifact] R2 module imported, configured: false
# [R2 Artifact] Could not create test conversation: Could not find the 'user_id' column of 'conversations' in the schema cache
# [Skip] R2 not configured or module unavailable
# [Skip] R2 not configured or module unavailable
# [Skip] R2 not configured, Supabase unavailable, or R2 module missing
# Subtest: R2 Artifact Offload Tests
    # Subtest: R2 Module Functions
        # Subtest: buildTenantKey generates valid tenant-scoped key
        ok 1 - buildTenantKey generates valid tenant-scoped key
          ---
          duration_ms: 6.983965
          ...
        # Subtest: putObject uploads to R2 (skips if not configured)
        ok 2 - putObject uploads to R2 (skips if not configured)
          ---
          duration_ms: 0.707248
          ...
        # Subtest: getObject retrieves from R2 (skips if not configured)
        ok 3 - getObject retrieves from R2 (skips if not configured)
          ---
          duration_ms: 7.081044
          ...
        1..3
    ok 1 - R2 Module Functions
      ---
      duration_ms: 18.923237
      type: 'suite'
      ...
    # Subtest: artifact_refs Database Operations
        # Subtest: writeArtifactRef stores pointer and uploads to R2 (skips if not configured)
        ok 1 - writeArtifactRef stores pointer and uploads to R2 (skips if not configured)
          ---
          duration_ms: 4.181547
          ...
# [Skip] R2 not configured, Supabase unavailable, or no test conversation
# [Skip] R2 not configured, Supabase unavailable, or no test conversation
# [Expected] R2 not configured - offloading would be skipped
        # Subtest: artifact_refs enforces tenant isolation via RLS
        ok 2 - artifact_refs enforces tenant isolation via RLS
          ---
          duration_ms: 122.047257
          ...
        1..2
    ok 2 - artifact_refs Database Operations
      ---
      duration_ms: 126.930829
      type: 'suite'
      ...
    # Subtest: Metadata Offload Logic
        # Subtest: maybeOffloadMetadata offloads tool_interactions array (mock)
        ok 1 - maybeOffloadMetadata offloads tool_interactions array (mock)
          ---
          duration_ms: 0.537233
          ...
        # Subtest: maybeOffloadMetadata offloads oversized metadata (mock)
        ok 2 - maybeOffloadMetadata offloads oversized metadata (mock)
          ---
          duration_ms: 0.459542
          ...
        1..2
    ok 3 - Metadata Offload Logic
      ---
      duration_ms: 7.332602
      type: 'suite'
      ...
    # Subtest: insertAssistantMessage Integration
        # Subtest: insertAssistantMessage with tool_interactions stores ref (requires R2)
        ok 1 - insertAssistantMessage with tool_interactions stores ref (requires R2)
          ---
          duration_ms: 0.74227
          ...
        # Subtest: Tool context message stores tool_results_ref (requires R2)
        ok 2 - Tool context message stores tool_results_ref (requires R2)
          ---
          duration_ms: 0.607907
          ...
        1..2
    ok 4 - insertAssistantMessage Integration
      ---
      duration_ms: 1.673125
      type: 'suite'
      ...
    # Subtest: Error Handling & Graceful Degradation
        # Subtest: Offload failures should not break chat flow
        ok 1 - Offload failures should not break chat flow
          ---
          duration_ms: 0.405978
          ...
        # Subtest: Missing tenant_id should skip offload gracefully
        ok 2 - Missing tenant_id should skip offload gracefully
          ---
          duration_ms: 0.896171
          ...
        # Subtest: R2 not configured should log warning but not fail
        ok 3 - R2 not configured should log warning but not fail
          ---
          duration_ms: 0.491079
          ...
        1..3
    ok 5 - Error Handling & Graceful Degradation
      ---
      duration_ms: 2.168214
      type: 'suite'
      ...
    1..5
ok 24 - R2 Artifact Offload Tests
  ---
  duration_ms: 1189.897194
  type: 'suite'
  ...
# ✓ Supabase DB client initialized with performance tracking
# ✓ Supabase DB client initialized (using centralized factory)
# Subtest: Suggestions Routes
    # Subtest: GET /api/ai/suggestions returns 200
    ok 1 - GET /api/ai/suggestions returns 200
      ---
      duration_ms: 486.258443
      ...
    # Subtest: GET /api/ai/suggestions requires tenant_id
    ok 2 - GET /api/ai/suggestions requires tenant_id
      ---
      duration_ms: 67.461638
      ...
    # Subtest: GET /api/ai/suggestions/:id returns single suggestion
    ok 3 - GET /api/ai/suggestions/:id returns single suggestion
      ---
      duration_ms: 340.81081
      ...
    # Subtest: GET /api/ai/suggestions/stats returns statistics
    ok 4 - GET /api/ai/suggestions/stats returns statistics
      ---
      duration_ms: 152.279154
      ...
    # Subtest: POST /api/ai/suggestions/trigger triggers detection
    ok 5 - POST /api/ai/suggestions/trigger triggers detection
      ---
      duration_ms: 3672.817272
      ...
    # Subtest: GET /api/ai/suggestions supports status filter
    ok 6 - GET /api/ai/suggestions supports status filter
      ---
      duration_ms: 170.383624
      ...
    # Subtest: GET /api/ai/suggestions supports trigger_id filter
    ok 7 - GET /api/ai/suggestions supports trigger_id filter
      ---
      duration_ms: 183.28306
      ...
    # Subtest: GET /api/ai/suggestions supports priority filter
    ok 8 - GET /api/ai/suggestions supports priority filter
      ---
      duration_ms: 355.38082
      ...
    # Subtest: GET /api/ai/suggestions supports record_type filter
    ok 9 - GET /api/ai/suggestions supports record_type filter
      ---
      duration_ms: 154.633764
      ...
    # Subtest: GET /api/ai/suggestions supports pagination with limit and offset
    ok 10 - GET /api/ai/suggestions supports pagination with limit and offset
      ---
      duration_ms: 251.968707
      ...
    1..10
ok 25 - Suggestions Routes
  ---
  duration_ms: 6045.827851
  type: 'suite'
  ...
# Subtest: Suggestion Actions
    # Subtest: POST /api/ai/suggestions/:id/approve returns appropriate response
    ok 1 - POST /api/ai/suggestions/:id/approve returns appropriate response
      ---
      duration_ms: 165.434131
      ...
    # Subtest: POST /api/ai/suggestions/:id/reject returns appropriate response
    ok 2 - POST /api/ai/suggestions/:id/reject returns appropriate response
      ---
      duration_ms: 250.912703
      ...
    # Subtest: POST /api/ai/suggestions/:id/apply returns appropriate response
    ok 3 - POST /api/ai/suggestions/:id/apply returns appropriate response
      ---
      duration_ms: 437.893004
      ...
    # Subtest: POST /api/ai/suggestions/:id/approve returns 404 for invalid ID
    ok 4 - POST /api/ai/suggestions/:id/approve returns 404 for invalid ID
      ---
      duration_ms: 104.297299
      ...
    1..4
ok 26 - Suggestion Actions
  ---
  duration_ms: 959.588639
  type: 'suite'
  ...
# Subtest: Metrics Endpoints
    # Subtest: GET /api/ai/suggestions/metrics returns metrics data
    ok 1 - GET /api/ai/suggestions/metrics returns metrics data
      ---
      duration_ms: 266.425325
      ...
    # Subtest: GET /api/ai/suggestions/metrics supports date range
    ok 2 - GET /api/ai/suggestions/metrics supports date range
      ---
      duration_ms: 230.968827
      ...
    1..2
ok 27 - Metrics Endpoints
  ---
  duration_ms: 498.023473
  type: 'suite'
  ...
# [TenantContextDictionary] Error resolving tenant: Cannot read properties of null (reading 'query')
# Subtest: Tenant Context Dictionary
    # Subtest: V3_WORKFLOW_DEFINITIONS
        # Subtest: should have three main workflows
        ok 1 - should have three main workflows
          ---
          duration_ms: 10.715863
          ...
        # Subtest: bizdev_to_lead workflow should have correct stages
        ok 2 - bizdev_to_lead workflow should have correct stages
          ---
          duration_ms: 5.045401
          ...
        # Subtest: lead_to_conversion workflow should have correct stages
        ok 3 - lead_to_conversion workflow should have correct stages
          ---
          duration_ms: 1.106799
          ...
        # Subtest: opportunity_pipeline workflow should have standard sales stages
        ok 4 - opportunity_pipeline workflow should have standard sales stages
          ---
          duration_ms: 0.654411
          ...
        1..4
    ok 1 - V3_WORKFLOW_DEFINITIONS
      ---
      duration_ms: 25.007912
      type: 'suite'
      ...
    # Subtest: DEFAULT_STATUS_CARDS
        # Subtest: should have status cards for all main entities
        ok 1 - should have status cards for all main entities
          ---
          duration_ms: 0.764826
          ...
        # Subtest: leads should have standard v3.0.0 statuses
        ok 2 - leads should have standard v3.0.0 statuses
          ---
          duration_ms: 0.584108
          ...
        # Subtest: activities should have status-based cards
        ok 3 - activities should have status-based cards
          ---
          duration_ms: 0.358349
          ...
        1..3
    ok 2 - DEFAULT_STATUS_CARDS
      ---
      duration_ms: 4.208266
      type: 'suite'
      ...
    # Subtest: generateContextDictionaryPrompt()
        # Subtest: should handle error dictionary gracefully
        ok 1 - should handle error dictionary gracefully
          ---
          duration_ms: 1.08515
          ...
        # Subtest: should generate prompt with tenant information
        ok 2 - should generate prompt with tenant information
          ---
          duration_ms: 2.809806
          ...
        # Subtest: should not include custom terminology section if no customizations
        ok 3 - should not include custom terminology section if no customizations
          ---
          duration_ms: 0.987224
          ...
        1..3
    ok 3 - generateContextDictionaryPrompt()
      ---
      duration_ms: 5.422069
      type: 'suite'
      ...
    # Subtest: buildTenantContextDictionary()
        # Subtest: should require a database pool
        ok 1 - should require a database pool
          ---
          duration_ms: 2.88834
          ...
        # Subtest: should return error for non-existent tenant
        ok 2 - should return error for non-existent tenant
          ---
          duration_ms: 0.796975
          ...
        1..2
    ok 4 - buildTenantContextDictionary()
      ---
      duration_ms: 4.008648
      type: 'suite'
      ...
    1..4
ok 28 - Tenant Context Dictionary
  ---
  duration_ms: 806.147053
  type: 'suite'
  ...
# [TokenBudget] Enforced tool schema cap: { original: 20, capped: 6, tokensEstimate: 468, cap: 500 }
# [TokenBudget] Enforced tool schema cap: { original: 20, capped: 5, tokensEstimate: 256, cap: 300 }
# [Budget] total=750, system=100, tools=300, memory=50, history=200
# [Budget] total=700, system=100, tools=300, memory=0, history=200, actions=cleared_memory,dropped_5_tools
# Subtest: TokenBudgetManager
    # Subtest: estimateTokens
        # Subtest: should estimate tokens at ~4 chars per token
        ok 1 - should estimate tokens at ~4 chars per token
          ---
          duration_ms: 4.102964
          ...
        # Subtest: should handle empty string
        ok 2 - should handle empty string
          ---
          duration_ms: 0.807238
          ...
        # Subtest: should handle null/undefined
        ok 3 - should handle null/undefined
          ---
          duration_ms: 0.746908
          ...
        # Subtest: should handle long strings
        ok 4 - should handle long strings
          ---
          duration_ms: 0.469808
          ...
        1..4
    ok 1 - estimateTokens
      ---
      duration_ms: 9.957701
      type: 'suite'
      ...
    # Subtest: estimateMessagesTokens
        # Subtest: should estimate tokens for simple messages
        ok 1 - should estimate tokens for simple messages
          ---
          duration_ms: 1.134216
          ...
        # Subtest: should handle empty messages array
        ok 2 - should handle empty messages array
          ---
          duration_ms: 0.418605
          ...
        # Subtest: should account for tool_calls
        ok 3 - should account for tool_calls
          ---
          duration_ms: 0.891482
          ...
        1..3
    ok 2 - estimateMessagesTokens
      ---
      duration_ms: 3.314246
      type: 'suite'
      ...
    # Subtest: estimateToolsTokens
        # Subtest: should estimate tokens for tool schemas
        ok 1 - should estimate tokens for tool schemas
          ---
          duration_ms: 5.378978
          ...
        # Subtest: should handle empty tools array
        ok 2 - should handle empty tools array
          ---
          duration_ms: 0.446944
          ...
        1..2
    ok 3 - estimateToolsTokens
      ---
      duration_ms: 6.497622
      type: 'suite'
      ...
    # Subtest: buildBudgetReport
        # Subtest: should build a complete budget report
        ok 1 - should build a complete budget report
          ---
          duration_ms: 1.091825
          ...
        # Subtest: should correctly identify when over budget
        ok 2 - should correctly identify when over budget
          ---
          duration_ms: 0.455299
          ...
        1..2
    ok 4 - buildBudgetReport
      ---
      duration_ms: 1.929673
      type: 'suite'
      ...
    # Subtest: applyBudgetCaps
        # Subtest: should return unchanged data when within budget
        ok 1 - should return unchanged data when within budget
          ---
          duration_ms: 1.010087
          ...
        # Subtest: should drop memory first when over budget
        ok 2 - should drop memory first when over budget
          ---
          duration_ms: 0.414798
          ...
        # Subtest: should preserve forced tool when dropping tools
        ok 3 - should preserve forced tool when dropping tools
          ---
          duration_ms: 1.367448
          ...
        1..3
    ok 5 - applyBudgetCaps
      ---
      duration_ms: 3.199431
      type: 'suite'
      ...
    # Subtest: enforceToolSchemaCap
        # Subtest: should limit tools by token count
        ok 1 - should limit tools by token count
          ---
          duration_ms: 8.243494
          ...
        # Subtest: should preserve forced tool
        ok 2 - should preserve forced tool
          ---
          duration_ms: 1.351065
          ...
        # Subtest: should handle empty tools array
        ok 3 - should handle empty tools array
          ---
          duration_ms: 3.177248
          ...
        1..3
    ok 6 - enforceToolSchemaCap
      ---
      duration_ms: 13.162967
      type: 'suite'
      ...
    # Subtest: logBudgetSummary
        # Subtest: should log budget summary without throwing
        ok 1 - should log budget summary without throwing
          ---
          duration_ms: 1.659862
          ...
        # Subtest: should log actions taken
        ok 2 - should log actions taken
          ---
          duration_ms: 1.068639
          ...
        1..2
    ok 7 - logBudgetSummary
      ---
      duration_ms: 2.993248
      type: 'suite'
      ...
    # Subtest: TOKEN_CAPS constants
        # Subtest: should have expected caps defined
        ok 1 - should have expected caps defined
          ---
          duration_ms: 1.600396
          ...
        # Subtest: should have reasonable default values
        ok 2 - should have reasonable default values
          ---
          duration_ms: 0.634305
          ...
        1..2
    ok 8 - TOKEN_CAPS constants
      ---
      duration_ms: 2.637314
      type: 'suite'
      ...
    # Subtest: Integration: Full budget enforcement pipeline
        # Subtest: should produce a valid request payload under budget from oversized inputs
        ok 1 - should produce a valid request payload under budget from oversized inputs
          ---
          duration_ms: 6.270839
          ...
        # Subtest: should not modify inputs that are already within budget
        ok 2 - should not modify inputs that are already within budget
          ---
          duration_ms: 1.404857
          ...
        1..2
    ok 9 - Integration: Full budget enforcement pipeline
      ---
      duration_ms: 8.183396
      type: 'suite'
      ...
    1..9
ok 29 - TokenBudgetManager
  ---
  duration_ms: 56.351418
  type: 'suite'
  ...
# Subtest: BUG-AUTH-002: Login Authentication
    # Subtest: POST /api/auth/login
        # Subtest: should reject login with missing email
        ok 1 - should reject login with missing email
          ---
          duration_ms: 315.956813
          ...
        # Subtest: should reject login with missing password
        ok 2 - should reject login with missing password
          ---
          duration_ms: 138.509813
          ...
        # Subtest: should reject login with invalid credentials
        ok 3 - should reject login with invalid credentials
          ---
          duration_ms: 384.968768
          ...
        # Subtest: should reject login for disabled account
        ok 4 - should reject login for disabled account
          ---
          duration_ms: 463.891993
          ...
        # Subtest: should normalize email to lowercase
        ok 5 - should normalize email to lowercase
          ---
          duration_ms: 268.408865
          ...
        # Subtest: should handle whitespace in email
        ok 6 - should handle whitespace in email
          ---
          duration_ms: 288.268895
          ...
        1..6
    ok 1 - POST /api/auth/login
      ---
      duration_ms: 1862.96855
      type: 'suite'
      ...
    # Subtest: POST /api/auth/verify-token
        # Subtest: should reject request with missing token
        ok 1 - should reject request with missing token
          ---
          duration_ms: 118.514334
          ...
        # Subtest: should reject invalid token
        ok 2 - should reject invalid token
          ---
          duration_ms: 112.386091
          ...
        1..2
    ok 2 - POST /api/auth/verify-token
      ---
      duration_ms: 232.664094
      type: 'suite'
      ...
    # Subtest: GET /api/auth/me
        # Subtest: should return 401 without auth cookie
        ok 1 - should return 401 without auth cookie
          ---
          duration_ms: 120.434035
          ...
        1..1
    ok 3 - GET /api/auth/me
      ---
      duration_ms: 121.170275
      type: 'suite'
      ...
    # Subtest: POST /api/auth/logout
        # Subtest: should successfully logout even without session
        ok 1 - should successfully logout even without session
          ---
          duration_ms: 113.157464
          ...
        1..1
    ok 4 - POST /api/auth/logout
      ---
      duration_ms: 113.999615
      type: 'suite'
      ...
    1..4
ok 30 - BUG-AUTH-002: Login Authentication
  ---
  duration_ms: 2858.945583
  type: 'suite'
  ...
# Subtest: BUG-AUTH-002: Complete Login Flow
    # Subtest: should successfully login with valid credentials
    ok 1 - should successfully login with valid credentials # SKIP
      ---
      duration_ms: 0.689884
      ...
    # Subtest: should be able to access /me after login
    ok 2 - should be able to access /me after login # SKIP
      ---
      duration_ms: 0.729574
      ...
    1..2
ok 31 - BUG-AUTH-002: Complete Login Flow
  ---
  duration_ms: 2.141931
  type: 'suite'
  ...
# Subtest: Superadmin Cross-Tenant Access
    # Subtest: GET /api/v2/opportunities with tenant_id returns data
    not ok 1 - GET /api/v2/opportunities with tenant_id returns data
      ---
      duration_ms: 209.872444
      location: '/app/__tests__/auth/superadminCrossTenantAccess.test.js:27:3'
      failureType: 'testCodeFailure'
      error: |-
        Expected 200, got 401
        
        401 !== 200
        
      code: 'ERR_ASSERTION'
      name: 'AssertionError'
      expected: 200
      actual: 401
      operator: 'strictEqual'
      stack: |-
        TestContext.<anonymous> (file:///app/__tests__/auth/superadminCrossTenantAccess.test.js:30:12)
        process.processTicksAndRejections (node:internal/process/task_queues:95:5)
        async Test.run (node:internal/test_runner/test:797:9)
        async Promise.all (index 0)
        async Suite.run (node:internal/test_runner/test:1135:7)
        async Test.processPendingSubtests (node:internal/test_runner/test:526:7)
      ...
    # Subtest: GET /api/v2/leads with tenant_id returns data
    ok 2 - GET /api/v2/leads with tenant_id returns data
      ---
      duration_ms: 136.47822
      ...
    # Subtest: GET /api/v2/accounts with tenant_id returns data
    not ok 3 - GET /api/v2/accounts with tenant_id returns data
      ---
      duration_ms: 26.697219
      location: '/app/__tests__/auth/superadminCrossTenantAccess.test.js:45:3'
      failureType: 'testCodeFailure'
      error: |-
        Expected 200, got 401
        
        401 !== 200
        
      code: 'ERR_ASSERTION'
      name: 'AssertionError'
      expected: 200
      actual: 401
      operator: 'strictEqual'
      stack: |-
        TestContext.<anonymous> (file:///app/__tests__/auth/superadminCrossTenantAccess.test.js:48:12)
        process.processTicksAndRejections (node:internal/process/task_queues:95:5)
        async Test.run (node:internal/test_runner/test:797:9)
        async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
      ...
    # Subtest: POST /api/v2/opportunities without tenant_id is rejected
    ok 4 - POST /api/v2/opportunities without tenant_id is rejected
      ---
      duration_ms: 28.210056
      ...
    # Subtest: Tenant-scoped routes require tenant_id
    ok 5 - Tenant-scoped routes require tenant_id
      ---
      duration_ms: 25.406253
      ...
    1..5
not ok 32 - Superadmin Cross-Tenant Access
  ---
  duration_ms: 434.913283
  type: 'suite'
  location: '/app/__tests__/auth/superadminCrossTenantAccess.test.js:25:1'
  failureType: 'subtestsFailed'
  error: '2 subtests failed'
  code: 'ERR_TEST_FAILURE'
  ...
# node:internal/modules/cjs/loader:1210
#   throw err;
#   ^
# Error: Cannot find module '/app/scripts/maintenance/emit_viz_test_events.js'
#     at Module._resolveFilename (node:internal/modules/cjs/loader:1207:15)
#     at Module._load (node:internal/modules/cjs/loader:1038:27)
#     at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:164:12)
#     at node:internal/main/run_main_module:28:49 {
#   code: 'MODULE_NOT_FOUND',
#   requireStack: []
# }
# Node.js v20.20.0
# Subtest: office-viz ingests backoffice agent telemetry (timeout-protected)
not ok 33 - office-viz ingests backoffice agent telemetry (timeout-protected) # SKIP office-viz not reachable on /health
  ---
  duration_ms: 286.383078
  location: '/app/__tests__/integration/agentOffice.viz.test.js:59:1'
  failureType: 'testCodeFailure'
  error: |-
    Command failed: node scripts/maintenance/emit_viz_test_events.js --count 1 --complete 1 --assignee ops_manager:dev --tenant dev --interval-ms 10
    node:internal/modules/cjs/loader:1210
      throw err;
      ^
    
    Error: Cannot find module '/app/scripts/maintenance/emit_viz_test_events.js'
        at Module._resolveFilename (node:internal/modules/cjs/loader:1207:15)
        at Module._load (node:internal/modules/cjs/loader:1038:27)
        at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:164:12)
        at node:internal/main/run_main_module:28:49 {
      code: 'MODULE_NOT_FOUND',
      requireStack: []
    }
    
    Node.js v20.20.0
    
  code: 'ERR_TEST_FAILURE'
  stack: |-
    Module._resolveFilename (node:internal/modules/cjs/loader:1207:15)
    Module._load (node:internal/modules/cjs/loader:1038:27)
    Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:164:12)
    node:internal/main/run_main_module:28:49 {
    genericNodeError (node:internal/errors:984:15)
    wrappedFn (node:internal/errors:538:14)
    checkExecSyncError (node:child_process:891:11)
    execSync (node:child_process:963:15)
    injectTestEvents (file:///app/__tests__/integration/agentOffice.viz.test.js:31:18)
    TestContext.<anonymous> (file:///app/__tests__/integration/agentOffice.viz.test.js:65:3)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async Test.run (node:internal/test_runner/test:797:9)
    async Test.processPendingSubtests (node:internal/test_runner/test:526:7)
  ...
# Subtest: AI Token Optimization
    # Subtest: should limit incoming messages to MAX_INCOMING (8)
    ok 1 - should limit incoming messages to MAX_INCOMING (8)
      ---
      duration_ms: 2.004734
      ...
    # Subtest: should truncate message content to MAX_CHARS (1500)
    ok 2 - should truncate message content to MAX_CHARS (1500)
      ---
      duration_ms: 0.663003
      ...
    # Subtest: should truncate tool summary to 1200 chars
    ok 3 - should truncate tool summary to 1200 chars
      ---
      duration_ms: 0.874746
      ...
    # Subtest: should handle empty or null summaries gracefully
    ok 4 - should handle empty or null summaries gracefully
      ---
      duration_ms: 0.5237
      ...
    # Subtest: should preserve message structure after optimization
    ok 5 - should preserve message structure after optimization
      ---
      duration_ms: 0.562687
      ...
    # Subtest: should only send last user and last assistant in frontend optimization
    ok 6 - should only send last user and last assistant in frontend optimization
      ---
      duration_ms: 0.635597
      ...
    # Subtest: should handle conversation with only user messages
    ok 7 - should handle conversation with only user messages
      ---
      duration_ms: 1.052855
      ...
    1..7
ok 34 - AI Token Optimization
  ---
  duration_ms: 12.003534
  type: 'suite'
  ...
# ✅ Health Monitoring System tests completed
# ✓ Supabase DB client initialized with performance tracking
# Subtest: Health Monitoring System
    # Subtest: should create health alerts table and views
    ok 1 - should create health alerts table and views
      ---
      duration_ms: 482.278361
      ...
    # Subtest: should create deduplication function
    ok 2 - should create deduplication function
      ---
      duration_ms: 269.797232
      ...
    # Subtest: should create a health alert
    ok 3 - should create a health alert
      ---
      duration_ms: 108.380711
      ...
    # Subtest: should prevent duplicate alerts
    ok 4 - should prevent duplicate alerts
      ---
      duration_ms: 241.835529
      ...
    # Subtest: should get active alerts
    ok 5 - should get active alerts
      ---
      duration_ms: 87.640823
      ...
    # Subtest: should get health stats
    not ok 6 - should get health stats
      ---
      duration_ms: 73.962851
      location: '/app/__tests__/integration/healthMonitoring.test.js:116:3'
      failureType: 'testCodeFailure'
      error: 'Should include critical_alerts'
      code: 'ERR_ASSERTION'
      name: 'AssertionError'
      expected: true
      actual: false
      operator: '=='
      stack: |-
        TestContext.<anonymous> (file:///app/__tests__/integration/healthMonitoring.test.js:121:12)
        process.processTicksAndRejections (node:internal/process/task_queues:95:5)
        async Test.run (node:internal/test_runner/test:797:9)
        async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
      ...
# [Health Monitor] ✅ Alert resolved: Test Error Spike
# [Health Monitor] Manual health check triggered
# [Health Monitor] Running health checks...
    # Subtest: should resolve an alert
    ok 7 - should resolve an alert
      ---
      duration_ms: 155.731468
      ...
# [Health Monitor] Docker check skipped (docker CLI not available in container)
# [Health Monitor] Check complete in 153ms - All systems healthy
    # Subtest: should trigger manual health check
    ok 8 - should trigger manual health check
      ---
      duration_ms: 155.258245
      ...
# [Health Monitor] Failed to resolve alert: Cannot coerce the result to a single JSON object
    # Subtest: should handle invalid alert ID gracefully
    ok 9 - should handle invalid alert ID gracefully
      ---
      duration_ms: 99.813453
      ...
    # Subtest: should clean up test alerts
    ok 10 - should clean up test alerts
      ---
      duration_ms: 69.752766
      ...
    1..10
not ok 35 - Health Monitoring System
  ---
  duration_ms: 1753.710491
  type: 'suite'
  location: '/app/__tests__/integration/healthMonitoring.test.js:16:1'
  failureType: 'subtestsFailed'
  error: '1 subtest failed'
  code: 'ERR_TEST_FAILURE'
  ...
# Subtest: Log Pattern Analysis
    # Subtest: should detect error spikes in logs
    not ok 1 - should detect error spikes in logs
      ---
      duration_ms: 163.863674
      location: '/app/__tests__/integration/healthMonitoring.test.js:169:3'
      failureType: 'testCodeFailure'
      error: 'readLogs function should exist'
      code: 'ERR_ASSERTION'
      name: 'AssertionError'
      expected: true
      actual: false
      operator: '=='
      stack: |-
        TestContext.<anonymous> (file:///app/__tests__/integration/healthMonitoring.test.js:187:12)
        async Test.run (node:internal/test_runner/test:797:9)
        async Promise.all (index 0)
        async Suite.run (node:internal/test_runner/test:1135:7)
        async Test.processPendingSubtests (node:internal/test_runner/test:526:7)
      ...
    1..1
not ok 36 - Log Pattern Analysis
  ---
  duration_ms: 165.039877
  type: 'suite'
  location: '/app/__tests__/integration/healthMonitoring.test.js:168:1'
  failureType: 'subtestsFailed'
  error: '1 subtest failed'
  code: 'ERR_TEST_FAILURE'
  ...
# Subtest: Health Alerts API Endpoints
    # Subtest: should have health alerts endpoints defined
    not ok 1 - should have health alerts endpoints defined
      ---
      duration_ms: 1.059795
      location: '/app/__tests__/integration/healthMonitoring.test.js:192:3'
      failureType: 'testCodeFailure'
      error: "Cannot find module '/app/__tests__/routes/devaiHealthAlerts.js' imported from /app/__tests__/integration/healthMonitoring.test.js"
      code: 'ERR_MODULE_NOT_FOUND'
      stack: |-
        finalizeResolution (node:internal/modules/esm/resolve:283:11)
        moduleResolve (node:internal/modules/esm/resolve:952:10)
        defaultResolve (node:internal/modules/esm/resolve:1188:11)
        ModuleLoader.defaultResolve (node:internal/modules/esm/loader:708:12)
        #cachedDefaultResolve (node:internal/modules/esm/loader:657:25)
        ModuleLoader.resolve (node:internal/modules/esm/loader:640:38)
        ModuleLoader.getModuleJobForImport (node:internal/modules/esm/loader:264:38)
        ModuleLoader.import (node:internal/modules/esm/loader:605:34)
        defaultImportModuleDynamicallyForModule (node:internal/modules/esm/utils:221:31)
        importModuleDynamicallyCallback (node:internal/modules/esm/utils:260:12)
      ...
    1..1
not ok 37 - Health Alerts API Endpoints
  ---
  duration_ms: 1.217787
  type: 'suite'
  location: '/app/__tests__/integration/healthMonitoring.test.js:191:1'
  failureType: 'subtestsFailed'
  error: '1 subtest failed'
  code: 'ERR_TEST_FAILURE'
  ...
# Internet access to Wikipedia: available
# ✓ Supabase DB client initialized with performance tracking
# ✓ Supabase DB client initialized (using centralized factory)
# [ModelRouter] Module loaded - LLM_PROVIDER=undefined
# Subtest: MCP Routes
    # Subtest: POST /api/mcp/run-proxy - Web Adapter Fallback
        # Subtest: web search should return success (fallback only if MCP unreachable)
        ok 1 - web search should return success (fallback only if MCP unreachable)
          ---
          duration_ms: 533.363554
          ...
        # Subtest: web page fetch should return success (fallback only if MCP unreachable)
        ok 2 - web page fetch should return success (fallback only if MCP unreachable)
          ---
          duration_ms: 350.809388
          ...
        # Subtest: should return error for missing query parameter in Wikipedia search
        ok 3 - should return error for missing query parameter in Wikipedia search
          ---
          duration_ms: 43.828472
          ...
        # Subtest: should return error for missing pageid parameter in Wikipedia page fetch
        ok 4 - should return error for missing pageid parameter in Wikipedia page fetch
          ---
          duration_ms: 49.185036
          ...
        # Subtest: github adapter returns success when MCP reachable (502 if unreachable)
        ok 5 - github adapter returns success when MCP reachable (502 if unreachable)
          ---
          duration_ms: 44.974123
          ...
        1..5
    ok 1 - POST /api/mcp/run-proxy - Web Adapter Fallback
      ---
      duration_ms: 1026.171749
      type: 'suite'
      ...
    # Subtest: GET /api/mcp/servers
        # Subtest: should return list of available MCP servers
        ok 1 - should return list of available MCP servers
          ---
          duration_ms: 18.386034
          ...
        1..1
    ok 2 - GET /api/mcp/servers
      ---
      duration_ms: 22.896993
      type: 'suite'
      ...
    # Subtest: POST /api/mcp/execute-tool - Web Tools
        # Subtest: should handle web.search_wikipedia tool directly (success with internet, error without)
        ok 1 - should handle web.search_wikipedia tool directly (success with internet, error without)
          ---
          duration_ms: 521.553067
          ...
        # Subtest: should handle web.get_wikipedia_page tool directly (success with internet, error without)
        ok 2 - should handle web.get_wikipedia_page tool directly (success with internet, error without)
          ---
          duration_ms: 130.643707
          ...
        1..2
    ok 3 - POST /api/mcp/execute-tool - Web Tools
      ---
      duration_ms: 652.580965
      type: 'suite'
      ...
    1..3
ok 38 - MCP Routes
  ---
  duration_ms: 3492.465704
  type: 'suite'
  ...
# ✓ Supabase Admin client initialized
# ✓ Supabase Admin client initialized
# ✓ Supabase DB client initialized with performance tracking
# ✓ Supabase DB client initialized with performance tracking
# ✓ Supabase Admin client initialized
# ✓ Supabase DB client initialized with performance tracking
# ✓ Supabase Admin client initialized
# ✓ Supabase Admin client initialized
# Subtest: supabaseFactory
    # Subtest: getSupabaseAdmin()
        # Subtest: should create admin client with correct configuration
        ok 1 - should create admin client with correct configuration
          ---
          duration_ms: 112.662378
          ...
        # Subtest: should return same instance on subsequent calls (singleton)
        ok 2 - should return same instance on subsequent calls (singleton)
          ---
          duration_ms: 4.758285
          ...
        # Subtest: should throw error when SUPABASE_URL is missing (default behavior)
        ok 3 - should throw error when SUPABASE_URL is missing (default behavior)
          ---
          duration_ms: 1.995991
          ...
        # Subtest: should return null when SUPABASE_URL is missing and throwOnMissing=false
        ok 4 - should return null when SUPABASE_URL is missing and throwOnMissing=false
          ---
          duration_ms: 1.164048
          ...
        # Subtest: should throw error when SUPABASE_SERVICE_ROLE_KEY is missing (default behavior)
        ok 5 - should throw error when SUPABASE_SERVICE_ROLE_KEY is missing (default behavior)
          ---
          duration_ms: 1.000222
          ...
        1..5
    ok 1 - getSupabaseAdmin()
      ---
      duration_ms: 132.692701
      type: 'suite'
      ...
    # Subtest: getSupabaseDB()
        # Subtest: should create DB client with performance tracking
        ok 1 - should create DB client with performance tracking
          ---
          duration_ms: 2.308736
          ...
        # Subtest: should return same instance on subsequent calls (singleton)
        ok 2 - should return same instance on subsequent calls (singleton)
          ---
          duration_ms: 1.874303
          ...
        # Subtest: should be different from admin client
        ok 3 - should be different from admin client
          ---
          duration_ms: 2.682934
          ...
        # Subtest: should throw error when SUPABASE_URL is missing
        ok 4 - should throw error when SUPABASE_URL is missing
          ---
          duration_ms: 1.242166
          ...
        # Subtest: should throw error when SUPABASE_SERVICE_ROLE_KEY is missing
        ok 5 - should throw error when SUPABASE_SERVICE_ROLE_KEY is missing
          ---
          duration_ms: 0.701232
          ...
        1..5
    ok 2 - getSupabaseDB()
      ---
      duration_ms: 9.672294
      type: 'suite'
      ...
    # Subtest: getBucketName()
        # Subtest: should return configured bucket name
        ok 1 - should return configured bucket name
          ---
          duration_ms: 1.88054
          ...
        # Subtest: should return default bucket name when not configured
        ok 2 - should return default bucket name when not configured
          ---
          duration_ms: 2.00309
          ...
        1..2
    ok 3 - getBucketName()
      ---
      duration_ms: 4.777062
      type: 'suite'
      ...
    # Subtest: _resetClients()
        # Subtest: should reset singleton state
        ok 1 - should reset singleton state
          ---
          duration_ms: 3.662253
          ...
        1..1
    ok 4 - _resetClients()
      ---
      duration_ms: 4.340563
      type: 'suite'
      ...
    1..4
ok 39 - supabaseFactory
  ---
  duration_ms: 158.18434
  type: 'suite'
  ...
# ✓ Supabase DB client initialized with performance tracking
# ✓ Supabase DB client initialized (using centralized factory)
# Subtest: tenantCanonicalResolver
    # Subtest: isUuid()
        # Subtest: should return true for valid UUIDs
        ok 1 - should return true for valid UUIDs
          ---
          duration_ms: 2.834731
          ...
        # Subtest: should return false for invalid UUIDs
        ok 2 - should return false for invalid UUIDs
          ---
          duration_ms: 2.14479
          ...
        # Subtest: should handle trimmed whitespace
        ok 3 - should handle trimmed whitespace
          ---
          duration_ms: 0.952479
          ...
        1..3
    ok 1 - isUuid()
      ---
      duration_ms: 7.979554
      type: 'suite'
      ...
    # Subtest: resolveCanonicalTenant() - Unit Tests
        # Subtest: should return empty result for null/empty identifier
        ok 1 - should return empty result for null/empty identifier
          ---
          duration_ms: 3.681675
          ...
        # Subtest: should handle system tenant with env var
        ok 2 - should handle system tenant with env var
          ---
          duration_ms: 1.839688
          ...
        # Subtest: should handle system tenant without env var
        ok 3 - should handle system tenant without env var
          ---
          duration_ms: 1.117704
          ...
        1..3
    ok 2 - resolveCanonicalTenant() - Unit Tests
      ---
      duration_ms: 7.443076
      type: 'suite'
      ...
    # Subtest: Cache Behavior
        # Subtest: should cache tenant resolution results
        ok 1 - should cache tenant resolution results
          ---
          duration_ms: 5.489554
          ...
        # Subtest: should report accurate cache statistics
        ok 2 - should report accurate cache statistics
          ---
          duration_ms: 413.784477
          ...
        # Subtest: should clear cache on demand
        ok 3 - should clear cache on demand
          ---
          duration_ms: 111.505306
          ...
        1..3
    ok 3 - Cache Behavior
      ---
      duration_ms: 531.682316
      type: 'suite'
      ...
    # Subtest: Integration Tests (Supabase)
        # Subtest: should resolve known UUID tenant from database
        ok 1 - should resolve known UUID tenant from database
          ---
          duration_ms: 77.276837
          ...
        # Subtest: should resolve known slug tenant from database
        ok 2 - should resolve known slug tenant from database
          ---
          duration_ms: 152.889149
          ...
        # Subtest: should handle unknown UUID gracefully
        ok 3 - should handle unknown UUID gracefully
          ---
          duration_ms: 137.395187
          ...
        # Subtest: should handle unknown slug gracefully
        ok 4 - should handle unknown slug gracefully
          ---
          duration_ms: 81.237761
          ...
        1..4
    ok 4 - Integration Tests (Supabase)
      ---
      duration_ms: 450.603663
      type: 'suite'
      ...
    # Subtest: Edge Cases
        # Subtest: should handle whitespace in identifiers
        ok 1 - should handle whitespace in identifiers
          ---
          duration_ms: 0.850089
          ...
        # Subtest: should distinguish UUID from slug correctly
        ok 2 - should distinguish UUID from slug correctly
          ---
          duration_ms: 157.915063
          ...
        # Subtest: should handle case sensitivity in UUIDs
        ok 3 - should handle case sensitivity in UUIDs
          ---
          duration_ms: 0.578628
          ...
        1..3
    ok 5 - Edge Cases
      ---
      duration_ms: 160.023918
      type: 'suite'
      ...
    1..5
ok 40 - tenantCanonicalResolver
  ---
  duration_ms: 1248.875728
  type: 'suite'
  ...
# [UUID Validator] Invalid UUID rejected: "system"
# [UUID Validator] Invalid UUID rejected: "not-a-uuid"
# [UUID Validator] Invalid UUID rejected: "local-tenant-001"
# [UUID Validator] Invalid UUID rejected: "12345"
# [UUID Validator] Invalid UUID rejected: "invalid-uuid"
# [UUID Validator] Invalid UUID rejected: "invalid-uuid"
# [UUID Validator] Invalid UUID rejected: "invalid"
# [UUID Validator] Invalid UUID rejected: "invalid-uuid"
# Subtest: uuidValidator
    # Subtest: isValidUUID()
        # Subtest: should return true for valid UUIDs
        ok 1 - should return true for valid UUIDs
          ---
          duration_ms: 5.174107
          ...
        # Subtest: should return false for invalid UUIDs
        ok 2 - should return false for invalid UUIDs
          ---
          duration_ms: 0.371078
          ...
        # Subtest: should return false for non-string inputs
        ok 3 - should return false for non-string inputs
          ---
          duration_ms: 0.645359
          ...
        1..3
    ok 1 - isValidUUID()
      ---
      duration_ms: 7.685636
      type: 'suite'
      ...
    # Subtest: sanitizeUuidInput()
        # Subtest: should return valid UUIDs unchanged
        ok 1 - should return valid UUIDs unchanged
          ---
          duration_ms: 0.642427
          ...
        # Subtest: should return null for null/undefined/empty with allowNull
        ok 2 - should return null for null/undefined/empty with allowNull
          ---
          duration_ms: 0.255949
          ...
        # Subtest: should return undefined for null/undefined with allowNull:false
        ok 3 - should return undefined for null/undefined with allowNull:false
          ---
          duration_ms: 0.337498
          ...
        # Subtest: should convert system aliases to null
        ok 4 - should convert system aliases to null
          ---
          duration_ms: 0.381972
          ...
        # Subtest: should handle custom system aliases
        ok 5 - should handle custom system aliases
          ---
          duration_ms: 2.489015
          ...
        # Subtest: should return null for invalid UUIDs
        ok 6 - should return null for invalid UUIDs
          ---
          duration_ms: 1.705599
          ...
        1..6
    ok 2 - sanitizeUuidInput()
      ---
      duration_ms: 6.797857
      type: 'suite'
      ...
    # Subtest: sanitizeUuidFilter()
        # Subtest: should sanitize UUID columns in simple filter
        ok 1 - should sanitize UUID columns in simple filter
          ---
          duration_ms: 1.13348
          ...
        # Subtest: should preserve operator objects
        ok 2 - should preserve operator objects
          ---
          duration_ms: 1.929139
          ...
        # Subtest: should sanitize $or conditions recursively
        ok 3 - should sanitize $or conditions recursively
          ---
          duration_ms: 0.966299
          ...
        # Subtest: should sanitize $and conditions recursively
        ok 4 - should sanitize $and conditions recursively
          ---
          duration_ms: 2.411095
          ...
        # Subtest: should handle nested $or/$and combinations
        ok 5 - should handle nested $or/$and combinations
          ---
          duration_ms: 0.640182
          ...
        # Subtest: should return filter unchanged for non-object input
        ok 6 - should return filter unchanged for non-object input
          ---
          duration_ms: 0.299267
          ...
        # Subtest: should create new object (not mutate original)
        ok 7 - should create new object (not mutate original)
          ---
          duration_ms: 0.692758
          ...
        1..7
    ok 3 - sanitizeUuidFilter()
      ---
      duration_ms: 8.913232
      type: 'suite'
      ...
    # Subtest: validateUuidParams() middleware
        # Subtest: should pass for valid UUID params
        ok 1 - should pass for valid UUID params
          ---
          duration_ms: 0.622672
          ...
        # Subtest: should return 400 for invalid UUID params
        ok 2 - should return 400 for invalid UUID params
          ---
          duration_ms: 0.821363
          ...
        # Subtest: should validate multiple params and report all invalid ones
        ok 3 - should validate multiple params and report all invalid ones
          ---
          duration_ms: 0.521609
          ...
        1..3
    ok 4 - validateUuidParams() middleware
      ---
      duration_ms: 2.241401
      type: 'suite'
      ...
    # Subtest: validateUuidQuery() middleware
        # Subtest: should pass for valid UUID query params
        ok 1 - should pass for valid UUID query params
          ---
          duration_ms: 0.577627
          ...
        # Subtest: should allow "null" string for query params
        ok 2 - should allow "null" string for query params
          ---
          duration_ms: 1.009653
          ...
        # Subtest: should return 400 for invalid UUID query params
        ok 3 - should return 400 for invalid UUID query params
          ---
          duration_ms: 0.633
          ...
        1..3
    ok 5 - validateUuidQuery() middleware
      ---
      duration_ms: 2.509724
      type: 'suite'
      ...
    1..5
ok 41 - uuidValidator
  ---
  duration_ms: 31.372698
  type: 'suite'
  ...
# Subtest: Deprecation Middleware Unit Tests
    # Subtest: Request path detection
        # Subtest: should detect v1 API paths
        ok 1 - should detect v1 API paths
          ---
          duration_ms: 6.974934
          ...
        # Subtest: should skip v2 API paths
        ok 2 - should skip v2 API paths
          ---
          duration_ms: 0.894196
          ...
        # Subtest: should skip non-API paths
        ok 3 - should skip non-API paths
          ---
          duration_ms: 0.91728
          ...
        1..3
    ok 1 - Request path detection
      ---
      duration_ms: 16.499631
      type: 'suite'
      ...
    # Subtest: Before sunset date (current behavior)
        # Subtest: should add deprecation headers for v1 endpoints
        ok 1 - should add deprecation headers for v1 endpoints
          ---
          duration_ms: 1.19872
          ...
        1..1
    ok 2 - Before sunset date (current behavior)
      ---
      duration_ms: 3.157812
      type: 'suite'
      ...
    # Subtest: V2 endpoint mapping
        # Subtest: should correctly map v1 paths to v2
        ok 1 - should correctly map v1 paths to v2
          ---
          duration_ms: 4.834268
          ...
        1..1
    ok 3 - V2 endpoint mapping
      ---
      duration_ms: 5.204597
      type: 'suite'
      ...
    # Subtest: Routes without v2 alternatives
        # Subtest: should not add full deprecation headers for non-migrated routes
        ok 1 - should not add full deprecation headers for non-migrated routes
          ---
          duration_ms: 3.252787
          ...
        1..1
    ok 4 - Routes without v2 alternatives
      ---
      duration_ms: 4.562767
      type: 'suite'
      ...
    1..4
ok 42 - Deprecation Middleware Unit Tests
  ---
  duration_ms: 31.800586
  type: 'suite'
  ...
# Subtest: Deprecation Middleware - After Sunset Simulation
    # Subtest: should return 410 Gone with correct error structure
    ok 1 - should return 410 Gone with correct error structure
      ---
      duration_ms: 1.344858
      ...
    # Subtest: should include all required fields in 410 response
    ok 2 - should include all required fields in 410 response
      ---
      duration_ms: 4.05734
      ...
    1..2
ok 43 - Deprecation Middleware - After Sunset Simulation
  ---
  duration_ms: 8.852044
  type: 'suite'
  ...
# [ModelRouter] Module loaded - LLM_PROVIDER=undefined
# Subtest: Section A: Trigger Engine Verification
    # Subtest: A1: Trigger Worker Integrity
        # Subtest: Worker module exports required functions
        ok 1 - Worker module exports required functions
          ---
          duration_ms: 1357.178553
          ...
        # Subtest: Worker respects AI_TRIGGERS_WORKER_ENABLED environment variable
        ok 2 - Worker respects AI_TRIGGERS_WORKER_ENABLED environment variable
          ---
          duration_ms: 7.895596
          ...
        # Subtest: Worker exports TRIGGER_TYPES constant for structured logging
        ok 3 - Worker exports TRIGGER_TYPES constant for structured logging
          ---
          duration_ms: 1.229991
          ...
        # Subtest: Worker logs with tenant_id context
        ok 4 - Worker logs with tenant_id context
          ---
          duration_ms: 1.582745
          ...
        1..4
    ok 1 - A1: Trigger Worker Integrity
      ---
      duration_ms: 1371.19833
      type: 'suite'
      ...
    # Subtest: A2: Supabase Query Policy Compliance
        # Subtest: aiTriggersWorker.js has no prohibited SQL patterns
        ok 1 - aiTriggersWorker.js has no prohibited SQL patterns
          ---
          duration_ms: 5.969718
          ...
        # Subtest: Worker uses Supabase JS client for data retrieval
        ok 2 - Worker uses Supabase JS client for data retrieval
          ---
          duration_ms: 2.895811
          ...
        # Subtest: Complex logic done in JavaScript, not SQL
        ok 3 - Complex logic done in JavaScript, not SQL
          ---
          duration_ms: 1.639123
          ...
        1..3
    ok 2 - A2: Supabase Query Policy Compliance
      ---
      duration_ms: 13.139671
      type: 'suite'
      ...
    # Subtest: A3: Trigger Output Format
        # Subtest: Trigger format includes required fields
        ok 1 - Trigger format includes required fields
          ---
          duration_ms: 1.59031
          ...
        # Subtest: Worker creates suggestions with proper JSON structure
        ok 2 - Worker creates suggestions with proper JSON structure
          ---
          duration_ms: 1.598008
          ...
        1..2
    ok 3 - A3: Trigger Output Format
      ---
      duration_ms: 3.663394
      type: 'suite'
      ...
    1..3
ok 44 - Section A: Trigger Engine Verification
  ---
  duration_ms: 1392.366199
  type: 'suite'
  ...
# Subtest: Section B: Suggestion Engine Verification
    # Subtest: B1: AI Brain (Braid) Integration
        # Subtest: Worker uses propose_actions mode for suggestions
        ok 1 - Worker uses propose_actions mode for suggestions
          ---
          duration_ms: 7.650619
          ...
        # Subtest: No direct database writes from suggestion generation
        ok 2 - No direct database writes from suggestion generation
          ---
          duration_ms: 2.506642
          ...
        # Subtest: Suggestion actions match allowed Braid tools
        ok 3 - Suggestion actions match allowed Braid tools
          ---
          duration_ms: 0.807313
          ...
        1..3
    ok 1 - B1: AI Brain (Braid) Integration
      ---
      duration_ms: 13.995026
      type: 'suite'
      ...
    # Subtest: B2: Suggestion JSON Format
        # Subtest: Sample suggestion structure is valid
        ok 1 - Sample suggestion structure is valid
          ---
          duration_ms: 2.07107
          ...
        # Subtest: Missing action field is detected
        ok 2 - Missing action field is detected
          ---
          duration_ms: 0.653391
          ...
        # Subtest: Missing confidence field is detected
        ok 3 - Missing confidence field is detected
          ---
          duration_ms: 0.67151
          ...
        # Subtest: Confidence out of range is detected
        ok 4 - Confidence out of range is detected
          ---
          duration_ms: 0.736026
          ...
        # Subtest: Empty reasoning is detected
        ok 5 - Empty reasoning is detected
          ---
          duration_ms: 0.58292
          ...
        # Subtest: Unknown action/tool is detected
        ok 6 - Unknown action/tool is detected
          ---
          duration_ms: 0.707301
          ...
        1..6
    ok 2 - B2: Suggestion JSON Format
      ---
      duration_ms: 7.33582
      type: 'suite'
      ...
    # Subtest: B3: Deduplication
        # Subtest: Worker checks for existing pending suggestions
        ok 1 - Worker checks for existing pending suggestions
          ---
          duration_ms: 2.687765
          ...
        # Subtest: Worker excludes already-processed records
        ok 2 - Worker excludes already-processed records
          ---
          duration_ms: 1.654775
          ...
        1..2
    ok 3 - B3: Deduplication
      ---
      duration_ms: 4.882196
      type: 'suite'
      ...
    1..3
ok 45 - Section B: Suggestion Engine Verification
  ---
  duration_ms: 34.731161
  type: 'suite'
  ...
# ✓ Supabase DB client initialized with performance tracking
# ✓ Supabase DB client initialized (using centralized factory)
# Subtest: Section C: Suggestion Queue Verification
    # Subtest: C1: Database Table Validity
        # Subtest: ai_suggestions table exists and is accessible
        not ok 1 - ai_suggestions table exists and is accessible
          ---
          duration_ms: 59.31703
          location: '/app/__tests__/phase3/section-c-suggestion-queue.test.js:30:5'
          failureType: 'testCodeFailure'
          error: 'fetch failed'
          code: 'ERR_TEST_FAILURE'
          name: 'TypeError'
          stack: |-
            node:internal/deps/undici/undici:14902:13
            process.processTicksAndRejections (node:internal/process/task_queues:95:5)
            async TestContext.<anonymous> (file:///app/__tests__/phase3/section-c-suggestion-queue.test.js:31:19)
            async Test.run (node:internal/test_runner/test:797:9)
            async Promise.all (index 0)
            async Suite.run (node:internal/test_runner/test:1135:7)
            async Promise.all (index 0)
            async Suite.run (node:internal/test_runner/test:1135:7)
            async Test.processPendingSubtests (node:internal/test_runner/test:526:7)
          ...
        # Subtest: Suggestions list returns expected structure
        not ok 2 - Suggestions list returns expected structure
          ---
          duration_ms: 28.260976
          location: '/app/__tests__/phase3/section-c-suggestion-queue.test.js:40:5'
          failureType: 'testCodeFailure'
          error: 'fetch failed'
          code: 'ERR_TEST_FAILURE'
          name: 'TypeError'
          stack: |-
            node:internal/deps/undici/undici:14902:13
            process.processTicksAndRejections (node:internal/process/task_queues:95:5)
            async TestContext.<anonymous> (file:///app/__tests__/phase3/section-c-suggestion-queue.test.js:41:19)
            async Test.run (node:internal/test_runner/test:797:9)
            async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
          ...
        # Subtest: API response format matches frontend contract
        not ok 3 - API response format matches frontend contract
          ---
          duration_ms: 16.185809
          location: '/app/__tests__/phase3/section-c-suggestion-queue.test.js:50:5'
          failureType: 'testCodeFailure'
          error: 'fetch failed'
          code: 'ERR_TEST_FAILURE'
          name: 'TypeError'
          stack: |-
            node:internal/deps/undici/undici:14902:13
            process.processTicksAndRejections (node:internal/process/task_queues:95:5)
            async TestContext.<anonymous> (file:///app/__tests__/phase3/section-c-suggestion-queue.test.js:53:19)
            async Test.run (node:internal/test_runner/test:797:9)
            async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
          ...
        # Subtest: Stats endpoint returns aggregated data
        not ok 4 - Stats endpoint returns aggregated data
          ---
          duration_ms: 8.352234
          location: '/app/__tests__/phase3/section-c-suggestion-queue.test.js:76:5'
          failureType: 'testCodeFailure'
          error: 'fetch failed'
          code: 'ERR_TEST_FAILURE'
          name: 'TypeError'
          stack: |-
            node:internal/deps/undici/undici:14902:13
            process.processTicksAndRejections (node:internal/process/task_queues:95:5)
            async TestContext.<anonymous> (file:///app/__tests__/phase3/section-c-suggestion-queue.test.js:77:19)
            async Test.run (node:internal/test_runner/test:797:9)
            async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
          ...
        1..4
    not ok 1 - C1: Database Table Validity
      ---
      duration_ms: 118.627961
      type: 'suite'
      location: '/app/__tests__/phase3/section-c-suggestion-queue.test.js:28:3'
      failureType: 'subtestsFailed'
      error: '4 subtests failed'
      code: 'ERR_TEST_FAILURE'
      stack: |-
        async Promise.all (index 0)
      ...
    # Subtest: C2: API Verification
        # Subtest: GET /api/ai/suggestions requires tenant_id
        not ok 1 - GET /api/ai/suggestions requires tenant_id
          ---
          duration_ms: 9.195571
          location: '/app/__tests__/phase3/section-c-suggestion-queue.test.js:93:5'
          failureType: 'testCodeFailure'
          error: 'fetch failed'
          code: 'ERR_TEST_FAILURE'
          name: 'TypeError'
          stack: |-
            node:internal/deps/undici/undici:14902:13
            process.processTicksAndRejections (node:internal/process/task_queues:95:5)
            async TestContext.<anonymous> (file:///app/__tests__/phase3/section-c-suggestion-queue.test.js:94:19)
            async Test.run (node:internal/test_runner/test:797:9)
            async Promise.all (index 0)
            async Suite.run (node:internal/test_runner/test:1135:7)
            async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
          ...
        # Subtest: GET /api/ai/suggestions/:id returns single suggestion or 404
        not ok 2 - GET /api/ai/suggestions/:id returns single suggestion or 404
          ---
          duration_ms: 9.178395
          location: '/app/__tests__/phase3/section-c-suggestion-queue.test.js:100:5'
          failureType: 'testCodeFailure'
          error: 'fetch failed'
          code: 'ERR_TEST_FAILURE'
          name: 'TypeError'
          stack: |-
            node:internal/deps/undici/undici:14902:13
            process.processTicksAndRejections (node:internal/process/task_queues:95:5)
            async TestContext.<anonymous> (file:///app/__tests__/phase3/section-c-suggestion-queue.test.js:102:23)
            async Test.run (node:internal/test_runner/test:797:9)
            async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
          ...
        # Subtest: POST /api/ai/suggestions/:id/approve requires tenant_id
        not ok 3 - POST /api/ai/suggestions/:id/approve requires tenant_id
          ---
          duration_ms: 22.508922
          location: '/app/__tests__/phase3/section-c-suggestion-queue.test.js:121:5'
          failureType: 'testCodeFailure'
          error: 'fetch failed'
          code: 'ERR_TEST_FAILURE'
          name: 'TypeError'
          stack: |-
            node:internal/deps/undici/undici:14902:13
            process.processTicksAndRejections (node:internal/process/task_queues:95:5)
            async TestContext.<anonymous> (file:///app/__tests__/phase3/section-c-suggestion-queue.test.js:123:19)
            async Test.run (node:internal/test_runner/test:797:9)
            async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
          ...
        # Subtest: POST /api/ai/suggestions/:id/reject requires tenant_id
        not ok 4 - POST /api/ai/suggestions/:id/reject requires tenant_id
          ---
          duration_ms: 8.986298
          location: '/app/__tests__/phase3/section-c-suggestion-queue.test.js:132:5'
          failureType: 'testCodeFailure'
          error: 'fetch failed'
          code: 'ERR_TEST_FAILURE'
          name: 'TypeError'
          stack: |-
            node:internal/deps/undici/undici:14902:13
            process.processTicksAndRejections (node:internal/process/task_queues:95:5)
            async TestContext.<anonymous> (file:///app/__tests__/phase3/section-c-suggestion-queue.test.js:134:19)
            async Test.run (node:internal/test_runner/test:797:9)
            async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
          ...
        # Subtest: Tenant isolation - cross-tenant access blocked
        not ok 5 - Tenant isolation - cross-tenant access blocked
          ---
          duration_ms: 3.660224
          location: '/app/__tests__/phase3/section-c-suggestion-queue.test.js:143:5'
          failureType: 'testCodeFailure'
          error: 'fetch failed'
          code: 'ERR_TEST_FAILURE'
          name: 'TypeError'
          stack: |-
            node:internal/deps/undici/undici:14902:13
            process.processTicksAndRejections (node:internal/process/task_queues:95:5)
            async TestContext.<anonymous> (file:///app/__tests__/phase3/section-c-suggestion-queue.test.js:146:19)
            async Test.run (node:internal/test_runner/test:797:9)
            async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
          ...
        # Subtest: Suggestions list supports filtering by status
        not ok 6 - Suggestions list supports filtering by status
          ---
          duration_ms: 6.103429
          location: '/app/__tests__/phase3/section-c-suggestion-queue.test.js:164:5'
          failureType: 'testCodeFailure'
          error: 'fetch failed'
          code: 'ERR_TEST_FAILURE'
          name: 'TypeError'
          stack: |-
            node:internal/deps/undici/undici:14902:13
            process.processTicksAndRejections (node:internal/process/task_queues:95:5)
            async TestContext.<anonymous> (file:///app/__tests__/phase3/section-c-suggestion-queue.test.js:168:21)
            async Test.run (node:internal/test_runner/test:797:9)
            async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
          ...
        # Subtest: Suggestions list supports pagination
        not ok 7 - Suggestions list supports pagination
          ---
          duration_ms: 3.892786
          location: '/app/__tests__/phase3/section-c-suggestion-queue.test.js:180:5'
          failureType: 'testCodeFailure'
          error: 'fetch failed'
          code: 'ERR_TEST_FAILURE'
          name: 'TypeError'
          stack: |-
            node:internal/deps/undici/undici:14902:13
            process.processTicksAndRejections (node:internal/process/task_queues:95:5)
            async TestContext.<anonymous> (file:///app/__tests__/phase3/section-c-suggestion-queue.test.js:181:19)
            async Test.run (node:internal/test_runner/test:797:9)
            async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
          ...
        1..7
    not ok 2 - C2: API Verification
      ---
      duration_ms: 66.72264
      type: 'suite'
      location: '/app/__tests__/phase3/section-c-suggestion-queue.test.js:91:3'
      failureType: 'subtestsFailed'
      error: '7 subtests failed'
      code: 'ERR_TEST_FAILURE'
      ...
    1..2
not ok 46 - Section C: Suggestion Queue Verification
  ---
  duration_ms: 423.006097
  type: 'suite'
  location: '/app/__tests__/phase3/section-c-suggestion-queue.test.js:20:1'
  failureType: 'subtestsFailed'
  error: '2 subtests failed'
  code: 'ERR_TEST_FAILURE'
  ...
# Subtest: Section D: Review UI Verification
ok 47 - Section D: Review UI Verification # SKIP
  ---
  duration_ms: 5.099908
  type: 'suite'
  ...
# Subtest: Section E: Safe Apply Engine Verification
    # Subtest: E1: Apply Pipeline Integrity
        # Subtest: Braid integration module exists
        ok 1 - Braid integration module exists
          ---
          duration_ms: 4.318814
          ...
        # Subtest: Apply route validates tenant ownership
        ok 2 - Apply route validates tenant ownership
          ---
          duration_ms: 1.148083
          ...
        # Subtest: Apply route uses executeBraidTool
        ok 3 - Apply route uses executeBraidTool
          ---
          duration_ms: 0.725154
          ...
        # Subtest: No direct Supabase writes to CRM tables from apply
        ok 4 - No direct Supabase writes to CRM tables from apply
          ---
          duration_ms: 0.593601
          ...
        1..4
    ok 1 - E1: Apply Pipeline Integrity
      ---
      duration_ms: 8.340445
      type: 'suite'
      ...
    # Subtest: E2: Post-Apply Status
        # Subtest: Apply endpoint updates suggestion status
        not ok 1 - Apply endpoint updates suggestion status
          ---
          duration_ms: 98.661607
          location: '/app/__tests__/phase3/section-e-safe-apply.test.js:100:5'
          failureType: 'testCodeFailure'
          error: 'fetch failed'
          code: 'ERR_TEST_FAILURE'
          name: 'TypeError'
          stack: |-
            node:internal/deps/undici/undici:14902:13
            process.processTicksAndRejections (node:internal/process/task_queues:95:5)
            async TestContext.<anonymous> (file:///app/__tests__/phase3/section-e-safe-apply.test.js:102:23)
            async Test.run (node:internal/test_runner/test:797:9)
            async Promise.all (index 0)
            async Suite.run (node:internal/test_runner/test:1135:7)
            async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
          ...
        # Subtest: Apply stores apply_result on success or failure
        ok 2 - Apply stores apply_result on success or failure
          ---
          duration_ms: 6.211185
          ...
        1..2
    not ok 2 - E2: Post-Apply Status
      ---
      duration_ms: 106.110307
      type: 'suite'
      location: '/app/__tests__/phase3/section-e-safe-apply.test.js:98:3'
      failureType: 'subtestsFailed'
      error: '1 subtest failed'
      code: 'ERR_TEST_FAILURE'
      ...
    # Subtest: E3: Audit Logging
        # Subtest: Apply operations are logged
        not ok 1 - Apply operations are logged
          ---
          duration_ms: 1.993424
          location: '/app/__tests__/phase3/section-e-safe-apply.test.js:151:5'
          failureType: 'testCodeFailure'
          error: 'Apply should have logging'
          code: 'ERR_ASSERTION'
          name: 'AssertionError'
          expected: true
          actual: false
          operator: '=='
          stack: |-
            TestContext.<anonymous> (file:///app/__tests__/phase3/section-e-safe-apply.test.js:156:14)
            Test.runInAsyncScope (node:async_hooks:206:9)
            Test.run (node:internal/test_runner/test:796:25)
            Test.start (node:internal/test_runner/test:702:17)
            node:internal/test_runner/test:1133:71
            node:internal/per_context/primordials:482:82
            new Promise (<anonymous>)
            new SafePromise (node:internal/per_context/primordials:450:29)
            node:internal/per_context/primordials:482:9
            Array.map (<anonymous>)
          ...
        # Subtest: Errors are captured and logged
        ok 2 - Errors are captured and logged
          ---
          duration_ms: 0.839878
          ...
        1..2
    not ok 3 - E3: Audit Logging
      ---
      duration_ms: 3.651896
      type: 'suite'
      location: '/app/__tests__/phase3/section-e-safe-apply.test.js:149:3'
      failureType: 'subtestsFailed'
      error: '1 subtest failed'
      code: 'ERR_TEST_FAILURE'
      ...
    1..3
not ok 48 - Section E: Safe Apply Engine Verification
  ---
  duration_ms: 120.324944
  type: 'suite'
  location: '/app/__tests__/phase3/section-e-safe-apply.test.js:24:1'
  failureType: 'subtestsFailed'
  error: '2 subtests failed'
  code: 'ERR_TEST_FAILURE'
  ...
# Subtest: Section F: Integration Layers Verification
    # Subtest: F1: Workflow Canvas
        # Subtest: Workflow routes exist
        ok 1 - Workflow routes exist
          ---
          duration_ms: 3.463114
          ...
        # Subtest: Workflow can emit triggers (if implemented)
        ok 2 - Workflow can emit triggers (if implemented)
          ---
          duration_ms: 1.271136
          ...
        1..2
    ok 1 - F1: Workflow Canvas
      ---
      duration_ms: 6.638587
      type: 'suite'
      ...
    # Subtest: F2: Email Integration
        # Subtest: Email-related routes or handlers exist
        ok 1 - Email-related routes or handlers exist
          ---
          duration_ms: 0.66761
          ...
        # Subtest: Email sending uses tools, not direct SMTP
        ok 2 - Email sending uses tools, not direct SMTP
          ---
          duration_ms: 0.587463
          ...
        1..2
    ok 2 - F2: Email Integration
      ---
      duration_ms: 1.707064
      type: 'suite'
      ...
    # Subtest: F3: CallFluent Integration
        # Subtest: Telephony routes exist
        ok 1 - Telephony routes exist
          ---
          duration_ms: 1.774555
          ...
        # Subtest: Call webhooks can trigger AI suggestions
        ok 2 - Call webhooks can trigger AI suggestions
          ---
          duration_ms: 0.854427
          ...
        # Subtest: Call summaries can feed into trigger detection
        ok 3 - Call summaries can feed into trigger detection
          ---
          duration_ms: 1.071954
          ...
        1..3
    ok 3 - F3: CallFluent Integration
      ---
      duration_ms: 5.026472
      type: 'suite'
      ...
    # Subtest: F4: Thoughtly Integration
        # Subtest: No PII leakage across tenants in context
        ok 1 - No PII leakage across tenants in context
          ---
          duration_ms: 1.089385
          ...
        # Subtest: Behavioral insights remain tenant-isolated
        ok 2 - Behavioral insights remain tenant-isolated
          ---
          duration_ms: 0.834356
          ...
        1..2
    ok 4 - F4: Thoughtly Integration
      ---
      duration_ms: 2.178661
      type: 'suite'
      ...
    1..4
ok 49 - Section F: Integration Layers Verification
  ---
  duration_ms: 22.082564
  type: 'suite'
  ...
# Subtest: Section G: Telemetry & Observability Verification
    # Subtest: G1: Telemetry Logging
        # Subtest: Worker logs trigger events
        not ok 1 - Worker logs trigger events
          ---
          duration_ms: 6.165798
          location: '/app/__tests__/phase3/section-g-telemetry.test.js:31:5'
          failureType: 'testCodeFailure'
          error: 'Worker should log events'
          code: 'ERR_ASSERTION'
          name: 'AssertionError'
          expected: true
          actual: false
          operator: '=='
          stack: |-
            TestContext.<anonymous> (file:///app/__tests__/phase3/section-g-telemetry.test.js:36:14)
            Test.runInAsyncScope (node:async_hooks:206:9)
            Test.run (node:internal/test_runner/test:796:25)
            Test.start (node:internal/test_runner/test:702:17)
            node:internal/test_runner/test:1133:71
            node:internal/per_context/primordials:482:82
            new Promise (<anonymous>)
            new SafePromise (node:internal/per_context/primordials:450:29)
            node:internal/per_context/primordials:482:9
            Array.map (<anonymous>)
          ...
        # Subtest: Suggestion routes log approval/rejection
        ok 2 - Suggestion routes log approval/rejection
          ---
          duration_ms: 0.755949
          ...
        # Subtest: Apply operations log success/failure
        ok 3 - Apply operations log success/failure
          ---
          duration_ms: 0.813697
          ...
        # Subtest: Logs include tenant context
        ok 4 - Logs include tenant context
          ---
          duration_ms: 1.950574
          ...
        1..4
    not ok 1 - G1: Telemetry Logging
      ---
      duration_ms: 11.734428
      type: 'suite'
      location: '/app/__tests__/phase3/section-g-telemetry.test.js:29:3'
      failureType: 'subtestsFailed'
      error: '1 subtest failed'
      code: 'ERR_TEST_FAILURE'
      stack: |-
        async Promise.all (index 0)
      ...
    # Subtest: G2: Telemetry JSON Format
        # Subtest: Metrics endpoint returns structured data
        not ok 1 - Metrics endpoint returns structured data
          ---
          duration_ms: 96.262095
          location: '/app/__tests__/phase3/section-g-telemetry.test.js:98:5'
          failureType: 'testCodeFailure'
          error: 'fetch failed'
          code: 'ERR_TEST_FAILURE'
          name: 'TypeError'
          stack: |-
            node:internal/deps/undici/undici:14902:13
            process.processTicksAndRejections (node:internal/process/task_queues:95:5)
            async TestContext.<anonymous> (file:///app/__tests__/phase3/section-g-telemetry.test.js:99:19)
            async Test.run (node:internal/test_runner/test:797:9)
            async Promise.all (index 0)
            async Suite.run (node:internal/test_runner/test:1135:7)
            async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
          ...
        # Subtest: Metrics include required fields
        not ok 2 - Metrics include required fields
          ---
          duration_ms: 8.539346
          location: '/app/__tests__/phase3/section-g-telemetry.test.js:107:5'
          failureType: 'testCodeFailure'
          error: 'fetch failed'
          code: 'ERR_TEST_FAILURE'
          name: 'TypeError'
          stack: |-
            node:internal/deps/undici/undici:14902:13
            process.processTicksAndRejections (node:internal/process/task_queues:95:5)
            async TestContext.<anonymous> (file:///app/__tests__/phase3/section-g-telemetry.test.js:108:19)
            async Test.run (node:internal/test_runner/test:797:9)
            async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
          ...
        # Subtest: Feedback endpoint accepts telemetry data
        not ok 3 - Feedback endpoint accepts telemetry data
          ---
          duration_ms: 4.857331
          location: '/app/__tests__/phase3/section-g-telemetry.test.js:124:5'
          failureType: 'testCodeFailure'
          error: 'fetch failed'
          code: 'ERR_TEST_FAILURE'
          name: 'TypeError'
          stack: |-
            node:internal/deps/undici/undici:14902:13
            process.processTicksAndRejections (node:internal/process/task_queues:95:5)
            async TestContext.<anonymous> (file:///app/__tests__/phase3/section-g-telemetry.test.js:126:23)
            async Test.run (node:internal/test_runner/test:797:9)
            async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
          ...
        1..3
    not ok 2 - G2: Telemetry JSON Format
      ---
      duration_ms: 110.777903
      type: 'suite'
      location: '/app/__tests__/phase3/section-g-telemetry.test.js:96:3'
      failureType: 'subtestsFailed'
      error: '3 subtests failed'
      code: 'ERR_TEST_FAILURE'
      ...
    # Subtest: G3: Log Structure Validation
        # Subtest: Worker logs are parseable
        ok 1 - Worker logs are parseable
          ---
          duration_ms: 1.233497
          ...
        # Subtest: Timestamps are included in processing logs
        ok 2 - Timestamps are included in processing logs
          ---
          duration_ms: 2.654902
          ...
        1..2
    ok 3 - G3: Log Structure Validation
      ---
      duration_ms: 4.447301
      type: 'suite'
      ...
    1..3
not ok 50 - Section G: Telemetry & Observability Verification
  ---
  duration_ms: 129.762183
  type: 'suite'
  location: '/app/__tests__/phase3/section-g-telemetry.test.js:27:1'
  failureType: 'subtestsFailed'
  error: '2 subtests failed'
  code: 'ERR_TEST_FAILURE'
  ...
# Subtest: Section H: End-to-End Flow Verification
    # Subtest: H.1: E2E Flow - Happy Path
        # Subtest: Step 1: Trigger endpoint is accessible and returns valid response
        ok 1 - Step 1: Trigger endpoint is accessible and returns valid response
          ---
          duration_ms: 194.342068
          ...
# Note: Suggestion creation returned: 404 {
#   status: 'error',
#   code: 'NOT_FOUND',
#   message: 'Route POST /api/ai/suggestions not found'
# }
# Skipping: No test suggestion was created
# Skipping: No test suggestion was created
# Skipping: No test suggestion was created
        # Subtest: Step 2: Create a test suggestion to simulate trigger output
        ok 2 - Step 2: Create a test suggestion to simulate trigger output
          ---
          duration_ms: 54.478044
          ...
        # Subtest: Step 3: Suggestion appears in queue with pending status
        ok 3 - Step 3: Suggestion appears in queue with pending status
          ---
          duration_ms: 1.187982
          ...
        # Subtest: Step 4: Review and approve the suggestion
        ok 4 - Step 4: Review and approve the suggestion
          ---
          duration_ms: 0.734964
          ...
        # Subtest: Step 5: Apply endpoint handles approved suggestion
        ok 5 - Step 5: Apply endpoint handles approved suggestion
          ---
          duration_ms: 1.03422
          ...
        1..5
    ok 1 - H.1: E2E Flow - Happy Path
      ---
      duration_ms: 255.870564
      type: 'suite'
      ...
# Skipping state test: Could not create suggestion
    # Subtest: H.2: State Machine Verification
        # Subtest: Pending → Approved transition is valid
        ok 1 - Pending → Approved transition is valid
          ---
          duration_ms: 48.150979
          ...
# Skipping state test: Could not create suggestion
        # Subtest: Pending → Rejected transition is valid
        ok 2 - Pending → Rejected transition is valid
          ---
          duration_ms: 11.882381
          ...
# Skipping state test: Could not create suggestion
        # Subtest: Invalid transition (Rejected → Applied) should fail or be prevented
        ok 3 - Invalid transition (Rejected → Applied) should fail or be prevented
          ---
          duration_ms: 11.599983
          ...
        1..3
    ok 2 - H.2: State Machine Verification
      ---
      duration_ms: 73.551262
      type: 'suite'
      ...
    # Subtest: H.3: Telemetry Emission Verification
        # Subtest: Telemetry endpoint captures events during flow
        ok 1 - Telemetry endpoint captures events during flow
          ---
          duration_ms: 11.399195
          ...
        # Subtest: System logs endpoint accessible for audit trail
        ok 2 - System logs endpoint accessible for audit trail
          ---
          duration_ms: 188.395208
          ...
        1..2
    ok 3 - H.3: Telemetry Emission Verification
      ---
      duration_ms: 200.7944
      type: 'suite'
      ...
    # Subtest: H.4: Error Handling & Edge Cases
        # Subtest: Trigger with invalid payload is handled gracefully
        ok 1 - Trigger with invalid payload is handled gracefully
          ---
          duration_ms: 7.309112
          ...
        # Subtest: Apply on non-existent suggestion returns 404
        ok 2 - Apply on non-existent suggestion returns 404
          ---
          duration_ms: 11.643364
          ...
        # Subtest: Missing tenant header is handled appropriately
        ok 3 - Missing tenant header is handled appropriately
          ---
          duration_ms: 13.767922
          ...
        1..3
    ok 4 - H.4: Error Handling & Edge Cases
      ---
      duration_ms: 33.504583
      type: 'suite'
      ...
    # Subtest: H.5: Performance & Timing
        # Subtest: Trigger endpoint responds within 5 seconds
        ok 1 - Trigger endpoint responds within 5 seconds
          ---
          duration_ms: 10.89676
          ...
        # Subtest: Suggestion list query responds within 2 seconds
        ok 2 - Suggestion list query responds within 2 seconds
          ---
          duration_ms: 11.48705
          ...
# Skipping timing test: Could not create suggestion
        # Subtest: Apply operation responds within 10 seconds
        ok 3 - Apply operation responds within 10 seconds
          ---
          duration_ms: 15.58672
          ...
        1..3
    ok 5 - H.5: Performance & Timing
      ---
      duration_ms: 39.016507
      type: 'suite'
      ...
    1..5
ok 51 - Section H: End-to-End Flow Verification
  ---
  duration_ms: 609.871269
  type: 'suite'
  ...
# ✅ Phase 6: Developer AI Safety Tests
# Subtest: Phase 6: Command Safety Classification
    # Subtest: Safe Commands (Auto-Execute)
        # Subtest: should allow docker ps
        ok 1 - should allow docker ps
          ---
          duration_ms: 10.481984
          ...
        # Subtest: should allow docker logs with tail
        ok 2 - should allow docker logs with tail
          ---
          duration_ms: 2.395174
          ...
        # Subtest: should allow systemctl status
        ok 3 - should allow systemctl status
          ---
          duration_ms: 4.661305
          ...
        # Subtest: should allow health check curl
        ok 4 - should allow health check curl
          ---
          duration_ms: 2.206102
          ...
        # Subtest: should allow safe file reads
        ok 5 - should allow safe file reads
          ---
          duration_ms: 1.526336
          ...
        # Subtest: should allow git status
        ok 6 - should allow git status
          ---
          duration_ms: 3.291685
          ...
        1..6
    ok 1 - Safe Commands (Auto-Execute)
      ---
      duration_ms: 29.298641
      type: 'suite'
      ...
    # Subtest: Blocked Commands
        # Subtest: should block rm -rf
        ok 1 - should block rm -rf
          ---
          duration_ms: 0.623995
          ...
        # Subtest: should block sudo commands
        ok 2 - should block sudo commands
          ---
          duration_ms: 0.580095
          ...
        # Subtest: should block ssh
        ok 3 - should block ssh
          ---
          duration_ms: 0.678107
          ...
        # Subtest: should block env variable access
        ok 4 - should block env variable access
          ---
          duration_ms: 0.536974
          ...
        # Subtest: should block reading .env files
        ok 5 - should block reading .env files
          ---
          duration_ms: 0.546157
          ...
        1..5
    ok 2 - Blocked Commands
      ---
      duration_ms: 4.074592
      type: 'suite'
      ...
    # Subtest: Approval-Required Commands
        # Subtest: should require approval for chmod
        ok 1 - should require approval for chmod
          ---
          duration_ms: 0.746343
          ...
        # Subtest: should require approval for npm install
        ok 2 - should require approval for npm install
          ---
          duration_ms: 0.587621
          ...
        # Subtest: should require approval for unknown commands
        ok 3 - should require approval for unknown commands
          ---
          duration_ms: 1.192241
          ...
        1..3
    ok 3 - Approval-Required Commands
      ---
      duration_ms: 2.977968
      type: 'suite'
      ...
    # Subtest: File Operations
        # Subtest: should allow read operations on safe files
        ok 1 - should allow read operations on safe files
          ---
          duration_ms: 2.267723
          ...
        # Subtest: should block reading .env files
        ok 2 - should block reading .env files
          ---
          duration_ms: 0.527029
          ...
        # Subtest: should require approval for write operations
        ok 3 - should require approval for write operations
          ---
          duration_ms: 0.399566
          ...
        # Subtest: should block delete operations
        ok 4 - should block delete operations
          ---
          duration_ms: 0.884693
          ...
        1..4
    ok 4 - File Operations
      ---
      duration_ms: 4.690482
      type: 'suite'
      ...
    1..4
ok 52 - Phase 6: Command Safety Classification
  ---
  duration_ms: 44.178991
  type: 'suite'
  ...
# Subtest: Phase 6: Secret Redaction
    # Subtest: should redact JWT tokens
    ok 1 - should redact JWT tokens
      ---
      duration_ms: 2.97601
      ...
    # Subtest: should redact Bearer tokens
    ok 2 - should redact Bearer tokens
      ---
      duration_ms: 3.569174
      ...
    # Subtest: should redact API keys
    ok 3 - should redact API keys
      ---
      duration_ms: 0.784144
      ...
    # Subtest: should redact Supabase keys
    ok 4 - should redact Supabase keys
      ---
      duration_ms: 0.685017
      ...
    # Subtest: should redact secrets from objects
    ok 5 - should redact secrets from objects
      ---
      duration_ms: 1.246598
      ...
    # Subtest: should handle nested objects
    ok 6 - should handle nested objects
      ---
      duration_ms: 0.691957
      ...
    1..6
ok 53 - Phase 6: Secret Redaction
  ---
  duration_ms: 11.64766
  type: 'suite'
  ...
# Subtest: Phase 6: Path Safety Validation
    # Subtest: should allow safe paths
    ok 1 - should allow safe paths
      ---
      duration_ms: 6.021465
      ...
    # Subtest: should block path traversal
    ok 2 - should block path traversal
      ---
      duration_ms: 0.432974
      ...
    # Subtest: should block .env files
    ok 3 - should block .env files
      ---
      duration_ms: 0.515914
      ...
    # Subtest: should block key files
    ok 4 - should block key files
      ---
      duration_ms: 0.383896
      ...
    # Subtest: should block secrets directories
    ok 5 - should block secrets directories
      ---
      duration_ms: 0.385196
      ...
    # Subtest: Export Safety
        # Subtest: should allow exportable source files
        ok 1 - should allow exportable source files
          ---
          duration_ms: 1.82778
          ...
        # Subtest: should block node_modules
        ok 2 - should block node_modules
          ---
          duration_ms: 1.839397
          ...
        # Subtest: should block build artifacts
        ok 3 - should block build artifacts
          ---
          duration_ms: 5.386149
          ...
        # Subtest: should block log files
        ok 4 - should block log files
          ---
          duration_ms: 0.48447
          ...
        1..4
    ok 6 - Export Safety
      ---
      duration_ms: 9.978284
      type: 'suite'
      ...
    1..6
ok 54 - Phase 6: Path Safety Validation
  ---
  duration_ms: 18.295394
  type: 'suite'
  ...
# Subtest: Phase 6: Integration Tests
    # Subtest: should create approval record in database
    ok 1 - should create approval record in database # SKIP
      ---
      duration_ms: 0.170017
      ...
    # Subtest: should execute approved action
    ok 2 - should execute approved action # SKIP
      ---
      duration_ms: 0.131485
      ...
    # Subtest: should create export bundle with manifest
    ok 3 - should create export bundle with manifest # SKIP
      ---
      duration_ms: 0.166756
      ...
    1..3
ok 55 - Phase 6: Integration Tests
  ---
  duration_ms: 0.964126
  type: 'suite'
  ...
# Subtest: Accounts Routes
    # Subtest: GET /api/accounts returns 200 with tenant_id
    not ok 1 - GET /api/accounts returns 200 with tenant_id
      ---
      duration_ms: 0
      location: '/app/__tests__/routes/accounts.route.test.js:75:3'
      failureType: 'cancelledByParent'
      error: 'test did not finish before its parent and was cancelled'
      code: 'ERR_TEST_FAILURE'
      ...
    # Subtest: GET /api/accounts/:id returns specific account
    not ok 2 - GET /api/accounts/:id returns specific account
      ---
      duration_ms: 0
      location: '/app/__tests__/routes/accounts.route.test.js:84:3'
      failureType: 'cancelledByParent'
      error: 'test did not finish before its parent and was cancelled'
      code: 'ERR_TEST_FAILURE'
      ...
    # Subtest: GET /api/accounts/:id enforces tenant scoping
    not ok 3 - GET /api/accounts/:id enforces tenant scoping
      ---
      duration_ms: 0
      location: '/app/__tests__/routes/accounts.route.test.js:98:3'
      failureType: 'cancelledByParent'
      error: 'test did not finish before its parent and was cancelled'
      code: 'ERR_TEST_FAILURE'
      ...
    # Subtest: PUT /api/accounts/:id updates account
    not ok 4 - PUT /api/accounts/:id updates account
      ---
      duration_ms: 0
      location: '/app/__tests__/routes/accounts.route.test.js:108:3'
      failureType: 'cancelledByParent'
      error: 'test did not finish before its parent and was cancelled'
      code: 'ERR_TEST_FAILURE'
      ...
    # Subtest: DELETE /api/accounts/:id removes account
    not ok 5 - DELETE /api/accounts/:id removes account
      ---
      duration_ms: 0
      location: '/app/__tests__/routes/accounts.route.test.js:126:3'
      failureType: 'cancelledByParent'
      error: 'test did not finish before its parent and was cancelled'
      code: 'ERR_TEST_FAILURE'
      ...
    # Subtest: GET /api/accounts supports type filter
    not ok 6 - GET /api/accounts supports type filter
      ---
      duration_ms: 0
      location: '/app/__tests__/routes/accounts.route.test.js:145:3'
      failureType: 'cancelledByParent'
      error: 'test did not finish before its parent and was cancelled'
      code: 'ERR_TEST_FAILURE'
      ...
    # Subtest: POST /api/accounts requires tenant_id
    not ok 7 - POST /api/accounts requires tenant_id
      ---
      duration_ms: 0
      location: '/app/__tests__/routes/accounts.route.test.js:158:3'
      failureType: 'cancelledByParent'
      error: 'test did not finish before its parent and was cancelled'
      code: 'ERR_TEST_FAILURE'
      ...
    # Subtest: POST /api/accounts creates account with metadata
    not ok 8 - POST /api/accounts creates account with metadata
      ---
      duration_ms: 0
      location: '/app/__tests__/routes/accounts.route.test.js:169:3'
      failureType: 'cancelledByParent'
      error: 'test did not finish before its parent and was cancelled'
      code: 'ERR_TEST_FAILURE'
      ...
    # Subtest: GET /api/accounts/search returns matching accounts
    not ok 9 - GET /api/accounts/search returns matching accounts
      ---
      duration_ms: 0
      location: '/app/__tests__/routes/accounts.route.test.js:191:3'
      failureType: 'cancelledByParent'
      error: 'test did not finish before its parent and was cancelled'
      code: 'ERR_TEST_FAILURE'
      ...
    # Subtest: GET /api/accounts/search requires q parameter
    not ok 10 - GET /api/accounts/search requires q parameter
      ---
      duration_ms: 0
      location: '/app/__tests__/routes/accounts.route.test.js:200:3'
      failureType: 'cancelledByParent'
      error: 'test did not finish before its parent and was cancelled'
      code: 'ERR_TEST_FAILURE'
      ...
    # Subtest: GET /api/accounts/search requires tenant_id
    not ok 11 - GET /api/accounts/search requires tenant_id
      ---
      duration_ms: 0
      location: '/app/__tests__/routes/accounts.route.test.js:207:3'
      failureType: 'cancelledByParent'
      error: 'test did not finish before its parent and was cancelled'
      code: 'ERR_TEST_FAILURE'
      ...
    1..11
not ok 56 - Accounts Routes
  ---
  duration_ms: 259.627993
  type: 'suite'
  location: '/app/__tests__/routes/accounts.route.test.js:42:1'
  failureType: 'hookFailed'
  error: 'create account A failed: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    SuiteContext.<anonymous> (file:///app/__tests__/routes/accounts.route.test.js:52:12)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
    async Suite.runHook (node:internal/test_runner/test:723:9)
    async Suite.run (node:internal/test_runner/test:1129:7)
    async Test.processPendingSubtests (node:internal/test_runner/test:526:7)
  ...
# Subtest: Accounts V2 - tenant_id validation for GET by ID
    # Subtest: GET /api/v2/accounts/:id WITH tenant_id returns 200
    not ok 1 - GET /api/v2/accounts/:id WITH tenant_id returns 200
      ---
      duration_ms: 0
      location: '/app/__tests__/routes/accounts.v2.tenant-validation.test.js:57:3'
      failureType: 'cancelledByParent'
      error: 'test did not finish before its parent and was cancelled'
      code: 'ERR_TEST_FAILURE'
      ...
    # Subtest: GET /api/v2/accounts/:id WITHOUT tenant_id returns 400
    not ok 2 - GET /api/v2/accounts/:id WITHOUT tenant_id returns 400
      ---
      duration_ms: 0
      location: '/app/__tests__/routes/accounts.v2.tenant-validation.test.js:66:3'
      failureType: 'cancelledByParent'
      error: 'test did not finish before its parent and was cancelled'
      code: 'ERR_TEST_FAILURE'
      ...
    # Subtest: GET /api/v2/accounts/:id with WRONG tenant_id returns 404
    not ok 3 - GET /api/v2/accounts/:id with WRONG tenant_id returns 404
      ---
      duration_ms: 0
      location: '/app/__tests__/routes/accounts.v2.tenant-validation.test.js:75:3'
      failureType: 'cancelledByParent'
      error: 'test did not finish before its parent and was cancelled'
      code: 'ERR_TEST_FAILURE'
      ...
    # Subtest: GET /api/v2/accounts/:id with empty tenant_id returns 400
    not ok 4 - GET /api/v2/accounts/:id with empty tenant_id returns 400
      ---
      duration_ms: 0
      location: '/app/__tests__/routes/accounts.v2.tenant-validation.test.js:84:3'
      failureType: 'cancelledByParent'
      error: 'test did not finish before its parent and was cancelled'
      code: 'ERR_TEST_FAILURE'
      ...
    1..4
not ok 57 - Accounts V2 - tenant_id validation for GET by ID
  ---
  duration_ms: 151.105751
  type: 'suite'
  location: '/app/__tests__/routes/accounts.v2.tenant-validation.test.js:41:1'
  failureType: 'hookFailed'
  error: 'fetch failed'
  code: 'ERR_TEST_FAILURE'
  name: 'TypeError'
  stack: |-
    node:internal/deps/undici/undici:14902:13
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async createTestAccount (file:///app/__tests__/routes/accounts.v2.tenant-validation.test.js:17:15)
    async SuiteContext.<anonymous> (file:///app/__tests__/routes/accounts.v2.tenant-validation.test.js:44:20)
    async TestHook.run (node:internal/test_runner/test:797:9)
    async Suite.runHook (node:internal/test_runner/test:723:9)
    async Suite.run (node:internal/test_runner/test:1129:7)
    async Test.processPendingSubtests (node:internal/test_runner/test:526:7)
  ...
# Test cleanup complete.
# Subtest: GET /api/v2/activities returns list with tenant_id
not ok 58 - GET /api/v2/activities returns list with tenant_id
  ---
  duration_ms: 32.675393
  location: '/app/__tests__/routes/activities.filters.test.js:112:32'
  failureType: 'hookFailed'
  error: 'fetch failed'
  code: 'ERR_TEST_FAILURE'
  name: 'TypeError'
  stack: |-
    node:internal/deps/undici/undici:14902:13
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async createActivity (file:///app/__tests__/routes/activities.filters.test.js:25:15)
    async TestContext.<anonymous> (file:///app/__tests__/routes/activities.filters.test.js:74:13)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: Filter by status=scheduled returns scheduled activities
not ok 59 - Filter by status=scheduled returns scheduled activities
  ---
  duration_ms: 4.767135
  location: '/app/__tests__/routes/activities.filters.test.js:123:32'
  failureType: 'hookFailed'
  error: 'fetch failed'
  code: 'ERR_TEST_FAILURE'
  name: 'TypeError'
  stack: |-
    node:internal/deps/undici/undici:14902:13
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async createActivity (file:///app/__tests__/routes/activities.filters.test.js:25:15)
    async TestContext.<anonymous> (file:///app/__tests__/routes/activities.filters.test.js:74:13)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: Filter by is_test_data=true returns test activities
not ok 60 - Filter by is_test_data=true returns test activities
  ---
  duration_ms: 0.159043
  location: '/app/__tests__/routes/activities.filters.test.js:139:32'
  failureType: 'hookFailed'
  error: 'fetch failed'
  code: 'ERR_TEST_FAILURE'
  name: 'TypeError'
  stack: |-
    node:internal/deps/undici/undici:14902:13
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async createActivity (file:///app/__tests__/routes/activities.filters.test.js:25:15)
    async TestContext.<anonymous> (file:///app/__tests__/routes/activities.filters.test.js:74:13)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: Filter by is_test_data=false excludes test activities
not ok 61 - Filter by is_test_data=false excludes test activities
  ---
  duration_ms: 0.125002
  location: '/app/__tests__/routes/activities.filters.test.js:161:32'
  failureType: 'hookFailed'
  error: 'fetch failed'
  code: 'ERR_TEST_FAILURE'
  name: 'TypeError'
  stack: |-
    node:internal/deps/undici/undici:14902:13
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async createActivity (file:///app/__tests__/routes/activities.filters.test.js:25:15)
    async TestContext.<anonymous> (file:///app/__tests__/routes/activities.filters.test.js:74:13)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: Pagination with limit and offset works
not ok 62 - Pagination with limit and offset works
  ---
  duration_ms: 0.270185
  location: '/app/__tests__/routes/activities.filters.test.js:177:32'
  failureType: 'hookFailed'
  error: 'fetch failed'
  code: 'ERR_TEST_FAILURE'
  name: 'TypeError'
  stack: |-
    node:internal/deps/undici/undici:14902:13
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async createActivity (file:///app/__tests__/routes/activities.filters.test.js:25:15)
    async TestContext.<anonymous> (file:///app/__tests__/routes/activities.filters.test.js:74:13)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: AI timezone inputs retain local components and capture original ISO
not ok 63 - AI timezone inputs retain local components and capture original ISO
  ---
  duration_ms: 0.120667
  location: '/app/__tests__/routes/activities.filters.test.js:208:32'
  failureType: 'hookFailed'
  error: 'fetch failed'
  code: 'ERR_TEST_FAILURE'
  name: 'TypeError'
  stack: |-
    node:internal/deps/undici/undici:14902:13
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async createActivity (file:///app/__tests__/routes/activities.filters.test.js:25:15)
    async TestContext.<anonymous> (file:///app/__tests__/routes/activities.filters.test.js:74:13)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/v2/activities/:id returns single activity
not ok 64 - GET /api/v2/activities/:id returns single activity
  ---
  duration_ms: 0.350923
  location: '/app/__tests__/routes/activities.filters.test.js:233:32'
  failureType: 'hookFailed'
  error: 'fetch failed'
  code: 'ERR_TEST_FAILURE'
  name: 'TypeError'
  stack: |-
    node:internal/deps/undici/undici:14902:13
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async createActivity (file:///app/__tests__/routes/activities.filters.test.js:25:15)
    async TestContext.<anonymous> (file:///app/__tests__/routes/activities.filters.test.js:74:13)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: Filter by type=task returns task activities
not ok 65 - Filter by type=task returns task activities
  ---
  duration_ms: 0.136301
  location: '/app/__tests__/routes/activities.filters.test.js:252:32'
  failureType: 'hookFailed'
  error: 'fetch failed'
  code: 'ERR_TEST_FAILURE'
  name: 'TypeError'
  stack: |-
    node:internal/deps/undici/undici:14902:13
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async createActivity (file:///app/__tests__/routes/activities.filters.test.js:25:15)
    async TestContext.<anonymous> (file:///app/__tests__/routes/activities.filters.test.js:74:13)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: include_stats=true returns activity counts
not ok 66 - include_stats=true returns activity counts
  ---
  duration_ms: 0.35987
  location: '/app/__tests__/routes/activities.filters.test.js:265:32'
  failureType: 'hookFailed'
  error: 'fetch failed'
  code: 'ERR_TEST_FAILURE'
  name: 'TypeError'
  stack: |-
    node:internal/deps/undici/undici:14902:13
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async createActivity (file:///app/__tests__/routes/activities.filters.test.js:25:15)
    async TestContext.<anonymous> (file:///app/__tests__/routes/activities.filters.test.js:74:13)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: Filter with $or and $regex operators works correctly
not ok 67 - Filter with $or and $regex operators works correctly
  ---
  duration_ms: 0.177195
  location: '/app/__tests__/routes/activities.filters.test.js:282:32'
  failureType: 'hookFailed'
  error: 'fetch failed'
  code: 'ERR_TEST_FAILURE'
  name: 'TypeError'
  stack: |-
    node:internal/deps/undici/undici:14902:13
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async createActivity (file:///app/__tests__/routes/activities.filters.test.js:25:15)
    async TestContext.<anonymous> (file:///app/__tests__/routes/activities.filters.test.js:74:13)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: Filter with special characters in $regex pattern
not ok 68 - Filter with special characters in $regex pattern
  ---
  duration_ms: 0.070562
  location: '/app/__tests__/routes/activities.filters.test.js:321:32'
  failureType: 'hookFailed'
  error: 'fetch failed'
  code: 'ERR_TEST_FAILURE'
  name: 'TypeError'
  stack: |-
    node:internal/deps/undici/undici:14902:13
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async createActivity (file:///app/__tests__/routes/activities.filters.test.js:25:15)
    async TestContext.<anonymous> (file:///app/__tests__/routes/activities.filters.test.js:74:13)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/v2/activities returns 200 with tenant_id and includes total
not ok 69 - GET /api/v2/activities returns 200 with tenant_id and includes total
  ---
  duration_ms: 92.662893
  location: '/app/__tests__/routes/activities.route.test.js:47:32'
  failureType: 'hookFailed'
  error: 'create activity A failed: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/activities.route.test.js:32:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/v2/activities supports search query param
not ok 70 - GET /api/v2/activities supports search query param
  ---
  duration_ms: 2.400496
  location: '/app/__tests__/routes/activities.route.test.js:57:32'
  failureType: 'hookFailed'
  error: 'create activity A failed: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/activities.route.test.js:32:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/v2/activities supports status filter
not ok 71 - GET /api/v2/activities supports status filter
  ---
  duration_ms: 0.293942
  location: '/app/__tests__/routes/activities.route.test.js:65:32'
  failureType: 'hookFailed'
  error: 'create activity A failed: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/activities.route.test.js:32:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/v2/activities requires tenant_id
not ok 72 - GET /api/v2/activities requires tenant_id
  ---
  duration_ms: 1.285494
  location: '/app/__tests__/routes/activities.route.test.js:72:32'
  failureType: 'hookFailed'
  error: 'create activity A failed: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/activities.route.test.js:32:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: AI Routes
    # Subtest: GET /api/ai/assistants returns list of assistants
    ok 1 - GET /api/ai/assistants returns list of assistants
      ---
      duration_ms: 191.83897
      ...
    # Subtest: GET /api/ai/conversations returns conversations list
    not ok 2 - GET /api/ai/conversations returns conversations list
      ---
      duration_ms: 22.52167
      location: '/app/__tests__/routes/ai.route.test.js:26:3'
      failureType: 'testCodeFailure'
      error: 'expected 200 or 500, got 401'
      code: 'ERR_ASSERTION'
      name: 'AssertionError'
      expected: true
      actual: false
      operator: '=='
      stack: |-
        TestContext.<anonymous> (file:///app/__tests__/routes/ai.route.test.js:28:12)
        process.processTicksAndRejections (node:internal/process/task_queues:95:5)
        async Test.run (node:internal/test_runner/test:797:9)
        async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
      ...
    # Subtest: POST /api/ai/chat returns 400 without message
    ok 3 - POST /api/ai/chat returns 400 without message
      ---
      duration_ms: 35.875518
      ...
    # Subtest: POST /api/ai/summarize handles missing text
    ok 4 - POST /api/ai/summarize handles missing text
      ---
      duration_ms: 19.639016
      ...
    # Subtest: POST /api/ai/sentiment handles missing text
    ok 5 - POST /api/ai/sentiment handles missing text
      ---
      duration_ms: 25.390892
      ...
    # Subtest: GET /api/ai/context returns context info
    ok 6 - GET /api/ai/context returns context info
      ---
      duration_ms: 17.962163
      ...
    # Subtest: GET /api/ai/tools returns available tools or 404
    ok 7 - GET /api/ai/tools returns available tools or 404
      ---
      duration_ms: 16.632747
      ...
    # Subtest: POST /api/ai/brain-test requires auth key
    ok 8 - POST /api/ai/brain-test requires auth key
      ---
      duration_ms: 28.621991
      ...
    # Subtest: DELETE /api/ai/conversations/:id validates conversation exists
    not ok 9 - DELETE /api/ai/conversations/:id validates conversation exists
      ---
      duration_ms: 42.576368
      location: '/app/__tests__/routes/ai.route.test.js:102:3'
      failureType: 'testCodeFailure'
      error: 'expected 200 or 404, got 401'
      code: 'ERR_ASSERTION'
      name: 'AssertionError'
      expected: true
      actual: false
      operator: '=='
      stack: |-
        TestContext.<anonymous> (file:///app/__tests__/routes/ai.route.test.js:108:12)
        process.processTicksAndRejections (node:internal/process/task_queues:95:5)
        async Test.run (node:internal/test_runner/test:797:9)
        async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
      ...
    1..9
not ok 73 - AI Routes
  ---
  duration_ms: 410.394144
  type: 'suite'
  location: '/app/__tests__/routes/ai.route.test.js:9:1'
  failureType: 'subtestsFailed'
  error: '2 subtests failed'
  code: 'ERR_TEST_FAILURE'
  ...
# Subtest: AI Realtime Routes
    # Subtest: GET /api/ai/realtime-token requires authentication
    ok 1 - GET /api/ai/realtime-token requires authentication
      ---
      duration_ms: 189.951237
      ...
    # Subtest: POST /api/ai/realtime-session requires authentication
    ok 2 - POST /api/ai/realtime-session requires authentication
      ---
      duration_ms: 39.436818
      ...
    # Subtest: POST /api/ai/realtime-session with invalid data returns 400
    ok 3 - POST /api/ai/realtime-session with invalid data returns 400
      ---
      duration_ms: 25.409813
      ...
    # Subtest: GET /api/ai/realtime-config returns config or 404
    ok 4 - GET /api/ai/realtime-config returns config or 404
      ---
      duration_ms: 25.794611
      ...
    # Subtest: POST /api/ai/realtime-event validates event format
    ok 5 - POST /api/ai/realtime-event validates event format
      ---
      duration_ms: 12.234319
      ...
    1..5
ok 74 - AI Realtime Routes
  ---
  duration_ms: 299.12174
  type: 'suite'
  ...
# Subtest: AI Settings Routes
    # Subtest: GET /api/ai-settings returns AI settings
    ok 1 - GET /api/ai-settings returns AI settings
      ---
      duration_ms: 377.906439
      ...
    # Subtest: PUT /api/ai-settings/:id updates AI settings
    ok 2 - PUT /api/ai-settings/:id updates AI settings
      ---
      duration_ms: 340.387425
      ...
    # Subtest: GET /api/ai-settings/categories returns categories
    ok 3 - GET /api/ai-settings/categories returns categories
      ---
      duration_ms: 111.124388
      ...
    # Subtest: POST /api/ai-settings/reset resets to defaults
    ok 4 - POST /api/ai-settings/reset resets to defaults
      ---
      duration_ms: 133.469238
      ...
    # Subtest: POST /api/ai-settings/clear-cache clears cache
    ok 5 - POST /api/ai-settings/clear-cache clears cache
      ---
      duration_ms: 8.141293
      ...
    1..5
ok 75 - AI Settings Routes
  ---
  duration_ms: 983.123644
  type: 'suite'
  ...
# Subtest: AI Campaigns Routes
    # Subtest: GET /api/aicampaigns returns 200 with tenant_id
    not ok 1 - GET /api/aicampaigns returns 200 with tenant_id
      ---
      duration_ms: 75.326463
      location: '/app/__tests__/routes/aicampaigns.route.test.js:49:3'
      failureType: 'testCodeFailure'
      error: |-
        expected 200 from campaigns list
        
        401 !== 200
        
      code: 'ERR_ASSERTION'
      name: 'AssertionError'
      expected: 200
      actual: 401
      operator: 'strictEqual'
      stack: |-
        TestContext.<anonymous> (file:///app/__tests__/routes/aicampaigns.route.test.js:51:12)
        process.processTicksAndRejections (node:internal/process/task_queues:95:5)
        async Test.run (node:internal/test_runner/test:797:9)
        async Promise.all (index 0)
        async Suite.run (node:internal/test_runner/test:1135:7)
        async Test.processPendingSubtests (node:internal/test_runner/test:526:7)
      ...
    # Subtest: POST /api/aicampaigns creates new campaign
    not ok 2 - POST /api/aicampaigns creates new campaign
      ---
      duration_ms: 34.424057
      location: '/app/__tests__/routes/aicampaigns.route.test.js:57:3'
      failureType: 'testCodeFailure'
      error: 'expected 200 or 201, got 401: {"status":"error","message":"Authentication required"}'
      code: 'ERR_ASSERTION'
      name: 'AssertionError'
      expected: true
      actual: false
      operator: '=='
      stack: |-
        TestContext.<anonymous> (file:///app/__tests__/routes/aicampaigns.route.test.js:70:12)
        process.processTicksAndRejections (node:internal/process/task_queues:95:5)
        async Test.run (node:internal/test_runner/test:797:9)
        async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
      ...
    # Subtest: POST /api/aicampaigns requires name
    not ok 3 - POST /api/aicampaigns requires name
      ---
      duration_ms: 40.278449
      location: '/app/__tests__/routes/aicampaigns.route.test.js:76:3'
      failureType: 'testCodeFailure'
      error: 'expected 400, 422, or 500, got 401'
      code: 'ERR_ASSERTION'
      name: 'AssertionError'
      expected: true
      actual: false
      operator: '=='
      stack: |-
        TestContext.<anonymous> (file:///app/__tests__/routes/aicampaigns.route.test.js:83:12)
        process.processTicksAndRejections (node:internal/process/task_queues:95:5)
        async Test.run (node:internal/test_runner/test:797:9)
        async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
      ...
    # Subtest: GET /api/aicampaigns/:id returns specific campaign
    ok 4 - GET /api/aicampaigns/:id returns specific campaign
      ---
      duration_ms: 1.135588
      ...
    # Subtest: PUT /api/aicampaigns/:id updates campaign
    ok 5 - PUT /api/aicampaigns/:id updates campaign
      ---
      duration_ms: 2.416991
      ...
    # Subtest: POST /api/aicampaigns/:id/start initiates campaign
    ok 6 - POST /api/aicampaigns/:id/start initiates campaign
      ---
      duration_ms: 0.738856
      ...
    # Subtest: POST /api/aicampaigns/:id/pause pauses campaign
    ok 7 - POST /api/aicampaigns/:id/pause pauses campaign
      ---
      duration_ms: 1.351705
      ...
    # Subtest: GET /api/aicampaigns/:id/stats returns campaign statistics
    ok 8 - GET /api/aicampaigns/:id/stats returns campaign statistics
      ---
      duration_ms: 1.042903
      ...
    1..8
not ok 76 - AI Campaigns Routes
  ---
  duration_ms: 343.393003
  type: 'suite'
  location: '/app/__tests__/routes/aicampaigns.route.test.js:26:1'
  failureType: 'subtestsFailed'
  error: '3 subtests failed'
  code: 'ERR_TEST_FAILURE'
  ...
# Subtest: Announcements Routes
    # Subtest: GET /api/announcements returns announcements list
    ok 1 - GET /api/announcements returns announcements list
      ---
      duration_ms: 393.638806
      ...
    # Subtest: POST /api/announcements without required fields returns error
    ok 2 - POST /api/announcements without required fields returns error
      ---
      duration_ms: 33.423147
      ...
    # Subtest: POST /api/announcements with valid data creates announcement
    ok 3 - POST /api/announcements with valid data creates announcement
      ---
      duration_ms: 125.527829
      ...
    # Subtest: GET /api/announcements/:id returns specific announcement
    not ok 4 - GET /api/announcements/:id returns specific announcement
      ---
      duration_ms: 10.466028
      location: '/app/__tests__/routes/announcements.route.test.js:49:3'
      failureType: 'testCodeFailure'
      error: 'expected 200/401/404, got 400'
      code: 'ERR_ASSERTION'
      name: 'AssertionError'
      expected: true
      actual: false
      operator: '=='
      stack: |-
        TestContext.<anonymous> (file:///app/__tests__/routes/announcements.route.test.js:52:12)
        process.processTicksAndRejections (node:internal/process/task_queues:95:5)
        async Test.run (node:internal/test_runner/test:797:9)
        async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
      ...
    # Subtest: PUT /api/announcements/:id updates announcement
    not ok 5 - PUT /api/announcements/:id updates announcement
      ---
      duration_ms: 18.065849
      location: '/app/__tests__/routes/announcements.route.test.js:55:3'
      failureType: 'testCodeFailure'
      error: 'expected update response, got 400'
      code: 'ERR_ASSERTION'
      name: 'AssertionError'
      expected: true
      actual: false
      operator: '=='
      stack: |-
        TestContext.<anonymous> (file:///app/__tests__/routes/announcements.route.test.js:62:12)
        process.processTicksAndRejections (node:internal/process/task_queues:95:5)
        async Test.run (node:internal/test_runner/test:797:9)
        async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
      ...
    # Subtest: DELETE /api/announcements/:id requires auth
    not ok 6 - DELETE /api/announcements/:id requires auth
      ---
      duration_ms: 25.608201
      location: '/app/__tests__/routes/announcements.route.test.js:65:3'
      failureType: 'testCodeFailure'
      error: 'expected delete response, got 400'
      code: 'ERR_ASSERTION'
      name: 'AssertionError'
      expected: true
      actual: false
      operator: '=='
      stack: |-
        TestContext.<anonymous> (file:///app/__tests__/routes/announcements.route.test.js:70:12)
        process.processTicksAndRejections (node:internal/process/task_queues:95:5)
        async Test.run (node:internal/test_runner/test:797:9)
        async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
      ...
    # Subtest: POST /api/announcements/:id/dismiss marks announcement as dismissed
    ok 7 - POST /api/announcements/:id/dismiss marks announcement as dismissed
      ---
      duration_ms: 22.324628
      ...
    # Subtest: GET /api/announcements/active returns active announcements
    not ok 8 - GET /api/announcements/active returns active announcements
      ---
      duration_ms: 18.756069
      location: '/app/__tests__/routes/announcements.route.test.js:83:3'
      failureType: 'testCodeFailure'
      error: 'expected 200/401/404, got 400'
      code: 'ERR_ASSERTION'
      name: 'AssertionError'
      expected: true
      actual: false
      operator: '=='
      stack: |-
        TestContext.<anonymous> (file:///app/__tests__/routes/announcements.route.test.js:85:12)
        process.processTicksAndRejections (node:internal/process/task_queues:95:5)
        async Test.run (node:internal/test_runner/test:797:9)
        async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
      ...
    1..8
not ok 77 - Announcements Routes
  ---
  duration_ms: 654.818711
  type: 'suite'
  location: '/app/__tests__/routes/announcements.route.test.js:13:1'
  failureType: 'subtestsFailed'
  error: '4 subtests failed'
  code: 'ERR_TEST_FAILURE'
  ...
# Subtest: API Keys Routes
    # Subtest: GET /api/apikeys returns API keys list
    ok 1 - GET /api/apikeys returns API keys list
      ---
      duration_ms: 354.34133
      ...
    # Subtest: POST /api/apikeys without required fields returns error
    ok 2 - POST /api/apikeys without required fields returns error
      ---
      duration_ms: 43.210908
      ...
    # Subtest: POST /api/apikeys with valid data creates key
    not ok 3 - POST /api/apikeys with valid data creates key
      ---
      duration_ms: 144.941365
      location: '/app/__tests__/routes/apikeys.route.test.js:36:3'
      failureType: 'testCodeFailure'
      error: 'expected key data in response'
      code: 'ERR_ASSERTION'
      name: 'AssertionError'
      expected: true
      operator: '=='
      stack: |-
        TestContext.<anonymous> (file:///app/__tests__/routes/apikeys.route.test.js:51:14)
        process.processTicksAndRejections (node:internal/process/task_queues:95:5)
        async Test.run (node:internal/test_runner/test:797:9)
        async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
      ...
    # Subtest: GET /api/apikeys/:id returns specific API key
    not ok 4 - GET /api/apikeys/:id returns specific API key
      ---
      duration_ms: 26.018316
      location: '/app/__tests__/routes/apikeys.route.test.js:55:3'
      failureType: 'testCodeFailure'
      error: 'expected 200/401/404, got 400'
      code: 'ERR_ASSERTION'
      name: 'AssertionError'
      expected: true
      actual: false
      operator: '=='
      stack: |-
        TestContext.<anonymous> (file:///app/__tests__/routes/apikeys.route.test.js:58:12)
        process.processTicksAndRejections (node:internal/process/task_queues:95:5)
        async Test.run (node:internal/test_runner/test:797:9)
        async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
      ...
    # Subtest: PUT /api/apikeys/:id updates API key
    ok 5 - PUT /api/apikeys/:id updates API key
      ---
      duration_ms: 30.282727
      ...
    # Subtest: DELETE /api/apikeys/:id requires auth
    not ok 6 - DELETE /api/apikeys/:id requires auth
      ---
      duration_ms: 52.177703
      location: '/app/__tests__/routes/apikeys.route.test.js:74:3'
      failureType: 'testCodeFailure'
      error: 'expected delete response, got 400'
      code: 'ERR_ASSERTION'
      name: 'AssertionError'
      expected: true
      actual: false
      operator: '=='
      stack: |-
        TestContext.<anonymous> (file:///app/__tests__/routes/apikeys.route.test.js:79:12)
        process.processTicksAndRejections (node:internal/process/task_queues:95:5)
        async Test.run (node:internal/test_runner/test:797:9)
        async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
      ...
    1..6
not ok 78 - API Keys Routes
  ---
  duration_ms: 657.429642
  type: 'suite'
  location: '/app/__tests__/routes/apikeys.route.test.js:13:1'
  failureType: 'subtestsFailed'
  error: '3 subtests failed'
  code: 'ERR_TEST_FAILURE'
  ...
# Subtest: Audit Logs Routes
    # Subtest: GET /api/audit-logs returns audit logs list
    ok 1 - GET /api/audit-logs returns audit logs list
      ---
      duration_ms: 204.518427
      ...
    # Subtest: GET /api/audit-logs/:id returns specific audit log
    ok 2 - GET /api/audit-logs/:id returns specific audit log
      ---
      duration_ms: 73.122967
      ...
    # Subtest: GET /api/audit-logs with filters returns filtered results
    ok 3 - GET /api/audit-logs with filters returns filtered results
      ---
      duration_ms: 32.319443
      ...
    # Subtest: GET /api/audit-logs with date range filters
    ok 4 - GET /api/audit-logs with date range filters
      ---
      duration_ms: 50.231772
      ...
    # Subtest: GET /api/audit-logs with user filter
    ok 5 - GET /api/audit-logs with user filter
      ---
      duration_ms: 61.405856
      ...
    # Subtest: GET /api/audit-logs/export returns export data
    ok 6 - GET /api/audit-logs/export returns export data
      ---
      duration_ms: 41.517558
      ...
    # Subtest: GET /api/audit-logs/stats returns statistics
    ok 7 - GET /api/audit-logs/stats returns statistics
      ---
      duration_ms: 17.987162
      ...
    # Subtest: DELETE /api/audit-logs requires admin auth
    ok 8 - DELETE /api/audit-logs requires admin auth
      ---
      duration_ms: 13.466843
      ...
    1..8
ok 79 - Audit Logs Routes
  ---
  duration_ms: 500.413683
  type: 'suite'
  ...
# Subtest: Auth Routes
    # Subtest: POST /api/auth/verify-token returns 400 without token
    ok 1 - POST /api/auth/verify-token returns 400 without token
      ---
      duration_ms: 195.59407
      ...
    # Subtest: POST /api/auth/verify-token validates invalid token
    ok 2 - POST /api/auth/verify-token validates invalid token
      ---
      duration_ms: 58.739917
      ...
    # Subtest: POST /api/auth/login returns 400 without credentials
    ok 3 - POST /api/auth/login returns 400 without credentials
      ---
      duration_ms: 62.07633
      ...
    # Subtest: POST /api/auth/login returns error for invalid credentials
    ok 4 - POST /api/auth/login returns error for invalid credentials
      ---
      duration_ms: 218.452139
      ...
    # Subtest: POST /api/auth/forgot-password returns 400 without email
    ok 5 - POST /api/auth/forgot-password returns 400 without email
      ---
      duration_ms: 9.02863
      ...
    # Subtest: POST /api/auth/forgot-password handles non-existent email gracefully
    ok 6 - POST /api/auth/forgot-password handles non-existent email gracefully
      ---
      duration_ms: 13.522959
      ...
    # Subtest: POST /api/auth/logout clears cookies
    ok 7 - POST /api/auth/logout clears cookies
      ---
      duration_ms: 14.087152
      ...
    # Subtest: GET /api/auth/me without auth returns 401
    ok 8 - GET /api/auth/me without auth returns 401
      ---
      duration_ms: 5.360663
      ...
    # Subtest: POST /api/auth/refresh without cookie returns 401
    ok 9 - POST /api/auth/refresh without cookie returns 401
      ---
      duration_ms: 10.564077
      ...
    1..9
ok 80 - Auth Routes
  ---
  duration_ms: 595.233386
  type: 'suite'
  ...
# Subtest: GET /api/contacts returns 200 with tenant_id
not ok 81 - GET /api/contacts returns 200 with tenant_id
  ---
  duration_ms: 120.825108
  location: '/app/__tests__/routes/contacts.route.test.js:76:32'
  failureType: 'hookFailed'
  error: 'create contact A failed: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/contacts.route.test.js:52:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/contacts/:id returns specific contact
not ok 82 - GET /api/contacts/:id returns specific contact
  ---
  duration_ms: 5.749758
  location: '/app/__tests__/routes/contacts.route.test.js:85:32'
  failureType: 'hookFailed'
  error: 'create contact A failed: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/contacts.route.test.js:52:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/contacts/:id enforces tenant scoping
not ok 83 - GET /api/contacts/:id enforces tenant scoping
  ---
  duration_ms: 0.363017
  location: '/app/__tests__/routes/contacts.route.test.js:98:32'
  failureType: 'hookFailed'
  error: 'create contact A failed: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/contacts.route.test.js:52:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: PUT /api/contacts/:id updates contact
not ok 84 - PUT /api/contacts/:id updates contact
  ---
  duration_ms: 6.525165
  location: '/app/__tests__/routes/contacts.route.test.js:108:32'
  failureType: 'hookFailed'
  error: 'create contact A failed: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/contacts.route.test.js:52:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: DELETE /api/contacts/:id removes contact
not ok 85 - DELETE /api/contacts/:id removes contact
  ---
  duration_ms: 0.403899
  location: '/app/__tests__/routes/contacts.route.test.js:126:32'
  failureType: 'hookFailed'
  error: 'create contact A failed: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/contacts.route.test.js:52:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/contacts supports status filter
not ok 86 - GET /api/contacts supports status filter
  ---
  duration_ms: 0.288352
  location: '/app/__tests__/routes/contacts.route.test.js:146:32'
  failureType: 'hookFailed'
  error: 'create contact A failed: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/contacts.route.test.js:52:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: POST /api/contacts requires tenant_id
not ok 87 - POST /api/contacts requires tenant_id
  ---
  duration_ms: 0.240003
  location: '/app/__tests__/routes/contacts.route.test.js:159:32'
  failureType: 'hookFailed'
  error: 'create contact A failed: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/contacts.route.test.js:52:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/contacts/search returns matching contacts
not ok 88 - GET /api/contacts/search returns matching contacts
  ---
  duration_ms: 0.302296
  location: '/app/__tests__/routes/contacts.route.test.js:170:32'
  failureType: 'hookFailed'
  error: 'create contact A failed: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/contacts.route.test.js:52:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/contacts/search requires q parameter
not ok 89 - GET /api/contacts/search requires q parameter
  ---
  duration_ms: 1.622675
  location: '/app/__tests__/routes/contacts.route.test.js:179:32'
  failureType: 'hookFailed'
  error: 'create contact A failed: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/contacts.route.test.js:52:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/contacts/search requires tenant_id
not ok 90 - GET /api/contacts/search requires tenant_id
  ---
  duration_ms: 1.559213
  location: '/app/__tests__/routes/contacts.route.test.js:186:32'
  failureType: 'hookFailed'
  error: 'create contact A failed: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/contacts.route.test.js:52:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/cron/jobs returns 200 with tenant_id
ok 91 - GET /api/cron/jobs returns 200 with tenant_id
  ---
  duration_ms: 427.15982
  ...
# Subtest: GET /api/cron/jobs supports tenant_id filter
ok 92 - GET /api/cron/jobs supports tenant_id filter
  ---
  duration_ms: 18.346297
  ...
# Subtest: GET /api/cron/jobs supports is_active filter
ok 93 - GET /api/cron/jobs supports is_active filter
  ---
  duration_ms: 81.22964
  ...
# Subtest: POST /api/cron/jobs creates new cron job
ok 94 - POST /api/cron/jobs creates new cron job
  ---
  duration_ms: 85.76304
  ...
# Subtest: POST /api/cron/jobs requires name, schedule, function_name
ok 95 - POST /api/cron/jobs requires name, schedule, function_name
  ---
  duration_ms: 13.762228
  ...
# Subtest: GET /api/cron/jobs/:id returns specific job
ok 96 - GET /api/cron/jobs/:id returns specific job
  ---
  duration_ms: 94.95843
  ...
# Subtest: GET /api/cron/jobs/:id returns 404 for non-existent job
ok 97 - GET /api/cron/jobs/:id returns 404 for non-existent job
  ---
  duration_ms: 90.387751
  ...
# Subtest: PUT /api/cron/jobs/:id updates job
ok 98 - PUT /api/cron/jobs/:id updates job
  ---
  duration_ms: 172.438559
  ...
# Subtest: DELETE /api/cron/jobs/:id removes job
ok 99 - DELETE /api/cron/jobs/:id removes job
  ---
  duration_ms: 265.447715
  ...
# Subtest: POST /api/cron/jobs/:id/run triggers job execution
ok 100 - POST /api/cron/jobs/:id/run triggers job execution
  ---
  duration_ms: 169.179377
  ...
# Subtest: GET /api/cron/status returns system status
ok 101 - GET /api/cron/status returns system status
  ---
  duration_ms: 7.165308
  ...
# Subtest: V1 API Deprecation Enforcement
    # Subtest: Before Sunset Date (current behavior)
        # Subtest: v1 endpoints should include deprecation headers
        not ok 1 - v1 endpoints should include deprecation headers
          ---
          duration_ms: 310.119181
          location: '/app/__tests__/routes/deprecation.enforcement.test.js:36:5'
          failureType: 'testCodeFailure'
          error: 'v1 endpoint should still work before sunset'
          code: 'ERR_ASSERTION'
          name: 'AssertionError'
          expected: true
          actual: false
          operator: '=='
          stack: |-
            TestContext.<anonymous> (file:///app/__tests__/routes/deprecation.enforcement.test.js:40:14)
            process.processTicksAndRejections (node:internal/process/task_queues:95:5)
            async Test.run (node:internal/test_runner/test:797:9)
            async Promise.all (index 0)
            async Suite.run (node:internal/test_runner/test:1135:7)
            async Promise.all (index 0)
            async Suite.run (node:internal/test_runner/test:1135:7)
            async Test.processPendingSubtests (node:internal/test_runner/test:526:7)
          ...
        # Subtest: v2 endpoints should not have deprecation headers
        not ok 2 - v2 endpoints should not have deprecation headers
          ---
          duration_ms: 13.523552
          location: '/app/__tests__/routes/deprecation.enforcement.test.js:50:5'
          failureType: 'testCodeFailure'
          error: 'v2 endpoint should work'
          code: 'ERR_ASSERTION'
          name: 'AssertionError'
          expected: true
          actual: false
          operator: '=='
          stack: |-
            TestContext.<anonymous> (file:///app/__tests__/routes/deprecation.enforcement.test.js:54:14)
            process.processTicksAndRejections (node:internal/process/task_queues:95:5)
            async Test.run (node:internal/test_runner/test:797:9)
            async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
          ...
        1..2
    not ok 1 - Before Sunset Date (current behavior)
      ---
      duration_ms: 329.342869
      type: 'suite'
      location: '/app/__tests__/routes/deprecation.enforcement.test.js:35:3'
      failureType: 'subtestsFailed'
      error: '2 subtests failed'
      code: 'ERR_TEST_FAILURE'
      stack: |-
        async Promise.all (index 0)
      ...
    # Subtest: After Sunset Date (enforcement behavior)
        # Subtest: v1 endpoints should return 410 Gone
        ok 1 - v1 endpoints should return 410 Gone # SKIP
          ---
          duration_ms: 0.690692
          ...
        # Subtest: all v1 endpoints with v2 alternatives should return 410
        ok 2 - all v1 endpoints with v2 alternatives should return 410 # SKIP
          ---
          duration_ms: 0.483562
          ...
        # Subtest: v2 endpoints should continue working normally
        ok 3 - v2 endpoints should continue working normally # SKIP
          ---
          duration_ms: 0.474494
          ...
        # Subtest: v1 endpoints without v2 alternatives should still work
        ok 4 - v1 endpoints without v2 alternatives should still work # SKIP
          ---
          duration_ms: 0.486274
          ...
        1..4
    ok 2 - After Sunset Date (enforcement behavior)
      ---
      duration_ms: 4.598996
      type: 'suite'
      ...
    # Subtest: Error Response Format
        # Subtest: 410 response should have all required fields
        ok 1 - 410 response should have all required fields # SKIP
          ---
          duration_ms: 0.889375
          ...
        1..1
    ok 3 - Error Response Format
      ---
      duration_ms: 1.572112
      type: 'suite'
      ...
    # Subtest: Endpoint Path Mapping
        # Subtest: nested v1 paths should map to nested v2 paths
        ok 1 - nested v1 paths should map to nested v2 paths # SKIP
          ---
          duration_ms: 0.733694
          ...
        1..1
    ok 4 - Endpoint Path Mapping
      ---
      duration_ms: 1.200457
      type: 'suite'
      ...
    1..4
not ok 102 - V1 API Deprecation Enforcement
  ---
  duration_ms: 342.683471
  type: 'suite'
  location: '/app/__tests__/routes/deprecation.enforcement.test.js:22:1'
  failureType: 'subtestsFailed'
  error: '1 subtest failed'
  code: 'ERR_TEST_FAILURE'
  ...
# Subtest: Employee Routes
    # Subtest: GET /api/employees returns 200 with tenant_id
    ok 1 - GET /api/employees returns 200 with tenant_id
      ---
      duration_ms: 119.564624
      ...
    # Subtest: POST /api/employees creates new employee
    ok 2 - POST /api/employees creates new employee
      ---
      duration_ms: 161.54517
      ...
    # Subtest: POST /api/employees requires first_name and last_name
    ok 3 - POST /api/employees requires first_name and last_name
      ---
      duration_ms: 9.449165
      ...
    # Subtest: GET /api/employees/:id returns specific employee
    ok 4 - GET /api/employees/:id returns specific employee
      ---
      duration_ms: 89.749971
      ...
    # Subtest: PUT /api/employees/:id updates employee
    ok 5 - PUT /api/employees/:id updates employee
      ---
      duration_ms: 176.971373
      ...
    # Subtest: GET /api/employees/:id returns 404 for non-existent
    ok 6 - GET /api/employees/:id returns 404 for non-existent
      ---
      duration_ms: 140.439171
      ...
    1..6
ok 103 - Employee Routes
  ---
  duration_ms: 1036.418845
  type: 'suite'
  ...
# Subtest: Entity Labels Routes
    # Subtest: GET /api/entity-labels/:tenant_id returns labels with UUID
    ok 1 - GET /api/entity-labels/:tenant_id returns labels with UUID
      ---
      duration_ms: 223.737899
      ...
    # Subtest: GET /api/entity-labels/:tenant_id works with text slug (resolves to UUID)
    ok 2 - GET /api/entity-labels/:tenant_id works with text slug (resolves to UUID)
      ---
      duration_ms: 84.677876
      ...
    # Subtest: GET /api/entity-labels/:tenant_id returns defaults for non-existent tenant
    ok 3 - GET /api/entity-labels/:tenant_id returns defaults for non-existent tenant
      ---
      duration_ms: 85.51695
      ...
    # Subtest: GET /api/entity-labels/:tenant_id returns 400 without tenant_id
    ok 4 - GET /api/entity-labels/:tenant_id returns 400 without tenant_id
      ---
      duration_ms: 6.214287
      ...
    # Subtest: PUT /api/entity-labels/:tenant_id requires authentication (or dev mode)
    ok 5 - PUT /api/entity-labels/:tenant_id requires authentication (or dev mode)
      ---
      duration_ms: 18.160241
      ...
    # Subtest: DELETE /api/entity-labels/:tenant_id requires authentication (or dev mode)
    ok 6 - DELETE /api/entity-labels/:tenant_id requires authentication (or dev mode)
      ---
      duration_ms: 20.2908
      ...
    # Subtest: Entity label response includes customized array
    ok 7 - Entity label response includes customized array
      ---
      duration_ms: 80.598874
      ...
    # Subtest: Entity labels have correct structure
    ok 8 - Entity labels have correct structure
      ---
      duration_ms: 91.920256
      ...
    1..8
ok 104 - Entity Labels Routes
  ---
  duration_ms: 616.707666
  type: 'suite'
  ...
# Subtest: Leads pagination: limit & offset yield distinct pages
not ok 105 - Leads pagination: limit & offset yield distinct pages
  ---
  duration_ms: 62.648974
  location: '/app/__tests__/routes/leads.pagination.test.js:45:32'
  failureType: 'hookFailed'
  error: |-
    create lead failed: {"status":"error","message":"Authentication required"}
    
    401 !== 201
    
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: 201
  actual: 401
  operator: 'strictEqual'
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/leads.pagination.test.js:34:12)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/leads returns 200 with tenant_id
not ok 106 - GET /api/leads returns 200 with tenant_id
  ---
  duration_ms: 71.337431
  location: '/app/__tests__/routes/leads.route.test.js:45:32'
  failureType: 'hookFailed'
  error: |-
    create lead A failed: {"status":"error","message":"Authentication required"}
    
    401 !== 201
    
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: 201
  actual: 401
  operator: 'strictEqual'
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/leads.route.test.js:30:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/leads supports status $nin (NOT IN)
not ok 107 - GET /api/leads supports status $nin (NOT IN)
  ---
  duration_ms: 4.44951
  location: '/app/__tests__/routes/leads.route.test.js:53:32'
  failureType: 'hookFailed'
  error: |-
    create lead A failed: {"status":"error","message":"Authentication required"}
    
    401 !== 201
    
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: 201
  actual: 401
  operator: 'strictEqual'
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/leads.route.test.js:30:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/leads/search returns matching leads
not ok 108 - GET /api/leads/search returns matching leads
  ---
  duration_ms: 0.340955
  location: '/app/__tests__/routes/leads.route.test.js:67:32'
  failureType: 'hookFailed'
  error: |-
    create lead A failed: {"status":"error","message":"Authentication required"}
    
    401 !== 201
    
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: 201
  actual: 401
  operator: 'strictEqual'
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/leads.route.test.js:30:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/leads/search requires q parameter
not ok 109 - GET /api/leads/search requires q parameter
  ---
  duration_ms: 0.378308
  location: '/app/__tests__/routes/leads.route.test.js:76:32'
  failureType: 'hookFailed'
  error: |-
    create lead A failed: {"status":"error","message":"Authentication required"}
    
    401 !== 201
    
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: 201
  actual: 401
  operator: 'strictEqual'
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/leads.route.test.js:30:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/leads/search requires tenant_id
not ok 110 - GET /api/leads/search requires tenant_id
  ---
  duration_ms: 0.50703
  location: '/app/__tests__/routes/leads.route.test.js:83:32'
  failureType: 'hookFailed'
  error: |-
    create lead A failed: {"status":"error","message":"Authentication required"}
    
    401 !== 201
    
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: 201
  actual: 401
  operator: 'strictEqual'
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/leads.route.test.js:30:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: Memory Routes (AI Agent Memory)
    # Subtest: GET /api/memory/sessions returns memory sessions
    ok 1 - GET /api/memory/sessions returns memory sessions
      ---
      duration_ms: 138.62422
      ...
    # Subtest: GET /api/memory/events returns memory events
    ok 2 - GET /api/memory/events returns memory events
      ---
      duration_ms: 12.905029
      ...
    # Subtest: POST /api/memory/sessions creates new session
    ok 3 - POST /api/memory/sessions creates new session
      ---
      duration_ms: 33.185398
      ...
    # Subtest: POST /api/memory/events stores memory event
    ok 4 - POST /api/memory/events stores memory event
      ---
      duration_ms: 10.385917
      ...
    # Subtest: GET /api/memory/archive returns archived memories
    ok 5 - GET /api/memory/archive returns archived memories
      ---
      duration_ms: 7.452768
      ...
    # Subtest: POST /api/memory/archive archives old memories
    ok 6 - POST /api/memory/archive archives old memories
      ---
      duration_ms: 10.875215
      ...
    1..6
ok 111 - Memory Routes (AI Agent Memory)
  ---
  duration_ms: 217.981827
  type: 'suite'
  ...
# Subtest: MCP Routes (Model Context Protocol)
    # Subtest: GET /api/mcp/status returns MCP server status
    ok 1 - GET /api/mcp/status returns MCP server status
      ---
      duration_ms: 15.479274
      ...
    # Subtest: GET /api/mcp/tools returns available MCP tools
    ok 2 - GET /api/mcp/tools returns available MCP tools
      ---
      duration_ms: 7.166652
      ...
    # Subtest: POST /api/mcp/execute requires tool_name
    ok 3 - POST /api/mcp/execute requires tool_name
      ---
      duration_ms: 11.199492
      ...
    # Subtest: GET /api/mcp/resources returns MCP resources
    ok 4 - GET /api/mcp/resources returns MCP resources
      ---
      duration_ms: 11.474337
      ...
    1..4
ok 112 - MCP Routes (Model Context Protocol)
  ---
  duration_ms: 46.430544
  type: 'suite'
  ...
# Subtest: Metrics Routes
    # Subtest: GET /api/metrics returns system metrics
    ok 1 - GET /api/metrics returns system metrics
      ---
      duration_ms: 156.497235
      ...
    # Subtest: GET /api/metrics/health returns health status
    ok 2 - GET /api/metrics/health returns health status
      ---
      duration_ms: 17.465263
      ...
    # Subtest: GET /api/metrics/tenant/:id returns tenant-specific metrics
    ok 3 - GET /api/metrics/tenant/:id returns tenant-specific metrics
      ---
      duration_ms: 7.778044
      ...
    # Subtest: GET /api/metrics/performance returns performance metrics
    ok 4 - GET /api/metrics/performance returns performance metrics
      ---
      duration_ms: 421.24817
      ...
    # Subtest: GET /api/metrics/database returns database metrics
    ok 5 - GET /api/metrics/database returns database metrics
      ---
      duration_ms: 6.810493
      ...
    # Subtest: GET /api/metrics/cache returns cache metrics
    ok 6 - GET /api/metrics/cache returns cache metrics
      ---
      duration_ms: 5.993783
      ...
    # Subtest: GET /api/metrics/api returns API usage metrics
    ok 7 - GET /api/metrics/api returns API usage metrics
      ---
      duration_ms: 13.18894
      ...
    1..7
ok 113 - Metrics Routes
  ---
  duration_ms: 637.295736
  type: 'suite'
  ...
# Subtest: GET /api/notes returns 200 with tenant_id
not ok 114 - GET /api/notes returns 200 with tenant_id
  ---
  duration_ms: 230.979159
  location: '/app/__tests__/routes/notes.route.test.js:79:32'
  failureType: 'hookFailed'
  error: 'create note A failed: {"status":"error","message":"function pg_catalog.coalesce(note, note) does not exist"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/notes.route.test.js:55:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/notes/:id returns specific note
not ok 115 - GET /api/notes/:id returns specific note
  ---
  duration_ms: 1.88924
  location: '/app/__tests__/routes/notes.route.test.js:88:32'
  failureType: 'hookFailed'
  error: 'create note A failed: {"status":"error","message":"function pg_catalog.coalesce(note, note) does not exist"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/notes.route.test.js:55:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/notes/:id enforces tenant scoping when tenant_id provided
not ok 116 - GET /api/notes/:id enforces tenant scoping when tenant_id provided
  ---
  duration_ms: 0.33063
  location: '/app/__tests__/routes/notes.route.test.js:102:32'
  failureType: 'hookFailed'
  error: 'create note A failed: {"status":"error","message":"function pg_catalog.coalesce(note, note) does not exist"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/notes.route.test.js:55:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: PUT /api/notes/:id updates note
not ok 117 - PUT /api/notes/:id updates note
  ---
  duration_ms: 1.049114
  location: '/app/__tests__/routes/notes.route.test.js:112:32'
  failureType: 'hookFailed'
  error: 'create note A failed: {"status":"error","message":"function pg_catalog.coalesce(note, note) does not exist"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/notes.route.test.js:55:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: DELETE /api/notes/:id removes note
not ok 118 - DELETE /api/notes/:id removes note
  ---
  duration_ms: 0.467264
  location: '/app/__tests__/routes/notes.route.test.js:130:32'
  failureType: 'hookFailed'
  error: 'create note A failed: {"status":"error","message":"function pg_catalog.coalesce(note, note) does not exist"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/notes.route.test.js:55:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/notes supports related_type filter
not ok 119 - GET /api/notes supports related_type filter
  ---
  duration_ms: 0.298106
  location: '/app/__tests__/routes/notes.route.test.js:149:32'
  failureType: 'hookFailed'
  error: 'create note A failed: {"status":"error","message":"function pg_catalog.coalesce(note, note) does not exist"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/notes.route.test.js:55:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/notes supports related_id filter
not ok 120 - GET /api/notes supports related_id filter
  ---
  duration_ms: 1.188282
  location: '/app/__tests__/routes/notes.route.test.js:162:32'
  failureType: 'hookFailed'
  error: 'create note A failed: {"status":"error","message":"function pg_catalog.coalesce(note, note) does not exist"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/notes.route.test.js:55:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: POST /api/notes requires tenant_id and content
not ok 121 - POST /api/notes requires tenant_id and content
  ---
  duration_ms: 0.193942
  location: '/app/__tests__/routes/notes.route.test.js:174:32'
  failureType: 'hookFailed'
  error: 'create note A failed: {"status":"error","message":"function pg_catalog.coalesce(note, note) does not exist"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/notes.route.test.js:55:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: POST /api/notes can create note with metadata
not ok 122 - POST /api/notes can create note with metadata
  ---
  duration_ms: 0.806583
  location: '/app/__tests__/routes/notes.route.test.js:192:32'
  failureType: 'hookFailed'
  error: 'create note A failed: {"status":"error","message":"function pg_catalog.coalesce(note, note) does not exist"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/notes.route.test.js:55:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/opportunities returns 200 with tenant_id
not ok 123 - GET /api/opportunities returns 200 with tenant_id
  ---
  duration_ms: 69.258673
  location: '/app/__tests__/routes/opportunities.route.test.js:77:32'
  failureType: 'hookFailed'
  error: 'create opportunity A failed: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/opportunities.route.test.js:52:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/opportunities/:id returns specific opportunity
not ok 124 - GET /api/opportunities/:id returns specific opportunity
  ---
  duration_ms: 2.393117
  location: '/app/__tests__/routes/opportunities.route.test.js:86:32'
  failureType: 'hookFailed'
  error: 'create opportunity A failed: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/opportunities.route.test.js:52:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/opportunities/:id enforces tenant scoping
not ok 125 - GET /api/opportunities/:id enforces tenant scoping
  ---
  duration_ms: 1.783078
  location: '/app/__tests__/routes/opportunities.route.test.js:101:32'
  failureType: 'hookFailed'
  error: 'create opportunity A failed: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/opportunities.route.test.js:52:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: PUT /api/opportunities/:id updates opportunity
not ok 126 - PUT /api/opportunities/:id updates opportunity
  ---
  duration_ms: 0.892835
  location: '/app/__tests__/routes/opportunities.route.test.js:111:32'
  failureType: 'hookFailed'
  error: 'create opportunity A failed: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/opportunities.route.test.js:52:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: DELETE /api/opportunities/:id removes opportunity
not ok 127 - DELETE /api/opportunities/:id removes opportunity
  ---
  duration_ms: 0.285223
  location: '/app/__tests__/routes/opportunities.route.test.js:131:32'
  failureType: 'hookFailed'
  error: 'create opportunity A failed: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/opportunities.route.test.js:52:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: POST /api/opportunities requires tenant_id
not ok 128 - POST /api/opportunities requires tenant_id
  ---
  duration_ms: 0.110871
  location: '/app/__tests__/routes/opportunities.route.test.js:151:32'
  failureType: 'hookFailed'
  error: 'create opportunity A failed: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/opportunities.route.test.js:52:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: POST /api/opportunities validates amount as number
not ok 129 - POST /api/opportunities validates amount as number
  ---
  duration_ms: 0.09237
  location: '/app/__tests__/routes/opportunities.route.test.js:162:32'
  failureType: 'hookFailed'
  error: 'create opportunity A failed: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/opportunities.route.test.js:52:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: PUT /api/opportunities can advance stage
not ok 130 - PUT /api/opportunities can advance stage
  ---
  duration_ms: 0.117404
  location: '/app/__tests__/routes/opportunities.route.test.js:183:32'
  failureType: 'hookFailed'
  error: 'create opportunity A failed: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/opportunities.route.test.js:52:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/opportunities/search returns matching opportunities
not ok 131 - GET /api/opportunities/search returns matching opportunities
  ---
  duration_ms: 0.684521
  location: '/app/__tests__/routes/opportunities.route.test.js:199:32'
  failureType: 'hookFailed'
  error: 'create opportunity A failed: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/opportunities.route.test.js:52:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/opportunities/search requires q parameter
not ok 132 - GET /api/opportunities/search requires q parameter
  ---
  duration_ms: 0.903732
  location: '/app/__tests__/routes/opportunities.route.test.js:208:32'
  failureType: 'hookFailed'
  error: 'create opportunity A failed: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/opportunities.route.test.js:52:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/opportunities/search requires tenant_id
not ok 133 - GET /api/opportunities/search requires tenant_id
  ---
  duration_ms: 0.626849
  location: '/app/__tests__/routes/opportunities.route.test.js:215:32'
  failureType: 'hookFailed'
  error: 'create opportunity A failed: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/opportunities.route.test.js:52:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/v2/opportunities returns 200 with tenant_id
not ok 134 - GET /api/v2/opportunities returns 200 with tenant_id
  ---
  duration_ms: 300.710663
  location: '/app/__tests__/routes/opportunities.v2.route.test.js:78:32'
  failureType: 'testCodeFailure'
  error: |-
    expected 200 from v2 opportunities list
    
    401 !== 200
    
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: 200
  actual: 401
  operator: 'strictEqual'
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/opportunities.v2.route.test.js:80:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async Test.run (node:internal/test_runner/test:797:9)
    async Test.processPendingSubtests (node:internal/test_runner/test:526:7)
  ...
# Subtest: GET /api/v2/opportunities supports single sort field
not ok 135 - GET /api/v2/opportunities supports single sort field
  ---
  duration_ms: 6.63173
  location: '/app/__tests__/routes/opportunities.v2.route.test.js:88:32'
  failureType: 'testCodeFailure'
  error: |-
    expected 200 from v2 opportunities list with single sort
    
    401 !== 200
    
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: 200
  actual: 401
  operator: 'strictEqual'
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/opportunities.v2.route.test.js:90:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async Test.run (node:internal/test_runner/test:797:9)
    async Test.processPendingSubtests (node:internal/test_runner/test:526:7)
  ...
# Subtest: GET /api/v2/opportunities supports multi-field sort (descending)
not ok 136 - GET /api/v2/opportunities supports multi-field sort (descending)
  ---
  duration_ms: 6.544041
  location: '/app/__tests__/routes/opportunities.v2.route.test.js:97:32'
  failureType: 'testCodeFailure'
  error: |-
    expected 200 from v2 opportunities list with multi-field sort
    
    401 !== 200
    
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: 200
  actual: 401
  operator: 'strictEqual'
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/opportunities.v2.route.test.js:99:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async Test.run (node:internal/test_runner/test:797:9)
    async Test.processPendingSubtests (node:internal/test_runner/test:526:7)
  ...
# Subtest: GET /api/v2/opportunities supports multi-field sort (ascending)
not ok 137 - GET /api/v2/opportunities supports multi-field sort (ascending)
  ---
  duration_ms: 6.071961
  location: '/app/__tests__/routes/opportunities.v2.route.test.js:107:32'
  failureType: 'testCodeFailure'
  error: |-
    expected 200 from v2 opportunities list with ascending multi-field sort
    
    401 !== 200
    
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: 200
  actual: 401
  operator: 'strictEqual'
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/opportunities.v2.route.test.js:109:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async Test.run (node:internal/test_runner/test:797:9)
    async Test.processPendingSubtests (node:internal/test_runner/test:526:7)
  ...
# Subtest: GET /api/v2/opportunities supports mixed sort directions
not ok 138 - GET /api/v2/opportunities supports mixed sort directions
  ---
  duration_ms: 10.237389
  location: '/app/__tests__/routes/opportunities.v2.route.test.js:116:32'
  failureType: 'testCodeFailure'
  error: |-
    expected 200 from v2 opportunities list with mixed sort directions
    
    401 !== 200
    
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: 200
  actual: 401
  operator: 'strictEqual'
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/opportunities.v2.route.test.js:118:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async Test.run (node:internal/test_runner/test:797:9)
    async Test.processPendingSubtests (node:internal/test_runner/test:526:7)
  ...
# Subtest: GET /api/v2/opportunities handles invalid sort gracefully
not ok 139 - GET /api/v2/opportunities handles invalid sort gracefully
  ---
  duration_ms: 11.48693
  location: '/app/__tests__/routes/opportunities.v2.route.test.js:138:32'
  failureType: 'testCodeFailure'
  error: |-
    expected 200 even with invalid sort (should use default)
    
    401 !== 200
    
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: 200
  actual: 401
  operator: 'strictEqual'
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/opportunities.v2.route.test.js:141:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async Test.run (node:internal/test_runner/test:797:9)
    async Test.processPendingSubtests (node:internal/test_runner/test:526:7)
  ...
# Subtest: GET /api/v2/opportunities rejects invalid field names
not ok 140 - GET /api/v2/opportunities rejects invalid field names
  ---
  duration_ms: 16.819423
  location: '/app/__tests__/routes/opportunities.v2.route.test.js:147:32'
  failureType: 'testCodeFailure'
  error: |-
    expected 200 (invalid fields should be ignored)
    
    401 !== 200
    
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: 200
  actual: 401
  operator: 'strictEqual'
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/opportunities.v2.route.test.js:150:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async Test.run (node:internal/test_runner/test:797:9)
    async Test.processPendingSubtests (node:internal/test_runner/test:526:7)
  ...
# Subtest: GET /api/v2/opportunities with pagination and sort
not ok 141 - GET /api/v2/opportunities with pagination and sort
  ---
  duration_ms: 6.34458
  location: '/app/__tests__/routes/opportunities.v2.route.test.js:157:32'
  failureType: 'testCodeFailure'
  error: |-
    expected 200 from v2 opportunities with pagination and sort
    
    401 !== 200
    
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: 200
  actual: 401
  operator: 'strictEqual'
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/opportunities.v2.route.test.js:159:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async Test.run (node:internal/test_runner/test:797:9)
    async Test.processPendingSubtests (node:internal/test_runner/test:526:7)
  ...
# Failed to create test opportunity: { status: 'error', message: 'Authentication required' }
# Subtest: Stage update from prospecting to qualification persists
not ok 142 - Stage update from prospecting to qualification persists
  ---
  duration_ms: 75.837279
  location: '/app/__tests__/routes/opportunityStageUpdate.test.js:65:32'
  failureType: 'hookFailed'
  error: 'Expected 201 creating opp, got 401'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/opportunityStageUpdate.test.js:43:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: Stage update from qualification to proposal persists
not ok 143 - Stage update from qualification to proposal persists
  ---
  duration_ms: 1.506404
  location: '/app/__tests__/routes/opportunityStageUpdate.test.js:89:32'
  failureType: 'hookFailed'
  error: 'Expected 201 creating opp, got 401'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/opportunityStageUpdate.test.js:43:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# ✓ Supabase DB client initialized with performance tracking
# ✓ Supabase DB client initialized (using centralized factory)
# [22:17:54.715] [34mDEBUG[39m: [36mundefined - [dashboard-bundle] Cache MISS key=dashboard:bundle:t1:include=true (compute from db)[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:54.718] [34mDEBUG[39m: [36mundefined - [dashboard-bundle] Falling back to individual queries[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:54.726] [34mDEBUG[39m: [36mundefined - [dashboard-bundle] Fetching lead sources for tenant:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:55.308] [31mERROR[39m: [36mundefined - [dashboard-bundle] Lead sources query error:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:55.559] [34mDEBUG[39m: [36mundefined - [dashboard-bundle] Bundle stats.leadsBySource:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# Subtest: Reports Routes
    # Subtest: GET /dashboard-bundle returns success bundle
    ok 1 - GET /dashboard-bundle returns success bundle
      ---
      duration_ms: 973.16449
      ...
# [22:17:55.616] [34mDEBUG[39m: [36mundefined - [dashboard-stats] Received tenant_id:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
    # Subtest: GET /dashboard-stats requires tenant_id when no db pool
    ok 2 - GET /dashboard-stats requires tenant_id when no db pool
      ---
      duration_ms: 26.615532
      ...
    1..2
ok 144 - Reports Routes
  ---
  duration_ms: 1841.935235
  type: 'suite'
  ...
# Subtest: Security Routes
    # Subtest: GET /api/security/audit-log returns audit entries
    ok 1 - GET /api/security/audit-log returns audit entries
      ---
      duration_ms: 127.613451
      ...
    # Subtest: GET /api/security/permissions returns permissions list
    ok 2 - GET /api/security/permissions returns permissions list
      ---
      duration_ms: 25.515504
      ...
    # Subtest: GET /api/apikeys returns API keys list
    ok 3 - GET /api/apikeys returns API keys list
      ---
      duration_ms: 119.361063
      ...
    # Subtest: POST /api/apikeys requires name
    ok 4 - POST /api/apikeys requires name
      ---
      duration_ms: 29.550095
      ...
    # Subtest: DELETE /api/apikeys/:id validates key exists
    ok 5 - DELETE /api/apikeys/:id validates key exists
      ---
      duration_ms: 29.082077
      ...
    # Subtest: GET /api/security/settings returns security settings
    ok 6 - GET /api/security/settings returns security settings
      ---
      duration_ms: 10.215842
      ...
    1..6
ok 145 - Security Routes
  ---
  duration_ms: 350.259071
  type: 'suite'
  ...
# Subtest: System Routes
    # Subtest: GET /api/system/health returns health status
    ok 1 - GET /api/system/health returns health status
      ---
      duration_ms: 14.201317
      ...
    # Subtest: GET /api/system/status returns system status
    ok 2 - GET /api/system/status returns system status
      ---
      duration_ms: 88.422986
      ...
    # Subtest: GET /health returns health check
    ok 3 - GET /health returns health check
      ---
      duration_ms: 15.342054
      ...
    # Subtest: GET /api/system-settings returns settings
    ok 4 - GET /api/system-settings returns settings
      ---
      duration_ms: 83.91141
      ...
    # Subtest: GET /api/system-logs returns system logs
    ok 5 - GET /api/system-logs returns system logs
      ---
      duration_ms: 103.199467
      ...
    # Subtest: GET /api/cron/status returns cron job status
    ok 6 - GET /api/cron/status returns cron job status
      ---
      duration_ms: 12.709863
      ...
    # Subtest: GET /api/metrics returns metrics data
    ok 7 - GET /api/metrics returns metrics data
      ---
      duration_ms: 13.38731
      ...
    1..7
ok 146 - System Routes
  ---
  duration_ms: 333.760393
  type: 'suite'
  ...
# Subtest: POST /api/storage/upload requires file
ok 147 - POST /api/storage/upload requires file
  ---
  duration_ms: 143.699758
  ...
# Subtest: POST /api/storage/upload accepts multipart form data
ok 148 - POST /api/storage/upload accepts multipart form data
  ---
  duration_ms: 474.947176
  ...
# Subtest: GET /api/storage/files lists files
ok 149 - GET /api/storage/files lists files
  ---
  duration_ms: 7.381037
  ...
# Subtest: GET /api/storage/file/:path returns file info
ok 150 - GET /api/storage/file/:path returns file info
  ---
  duration_ms: 7.223057
  ...
# Subtest: DELETE /api/storage/file/:path requires authentication
ok 151 - DELETE /api/storage/file/:path requires authentication
  ---
  duration_ms: 7.112743
  ...
# Subtest: GET /api/storage/signed-url generates signed URL
ok 152 - GET /api/storage/signed-url generates signed URL
  ---
  duration_ms: 5.596424
  ...
# Subtest: Storage routes handle missing Supabase config gracefully
ok 153 - Storage routes handle missing Supabase config gracefully
  ---
  duration_ms: 21.22102
  ...
# Subtest: POST /api/storage/upload respects tenant isolation
ok 154 - POST /api/storage/upload respects tenant isolation
  ---
  duration_ms: 339.607396
  ...
# Subtest: GET /api/storage/buckets lists available buckets
ok 155 - GET /api/storage/buckets lists available buckets
  ---
  duration_ms: 9.200855
  ...
# Subtest: GET /api/storage/r2/check returns R2 config status
ok 156 - GET /api/storage/r2/check returns R2 config status
  ---
  duration_ms: 275.486756
  ...
# Subtest: POST /api/storage/artifacts requires tenant_id
ok 157 - POST /api/storage/artifacts requires tenant_id
  ---
  duration_ms: 28.410844
  ...
# Subtest: POST /api/storage/artifacts requires kind parameter
ok 158 - POST /api/storage/artifacts requires kind parameter
  ---
  duration_ms: 36.117434
  ...
# Subtest: POST /api/storage/artifacts requires payload parameter
ok 159 - POST /api/storage/artifacts requires payload parameter
  ---
  duration_ms: 55.755043
  ...
# Subtest: POST /api/storage/artifacts stores and retrieves artifact (if R2 configured)
ok 160 - POST /api/storage/artifacts stores and retrieves artifact (if R2 configured)
  ---
  duration_ms: 1169.929351
  ...
# Subtest: GET /api/storage/artifacts/:id enforces tenant isolation
ok 161 - GET /api/storage/artifacts/:id enforces tenant isolation
  ---
  duration_ms: 80.152583
  ...
# Subtest: GET /api/storage/artifacts/:id requires tenant_id
ok 162 - GET /api/storage/artifacts/:id requires tenant_id
  ---
  duration_ms: 11.947817
  ...
# Subtest: POST /api/storage/upload completes within reasonable time
ok 163 - POST /api/storage/upload completes within reasonable time
  ---
  duration_ms: 385.073209
  ...
# Subtest: POST /api/storage/upload handles public URL validation gracefully
ok 164 - POST /api/storage/upload handles public URL validation gracefully
  ---
  duration_ms: 323.5766
  ...
# Subtest: POST /api/storage/signed-url completes within reasonable time
ok 165 - POST /api/storage/signed-url completes within reasonable time
  ---
  duration_ms: 416.454878
  ...
# Subtest: Telephony Routes
    # Subtest: GET /api/telephony/config returns telephony configuration
    ok 1 - GET /api/telephony/config returns telephony configuration
      ---
      duration_ms: 156.575601
      ...
    # Subtest: GET /api/telephony/status returns status
    ok 2 - GET /api/telephony/status returns status
      ---
      duration_ms: 42.653682
      ...
    # Subtest: POST /api/telephony/webhook/twilio/inbound accepts Twilio webhook format
    ok 3 - POST /api/telephony/webhook/twilio/inbound accepts Twilio webhook format
      ---
      duration_ms: 31.984033
      ...
    # Subtest: POST /api/telephony/webhook/signalwire/inbound accepts SignalWire webhook format
    ok 4 - POST /api/telephony/webhook/signalwire/inbound accepts SignalWire webhook format
      ---
      duration_ms: 14.369599
      ...
    # Subtest: POST /api/telephony/webhook/callfluent accepts CallFluent webhook
    ok 5 - POST /api/telephony/webhook/callfluent accepts CallFluent webhook
      ---
      duration_ms: 17.791451
      ...
    # Subtest: POST /api/telephony/webhook/thoughtly accepts Thoughtly webhook
    ok 6 - POST /api/telephony/webhook/thoughtly accepts Thoughtly webhook
      ---
      duration_ms: 12.79919
      ...
    # Subtest: POST /api/telephony/initiate-call requires phone number
    ok 7 - POST /api/telephony/initiate-call requires phone number
      ---
      duration_ms: 16.190548
      ...
    # Subtest: GET /api/telephony/providers lists available providers
    ok 8 - GET /api/telephony/providers lists available providers
      ---
      duration_ms: 7.502436
      ...
    1..8
ok 166 - Telephony Routes
  ---
  duration_ms: 307.299449
  type: 'suite'
  ...
# Subtest: Tenant Routes
    # Subtest: GET /api/tenants returns tenants list
    ok 1 - GET /api/tenants returns tenants list
      ---
      duration_ms: 288.168639
      ...
    # Subtest: GET /api/tenants/:id returns specific tenant
    ok 2 - GET /api/tenants/:id returns specific tenant
      ---
      duration_ms: 113.018706
      ...
    # Subtest: GET /api/tenant-resolve resolves tenant by UUID
    ok 3 - GET /api/tenant-resolve resolves tenant by UUID
      ---
      duration_ms: 8.913571
      ...
    # Subtest: GET /api/tenant-resolve returns 400 without identifier
    ok 4 - GET /api/tenant-resolve returns 400 without identifier
      ---
      duration_ms: 11.289085
      ...
    # Subtest: POST /api/tenants requires name
    ok 5 - POST /api/tenants requires name
      ---
      duration_ms: 34.352521
      ...
    # Subtest: PUT /api/tenants/:id validates tenant exists
    ok 6 - PUT /api/tenants/:id validates tenant exists
      ---
      duration_ms: 168.061183
      ...
    # Subtest: GET /api/tenants/:id/settings returns tenant settings
    ok 7 - GET /api/tenants/:id/settings returns tenant settings
      ---
      duration_ms: 11.771621
      ...
    # Subtest: GET /api/tenants/:id/stats returns tenant statistics
    ok 8 - GET /api/tenants/:id/stats returns tenant statistics
      ---
      duration_ms: 8.3369
      ...
    1..8
ok 167 - Tenant Routes
  ---
  duration_ms: 649.297015
  type: 'suite'
  ...
# Subtest: Testing Routes
    # Subtest: GET /api/testing/ping
        # Subtest: should return pong with timestamp
        ok 1 - should return pong with timestamp
          ---
          duration_ms: 207.454449
          ...
        1..1
    ok 1 - GET /api/testing/ping
      ---
      duration_ms: 209.02525
      type: 'suite'
      ...
    # Subtest: GET /api/testing/suites
        # Subtest: should return available test suites
        ok 1 - should return available test suites
          ---
          duration_ms: 27.163814
          ...
        1..1
    ok 2 - GET /api/testing/suites
      ---
      duration_ms: 30.72041
      type: 'suite'
      ...
    # Subtest: POST /api/testing/trigger-e2e
        # Subtest: should dispatch workflow with valid suite
        ok 1 - should dispatch workflow with valid suite
          ---
          duration_ms: 82.762568
          ...
        # Subtest: should handle GitHub API errors
        ok 2 - should handle GitHub API errors
          ---
          duration_ms: 18.54004
          ...
        1..2
    ok 3 - POST /api/testing/trigger-e2e
      ---
      duration_ms: 101.831821
      type: 'suite'
      ...
    # Subtest: GET /api/testing/workflow-status
        # Subtest: should return workflow runs from GitHub
        ok 1 - should return workflow runs from GitHub
          ---
          duration_ms: 13.35918
          ...
        # Subtest: should filter runs by created_after
        ok 2 - should filter runs by created_after
          ---
          duration_ms: 20.459551
          ...
        # Subtest: should return error when GITHUB_TOKEN is missing
        ok 3 - should return error when GITHUB_TOKEN is missing
          ---
          duration_ms: 13.586391
          ...
        1..3
    ok 4 - GET /api/testing/workflow-status
      ---
      duration_ms: 50.264982
      type: 'suite'
      ...
    1..4
ok 168 - Testing Routes
  ---
  duration_ms: 686.908966
  type: 'suite'
  ...
# Subtest: users.js - Section 2.3: Authentication Endpoints
    # Subtest: POST /api/users/login - User authentication
        # Subtest: should require email parameter
        ok 1 - should require email parameter
          ---
          duration_ms: 462.993463
          ...
# ✓ Supabase DB client initialized with performance tracking
        # Subtest: should return 401 for non-existent user
        ok 2 - should return 401 for non-existent user
          ---
          duration_ms: 662.160738
          ...
        # Subtest: should handle case-insensitive email lookup
        ok 3 - should handle case-insensitive email lookup
          ---
          duration_ms: 23.013474
          ...
        # Subtest: should handle users table lookup first
        ok 4 - should handle users table lookup first
          ---
          duration_ms: 19.769217
          ...
        # Subtest: should handle employees table lookup as fallback
        ok 5 - should handle employees table lookup as fallback
          ---
          duration_ms: 16.428407
          ...
        # Subtest: should block disabled accounts
        ok 6 - should block disabled accounts
          ---
          duration_ms: 11.461057
          ...
        # Subtest: should update user status on successful login
        ok 7 - should update user status on successful login
          ---
          duration_ms: 15.291191
          ...
        # Subtest: should generate JWT token on successful login
        ok 8 - should generate JWT token on successful login
          ---
          duration_ms: 8.688052
          ...
        # Subtest: should handle metadata expansion
        ok 9 - should handle metadata expansion
          ---
          duration_ms: 7.185289
          ...
        # Subtest: should handle database errors gracefully
        ok 10 - should handle database errors gracefully
          ---
          duration_ms: 12.231577
          ...
        1..10
    ok 1 - POST /api/users/login - User authentication
      ---
      duration_ms: 1245.418228
      type: 'suite'
      ...
    # Subtest: POST /api/users/heartbeat - Session validation
        # Subtest: should require authorization or email
        ok 1 - should require authorization or email
          ---
          duration_ms: 18.410513
          ...
        # Subtest: should accept JWT token in Authorization header
        ok 2 - should accept JWT token in Authorization header
          ---
          duration_ms: 20.635485
          ...
        # Subtest: should accept email in request body
        ok 3 - should accept email in request body
          ---
          duration_ms: 166.827545
          ...
        # Subtest: should accept email in query parameters
        ok 4 - should accept email in query parameters
          ---
          duration_ms: 157.822362
          ...
        # Subtest: should prioritize JWT over email
        ok 5 - should prioritize JWT over email
          ---
          duration_ms: 152.27843
          ...
        # Subtest: should handle invalid JWT tokens gracefully
        ok 6 - should handle invalid JWT tokens gracefully
          ---
          duration_ms: 7.719324
          ...
        # Subtest: should update user metadata on heartbeat
        ok 7 - should update user metadata on heartbeat
          ---
          duration_ms: 199.245501
          ...
        # Subtest: should handle users table lookup by ID
        ok 8 - should handle users table lookup by ID
          ---
          duration_ms: 35.171302
          ...
        # Subtest: should handle employees table lookup by ID
        ok 9 - should handle employees table lookup by ID
          ---
          duration_ms: 13.680198
          ...
        # Subtest: should handle email lookup for users
        ok 10 - should handle email lookup for users
          ---
          duration_ms: 154.787773
          ...
        # Subtest: should handle email lookup for employees
        ok 11 - should handle email lookup for employees
          ---
          duration_ms: 148.907285
          ...
        # Subtest: should create user from auth as fallback
        ok 12 - should create user from auth as fallback
          ---
          duration_ms: 173.856207
          ...
        # Subtest: should return 404 for user not found
        ok 13 - should return 404 for user not found
          ---
          duration_ms: 165.168985
          ...
        # Subtest: should return success with user data
        ok 14 - should return success with user data
          ---
          duration_ms: 156.021242
          ...
        1..14
    ok 2 - POST /api/users/heartbeat - Session validation
      ---
      duration_ms: 1573.36528
      type: 'suite'
      ...
# {"level":50,"time":"2026-02-04T22:17:57.943Z","env":"test","service":"aishacrm-backend","msg":"Error getting user:"}
    # Subtest: GET /api/users/heartbeat - Heartbeat checks
        # Subtest: should return online status and timestamp
        ok 1 - should return online status and timestamp
          ---
          duration_ms: 103.633658
          ...
# {"level":50,"time":"2026-02-04T22:17:58.026Z","env":"test","service":"aishacrm-backend","msg":"Error getting user:"}
        # Subtest: should handle query parameters
        ok 2 - should handle query parameters
          ---
          duration_ms: 81.343606
          ...
# {"level":50,"time":"2026-02-04T22:17:58.121Z","env":"test","service":"aishacrm-backend","msg":"Error getting user:"}
# {"level":50,"time":"2026-02-04T22:17:58.204Z","env":"test","service":"aishacrm-backend","msg":"Error getting user:"}
        # Subtest: should be read-only (no mutations)
        ok 3 - should be read-only (no mutations)
          ---
          duration_ms: 181.401239
          ...
# {"level":50,"time":"2026-02-04T22:17:58.306Z","env":"test","service":"aishacrm-backend","msg":"Error getting user:"}
        # Subtest: should work without authentication
        ok 4 - should work without authentication
          ---
          duration_ms: 99.177273
          ...
        1..4
    ok 3 - GET /api/users/heartbeat - Heartbeat checks
      ---
      duration_ms: 467.169783
      type: 'suite'
      ...
    # Subtest: JWT token validation
        # Subtest: should handle valid JWT structure
        ok 1 - should handle valid JWT structure
          ---
          duration_ms: 23.075132
          ...
        # Subtest: should extract user_id from JWT payload
        ok 2 - should extract user_id from JWT payload
          ---
          duration_ms: 11.170876
          ...
        # Subtest: should handle missing user_id in JWT
        ok 3 - should handle missing user_id in JWT
          ---
          duration_ms: 5.26171
          ...
        1..3
    ok 4 - JWT token validation
      ---
      duration_ms: 40.052318
      type: 'suite'
      ...
    # Subtest: Authentication flow integration
        # Subtest: should support login to heartbeat flow
        ok 1 - should support login to heartbeat flow
          ---
          duration_ms: 368.799158
          ...
# {"level":50,"time":"2026-02-04T22:17:58.835Z","env":"test","service":"aishacrm-backend","msg":"Error getting user:"}
        # Subtest: should handle concurrent heartbeat requests
        ok 2 - should handle concurrent heartbeat requests
          ---
          duration_ms: 337.874381
          ...
        1..2
    ok 5 - Authentication flow integration
      ---
      duration_ms: 707.088582
      type: 'suite'
      ...
    # Subtest: Error handling and edge cases
        # Subtest: should handle malformed Authorization header
        ok 1 - should handle malformed Authorization header
          ---
          duration_ms: 8.688367
          ...
        # Subtest: should handle empty Authorization header
        ok 2 - should handle empty Authorization header
          ---
          duration_ms: 11.982902
          ...
        # Subtest: should handle database connection errors
        ok 3 - should handle database connection errors
          ---
          duration_ms: 178.068782
          ...
        # Subtest: should handle JWT verification errors
        ok 4 - should handle JWT verification errors
          ---
          duration_ms: 6.642543
          ...
        # Subtest: should handle metadata update failures gracefully
        ok 5 - should handle metadata update failures gracefully
          ---
          duration_ms: 205.902336
          ...
        1..5
    ok 6 - Error handling and edge cases
      ---
      duration_ms: 413.213862
      type: 'suite'
      ...
    1..6
ok 169 - users.js - Section 2.3: Authentication Endpoints
  ---
  duration_ms: 5350.400782
  type: 'suite'
  ...
# Subtest: users.js - Section 2.4: User Creation & Registration
    # Subtest: POST /api/users - Create new user
        # Subtest: should require email and first_name
        ok 1 - should require email and first_name
          ---
          duration_ms: 386.616346
          ...
# {"level":40,"time":"2026-02-04T22:17:56.058Z","env":"test","service":"aishacrm-backend","msg":"[POST /api/users] BLOCKED test email pattern: test@example.com"}
        # Subtest: should require first_name
        ok 2 - should require first_name
          ---
          duration_ms: 48.971806
          ...
# {"level":40,"time":"2026-02-04T22:17:56.081Z","env":"test","service":"aishacrm-backend","msg":"[POST /api/users] BLOCKED test email pattern: audit.test.user@example.com"}
# {"level":40,"time":"2026-02-04T22:17:56.103Z","env":"test","service":"aishacrm-backend","msg":"[POST /api/users] BLOCKED test email pattern: e2e.temp.user@example.com"}
# {"level":40,"time":"2026-02-04T22:17:56.119Z","env":"test","service":"aishacrm-backend","msg":"[POST /api/users] BLOCKED test email pattern: user@playwright.test"}
        # Subtest: should block test email patterns
        ok 3 - should block test email patterns
          ---
          duration_ms: 69.443843
          ...
        # Subtest: should reject duplicate emails across users and employees
        ok 4 - should reject duplicate emails across users and employees
          ---
          duration_ms: 11.531693
          ...
        # Subtest: should create tenant admin user
        ok 5 - should create tenant admin user
          ---
          duration_ms: 11.790719
          ...
        # Subtest: should create tenant employee user
        ok 6 - should create tenant employee user
          ---
          duration_ms: 14.068017
          ...
        # Subtest: should require tenant_id for employee creation
        ok 7 - should require tenant_id for employee creation
          ---
          duration_ms: 9.605273
          ...
        # Subtest: should handle metadata expansion
        ok 8 - should handle metadata expansion
          ---
          duration_ms: 12.367262
          ...
        # Subtest: should handle database errors gracefully
        ok 9 - should handle database errors gracefully
          ---
          duration_ms: 14.578571
          ...
        # Subtest: should create audit log for user creation
        ok 10 - should create audit log for user creation
          ---
          duration_ms: 9.718741
          ...
        1..10
    ok 1 - POST /api/users - Create new user
      ---
      duration_ms: 592.68568
      type: 'suite'
      ...
    # Subtest: POST /api/users/register - User registration
        # Subtest: should require tenant_id and email
        ok 1 - should require tenant_id and email
          ---
          duration_ms: 17.814594
          ...
        # Subtest: should require tenant_id
        ok 2 - should require tenant_id
          ---
          duration_ms: 11.842722
          ...
        # Subtest: should require email
        ok 3 - should require email
          ---
          duration_ms: 8.587991
          ...
        # Subtest: should reject duplicate email registration
        ok 4 - should reject duplicate email registration
          ---
          duration_ms: 10.714785
          ...
        # Subtest: should register new user successfully
        ok 5 - should register new user successfully
          ---
          duration_ms: 9.606098
          ...
        # Subtest: should default role to user if not specified
        ok 6 - should default role to user if not specified
          ---
          duration_ms: 6.69614
          ...
        # Subtest: should accept custom role
        ok 7 - should accept custom role
          ---
          duration_ms: 6.721138
          ...
        # Subtest: should handle optional last_name
        ok 8 - should handle optional last_name
          ---
          duration_ms: 7.797858
          ...
        # Subtest: should handle database errors gracefully
        ok 9 - should handle database errors gracefully
          ---
          duration_ms: 8.27298
          ...
        1..9
    ok 2 - POST /api/users/register - User registration
      ---
      duration_ms: 90.42633
      type: 'suite'
      ...
    # Subtest: Integration between creation and registration
        # Subtest: should allow registration after creation
        ok 1 - should allow registration after creation
          ---
          duration_ms: 10.019654
          ...
        # Subtest: should handle concurrent registration attempts
        ok 2 - should handle concurrent registration attempts
          ---
          duration_ms: 19.456955
          ...
        1..2
    ok 3 - Integration between creation and registration
      ---
      duration_ms: 30.266261
      type: 'suite'
      ...
    # Subtest: Rate limiting for creation endpoints
        # Subtest: should apply rate limiting to POST /users
        ok 1 - should apply rate limiting to POST /users
          ---
          duration_ms: 63.943858
          ...
        # Subtest: should apply rate limiting to POST /register
        ok 2 - should apply rate limiting to POST /register
          ---
          duration_ms: 24.417969
          ...
        1..2
    ok 4 - Rate limiting for creation endpoints
      ---
      duration_ms: 89.33866
      type: 'suite'
      ...
    1..4
ok 170 - users.js - Section 2.4: User Creation & Registration
  ---
  duration_ms: 2003.900295
  type: 'suite'
  ...
# ✓ Supabase DB client initialized with performance tracking
# {"level":50,"time":"2026-02-04T22:17:55.902Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Supabase query error:"}
# {"level":50,"time":"2026-02-04T22:17:56.001Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Employees query error:"}
# Subtest: users.js - Section 2.6: User Deletion
    # Subtest: DELETE /api/users/:id - Delete user
        # Subtest: should require valid user ID
        ok 1 - should require valid user ID
          ---
          duration_ms: 604.163833
          ...
# {"level":50,"time":"2026-02-04T22:17:56.092Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Supabase query error:"}
# {"level":50,"time":"2026-02-04T22:17:56.222Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Employees query error:"}
        # Subtest: should delete user from users table
        ok 2 - should delete user from users table
          ---
          duration_ms: 220.244358
          ...
# {"level":50,"time":"2026-02-04T22:17:56.315Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Supabase query error:"}
# {"level":50,"time":"2026-02-04T22:17:56.456Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Employees query error:"}
        # Subtest: should delete user from employees table
        ok 3 - should delete user from employees table
          ---
          duration_ms: 229.767084
          ...
# {"level":50,"time":"2026-02-04T22:17:56.606Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Supabase query error:"}
# {"level":50,"time":"2026-02-04T22:17:56.681Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Employees query error:"}
        # Subtest: should handle tenant-scoped employee deletion
        ok 4 - should handle tenant-scoped employee deletion
          ---
          duration_ms: 222.688021
          ...
# {"level":50,"time":"2026-02-04T22:17:56.770Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Supabase query error:"}
# {"level":50,"time":"2026-02-04T22:17:56.863Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Employees query error:"}
        # Subtest: should delete from Supabase Auth when user exists
        ok 5 - should delete from Supabase Auth when user exists
          ---
          duration_ms: 180.449518
          ...
# {"level":50,"time":"2026-02-04T22:17:57.005Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Supabase query error:"}
# {"level":50,"time":"2026-02-04T22:17:57.078Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Employees query error:"}
        # Subtest: should handle auth deletion failures gracefully
        ok 6 - should handle auth deletion failures gracefully
          ---
          duration_ms: 216.164384
          ...
# {"level":50,"time":"2026-02-04T22:17:57.204Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Supabase query error:"}
# {"level":50,"time":"2026-02-04T22:17:57.275Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Employees query error:"}
        # Subtest: should create audit log for user deletion
        ok 7 - should create audit log for user deletion
          ---
          duration_ms: 195.60915
          ...
# {"level":50,"time":"2026-02-04T22:17:57.406Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Supabase query error:"}
# {"level":50,"time":"2026-02-04T22:17:57.492Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Employees query error:"}
        # Subtest: should handle database errors gracefully
        ok 8 - should handle database errors gracefully
          ---
          duration_ms: 218.017591
          ...
# {"level":50,"time":"2026-02-04T22:17:57.588Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Supabase query error:"}
# {"level":50,"time":"2026-02-04T22:17:57.663Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Employees query error:"}
        # Subtest: should return 404 for already deleted users
        ok 9 - should return 404 for already deleted users
          ---
          duration_ms: 173.865243
          ...
        1..9
    ok 1 - DELETE /api/users/:id - Delete user
      ---
      duration_ms: 2263.687876
      type: 'suite'
      ...
    # Subtest: Immutable superadmin protection
        # Subtest: should block deletion of immutable superadmin accounts
        ok 1 - should block deletion of immutable superadmin accounts
          ---
          duration_ms: 4.697152
          ...
        1..1
    ok 2 - Immutable superadmin protection
      ---
      duration_ms: 5.153342
      type: 'suite'
      ...
    # Subtest: Last superadmin protection
        # Subtest: should prevent deletion of the last superadmin
        ok 1 - should prevent deletion of the last superadmin
          ---
          duration_ms: 5.075899
          ...
        1..1
    ok 3 - Last superadmin protection
      ---
      duration_ms: 5.389285
      type: 'suite'
      ...
    # Subtest: Cross-table user deletion
        # Subtest: should prioritize users table over employees table
        ok 1 - should prioritize users table over employees table
          ---
          duration_ms: 7.358048
          ...
# {"level":50,"time":"2026-02-04T22:17:57.789Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Supabase query error:"}
# {"level":50,"time":"2026-02-04T22:17:57.864Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Employees query error:"}
        # Subtest: should fall back to employees table if not in users
        ok 2 - should fall back to employees table if not in users
          ---
          duration_ms: 178.637173
          ...
        1..2
    ok 4 - Cross-table user deletion
      ---
      duration_ms: 186.421834
      type: 'suite'
      ...
# {"level":50,"time":"2026-02-04T22:17:57.968Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Supabase query error:"}
# {"level":50,"time":"2026-02-04T22:17:58.053Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Employees query error:"}
# {"level":50,"time":"2026-02-04T22:17:58.072Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Supabase query error:"}
# {"level":50,"time":"2026-02-04T22:17:58.084Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Supabase query error:"}
# {"level":50,"time":"2026-02-04T22:17:58.114Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Supabase query error:"}
# {"level":50,"time":"2026-02-04T22:17:58.146Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Employees query error:"}
# {"level":50,"time":"2026-02-04T22:17:58.162Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Employees query error:"}
# {"level":50,"time":"2026-02-04T22:17:58.194Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Employees query error:"}
    # Subtest: Rate limiting for user deletion
        # Subtest: should apply rate limiting to DELETE /users/:id
        ok 1 - should apply rate limiting to DELETE /users/:id
          ---
          duration_ms: 328.931837
          ...
        1..1
    ok 5 - Rate limiting for user deletion
      ---
      duration_ms: 329.296115
      type: 'suite'
      ...
    # Subtest: Auth integration for deletion
        # Subtest: should attempt auth deletion for users with auth accounts
        ok 1 - should attempt auth deletion for users with auth accounts
          ---
          duration_ms: 9.03324
          ...
        # Subtest: should skip auth deletion for users without auth accounts
        ok 2 - should skip auth deletion for users without auth accounts
          ---
          duration_ms: 6.567829
          ...
        1..2
    ok 6 - Auth integration for deletion
      ---
      duration_ms: 16.33644
      type: 'suite'
      ...
    # Subtest: Audit logging for deletions
        # Subtest: should log user deletion with proper details
        ok 1 - should log user deletion with proper details
          ---
          duration_ms: 7.515636
          ...
        # Subtest: should handle audit logging failures gracefully
        ok 2 - should handle audit logging failures gracefully
          ---
          duration_ms: 8.477475
          ...
        1..2
    ok 7 - Audit logging for deletions
      ---
      duration_ms: 16.421549
      type: 'suite'
      ...
    1..7
ok 171 - users.js - Section 2.6: User Deletion
  ---
  duration_ms: 3760.355753
  type: 'suite'
  ...
# ✓ Supabase DB client initialized with performance tracking
# {"level":40,"time":"2026-02-04T22:17:56.502Z","env":"test","service":"aishacrm-backend","msg":"[User Invite] users select error:"}
# {"level":40,"time":"2026-02-04T22:17:56.576Z","env":"test","service":"aishacrm-backend","msg":"[User Invite] employees select error:"}
# Subtest: users.js - Section 2.8: User Invitations
    # Subtest: POST /api/users/:id/invite - Send invitation to user
        # Subtest: should return 404 for non-existent user
        ok 1 - should return 404 for non-existent user
          ---
          duration_ms: 576.526681
          ...
        # Subtest: should send password reset for existing auth user
        ok 2 - should send password reset for existing auth user
          ---
          duration_ms: 0.441018
          ...
        # Subtest: should send invitation for new auth user
        ok 3 - should send invitation for new auth user
          ---
          duration_ms: 0.341912
          ...
        # Subtest: should handle invitation errors gracefully
        ok 4 - should handle invitation errors gracefully
          ---
          duration_ms: 0.294786
          ...
        # Subtest: should handle password reset errors gracefully
        ok 5 - should handle password reset errors gracefully
          ---
          duration_ms: 0.250721
          ...
        # Subtest: should support optional redirect_url parameter
        ok 6 - should support optional redirect_url parameter
          ---
          duration_ms: 0.305706
          ...
        1..6
    ok 1 - POST /api/users/:id/invite - Send invitation to user
      ---
      duration_ms: 579.693855
      type: 'suite'
      ...
    # Subtest: POST /api/users/:id/invite - Employee invitations
        # Subtest: should send password reset for existing employee auth user
        ok 1 - should send password reset for existing employee auth user
          ---
          duration_ms: 0.712736
          ...
        # Subtest: should send invitation for new employee auth user
        ok 2 - should send invitation for new employee auth user
          ---
          duration_ms: 0.881263
          ...
        1..2
    ok 2 - POST /api/users/:id/invite - Employee invitations
      ---
      duration_ms: 2.470347
      type: 'suite'
      ...
# {"level":40,"time":"2026-02-04T22:17:56.733Z","env":"test","service":"aishacrm-backend","msg":"[User Invite] users select error:"}
# {"level":40,"time":"2026-02-04T22:17:56.807Z","env":"test","service":"aishacrm-backend","msg":"[User Invite] employees select error:"}
# {"level":40,"time":"2026-02-04T22:17:56.832Z","env":"test","service":"aishacrm-backend","msg":"[User Invite] users select error:"}
# {"level":40,"time":"2026-02-04T22:17:56.840Z","env":"test","service":"aishacrm-backend","msg":"[User Invite] users select error:"}
# {"level":40,"time":"2026-02-04T22:17:56.894Z","env":"test","service":"aishacrm-backend","msg":"[User Invite] users select error:"}
# {"level":40,"time":"2026-02-04T22:17:56.917Z","env":"test","service":"aishacrm-backend","msg":"[User Invite] employees select error:"}
# {"level":40,"time":"2026-02-04T22:17:56.920Z","env":"test","service":"aishacrm-backend","msg":"[User Invite] employees select error:"}
# {"level":40,"time":"2026-02-04T22:17:57.059Z","env":"test","service":"aishacrm-backend","msg":"[User Invite] employees select error:"}
    # Subtest: Rate limiting for invitation endpoint
        # Subtest: should apply rate limiting to POST /:id/invite
        ok 1 - should apply rate limiting to POST /:id/invite
          ---
          duration_ms: 467.956539
          ...
        1..1
    ok 3 - Rate limiting for invitation endpoint
      ---
      duration_ms: 469.268632
      type: 'suite'
      ...
    # Subtest: POST /api/users/:id/resend-invite - Alias endpoint for backward compatibility
        # Subtest: should work identically to /invite endpoint and not return 404
        ok 1 - should work identically to /invite endpoint and not return 404
          ---
          duration_ms: 15.341051
          ...
        # Subtest: should apply rate limiting to POST /:id/resend-invite
        ok 2 - should apply rate limiting to POST /:id/resend-invite
          ---
          duration_ms: 43.647712
          ...
        1..2
    ok 4 - POST /api/users/:id/resend-invite - Alias endpoint for backward compatibility
      ---
      duration_ms: 59.844957
      type: 'suite'
      ...
    1..4
ok 172 - users.js - Section 2.8: User Invitations
  ---
  duration_ms: 2324.04308
  type: 'suite'
  ...
# ✓ Supabase DB client initialized with performance tracking
# Subtest: users.js - Section 2.2: User Listing & Retrieval Endpoints
    # Subtest: GET /api/users/ - List users endpoint
        # Subtest: should return empty array when no users exist
        ok 1 - should return empty array when no users exist
          ---
          duration_ms: 543.660175
          ...
        # Subtest: should handle email parameter case insensitively
        ok 2 - should handle email parameter case insensitively
          ---
          duration_ms: 256.664483
          ...
        # Subtest: should accept limit and offset parameters
        ok 3 - should accept limit and offset parameters
          ---
          duration_ms: 179.595933
          ...
        # Subtest: should handle tenant_id filtering
        ok 4 - should handle tenant_id filtering
          ---
          duration_ms: 108.613552
          ...
        # Subtest: should support debug mode
        ok 5 - should support debug mode
          ---
          duration_ms: 158.273005
          ...
        # Subtest: should handle strict_email parameter
        ok 6 - should handle strict_email parameter
          ---
          duration_ms: 156.362564
          ...
        1..6
    ok 1 - GET /api/users/ - List users endpoint
      ---
      duration_ms: 1405.052348
      type: 'suite'
      ...
    # Subtest: GET /api/users/profiles - User profiles endpoint
        # Subtest: should return user profiles with default pagination
        ok 1 - should return user profiles with default pagination
          ---
          duration_ms: 98.310257
          ...
# {"level":50,"time":"2026-02-04T22:17:57.560Z","env":"test","service":"aishacrm-backend","msg":"[Users.profiles] query error:"}
        # Subtest: should filter profiles by tenant_id
        ok 2 - should filter profiles by tenant_id
          ---
          duration_ms: 93.536843
          ...
# {"level":50,"time":"2026-02-04T22:17:57.649Z","env":"test","service":"aishacrm-backend","msg":"[Users.profiles] query error:"}
        # Subtest: should handle custom limit and offset
        ok 3 - should handle custom limit and offset
          ---
          duration_ms: 84.441699
          ...
        # Subtest: should transform profile data correctly
        ok 4 - should transform profile data correctly
          ---
          duration_ms: 85.297814
          ...
        1..4
    ok 2 - GET /api/users/profiles - User profiles endpoint
      ---
      duration_ms: 363.457491
      type: 'suite'
      ...
# {"level":50,"time":"2026-02-04T22:17:57.843Z","env":"test","service":"aishacrm-backend","msg":"Error getting user:"}
    # Subtest: GET /api/users/:id - Single user retrieval
        # Subtest: should return 404 for non-existent user
        ok 1 - should return 404 for non-existent user
          ---
          duration_ms: 108.454779
          ...
# {"level":50,"time":"2026-02-04T22:17:57.939Z","env":"test","service":"aishacrm-backend","msg":"Error getting user:"}
        # Subtest: should handle tenant_id filtering for user lookup
        ok 2 - should handle tenant_id filtering for user lookup
          ---
          duration_ms: 99.461319
          ...
# {"level":50,"time":"2026-02-04T22:17:58.048Z","env":"test","service":"aishacrm-backend","msg":"Error getting user:"}
        # Subtest: should allow lookup without tenant_id
        ok 3 - should allow lookup without tenant_id
          ---
          duration_ms: 112.080231
          ...
# {"level":50,"time":"2026-02-04T22:17:58.157Z","env":"test","service":"aishacrm-backend","msg":"Error getting user:"}
        # Subtest: should expand user metadata correctly
        ok 4 - should expand user metadata correctly
          ---
          duration_ms: 100.471534
          ...
        1..4
    ok 3 - GET /api/users/:id - Single user retrieval
      ---
      duration_ms: 421.736621
      type: 'suite'
      ...
    # Subtest: POST /api/users/sync-from-auth - Auth synchronization
        # Subtest: should require email parameter
        ok 1 - should require email parameter
          ---
          duration_ms: 48.215193
          ...
# {"level":50,"time":"2026-02-04T22:17:58.303Z","env":"test","service":"aishacrm-backend","msg":"Error syncing from auth:"}
        # Subtest: should accept email in request body
        ok 2 - should accept email in request body
          ---
          duration_ms: 96.06988
          ...
# {"level":50,"time":"2026-02-04T22:17:58.395Z","env":"test","service":"aishacrm-backend","msg":"Error syncing from auth:"}
        # Subtest: should accept email in query parameters
        ok 3 - should accept email in query parameters
          ---
          duration_ms: 91.353383
          ...
# {"level":50,"time":"2026-02-04T22:17:58.483Z","env":"test","service":"aishacrm-backend","msg":"Error syncing from auth:"}
        # Subtest: should handle existing user case
        ok 4 - should handle existing user case
          ---
          duration_ms: 88.836423
          ...
# {"level":50,"time":"2026-02-04T22:17:58.568Z","env":"test","service":"aishacrm-backend","msg":"Error syncing from auth:"}
        # Subtest: should handle auth user not found
        ok 5 - should handle auth user not found
          ---
          duration_ms: 84.553019
          ...
        # Subtest: should create user from auth metadata
        ok 6 - should create user from auth metadata
          ---
          duration_ms: 119.440863
          ...
# {"level":50,"time":"2026-02-04T22:17:58.678Z","env":"test","service":"aishacrm-backend","msg":"Error syncing from auth:"}
# {"level":50,"time":"2026-02-04T22:17:58.784Z","env":"test","service":"aishacrm-backend","msg":"Error syncing from auth:"}
        # Subtest: should handle different user roles
        ok 7 - should handle different user roles
          ---
          duration_ms: 94.929375
          ...
# {"level":50,"time":"2026-02-04T22:17:58.870Z","env":"test","service":"aishacrm-backend","msg":"Error syncing from auth:"}
        # Subtest: should validate tenant_id for non-admin users
        ok 8 - should validate tenant_id for non-admin users
          ---
          duration_ms: 86.114152
          ...
        1..8
    ok 4 - POST /api/users/sync-from-auth - Auth synchronization
      ---
      duration_ms: 710.788534
      type: 'suite'
      ...
    # Subtest: Query parameter validation
        # Subtest: should handle malformed limit parameter
        ok 1 - should handle malformed limit parameter
          ---
          duration_ms: 169.547299
          ...
        # Subtest: should handle malformed offset parameter
        ok 2 - should handle malformed offset parameter
          ---
          duration_ms: 172.582318
          ...
        # Subtest: should handle empty email parameter
        ok 3 - should handle empty email parameter
          ---
          duration_ms: 177.947062
          ...
        # Subtest: should handle special characters in email
        ok 4 - should handle special characters in email
          ---
          duration_ms: 163.952213
          ...
        1..4
    ok 5 - Query parameter validation
      ---
      duration_ms: 686.034929
      type: 'suite'
      ...
    # Subtest: Error handling
        # Subtest: should handle database connection errors gracefully
        ok 1 - should handle database connection errors gracefully
          ---
          duration_ms: 161.23237
          ...
        # Subtest: should handle malformed JSON in request body
        ok 2 - should handle malformed JSON in request body
          ---
          duration_ms: 11.056139
          ...
        # Subtest: should handle missing route parameters
        ok 3 - should handle missing route parameters
          ---
          duration_ms: 154.672596
          ...
        1..3
    ok 6 - Error handling
      ---
      duration_ms: 327.667633
      type: 'suite'
      ...
    1..6
ok 173 - users.js - Section 2.2: User Listing & Retrieval Endpoints
  ---
  duration_ms: 5054.905029
  type: 'suite'
  ...
# ✓ Supabase DB client initialized with performance tracking
# Subtest: users.js - Section 2.1: Rate Limiting & Security Middleware
    # Subtest: should allow login requests within rate limit
    ok 1 - should allow login requests within rate limit
      ---
      duration_ms: 699.248418
      ...
    # Subtest: should block login requests exceeding rate limit
    ok 2 - should block login requests exceeding rate limit
      ---
      duration_ms: 279.481991
      ...
    # Subtest: should track rate limits per IP address
    ok 3 - should track rate limits per IP address
      ---
      duration_ms: 194.346044
      ...
# [22:17:57.594] [31mERROR[39m: [36mundefined - Error sending password reset:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
    # Subtest: should allow password reset requests within rate limit
    ok 4 - should allow password reset requests within rate limit
      ---
      duration_ms: 58.719464
      ...
# [22:17:57.630] [31mERROR[39m: [36mundefined - Error sending password reset:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
    # Subtest: should throttle excessive password reset requests
    ok 5 - should throttle excessive password reset requests
      ---
      duration_ms: 40.916802
      ...
# [22:17:57.671] [31mERROR[39m: [36mundefined - Error sending password reset:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
    # Subtest: should handle email normalization in throttling
    ok 6 - should handle email normalization in throttling
      ---
      duration_ms: 31.778712
      ...
# [22:17:57.691] [34mDEBUG[39m: [36mundefined - [POST /api/users] Creating user:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:57.691] [34mDEBUG[39m: [36mundefined - [POST /api/users] Running direct Supabase duplicate check for:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:57.840] [34mDEBUG[39m: [36mundefined - [POST /api/users] Duplicate check for newuser@corp.test:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:57.840] [34mDEBUG[39m: [36mundefined - [POST /api/users] Checking if condition: usersLength=0, employeesLength=0[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:57.840] [34mDEBUG[39m: [36mundefined - [POST /api/users] No duplicates found, continuing... Role: undefined, Tenant: undefined[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:57.840] [34mDEBUG[39m: [36mundefined - [POST /api/users] Role branching - isGlobalUser: false, role: undefined, normalizedTenantId: null[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
    # Subtest: should allow user creation within rate limit
    ok 7 - should allow user creation within rate limit
      ---
      duration_ms: 166.774823
      ...
# [22:17:57.868] [34mDEBUG[39m: [36mundefined - [POST /api/users] Creating user:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:57.868] [34mDEBUG[39m: [36mundefined - [POST /api/users] Running direct Supabase duplicate check for:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:57.872] [34mDEBUG[39m: [36mundefined - [POST /api/users] Creating user:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:57.872] [34mDEBUG[39m: [36mundefined - [POST /api/users] Running direct Supabase duplicate check for:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:58.016] [34mDEBUG[39m: [36mundefined - [POST /api/users] Duplicate check for user0@corp.test:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:58.017] [34mDEBUG[39m: [36mundefined - [POST /api/users] Checking if condition: usersLength=0, employeesLength=0[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:58.017] [34mDEBUG[39m: [36mundefined - [POST /api/users] No duplicates found, continuing... Role: undefined, Tenant: undefined[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:58.017] [34mDEBUG[39m: [36mundefined - [POST /api/users] Role branching - isGlobalUser: false, role: undefined, normalizedTenantId: null[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:58.020] [34mDEBUG[39m: [36mundefined - [POST /api/users] Duplicate check for user1@corp.test:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:58.020] [34mDEBUG[39m: [36mundefined - [POST /api/users] Checking if condition: usersLength=0, employeesLength=0[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:58.020] [34mDEBUG[39m: [36mundefined - [POST /api/users] No duplicates found, continuing... Role: undefined, Tenant: undefined[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:58.020] [34mDEBUG[39m: [36mundefined - [POST /api/users] Role branching - isGlobalUser: false, role: undefined, normalizedTenantId: null[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
    # Subtest: should block excessive user creation requests
    ok 8 - should block excessive user creation requests
      ---
      duration_ms: 196.869417
      ...
    # Subtest: should allow OPTIONS preflight requests
    ok 9 - should allow OPTIONS preflight requests
      ---
      duration_ms: 24.472775
      ...
    # Subtest: should allow requests after rate limit window expires
    ok 10 - should allow requests after rate limit window expires
      ---
      duration_ms: 996.099327
      ...
    1..10
ok 174 - users.js - Section 2.1: Rate Limiting & Security Middleware
  ---
  duration_ms: 2693.621568
  type: 'suite'
  ...
# Subtest: users.js - Section 2.1: Rate Limiting & Security Middleware
    # Subtest: should allow login requests within rate limit
    ok 1 - should allow login requests within rate limit
      ---
      duration_ms: 194.280731
      ...
    # Subtest: should block login requests exceeding rate limit
    ok 2 - should block login requests exceeding rate limit
      ---
      duration_ms: 214.77869
      ...
    # Subtest: should track rate limits per IP address
    ok 3 - should track rate limits per IP address
      ---
      duration_ms: 208.501076
      ...
# [22:17:59.696] [31mERROR[39m: [36mundefined - Error sending password reset:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
    # Subtest: should allow password reset requests within rate limit
    ok 4 - should allow password reset requests within rate limit
      ---
      duration_ms: 11.632537
      ...
# [22:17:59.707] [31mERROR[39m: [36mundefined - Error sending password reset:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
    # Subtest: should throttle excessive password reset requests
    ok 5 - should throttle excessive password reset requests
      ---
      duration_ms: 21.791114
      ...
# [22:17:59.752] [31mERROR[39m: [36mundefined - Error sending password reset:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
    # Subtest: should handle email normalization in throttling
    ok 6 - should handle email normalization in throttling
      ---
      duration_ms: 42.155275
      ...
# [22:17:59.768] [34mDEBUG[39m: [36mundefined - [POST /api/users] Creating user:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:59.769] [34mDEBUG[39m: [36mundefined - [POST /api/users] Running direct Supabase duplicate check for:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:59.915] [34mDEBUG[39m: [36mundefined - [POST /api/users] Duplicate check for newuser@corp.test:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:59.915] [34mDEBUG[39m: [36mundefined - [POST /api/users] Checking if condition: usersLength=0, employeesLength=0[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:59.915] [34mDEBUG[39m: [36mundefined - [POST /api/users] No duplicates found, continuing... Role: undefined, Tenant: undefined[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:59.915] [34mDEBUG[39m: [36mundefined - [POST /api/users] Role branching - isGlobalUser: false, role: undefined, normalizedTenantId: null[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
    # Subtest: should allow user creation within rate limit
    ok 7 - should allow user creation within rate limit
      ---
      duration_ms: 155.997362
      ...
# [22:17:59.935] [34mDEBUG[39m: [36mundefined - [POST /api/users] Creating user:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:59.935] [34mDEBUG[39m: [36mundefined - [POST /api/users] Running direct Supabase duplicate check for:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:59.937] [34mDEBUG[39m: [36mundefined - [POST /api/users] Creating user:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:59.938] [34mDEBUG[39m: [36mundefined - [POST /api/users] Running direct Supabase duplicate check for:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:18:00.079] [34mDEBUG[39m: [36mundefined - [POST /api/users] Duplicate check for user0@corp.test:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:18:00.079] [34mDEBUG[39m: [36mundefined - [POST /api/users] Checking if condition: usersLength=0, employeesLength=0[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:18:00.079] [34mDEBUG[39m: [36mundefined - [POST /api/users] No duplicates found, continuing... Role: undefined, Tenant: undefined[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:18:00.079] [34mDEBUG[39m: [36mundefined - [POST /api/users] Role branching - isGlobalUser: false, role: undefined, normalizedTenantId: null[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:18:00.099] [34mDEBUG[39m: [36mundefined - [POST /api/users] Duplicate check for user1@corp.test:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:18:00.099] [34mDEBUG[39m: [36mundefined - [POST /api/users] Checking if condition: usersLength=0, employeesLength=0[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:18:00.099] [34mDEBUG[39m: [36mundefined - [POST /api/users] No duplicates found, continuing... Role: undefined, Tenant: undefined[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:18:00.099] [34mDEBUG[39m: [36mundefined - [POST /api/users] Role branching - isGlobalUser: false, role: undefined, normalizedTenantId: null[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
    # Subtest: should block excessive user creation requests
    ok 8 - should block excessive user creation requests
      ---
      duration_ms: 183.237713
      ...
    # Subtest: should allow OPTIONS preflight requests
    ok 9 - should allow OPTIONS preflight requests
      ---
      duration_ms: 6.315198
      ...
    # Subtest: should allow requests after rate limit window expires
    ok 10 - should allow requests after rate limit window expires
      ---
      duration_ms: 932.393029
      ...
    1..10
ok 175 - users.js - Section 2.1: Rate Limiting & Security Middleware
  ---
  duration_ms: 1973.009843
  type: 'suite'
  ...
# Subtest: /app/__tests__/routes/users.middleware.test.js
not ok 70 - /app/__tests__/routes/users.middleware.test.js
  ---
  duration_ms: 10001.504109
  location: '/app/__tests__/routes/users.middleware.test.js:1:1'
  failureType: 'testTimeoutFailure'
  error: 'test timed out after 10000ms'
  code: 'ERR_TEST_FAILURE'
  ...
# Subtest: users.js - Section 2.7: Password Management
    # Subtest: POST /api/users/reset-password - Send password reset email
        # Subtest: should require email parameter
        ok 1 - should require email parameter
          ---
          duration_ms: 143.824511
          ...
        # Subtest: should send password reset email successfully
        ok 2 - should send password reset email successfully
          ---
          duration_ms: 17.950894
          ...
        # Subtest: should handle email throttling
        ok 3 - should handle email throttling
          ---
          duration_ms: 22.035756
          ...
        # Subtest: should handle Supabase errors gracefully
        ok 4 - should handle Supabase errors gracefully
          ---
          duration_ms: 15.109452
          ...
        1..4
    ok 1 - POST /api/users/reset-password - Send password reset email
      ---
      duration_ms: 201.182119
      type: 'suite'
      ...
    # Subtest: POST /api/users/generate-recovery-link - Generate recovery link
        # Subtest: should be blocked in production
        ok 1 - should be blocked in production
          ---
          duration_ms: 12.805955
          ...
        # Subtest: should require email parameter
        ok 2 - should require email parameter
          ---
          duration_ms: 14.866458
          ...
        # Subtest: should generate recovery link successfully
        ok 3 - should generate recovery link successfully
          ---
          duration_ms: 9.438903
          ...
        # Subtest: should handle optional redirectTo parameter
        ok 4 - should handle optional redirectTo parameter
          ---
          duration_ms: 12.426315
          ...
        1..4
    ok 2 - POST /api/users/generate-recovery-link - Generate recovery link
      ---
      duration_ms: 51.496679
      type: 'suite'
      ...
    # Subtest: POST /api/users/admin-password-reset - Direct password reset
        # Subtest: should require email and password parameters
        ok 1 - should require email and password parameters
          ---
          duration_ms: 17.015964
          ...
        # Subtest: should require password parameter
        ok 2 - should require password parameter
          ---
          duration_ms: 11.533046
          ...
        # Subtest: should return 404 for non-existent users
        ok 3 - should return 404 for non-existent users
          ---
          duration_ms: 8.695598
          ...
        # Subtest: should update password successfully
        ok 4 - should update password successfully
          ---
          duration_ms: 13.259933
          ...
        # Subtest: should confirm email after password change
        ok 5 - should confirm email after password change
          ---
          duration_ms: 9.97737
          ...
        # Subtest: should clear password expiration metadata
        ok 6 - should clear password expiration metadata
          ---
          duration_ms: 13.864179
          ...
        # Subtest: should handle password update failures gracefully
        ok 7 - should handle password update failures gracefully
          ---
          duration_ms: 14.739901
          ...
        1..7
    ok 3 - POST /api/users/admin-password-reset - Direct password reset
      ---
      duration_ms: 90.747296
      type: 'suite'
      ...
    # Subtest: Rate limiting for password endpoints
        # Subtest: should apply rate limiting to POST /reset-password
        ok 1 - should apply rate limiting to POST /reset-password
          ---
          duration_ms: 33.106812
          ...
        # Subtest: should apply rate limiting to POST /generate-recovery-link
        ok 2 - should apply rate limiting to POST /generate-recovery-link
          ---
          duration_ms: 26.924919
          ...
        # Subtest: should apply rate limiting to POST /admin-password-reset
        ok 3 - should apply rate limiting to POST /admin-password-reset
          ---
          duration_ms: 32.907313
          ...
        1..3
    ok 4 - Rate limiting for password endpoints
      ---
      duration_ms: 93.834121
      type: 'suite'
      ...
    # Subtest: Email throttling for password reset
        # Subtest: should throttle repeated password reset requests
        ok 1 - should throttle repeated password reset requests
          ---
          duration_ms: 16.454287
          ...
        # Subtest: should include retry-after header when throttled
        ok 2 - should include retry-after header when throttled
          ---
          duration_ms: 10.160297
          ...
        1..2
    ok 5 - Email throttling for password reset
      ---
      duration_ms: 27.296026
      type: 'suite'
      ...
    1..5
ok 177 - users.js - Section 2.7: Password Management
  ---
  duration_ms: 1272.185496
  type: 'suite'
  ...
# ✓ Supabase DB client initialized with performance tracking
# Subtest: users.js - Section 2.5: User Profile Management
    # Subtest: PUT /api/users/:id - Update user profile
        # Subtest: should require valid user ID
        ok 1 - should require valid user ID
          ---
          duration_ms: 530.912853
          ...
        # Subtest: should update basic user fields
        ok 2 - should update basic user fields
          ---
          duration_ms: 198.071425
          ...
        # Subtest: should update employee fields
        ok 3 - should update employee fields
          ---
          duration_ms: 193.507157
          ...
        # Subtest: should handle metadata updates
        ok 4 - should handle metadata updates
          ---
          duration_ms: 235.516157
          ...
        # Subtest: should update password when provided
        ok 5 - should update password when provided
          ---
          duration_ms: 227.679161
          ...
        # Subtest: should handle tenant_id updates
        ok 6 - should handle tenant_id updates
          ---
          duration_ms: 233.753736
          ...
        # Subtest: should normalize tenant_id values
        ok 7 - should normalize tenant_id values
          ---
          duration_ms: 1124.060168
          ...
        # Subtest: should auto-generate display_name from first/last name
        ok 8 - should auto-generate display_name from first/last name
          ---
          duration_ms: 210.36677
          ...
        # Subtest: should preserve existing metadata when updating
        ok 9 - should preserve existing metadata when updating
          ---
          duration_ms: 147.037077
          ...
        # Subtest: should handle permissions updates
        ok 10 - should handle permissions updates
          ---
          duration_ms: 169.994124
          ...
        # Subtest: should create audit log for updates
        ok 11 - should create audit log for updates
          ---
          duration_ms: 179.964826
          ...
        # Subtest: should sync auth metadata for name changes
        ok 12 - should sync auth metadata for name changes
          ---
          duration_ms: 145.99575
          ...
        # Subtest: should handle database errors gracefully
        ok 13 - should handle database errors gracefully
          ---
          duration_ms: 154.478382
          ...
        # Subtest: should expand metadata to top-level fields
        ok 14 - should expand metadata to top-level fields
          ---
          duration_ms: 149.043507
          ...
        1..14
    ok 1 - PUT /api/users/:id - Update user profile
      ---
      duration_ms: 3906.020239
      type: 'suite'
      ...
    # Subtest: Immutable superadmin protection
        # Subtest: should block updates to immutable superadmin accounts
        ok 1 - should block updates to immutable superadmin accounts
          ---
          duration_ms: 165.320928
          ...
        1..1
    ok 2 - Immutable superadmin protection
      ---
      duration_ms: 166.123435
      type: 'suite'
      ...
    # Subtest: Password update functionality
        # Subtest: should handle password update failures
        ok 1 - should handle password update failures
          ---
          duration_ms: 9.685961
          ...
        # Subtest: should confirm email after password change
        ok 2 - should confirm email after password change
          ---
          duration_ms: 3.018168
          ...
        # Subtest: should clear password from metadata
        ok 3 - should clear password from metadata
          ---
          duration_ms: 2.907675
          ...
        1..3
    ok 3 - Password update functionality
      ---
      duration_ms: 16.267523
      type: 'suite'
      ...
    # Subtest: Rate limiting for profile updates
        # Subtest: should apply rate limiting to PUT /users/:id
        ok 1 - should apply rate limiting to PUT /users/:id
          ---
          duration_ms: 16.285189
          ...
        1..1
    ok 4 - Rate limiting for profile updates
      ---
      duration_ms: 16.487778
      type: 'suite'
      ...
    # Subtest: Cross-table user updates
        # Subtest: should update users in users table
        ok 1 - should update users in users table
          ---
          duration_ms: 4.25896
          ...
        # Subtest: should update users in employees table
        ok 2 - should update users in employees table
          ---
          duration_ms: 7.064982
          ...
        1..2
    ok 5 - Cross-table user updates
      ---
      duration_ms: 12.095221
      type: 'suite'
      ...
    1..5
ok 178 - users.js - Section 2.5: User Profile Management
  ---
  duration_ms: 4906.591243
  type: 'suite'
  ...
# ✓ Supabase DB client initialized with performance tracking
# Subtest: users.js - Section 2.1: Rate Limiting & Security Middleware
    # Subtest: Rate limiting behavior on authentication endpoints
        # Subtest: should allow requests within rate limit for login endpoint
        ok 1 - should allow requests within rate limit for login endpoint
          ---
          duration_ms: 636.519195
          ...
        # Subtest: should block requests exceeding auth rate limit
        ok 2 - should block requests exceeding auth rate limit
          ---
          duration_ms: 250.583529
          ...
        # Subtest: should include Retry-After header when rate limited
        ok 3 - should include Retry-After header when rate limited
          ---
          duration_ms: 75.197404
          ...
        1..3
    ok 1 - Rate limiting behavior on authentication endpoints
      ---
      duration_ms: 972.702396
      type: 'suite'
      ...
# [22:17:58.368] [31mERROR[39m: [36mundefined - Error sending password reset:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
    # Subtest: Rate limiting behavior on password endpoints
        # Subtest: should allow initial password reset request
        ok 1 - should allow initial password reset request
          ---
          duration_ms: 22.387098
          ...
        # Subtest: should block excessive password reset requests
        ok 2 - should block excessive password reset requests
          ---
          duration_ms: 36.354267
          ...
        1..2
    ok 2 - Rate limiting behavior on password endpoints
      ---
      duration_ms: 60.186367
      type: 'suite'
      ...
# [22:17:58.423] [34mDEBUG[39m: [36mundefined - [POST /api/users] Creating user:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:58.424] [34mDEBUG[39m: [36mundefined - [POST /api/users] Running direct Supabase duplicate check for:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:58.615] [34mDEBUG[39m: [36mundefined - [POST /api/users] Duplicate check for newuser@test.com:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:58.615] [34mDEBUG[39m: [36mundefined - [POST /api/users] Checking if condition: usersLength=0, employeesLength=0[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:58.615] [34mDEBUG[39m: [36mundefined - [POST /api/users] No duplicates found, continuing... Role: undefined, Tenant: undefined[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:58.615] [34mDEBUG[39m: [36mundefined - [POST /api/users] Role branching - isGlobalUser: false, role: undefined, normalizedTenantId: null[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
    # Subtest: Rate limiting behavior on mutation endpoints
        # Subtest: should allow requests within rate limit for user creation
        ok 1 - should allow requests within rate limit for user creation
          ---
          duration_ms: 207.701896
          ...
# [22:17:58.644] [34mDEBUG[39m: [36mundefined - [POST /api/users] Creating user:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:58.644] [34mDEBUG[39m: [36mundefined - [POST /api/users] Running direct Supabase duplicate check for:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:58.655] [34mDEBUG[39m: [36mundefined - [POST /api/users] Creating user:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:58.656] [34mDEBUG[39m: [36mundefined - [POST /api/users] Running direct Supabase duplicate check for:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:58.659] [34mDEBUG[39m: [36mundefined - [POST /api/users] Creating user:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:58.659] [34mDEBUG[39m: [36mundefined - [POST /api/users] Running direct Supabase duplicate check for:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:58.671] [34mDEBUG[39m: [36mundefined - [POST /api/users] Creating user:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:58.671] [34mDEBUG[39m: [36mundefined - [POST /api/users] Running direct Supabase duplicate check for:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:58.901] [34mDEBUG[39m: [36mundefined - [POST /api/users] Duplicate check for user1@test.com:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:58.901] [34mDEBUG[39m: [36mundefined - [POST /api/users] Checking if condition: usersLength=0, employeesLength=0[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:58.901] [34mDEBUG[39m: [36mundefined - [POST /api/users] No duplicates found, continuing... Role: undefined, Tenant: undefined[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:58.901] [34mDEBUG[39m: [36mundefined - [POST /api/users] Role branching - isGlobalUser: false, role: undefined, normalizedTenantId: null[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:58.966] [34mDEBUG[39m: [36mundefined - [POST /api/users] Duplicate check for user0@test.com:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:58.967] [34mDEBUG[39m: [36mundefined - [POST /api/users] Checking if condition: usersLength=0, employeesLength=0[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:58.967] [34mDEBUG[39m: [36mundefined - [POST /api/users] No duplicates found, continuing... Role: undefined, Tenant: undefined[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:58.967] [34mDEBUG[39m: [36mundefined - [POST /api/users] Role branching - isGlobalUser: false, role: undefined, normalizedTenantId: null[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:59.007] [34mDEBUG[39m: [36mundefined - [POST /api/users] Duplicate check for user2@test.com:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:59.007] [34mDEBUG[39m: [36mundefined - [POST /api/users] Checking if condition: usersLength=0, employeesLength=0[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:59.007] [34mDEBUG[39m: [36mundefined - [POST /api/users] No duplicates found, continuing... Role: undefined, Tenant: undefined[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:59.007] [34mDEBUG[39m: [36mundefined - [POST /api/users] Role branching - isGlobalUser: false, role: undefined, normalizedTenantId: null[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:59.020] [34mDEBUG[39m: [36mundefined - [POST /api/users] Duplicate check for user3@test.com:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:59.020] [34mDEBUG[39m: [36mundefined - [POST /api/users] Checking if condition: usersLength=0, employeesLength=0[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:59.020] [34mDEBUG[39m: [36mundefined - [POST /api/users] No duplicates found, continuing... Role: undefined, Tenant: undefined[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:59.020] [34mDEBUG[39m: [36mundefined - [POST /api/users] Role branching - isGlobalUser: false, role: undefined, normalizedTenantId: null[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
        # Subtest: should block excessive mutation requests
        ok 2 - should block excessive mutation requests
          ---
          duration_ms: 403.861385
          ...
        1..2
    ok 3 - Rate limiting behavior on mutation endpoints
      ---
      duration_ms: 612.213227
      type: 'suite'
      ...
    # Subtest: OPTIONS request handling
        # Subtest: should allow OPTIONS requests without rate limiting
        ok 1 - should allow OPTIONS requests without rate limiting
          ---
          duration_ms: 67.511718
          ...
        1..1
    ok 4 - OPTIONS request handling
      ---
      duration_ms: 67.988995
      type: 'suite'
      ...
    # Subtest: Rate limit window reset
        # Subtest: should reset rate limits after window expires
        ok 1 - should reset rate limits after window expires
          ---
          duration_ms: 1584.990208
          ...
        1..1
    ok 5 - Rate limit window reset
      ---
      duration_ms: 1585.451078
      type: 'suite'
      ...
    # Subtest: IP-based rate limiting
        # Subtest: should apply rate limiting per IP address
        ok 1 - should apply rate limiting per IP address
          ---
          duration_ms: 295.297002
          ...
        1..1
    ok 6 - IP-based rate limiting
      ---
      duration_ms: 295.548134
      type: 'suite'
      ...
# [22:18:00.982] [31mERROR[39m: [36mundefined - Error sending password reset:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
    # Subtest: Email throttling for password operations
        # Subtest: should throttle password reset by email address
        ok 1 - should throttle password reset by email address
          ---
          duration_ms: 20.433987
          ...
        # Subtest: should handle email case insensitivity in throttling
        ok 2 - should handle email case insensitivity in throttling
          ---
          duration_ms: 14.042227
          ...
        1..2
    ok 7 - Email throttling for password operations
      ---
      duration_ms: 35.789008
      type: 'suite'
      ...
    1..7
ok 179 - users.js - Section 2.1: Rate Limiting & Security Middleware
  ---
  duration_ms: 4407.77242
  type: 'suite'
  ...
# Subtest: Users Routes
    # Subtest: GET /api/users returns 200 with tenant_id
    ok 1 - GET /api/users returns 200 with tenant_id
      ---
      duration_ms: 264.248438
      ...
    # Subtest: GET /api/users/:id returns specific user
    ok 2 - GET /api/users/:id returns specific user
      ---
      duration_ms: 188.918011
      ...
    # Subtest: GET /api/users/:id returns 404 for non-existent
    ok 3 - GET /api/users/:id returns 404 for non-existent
      ---
      duration_ms: 142.510891
      ...
    # Subtest: POST /api/users requires email
    ok 4 - POST /api/users requires email
      ---
      duration_ms: 35.699293
      ...
    # Subtest: PUT /api/users/:id validates user exists
    ok 5 - PUT /api/users/:id validates user exists
      ---
      duration_ms: 233.803534
      ...
    1..5
ok 180 - Users Routes
  ---
  duration_ms: 869.300376
  type: 'suite'
  ...
# Subtest: Utils Routes - Unique ID Generation Logic
    # Subtest: Unique ID Generation
        # Subtest: should generate ID with correct format for Lead
        ok 1 - should generate ID with correct format for Lead
          ---
          duration_ms: 3.89368
          ...
        # Subtest: should generate ID with correct format for Contact
        ok 2 - should generate ID with correct format for Contact
          ---
          duration_ms: 0.54144
          ...
        # Subtest: should generate ID with correct format for Account
        ok 3 - should generate ID with correct format for Account
          ---
          duration_ms: 0.38096
          ...
        # Subtest: should generate ID with correct format for Opportunity
        ok 4 - should generate ID with correct format for Opportunity
          ---
          duration_ms: 0.323099
          ...
        # Subtest: should handle case-insensitive entity types
        ok 5 - should handle case-insensitive entity types
          ---
          duration_ms: 0.21357
          ...
        # Subtest: should use UNKN prefix for unknown entity types
        ok 6 - should use UNKN prefix for unknown entity types
          ---
          duration_ms: 0.231097
          ...
        # Subtest: should generate different IDs on consecutive calls
        ok 7 - should generate different IDs on consecutive calls
          ---
          duration_ms: 0.290031
          ...
        # Subtest: should include current date in YYYYMMDD format
        ok 8 - should include current date in YYYYMMDD format
          ---
          duration_ms: 0.333069
          ...
        # Subtest: should generate 6-character hex random suffix
        ok 9 - should generate 6-character hex random suffix
          ---
          duration_ms: 0.405797
          ...
        # Subtest: should generate unique IDs for all supported entity types
        ok 10 - should generate unique IDs for all supported entity types
          ---
          duration_ms: 0.441796
          ...
        1..10
    ok 1 - Unique ID Generation
      ---
      duration_ms: 11.476774
      type: 'suite'
      ...
    # Subtest: UUID Generation
        # Subtest: should generate valid UUID v4
        ok 1 - should generate valid UUID v4
          ---
          duration_ms: 2.93384
          ...
        # Subtest: should generate different UUIDs on consecutive calls
        ok 2 - should generate different UUIDs on consecutive calls
          ---
          duration_ms: 0.354642
          ...
        1..2
    ok 2 - UUID Generation
      ---
      duration_ms: 3.7786
      type: 'suite'
      ...
    1..2
ok 181 - Utils Routes - Unique ID Generation Logic
  ---
  duration_ms: 17.528169
  type: 'suite'
  ...
# Subtest: GET /api/webhooks returns 200 with tenant_id
ok 182 - GET /api/webhooks returns 200 with tenant_id
  ---
  duration_ms: 323.760585
  ...
# Subtest: POST /api/webhooks creates new webhook
ok 183 - POST /api/webhooks creates new webhook
  ---
  duration_ms: 101.312945
  ...
# Subtest: POST /api/webhooks requires url
ok 184 - POST /api/webhooks requires url
  ---
  duration_ms: 15.479105
  ...
# Subtest: GET /api/webhooks/:id returns specific webhook
ok 185 - GET /api/webhooks/:id returns specific webhook
  ---
  duration_ms: 91.857542
  ...
# Subtest: PUT /api/webhooks/:id updates webhook
ok 186 - PUT /api/webhooks/:id updates webhook
  ---
  duration_ms: 99.010378
  ...
# Subtest: DELETE /api/webhooks/:id removes webhook
ok 187 - DELETE /api/webhooks/:id removes webhook
  ---
  duration_ms: 206.989689
  ...
# Subtest: GET /api/webhooks supports is_active filter
ok 188 - GET /api/webhooks supports is_active filter
  ---
  duration_ms: 103.24204
  ...
# Subtest: GET /api/webhooks supports pagination
ok 189 - GET /api/webhooks supports pagination
  ---
  duration_ms: 98.318303
  ...
# Subtest: Workflow Routes
    # Subtest: GET /api/workflows returns 200 with tenant_id
    not ok 1 - GET /api/workflows returns 200 with tenant_id
      ---
      duration_ms: 39.871228
      location: '/app/__tests__/routes/workflows.route.test.js:64:3'
      failureType: 'testCodeFailure'
      error: |-
        expected 200 from workflows list
        
        401 !== 200
        
      code: 'ERR_ASSERTION'
      name: 'AssertionError'
      expected: 200
      actual: 401
      operator: 'strictEqual'
      stack: |-
        TestContext.<anonymous> (file:///app/__tests__/routes/workflows.route.test.js:66:12)
        process.processTicksAndRejections (node:internal/process/task_queues:95:5)
        async Test.run (node:internal/test_runner/test:797:9)
        async Promise.all (index 0)
        async Suite.run (node:internal/test_runner/test:1135:7)
        async Test.processPendingSubtests (node:internal/test_runner/test:526:7)
      ...
    # Subtest: POST /api/workflows creates new workflow with nodes
    not ok 2 - POST /api/workflows creates new workflow with nodes
      ---
      duration_ms: 10.490044
      location: '/app/__tests__/routes/workflows.route.test.js:72:3'
      failureType: 'testCodeFailure'
      error: |-
        expected 201, got 401: {"status":"error","message":"Authentication required"}
        
        401 !== 201
        
      code: 'ERR_ASSERTION'
      name: 'AssertionError'
      expected: 201
      actual: 401
      operator: 'strictEqual'
      stack: |-
        TestContext.<anonymous> (file:///app/__tests__/routes/workflows.route.test.js:85:12)
        process.processTicksAndRejections (node:internal/process/task_queues:95:5)
        async Test.run (node:internal/test_runner/test:797:9)
        async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
      ...
    # Subtest: POST /api/workflows requires name
    not ok 3 - POST /api/workflows requires name
      ---
      duration_ms: 13.981771
      location: '/app/__tests__/routes/workflows.route.test.js:91:3'
      failureType: 'testCodeFailure'
      error: 'expected 400 or 422, got 401'
      code: 'ERR_ASSERTION'
      name: 'AssertionError'
      expected: true
      actual: false
      operator: '=='
      stack: |-
        TestContext.<anonymous> (file:///app/__tests__/routes/workflows.route.test.js:97:12)
        process.processTicksAndRejections (node:internal/process/task_queues:95:5)
        async Test.run (node:internal/test_runner/test:797:9)
        async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
      ...
    # Subtest: GET /api/workflows/:id returns specific workflow
    ok 4 - GET /api/workflows/:id returns specific workflow
      ---
      duration_ms: 1.498734
      ...
    # Subtest: PUT /api/workflows/:id updates workflow
    ok 5 - PUT /api/workflows/:id updates workflow
      ---
      duration_ms: 0.803122
      ...
    # Subtest: POST /api/workflows/:id/execute triggers workflow execution
    ok 6 - POST /api/workflows/:id/execute triggers workflow execution
      ---
      duration_ms: 0.956784
      ...
    # Subtest: GET /api/workflow-executions returns execution history
    ok 7 - GET /api/workflow-executions returns execution history
      ---
      duration_ms: 2863.662282
      ...
    # Subtest: GET /api/workflow-templates returns available templates
    ok 8 - GET /api/workflow-templates returns available templates
      ---
      duration_ms: 112.048371
      ...
    # Subtest: POST /api/workflows creates workflow with create_note node
    not ok 9 - POST /api/workflows creates workflow with create_note node
      ---
      duration_ms: 18.118411
      location: '/app/__tests__/routes/workflows.route.test.js:158:3'
      failureType: 'testCodeFailure'
      error: |-
        expected 201, got 401: {"status":"error","message":"Authentication required"}
        
        401 !== 201
        
      code: 'ERR_ASSERTION'
      name: 'AssertionError'
      expected: 201
      actual: 401
      operator: 'strictEqual'
      stack: |-
        TestContext.<anonymous> (file:///app/__tests__/routes/workflows.route.test.js:178:12)
        process.processTicksAndRejections (node:internal/process/task_queues:95:5)
        async Test.run (node:internal/test_runner/test:797:9)
        async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
      ...
    # Subtest: POST /api/workflows creates workflow with send_sms node
    not ok 10 - POST /api/workflows creates workflow with send_sms node
      ---
      duration_ms: 14.015398
      location: '/app/__tests__/routes/workflows.route.test.js:184:3'
      failureType: 'testCodeFailure'
      error: |-
        expected 201, got 401: {"status":"error","message":"Authentication required"}
        
        401 !== 201
        
      code: 'ERR_ASSERTION'
      name: 'AssertionError'
      expected: 201
      actual: 401
      operator: 'strictEqual'
      stack: |-
        TestContext.<anonymous> (file:///app/__tests__/routes/workflows.route.test.js:213:12)
        process.processTicksAndRejections (node:internal/process/task_queues:95:5)
        async Test.run (node:internal/test_runner/test:797:9)
        async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
      ...
    1..10
not ok 190 - Workflow Routes
  ---
  duration_ms: 3337.170788
  type: 'suite'
  location: '/app/__tests__/routes/workflows.route.test.js:37:1'
  failureType: 'subtestsFailed'
  error: '5 subtests failed'
  code: 'ERR_TEST_FAILURE'
  ...
# [field-parity DEBUG] Auth headers: {
#   "Authorization": "Bearer sb_secret_TEMOH-6ussfhYOelUYG-iQ_lBmInIki",
#   "apikey": "sb_secret_TEMOH-6ussfhYOelUYG-iQ_lBmInIki",
#   "Content-Type": "application/json"
# }
# [field-parity DEBUG] Has Authorization: true
# [field-parity DEBUG] Has apikey: true
# Subtest: Field Parity Tests
    # Subtest: leads: All form fields accepted by API (no column errors)
    ok 1 - leads: All form fields accepted by API (no column errors)
      ---
      duration_ms: 429.725819
      ...
    # Subtest: leads: Can query all expected fields
    ok 2 - leads: Can query all expected fields
      ---
      duration_ms: 104.71376
      ...
    # Subtest: leads: Update accepts all form fields
    ok 3 - leads: Update accepts all form fields
      ---
      duration_ms: 465.182577
      ...
    # Subtest: contacts: All form fields accepted by API (no column errors)
    ok 4 - contacts: All form fields accepted by API (no column errors)
      ---
      duration_ms: 145.729771
      ...
    # Subtest: contacts: Can query all expected fields
    ok 5 - contacts: Can query all expected fields
      ---
      duration_ms: 95.912277
      ...
    # Subtest: contacts: Update accepts all form fields
    ok 6 - contacts: Update accepts all form fields
      ---
      duration_ms: 318.179535
      ...
    # Subtest: accounts: All form fields accepted by API (no column errors)
    ok 7 - accounts: All form fields accepted by API (no column errors)
      ---
      duration_ms: 126.188016
      ...
    # Subtest: accounts: Can query all expected fields
    ok 8 - accounts: Can query all expected fields
      ---
      duration_ms: 96.410054
      ...
    # Subtest: accounts: Update accepts all form fields
    ok 9 - accounts: Update accepts all form fields
      ---
      duration_ms: 375.529541
      ...
    # Subtest: opportunities: All form fields accepted by API (no column errors)
    ok 10 - opportunities: All form fields accepted by API (no column errors)
      ---
      duration_ms: 146.128309
      ...
    # Subtest: opportunities: Can query all expected fields
    ok 11 - opportunities: Can query all expected fields
      ---
      duration_ms: 97.369106
      ...
    # Subtest: opportunities: Update accepts all form fields
    ok 12 - opportunities: Update accepts all form fields
      ---
      duration_ms: 318.348918
      ...
    # Subtest: activities: All form fields accepted by API (no column errors)
    ok 13 - activities: All form fields accepted by API (no column errors)
      ---
      duration_ms: 106.126605
      ...
    # Subtest: activities: Can query all expected fields
    ok 14 - activities: Can query all expected fields
      ---
      duration_ms: 86.064617
      ...
    # Subtest: activities: Update accepts all form fields
    ok 15 - activities: Update accepts all form fields
      ---
      duration_ms: 100.626779
      ...
    # Subtest: employees: All form fields accepted by API (no column errors)
    ok 16 - employees: All form fields accepted by API (no column errors)
      ---
      duration_ms: 7.896998
      ...
    # Subtest: employees: Can query all expected fields
    ok 17 - employees: Can query all expected fields
      ---
      duration_ms: 99.78338
      ...
    # Subtest: employees: Update accepts all form fields
    ok 18 - employees: Update accepts all form fields
      ---
      duration_ms: 7.563138
      ...
    1..18
ok 191 - Field Parity Tests
  ---
  duration_ms: 4005.614682
  type: 'suite'
  ...
# Subtest: Database Schema Verification
    # Subtest: Schema endpoint returns column information
    ok 1 - Schema endpoint returns column information
      ---
      duration_ms: 3.046331
      ...
    1..1
ok 192 - Database Schema Verification
  ---
  duration_ms: 3.231804
  type: 'suite'
  ...
# Subtest: Critical Field Regression Tests
    # Subtest: Leads: do_not_call column exists and accepts boolean
    ok 1 - Leads: do_not_call column exists and accepts boolean
      ---
      duration_ms: 104.101252
      ...
    # Subtest: Leads: is_test_data column exists and accepts boolean
    ok 2 - Leads: is_test_data column exists and accepts boolean
      ---
      duration_ms: 98.977852
      ...
    # Subtest: Leads: assigned_to column exists and accepts UUID
    ok 3 - Leads: assigned_to column exists and accepts UUID
      ---
      duration_ms: 97.570827
      ...
    # Subtest: Leads: tags column exists and accepts array
    ok 4 - Leads: tags column exists and accepts array
      ---
      duration_ms: 98.700705
      ...
    # Subtest: Contacts: job_title and department columns exist
    ok 5 - Contacts: job_title and department columns exist
      ---
      duration_ms: 99.85179
      ...
    # Subtest: Accounts: tags and notes columns exist
    ok 6 - Accounts: tags and notes columns exist
      ---
      duration_ms: 96.329327
      ...
    # Subtest: Opportunities: source and notes columns exist
    ok 7 - Opportunities: source and notes columns exist
      ---
      duration_ms: 89.03221
      ...
    1..7
ok 193 - Critical Field Regression Tests
  ---
  duration_ms: 1360.913086
  type: 'suite'
  ...
# [ModelRouter] Module loaded - LLM_PROVIDER=undefined
# [22:18:01.194] [34mDEBUG[39m: [36mundefined - [WorkflowQueue] Initializing workflow execution queue with Redis:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:18:01.204] [34mDEBUG[39m: [36mundefined - [WorkflowQueue] Queue initialized and ready to process jobs[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:18:01.290] [34mDEBUG[39m: [36mundefined - [TaskQueue] Initializing task execution queue with Redis:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:18:01.292] [33mWARN[39m: [36mundefined - [aiProvider] No DEFAULT OPENAI_API_KEY set; will require tenant-level key.[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:18:01.430] [34mDEBUG[39m: [36mundefined - [GitHub Issues] Configuration:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:18:01.431] [33mWARN[39m: [36mundefined - No database configured - set USE_SUPABASE_API=true (or USE_SUPABASE_PROD=true for legacy) with SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:18:01.432] [32mINFO[39m: [36mundefined - Memory layer available[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
#     [35mredisUrl[39m: "redis://redis-memory:6379"
# [22:18:01.452] [32mINFO[39m: [36mundefined - [MemoryClient] Connected to Redis[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:18:01.470] [32mINFO[39m: [36mundefined - ✓ Memory client initialized[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:18:01.472] [33mWARN[39m: [36mundefined - [RedisConfig] memory Redis using allkeys-lru policy (recommended: noeviction)[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
#     [35mpurpose[39m: "memory"
#     [35mcurrentPolicy[39m: "allkeys-lru"
#     [35mrecommendedPolicy[39m: "noeviction"
#     [35mmaxMemory[39m: 268435456
# [22:18:01.472] [34mDEBUG[39m: [36mundefined - [IDR] Loaded 0 blocked IPs from Redis[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:18:01.478] [32mINFO[39m: [36mundefined - [CacheManager] Redis cache connected[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:18:01.480] [32mINFO[39m: [36mundefined - API cache layer connected[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
#     [35mredisUrl[39m: "redis://redis-cache:6379"
# [22:18:01.482] [32mINFO[39m: [36mundefined - [RedisConfig] cache Redis configuration validated[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
#     [35mpurpose[39m: "cache"
#     [35mcurrentPolicy[39m: "allkeys-lru"
#     [35mmaxMemory[39m: 536870912
# ✓ Supabase Admin client initialized
# [22:18:01.488] [32mINFO[39m: [36mundefined - [CacheManager] All cache flushed[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:18:01.488] [32mINFO[39m: [36mundefined - API cache flushed on startup (dev mode)[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:18:01.492] [32mINFO[39m: [36mundefined - [CORS] Allowed origins configured[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
#     [35morigins[39m: "http://localhost:5173, http://localhost:4000, https://localhost:5173, https://localhost:4000, https://app.aishacrm.com, https://api.aishacrm.com"
# [22:18:01.493] [34mDEBUG[39m: [36mundefined - [Performance Logger] Middleware initialized with pgPool:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:18:01.493] [32mINFO[39m: [36mundefined - Performance logging middleware enabled[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
#     [35msource[39m: "PostgreSQL direct"
# [22:18:01.493] [32mINFO[39m: [36mundefined - Production safety guard enabled[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:18:01.493] [32mINFO[39m: [36mundefined - Intrusion Detection & Response (IDR) middleware enabled[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:18:01.511] [32mINFO[39m: [36mundefined - ✓ Supabase Auth initialized[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:18:01.514] [32mINFO[39m: [36mundefined - v1 API deprecation headers middleware enabled[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:18:01.534] [34mDEBUG[39m: [36mundefined - Mounting /api/v2/opportunities routes (dev/internal)[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:18:01.535] [34mDEBUG[39m: [36mundefined - Mounting /api/v2/activities routes (dev/internal)[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:18:01.536] [34mDEBUG[39m: [36mundefined - Mounting /api/v2/contacts routes (dev/internal)[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:18:01.537] [34mDEBUG[39m: [36mundefined - Mounting /api/v2/accounts routes (dev/internal)[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:18:01.537] [34mDEBUG[39m: [36mundefined - Mounting /api/v2/leads routes (dev/internal)[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:18:01.538] [34mDEBUG[39m: [36mundefined - Mounting /api/v2/reports routes (dev/internal)[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:18:01.539] [34mDEBUG[39m: [36mundefined - Mounting /api/v2/workflows routes (dev/internal)[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:18:01.539] [34mDEBUG[39m: [36mundefined - Mounting /api/v2/documents routes (dev/internal)[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:18:01.540] [34mDEBUG[39m: [36mundefined - Mounting /api/workflow-templates routes[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:18:01.545] [34mDEBUG[39m: [36mundefined - Mounting /api/dashboard/funnel-counts routes[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:18:01.545] [34mDEBUG[39m: [36mundefined - Mounting /api/care-config routes[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:18:01.545] [34mDEBUG[39m: [36mundefined - Mounting /api/braid/audit routes[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:18:01.545] [34mDEBUG[39m: [36mundefined - Mounting /api/braid/chain routes[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:18:01.545] [34mDEBUG[39m: [36mundefined - Mounting /api/braid/metrics routes[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:18:01.545] [34mDEBUG[39m: [36mundefined - Mounting /api/braid/graph routes[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:18:01.545] [34mDEBUG[39m: [36mundefined - Mounting /api/construction/projects routes[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:18:01.546] [34mDEBUG[39m: [36mundefined - Mounting /api/construction/assignments routes[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:18:01.546] [34mDEBUG[39m: [36mundefined - Mounting /api/workers routes[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:18:01.547] [34mDEBUG[39m: [36mundefined - Mounting /api/tasks routes[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:18:01.562] [31mERROR[39m: [36mundefined - Server error[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
#     err: {
#       "type": "Error",
#       "message": "listen EADDRINUSE: address already in use :::3001",
#       "stack":
#           Error: listen EADDRINUSE: address already in use :::3001
#               at Server.setupListenHandle [as _listen2] (node:net:1908:16)
#               at listenInCluster (node:net:1965:12)
#               at Server.listen (node:net:2067:7)
#               at file:///app/server.js:612:8
#               at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
#       "code": "EADDRINUSE",
#       "errno": -98,
#       "syscall": "listen",
#       "address": "::",
#       "port": 3001
#     }
# [22:18:01.564] [31mERROR[39m: [36mundefined - Port already in use[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
#     [35mport[39m: 3001
# Subtest: /app/__tests__/system/health.test.js
not ok 79 - /app/__tests__/system/health.test.js
  ---
  duration_ms: 3552.322296
  location: '/app/__tests__/system/health.test.js:1:1'
  failureType: 'testCodeFailure'
  exitCode: 1
  signal: ~
  error: 'test failed'
  code: 'ERR_TEST_FAILURE'
  ...
# Subtest: Metrics Routes
    # Subtest: GET /usage returns success envelope
    ok 1 - GET /usage returns success envelope
      ---
      duration_ms: 290.321735
      ...
    # Subtest: GET /performance returns structure with logs and metrics
    ok 2 - GET /performance returns structure with logs and metrics
      ---
      duration_ms: 30.016601
      ...
# [22:17:59.368] [34mDEBUG[39m: [36mundefined - [Metrics] performance[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:17:59.389] [34mDEBUG[39m: [36mundefined - [Metrics] Deleted 1 performance log(s) for tenant: ALL[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
    # Subtest: DELETE /performance returns deleted_count
    ok 3 - DELETE /performance returns deleted_count
      ---
      duration_ms: 23.144465
      ...
    # Subtest: GET /security returns composed sections
    ok 4 - GET /security returns composed sections
      ---
      duration_ms: 19.073847
      ...
    1..4
ok 195 - Metrics Routes
  ---
  duration_ms: 1017.725641
  type: 'suite'
  ...
# Subtest: server.js exists and contains app.listen
ok 196 - server.js exists and contains app.listen
  ---
  duration_ms: 10.503262
  ...
# Subtest: environment variables object is accessible
ok 197 - environment variables object is accessible
  ---
  duration_ms: 0.415823
  ...
# ✓ Supabase DB client initialized with performance tracking
# ✓ Supabase DB client initialized (using centralized factory)
# [UUID Validator] Invalid UUID rejected: "t1"
# Subtest: System Logs Routes
    # Subtest: POST / creates a log and expands metadata
    ok 1 - POST / creates a log and expands metadata
      ---
      duration_ms: 542.858609
      ...
# [UUID Validator] Invalid UUID rejected: "t1"
    # Subtest: GET / lists logs with pagination and expands metadata
    ok 2 - GET / lists logs with pagination and expands metadata
      ---
      duration_ms: 105.170001
      ...
# [UUID Validator] Invalid UUID rejected: "t1"
# [Cache] Manual invalidation: system_logs for tenant null
    # Subtest: DELETE /:id deletes existing log (404 if not found)
    ok 3 - DELETE /:id deletes existing log (404 if not found)
      ---
      duration_ms: 245.883406
      ...
# [Cache] Manual invalidation: system_logs for tenant null
    # Subtest: DELETE / bulk deletion responds with deleted_count
    ok 4 - DELETE / bulk deletion responds with deleted_count
      ---
      duration_ms: 127.824654
      ...
# [22:18:01.242] [34mDEBUG[39m: [36mundefined - [System Logs] Deleted 210 system log(s) for tenant: all[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:18:01.258] [33mWARN[39m: [36mundefined - [System Logs Bulk] Request received with no entries field[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
    # Subtest: POST /bulk handles missing request body
    ok 5 - POST /bulk handles missing request body
      ---
      duration_ms: 19.150807
      ...
# [22:18:01.279] [33mWARN[39m: [36mundefined - [System Logs Bulk] Request received with no entries field[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
    # Subtest: POST /bulk handles missing entries field
    ok 6 - POST /bulk handles missing entries field
      ---
      duration_ms: 12.767212
      ...
# [22:18:01.285] [33mWARN[39m: [36mundefined - [System Logs Bulk] entries field is not an array:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
    # Subtest: POST /bulk handles non-array entries
    ok 7 - POST /bulk handles non-array entries
      ---
      duration_ms: 4.992215
      ...
# [22:18:01.292] [34mDEBUG[39m: [36mundefined - [System Logs Bulk] Empty entries array received[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
    # Subtest: POST /bulk handles empty entries array
    ok 8 - POST /bulk handles empty entries array
      ---
      duration_ms: 8.63949
      ...
# [22:18:01.427] [34mDEBUG[39m: [36mundefined - [System Logs Bulk] Successfully inserted 3 log entries[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
    # Subtest: POST /bulk inserts valid log entries
    ok 9 - POST /bulk inserts valid log entries
      ---
      duration_ms: 132.555
      ...
# [22:18:01.432] [33mWARN[39m: [36mundefined - [System Logs Bulk] Batch size 250 exceeds max 200, truncating[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:18:01.541] [34mDEBUG[39m: [36mundefined - [System Logs Bulk] Successfully inserted 200 log entries[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
    # Subtest: POST /bulk handles batch size limit
    ok 10 - POST /bulk handles batch size limit
      ---
      duration_ms: 113.831148
      ...
    # Subtest: OPTIONS /bulk returns 204 for CORS preflight
    ok 11 - OPTIONS /bulk returns 204 for CORS preflight
      ---
      duration_ms: 2.637631
      ...
    1..11
ok 198 - System Logs Routes
  ---
  duration_ms: 2209.613555
  type: 'suite'
  ...
# ✓ Supabase DB client initialized with performance tracking
# ✓ Supabase DB client initialized (using centralized factory)
# Subtest: System Routes
    # Subtest: GET /status should report server running with database status
    ok 1 - GET /status should report server running with database status
      ---
      duration_ms: 477.694623
      ...
# ✓ Supabase DB client initialized (using centralized factory)
    # Subtest: GET /runtime should return non-secret diagnostics
    ok 2 - GET /runtime should return non-secret diagnostics
      ---
      duration_ms: 16.940736
      ...
    1..2
ok 199 - System Routes
  ---
  duration_ms: 1329.451432
  type: 'suite'
  ...
# Subtest: System Routes - logs with Supabase
    # Subtest: GET /logs should require tenant_id
    ok 1 - GET /logs should require tenant_id
      ---
      duration_ms: 18.6693
      ...
    # Subtest: GET /logs should return rows when tenant_id provided
    ok 2 - GET /logs should return rows when tenant_id provided
      ---
      duration_ms: 194.978799
      ...
    1..2
ok 200 - System Routes - logs with Supabase
  ---
  duration_ms: 225.902655
  type: 'suite'
  ...
# [22:18:00.887] [31mERROR[39m: [36mundefined - Error fetching system logs:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# Subtest: Utils Routes
    # Subtest: POST /hash should respond with placeholder message
    not ok 1 - POST /hash should respond with placeholder message
      ---
      duration_ms: 0
      location: '/app/__tests__/system/utils.test.js:38:3'
      failureType: 'cancelledByParent'
      error: 'Promise resolution is still pending but the event loop has already resolved'
      code: 'ERR_TEST_FAILURE'
      stack: |-
        process.emit (node:events:524:28)
      ...
    # Subtest: POST /generate-uuid should return a uuid
    not ok 2 - POST /generate-uuid should return a uuid
      ---
      duration_ms: 0
      location: '/app/__tests__/system/utils.test.js:47:3'
      failureType: 'cancelledByParent'
      error: 'Promise resolution is still pending but the event loop has already resolved'
      code: 'ERR_TEST_FAILURE'
      stack: |-
        process.emit (node:events:524:28)
      ...
    1..2
not ok 201 - Utils Routes
  ---
  duration_ms: 201.083717
  type: 'suite'
  location: '/app/__tests__/system/utils.test.js:21:1'
  failureType: 'cancelledByParent'
  error: 'Promise resolution is still pending but the event loop has already resolved'
  code: 'ERR_TEST_FAILURE'
  stack: |-
    process.emit (node:events:524:28)
  ...
# Error: Test hook "before" at __tests__/system/utils.test.js:22:3 generated asynchronous activity after the test ended. This activity created the error "Error: listen EADDRINUSE: address already in use :::3103" and would have caused the test to fail, but instead triggered an uncaughtException event.
# Subtest: /app/__tests__/utils/conversionHelpers.test.js
ok 85 - /app/__tests__/utils/conversionHelpers.test.js
  ---
  duration_ms: 277.658084
  ...
# [UUID Validator] Invalid UUID rejected: "not-a-uuid"
# [UUID Validator] Invalid UUID rejected: "123abc"
# [UUID Validator] Invalid UUID rejected: "system"
# [UUID Validator] Invalid UUID rejected: "invalid-uuid"
# Subtest: UUID Validator - isValidUUID
    # Subtest: returns true for valid UUIDs
    ok 1 - returns true for valid UUIDs
      ---
      duration_ms: 2.509801
      ...
    # Subtest: returns false for invalid UUIDs
    ok 2 - returns false for invalid UUIDs
      ---
      duration_ms: 0.279447
      ...
    # Subtest: returns false for non-strings
    ok 3 - returns false for non-strings
      ---
      duration_ms: 0.186979
      ...
    1..3
ok 203 - UUID Validator - isValidUUID
  ---
  duration_ms: 6.194403
  ...
# Subtest: UUID Validator - sanitizeUuidInput
    # Subtest: returns valid UUIDs unchanged
    ok 1 - returns valid UUIDs unchanged
      ---
      duration_ms: 2.488676
      ...
    # Subtest: converts system aliases to NULL
    ok 2 - converts system aliases to NULL
      ---
      duration_ms: 0.349232
      ...
    # Subtest: converts invalid UUIDs to NULL
    ok 3 - converts invalid UUIDs to NULL
      ---
      duration_ms: 2.738062
      ...
    # Subtest: handles NULL and empty values
    ok 4 - handles NULL and empty values
      ---
      duration_ms: 0.309703
      ...
    # Subtest: respects allowNull option
    ok 5 - respects allowNull option
      ---
      duration_ms: 0.434785
      ...
    # Subtest: respects custom systemAliases
    ok 6 - respects custom systemAliases
      ---
      duration_ms: 0.775432
      ...
    1..6
ok 204 - UUID Validator - sanitizeUuidInput
  ---
  duration_ms: 9.414576
  ...
# Subtest: UUID Validator - sanitizeUuidFilter
    # Subtest: sanitizes UUID columns in filter
    ok 1 - sanitizes UUID columns in filter
      ---
      duration_ms: 0.624583
      ...
    # Subtest: handles $or conditions
    ok 2 - handles $or conditions
      ---
      duration_ms: 0.353546
      ...
    # Subtest: handles $and conditions
    ok 3 - handles $and conditions
      ---
      duration_ms: 0.485051
      ...
    # Subtest: preserves operator objects like $regex
    ok 4 - preserves operator objects like $regex
      ---
      duration_ms: 1.251132
      ...
    # Subtest: handles empty filter
    ok 5 - handles empty filter
      ---
      duration_ms: 0.903828
      ...
    1..5
ok 205 - UUID Validator - sanitizeUuidFilter
  ---
  duration_ms: 6.498469
  ...
# ✓ Supabase DB client initialized with performance tracking
# ✓ Supabase DB client initialized (using centralized factory)
# Subtest: Validation Routes
    # Subtest: POST /find-duplicates requires entity_type and tenant_id
    ok 1 - POST /find-duplicates requires entity_type and tenant_id
      ---
      duration_ms: 163.809373
      ...
    # Subtest: POST /validate-and-import 400 when no records
    ok 2 - POST /validate-and-import 400 when no records
      ---
      duration_ms: 34.819328
      ...
    # Subtest: POST /validate-and-import 400 when missing tenant_id
    ok 3 - POST /validate-and-import 400 when missing tenant_id
      ---
      duration_ms: 11.236996
      ...
    # Subtest: POST /validate-and-import 400 for unsupported entity type
    ok 4 - POST /validate-and-import 400 for unsupported entity type
      ---
      duration_ms: 17.77236
      ...
# [22:18:00.778] [34mDEBUG[39m: [36mundefined - 📥 Import request: 1 Foo records[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
    # Subtest: POST /find-duplicates returns groups for allowed fields
    ok 5 - POST /find-duplicates returns groups for allowed fields
      ---
      duration_ms: 267.3926
      ...
# [22:18:01.128] [31mERROR[39m: [36mundefined - checkDuplicateBeforeCreate error:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
    # Subtest: POST /check-duplicate-before-create detects email and phone duplicates for Contact
    ok 6 - POST /check-duplicate-before-create detects email and phone duplicates for Contact
      ---
      duration_ms: 81.559697
      ...
# [22:18:01.142] [34mDEBUG[39m: [36mundefined - 📥 Import request: 1 Contact records[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:18:01.234] [31mERROR[39m: [36mundefined - Row 2 failed:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [22:18:01.234] [34mDEBUG[39m: [36mundefined - ✅ Import complete: 0 success, 1 failed[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
    # Subtest: imports one Contact and defaults missing last_name to UNK
    ok 7 - imports one Contact and defaults missing last_name to UNK
      ---
      duration_ms: 113.652263
      ...
    1..7
ok 206 - Validation Routes
  ---
  duration_ms: 1221.336734
  type: 'suite'
  ...
1..206
# tests 990
# suites 257
# pass 847
# fail 112
# cancelled 19
# skipped 12
# todo 0
# duration_ms 16562.156601
