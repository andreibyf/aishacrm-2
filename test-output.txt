
> aishacrm-backend@1.0.51 test
> BACKEND_URL=http://localhost:3001 node --test --test-reporter tap __tests__/**/*.test.js

TAP version 13
# ✓ Supabase DB client initialized with performance tracking
# ✓ Supabase DB client initialized (using centralized factory)
# [ModelRouter] Module loaded - LLM_PROVIDER=undefined
# Subtest: AI Triggers Worker
    # Subtest: TRIGGER_TYPES are properly defined
    ok 1 - TRIGGER_TYPES are properly defined
      ---
      duration_ms: 1556.999713
      ...
    # Subtest: Worker exports startAiTriggersWorker and stopAiTriggersWorker
    ok 2 - Worker exports startAiTriggersWorker and stopAiTriggersWorker
      ---
      duration_ms: 0.896783
      ...
    # Subtest: Worker exports triggerForTenant for manual triggering
    ok 3 - Worker exports triggerForTenant for manual triggering
      ---
      duration_ms: 0.629104
      ...
    # Subtest: Worker exports getPendingSuggestions
    ok 4 - Worker exports getPendingSuggestions
      ---
      duration_ms: 0.59159
      ...
    1..4
ok 1 - AI Triggers Worker
  ---
  duration_ms: 1874.109676
  type: 'suite'
  ...
# Subtest: Suggestions API
    # Subtest: GET /api/ai/suggestions returns 200 with tenant_id
    ok 1 - GET /api/ai/suggestions returns 200 with tenant_id
      ---
      duration_ms: 343.152977
      ...
    # Subtest: GET /api/ai/suggestions supports status filter
    ok 2 - GET /api/ai/suggestions supports status filter
      ---
      duration_ms: 339.540272
      ...
    # Subtest: GET /api/ai/suggestions supports trigger_id filter
    ok 3 - GET /api/ai/suggestions supports trigger_id filter
      ---
      duration_ms: 192.291715
      ...
    # Subtest: GET /api/ai/suggestions supports priority filter
    ok 4 - GET /api/ai/suggestions supports priority filter
      ---
      duration_ms: 251.846951
      ...
    # Subtest: GET /api/ai/suggestions supports pagination
    ok 5 - GET /api/ai/suggestions supports pagination
      ---
      duration_ms: 206.015585
      ...
    # Subtest: GET /api/ai/suggestions/stats returns statistics
    ok 6 - GET /api/ai/suggestions/stats returns statistics
      ---
      duration_ms: 124.107727
      ...
    1..6
ok 2 - Suggestions API
  ---
  duration_ms: 1459.490358
  type: 'suite'
  ...
# Subtest: Suggestion Actions
    # Subtest: POST /api/ai/suggestions/:id/approve updates status to approved
    ok 1 - POST /api/ai/suggestions/:id/approve updates status to approved
      ---
      duration_ms: 539.306962
      ...
    # Subtest: POST /api/ai/suggestions/:id/reject updates status to rejected
    ok 2 - POST /api/ai/suggestions/:id/reject updates status to rejected
      ---
      duration_ms: 172.973646
      ...
    1..2
ok 3 - Suggestion Actions
  ---
  duration_ms: 713.320029
  type: 'suite'
  ...
# Subtest: Trigger Detection Logic
    # Subtest: Lead stagnation detection threshold is 7 days
    ok 1 - Lead stagnation detection threshold is 7 days
      ---
      duration_ms: 0.78945
      ...
    # Subtest: Deal decay detection threshold is 14 days
    ok 2 - Deal decay detection threshold is 14 days
      ---
      duration_ms: 0.339893
      ...
    # Subtest: Hot opportunity detection requires 70% probability
    ok 3 - Hot opportunity detection requires 70% probability
      ---
      duration_ms: 0.490904
      ...
    1..3
ok 4 - Trigger Detection Logic
  ---
  duration_ms: 2.202162
  type: 'suite'
  ...
# Subtest: Suggestion Template Generation
    # Subtest: Template suggestions include required fields
    ok 1 - Template suggestions include required fields
      ---
      duration_ms: 289.815884
      ...
    1..1
ok 5 - Suggestion Template Generation
  ---
  duration_ms: 290.293294
  type: 'suite'
  ...
# Subtest: API key cleaning - removes newlines and tabs
ok 6 - API key cleaning - removes newlines and tabs
  ---
  duration_ms: 2.817732
  ...
# Subtest: API key cleaning - removes leading/trailing whitespace
ok 7 - API key cleaning - removes leading/trailing whitespace
  ---
  duration_ms: 0.320827
  ...
# Subtest: API key cleaning - handles multiple newlines
ok 8 - API key cleaning - handles multiple newlines
  ---
  duration_ms: 0.3395
  ...
# Subtest: API key cleaning - preserves valid key
ok 9 - API key cleaning - preserves valid key
  ---
  duration_ms: 0.315552
  ...
# Subtest: API key validation - accepts sk- prefix
ok 10 - API key validation - accepts sk- prefix
  ---
  duration_ms: 0.321614
  ...
# Subtest: API key validation - accepts reasonable length
ok 11 - API key validation - accepts reasonable length
  ---
  duration_ms: 2.30508
  ...
# Subtest: API key validation - rejects too short key
ok 12 - API key validation - rejects too short key
  ---
  duration_ms: 0.326314
  ...
# Subtest: API key validation - rejects wrong prefix
ok 13 - API key validation - rejects wrong prefix
  ---
  duration_ms: 0.302747
  ...
# Subtest: API key cleaning - handles CRLF line endings
ok 14 - API key cleaning - handles CRLF line endings
  ---
  duration_ms: 0.394136
  ...
# ✓ Supabase DB client initialized with performance tracking
# ✓ Supabase DB client initialized (using centralized factory)
# [Braid Scenarios] Supabase client initialized
# [Braid Scenarios] Found tenant: 6cb4c008-4847-426a-9a2e-918ad70e7b69
# [Braid Scenarios] Using TOOL_ACCESS_TOKEN for test execution
# [Braid Tool] Executing search_accounts {
#   braidPath: '/braid-llm-kit/examples/assistant/accounts.braid',
#   function: 'searchAccounts',
#   tenantUuid: '6cb4c008-4847-426a-9a2e-918ad70e7b69',
#   argsPreview: '["6cb4c008-4847-426a-9a2e-918ad70e7b69",null,5]'
# }
# [Braid Tool] Cache MISS for search_accounts {
#   cacheKey: 'braid:6cb4c008-4847-426a-9a2e-918ad70e7b69:search_accounts:5'
# }
# [Braid RT] http.get called with args: ["/api/v2/accounts",{"params":{"tenant_id":"6cb4c008-4847-426a-9a2e-918ad70e7b69","limit":5}}]
# [Braid HTTP GET] http://backend:3001/api/v2/accounts?tenant_id=6cb4c008-4847-426a-9a2e-918ad70e7b69&search=undefined&limit=5
# [Braid HTTP GET] Error: 401 {"status":"error","message":"Authentication required"}
# [Braid Tool] search_accounts completed {
#   resultTag: 'Err',
#   hasError: true,
#   errorType: undefined,
#   errorMsg: undefined,
#   resultCount: 'N/A',
#   resultPreview: 'N/A'
# }
# [Expected] search_accounts returned: undefined
# [Braid Tool] Executing search_contacts {
#   braidPath: '/braid-llm-kit/examples/assistant/contacts.braid',
#   function: 'searchContacts',
#   tenantUuid: '6cb4c008-4847-426a-9a2e-918ad70e7b69',
#   argsPreview: '["6cb4c008-4847-426a-9a2e-918ad70e7b69",null,5]'
# }
# [Braid Tool] Cache MISS for search_contacts {
#   cacheKey: 'braid:6cb4c008-4847-426a-9a2e-918ad70e7b69:search_contacts:5'
# }
# Subtest: Braid SDK Scenario Tests
    # Subtest: Retrieval Scenarios
        # Subtest: search_accounts retrieves accounts for tenant
        ok 1 - search_accounts retrieves accounts for tenant
          ---
          duration_ms: 179.680751
          ...
# [Braid RT] http.get called with args: ["/api/v2/contacts",{"params":{"tenant_id":"6cb4c008-4847-426a-9a2e-918ad70e7b69","limit":5}}]
# [Braid HTTP GET] http://backend:3001/api/v2/contacts?tenant_id=6cb4c008-4847-426a-9a2e-918ad70e7b69&search=undefined&limit=5
# [Braid HTTP GET] Error: 401 {"status":"error","message":"Authentication required"}
# [Braid Tool] search_contacts completed {
#   resultTag: 'Err',
#   hasError: true,
#   errorType: undefined,
#   errorMsg: undefined,
#   resultCount: 'N/A',
#   resultPreview: 'N/A'
# }
# [Braid Tool] Executing search_leads {
#   braidPath: '/braid-llm-kit/examples/assistant/leads.braid',
#   function: 'searchLeads',
#   tenantUuid: '6cb4c008-4847-426a-9a2e-918ad70e7b69',
#   argsPreview: '["6cb4c008-4847-426a-9a2e-918ad70e7b69",null,5]'
# }
# [Braid Tool] Cache MISS for search_leads {
#   cacheKey: 'braid:6cb4c008-4847-426a-9a2e-918ad70e7b69:search_leads:4208'
# }
        # Subtest: search_contacts retrieves contacts for tenant
        ok 2 - search_contacts retrieves contacts for tenant
          ---
          duration_ms: 85.761415
          ...
# [Braid RT] http.get called with args: ["/api/v2/leads",{"params":{"tenant_id":"6cb4c008-4847-426a-9a2e-918ad70e7b69","limit":5}}]
# [Braid HTTP GET] http://backend:3001/api/v2/leads?tenant_id=6cb4c008-4847-426a-9a2e-918ad70e7b69&limit=5&query=undefined
# [Braid HTTP GET] Response data keys: [ 'status', 'data' ]
# [Braid Tool] search_leads completed {
#   resultTag: 'Ok',
#   hasError: false,
#   errorType: undefined,
#   errorMsg: undefined,
#   resultCount: 0,
#   resultPreview: []
# }
# [Braid Tool] Cached search_leads result for 60s
# [Braid] No param order defined for searchOpportunities, passing as object
# [Braid Tool] Executing search_opportunities {
#   braidPath: '/braid-llm-kit/examples/assistant/opportunities.braid',
#   function: 'searchOpportunities',
#   tenantUuid: '6cb4c008-4847-426a-9a2e-918ad70e7b69',
#   argsPreview: '[{"limit":5,"tenant":"6cb4c008-4847-426a-9a2e-918ad70e7b69"}]'
# }
# [Braid Tool] Cache MISS for search_opportunities {
#   cacheKey: 'braid:6cb4c008-4847-426a-9a2e-918ad70e7b69:search_opportunit'
# }
        # Subtest: search_leads retrieves leads for tenant
        ok 3 - search_leads retrieves leads for tenant
          ---
          duration_ms: 164.037817
          ...
# [Braid RT] http.get called with args: ["/api/v2/opportunities",{"params":{"tenant_id":{"limit":5,"tenant":"6cb4c008-4847-426a-9a2e-918ad70e7b69"}}}]
# [Braid HTTP GET] http://backend:3001/api/v2/opportunities?tenant_id=6cb4c008-4847-426a-9a2e-918ad70e7b69&limit=undefined
# [Braid HTTP GET] Error: 401 {"status":"error","message":"Authentication required"}
# [Braid Tool] search_opportunities completed {
#   resultTag: 'Err',
#   hasError: true,
#   errorType: undefined,
#   errorMsg: undefined,
#   resultCount: 'N/A',
#   resultPreview: 'N/A'
# }
# [Braid Tool] Executing create_lead {
#   braidPath: '/braid-llm-kit/examples/assistant/leads.braid',
#   function: 'createLead',
#   tenantUuid: '6cb4c008-4847-426a-9a2e-918ad70e7b69',
#   argsPreview: '["6cb4c008-4847-426a-9a2e-918ad70e7b69",null,null,"braidtest1770229963617@example.com",null,"Braid Test Company","new","braid_test",null]'
# }
# [Braid HTTP] POST http://backend:3001/api/v2/leads {"tenant_id":"6cb4c008-4847-426a-9a2e-918ad70e7b69","email":"braidtest1770229963617@example.com","phone":"Braid Test Company","source":"new","status":"new","metadata":{}}
        # Subtest: search_opportunities retrieves opportunities for tenant
        ok 4 - search_opportunities retrieves opportunities for tenant
          ---
          duration_ms: 32.153191
          ...
        # Subtest: get_dashboard_metrics retrieves dashboard data
        ok 5 - get_dashboard_metrics retrieves dashboard data
          ---
          duration_ms: 0.536268
          ...
        1..5
    ok 1 - Retrieval Scenarios
      ---
      duration_ms: 464.498152
      type: 'suite'
      ...
# [Braid HTTP] POST error 400 {"status":"error","message":"first_name is required"}
# [Braid Tool] create_lead completed {
#   resultTag: 'Err',
#   hasError: true,
#   errorType: undefined,
#   errorMsg: undefined,
#   resultCount: 'N/A',
#   resultPreview: 'N/A'
# }
# [Create Lead] Error: undefined undefined
    # Subtest: CRUD Scenarios
        # Subtest: create_lead creates a new lead
        ok 1 - create_lead creates a new lead
          ---
          duration_ms: 62.653737
          ...
# [Braid Tool] Executing get_lead_details {
#   braidPath: '/braid-llm-kit/examples/assistant/leads.braid',
#   function: 'getLeadDetails',
#   tenantUuid: '6cb4c008-4847-426a-9a2e-918ad70e7b69',
#   argsPreview: '["6cb4c008-4847-426a-9a2e-918ad70e7b69","14e72a93-a392-4ce2-b940-b9da46b1a7e6"]'
# }
# [Braid Tool] Cache MISS for get_lead_details {
#   cacheKey: 'braid:6cb4c008-4847-426a-9a2e-918ad70e7b69:get_lead_details:'
# }
# [Braid RT] http.get called with args: ["/api/v2/leads/14e72a93-a392-4ce2-b940-b9da46b1a7e6",{"params":{"tenant_id":"6cb4c008-4847-426a-9a2e-918ad70e7b69"}}]
# [Braid HTTP GET] http://backend:3001/api/v2/leads/14e72a93-a392-4ce2-b940-b9da46b1a7e6?tenant_id=6cb4c008-4847-426a-9a2e-918ad70e7b69
# [Braid HTTP GET] Response data keys: [ 'status', 'data' ]
# [Braid Tool] get_lead_details completed {
#   resultTag: 'Ok',
#   hasError: false,
#   errorType: undefined,
#   errorMsg: undefined,
#   resultCount: 'N/A',
#   resultPreview: 'N/A'
# }
# [Braid Tool] Cached get_lead_details result for 180s
# [Braid Security] Tool execution DENIED - invalid or missing access token {
#   toolName: 'search_accounts',
#   hasToken: false,
#   tokenVerified: undefined,
#   tokenSource: undefined,
#   tenantId: '6cb4c008-4847-426a-9a2e-918ad70e7b69',
#   userId: '00000000-0000-0000-0000-000000000001'
# }
# [Braid Security] Tool execution DENIED - invalid or missing access token {
#   toolName: 'search_accounts',
#   hasToken: true,
#   tokenVerified: false,
#   tokenSource: 'fake',
#   tenantId: '6cb4c008-4847-426a-9a2e-918ad70e7b69',
#   userId: '00000000-0000-0000-0000-000000000001'
# }
# [Braid Tool] Executing search_accounts {
#   braidPath: '/braid-llm-kit/examples/assistant/accounts.braid',
#   function: 'searchAccounts',
#   tenantUuid: '6cb4c008-4847-426a-9a2e-918ad70e7b69',
#   argsPreview: '["6cb4c008-4847-426a-9a2e-918ad70e7b69",null,1]'
# }
# [Braid Tool] Cache MISS for search_accounts {
#   cacheKey: 'braid:6cb4c008-4847-426a-9a2e-918ad70e7b69:search_accounts:f'
# }
# [Braid RT] http.get called with args: ["/api/v2/accounts",{"params":{"tenant_id":"6cb4c008-4847-426a-9a2e-918ad70e7b69","limit":1}}]
# [Braid HTTP GET] http://backend:3001/api/v2/accounts?tenant_id=6cb4c008-4847-426a-9a2e-918ad70e7b69&search=undefined&limit=1
        # Subtest: get_lead_details retrieves a specific lead
        ok 2 - get_lead_details retrieves a specific lead
          ---
          duration_ms: 426.931823
          ...
        # Subtest: update_lead modifies an existing lead
        ok 3 - update_lead modifies an existing lead
          ---
          duration_ms: 0.872326
          ...
        1..3
    ok 2 - CRUD Scenarios
      ---
      duration_ms: 491.656675
      type: 'suite'
      ...
    # Subtest: Security Scenarios
        # Subtest: executeBraidTool rejects calls without access token
        ok 1 - executeBraidTool rejects calls without access token
          ---
          duration_ms: 0.916248
          ...
        # Subtest: executeBraidTool rejects invalid access token
        ok 2 - executeBraidTool rejects invalid access token
          ---
          duration_ms: 0.72812
          ...
        # Subtest: executeBraidTool rejects unknown tool names
        ok 3 - executeBraidTool rejects unknown tool names
          ---
          duration_ms: 0.305967
          ...
        1..3
    ok 3 - Security Scenarios
      ---
      duration_ms: 2.440563
      type: 'suite'
      ...
    # Subtest: Tool Registry Validation
        # Subtest: TOOL_REGISTRY contains expected CRM tools
        ok 1 - TOOL_REGISTRY contains expected CRM tools
          ---
          duration_ms: 0.828399
          ...
        # Subtest: Each registered tool has required metadata
        ok 2 - Each registered tool has required metadata
          ---
          duration_ms: 0.853365
          ...
        1..2
    ok 4 - Tool Registry Validation
      ---
      duration_ms: 2.556272
      type: 'suite'
      ...
# [Braid HTTP GET] Error: 401 {"status":"error","message":"Authentication required"}
# [Braid Tool] search_accounts completed {
#   resultTag: 'Err',
#   hasError: true,
#   errorType: undefined,
#   errorMsg: undefined,
#   resultCount: 'N/A',
#   resultPreview: 'N/A'
# }
# [Audit] Found 1 recent audit entries
    # Subtest: Audit Logging
        # Subtest: Tool execution creates audit log entries
        ok 1 - Tool execution creates audit log entries
          ---
          duration_ms: 630.522776
          ...
        1..1
    ok 5 - Audit Logging
      ---
      duration_ms: 631.305405
      type: 'suite'
      ...
    1..5
ok 15 - Braid SDK Scenario Tests
  ---
  duration_ms: 3387.621505
  type: 'suite'
  ...
# ✓ Supabase DB client initialized with performance tracking
# ✓ Supabase DB client initialized (using centralized factory)
# Subtest: Braid Tool Execution
    # Subtest: Braid Graph API
        # Subtest: GET /api/braid/graph returns tool dependency graph
        ok 1 - GET /api/braid/graph returns tool dependency graph
          ---
          duration_ms: 161.328933
          ...
        # Subtest: GET /api/braid/graph/categories returns tool categories
        ok 2 - GET /api/braid/graph/categories returns tool categories
          ---
          duration_ms: 26.374004
          ...
        # Subtest: GET /api/braid/graph/tool/:name returns tool details
        ok 3 - GET /api/braid/graph/tool/:name returns tool details
          ---
          duration_ms: 27.993439
          ...
        # Subtest: GET /api/braid/graph/tool/:name/impact returns impact analysis
        ok 4 - GET /api/braid/graph/tool/:name/impact returns impact analysis
          ---
          duration_ms: 32.826073
          ...
        # Subtest: GET /api/braid/graph/validate checks for circular dependencies
        ok 5 - GET /api/braid/graph/validate checks for circular dependencies
          ---
          duration_ms: 34.726085
          ...
        # Subtest: GET /api/braid/graph/effects/:effect returns tools by effect
        ok 6 - GET /api/braid/graph/effects/:effect returns tools by effect
          ---
          duration_ms: 48.123748
          ...
        1..6
    ok 1 - Braid Graph API
      ---
      duration_ms: 338.526214
      type: 'suite'
      ...
    # Subtest: Retrieval Functions
        # Subtest: GET /api/v2/accounts returns accounts list
        not ok 1 - GET /api/v2/accounts returns accounts list
          ---
          duration_ms: 33.924589
          location: '/app/__tests__/ai/braidToolExecution.test.js:122:5'
          failureType: 'testCodeFailure'
          error: |-
            Expected values to be strictly equal:
            
            401 !== 200
            
          code: 'ERR_ASSERTION'
          name: 'AssertionError'
          expected: 200
          actual: 401
          operator: 'strictEqual'
          stack: |-
            TestContext.<anonymous> (file:///app/__tests__/ai/braidToolExecution.test.js:126:14)
            process.processTicksAndRejections (node:internal/process/task_queues:95:5)
            async Test.run (node:internal/test_runner/test:797:9)
            async Promise.all (index 0)
            async Suite.run (node:internal/test_runner/test:1135:7)
            async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
          ...
        # Subtest: GET /api/v2/contacts returns contacts list
        not ok 2 - GET /api/v2/contacts returns contacts list
          ---
          duration_ms: 21.909178
          location: '/app/__tests__/ai/braidToolExecution.test.js:134:5'
          failureType: 'testCodeFailure'
          error: |-
            Expected values to be strictly equal:
            
            401 !== 200
            
          code: 'ERR_ASSERTION'
          name: 'AssertionError'
          expected: 200
          actual: 401
          operator: 'strictEqual'
          stack: |-
            TestContext.<anonymous> (file:///app/__tests__/ai/braidToolExecution.test.js:138:14)
            process.processTicksAndRejections (node:internal/process/task_queues:95:5)
            async Test.run (node:internal/test_runner/test:797:9)
            async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
          ...
        # Subtest: GET /api/v2/leads returns leads list
        ok 3 - GET /api/v2/leads returns leads list
          ---
          duration_ms: 286.126991
          ...
        # Subtest: GET /api/v2/opportunities returns opportunities list
        not ok 4 - GET /api/v2/opportunities returns opportunities list
          ---
          duration_ms: 16.306281
          location: '/app/__tests__/ai/braidToolExecution.test.js:150:5'
          failureType: 'testCodeFailure'
          error: |-
            Expected values to be strictly equal:
            
            401 !== 200
            
          code: 'ERR_ASSERTION'
          name: 'AssertionError'
          expected: 200
          actual: 401
          operator: 'strictEqual'
          stack: |-
            TestContext.<anonymous> (file:///app/__tests__/ai/braidToolExecution.test.js:154:14)
            process.processTicksAndRejections (node:internal/process/task_queues:95:5)
            async Test.run (node:internal/test_runner/test:797:9)
            async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
          ...
        # Subtest: GET /api/v2/activities returns activities list
        not ok 5 - GET /api/v2/activities returns activities list
          ---
          duration_ms: 12.243449
          location: '/app/__tests__/ai/braidToolExecution.test.js:158:5'
          failureType: 'testCodeFailure'
          error: |-
            Expected values to be strictly equal:
            
            401 !== 200
            
          code: 'ERR_ASSERTION'
          name: 'AssertionError'
          expected: 200
          actual: 401
          operator: 'strictEqual'
          stack: |-
            TestContext.<anonymous> (file:///app/__tests__/ai/braidToolExecution.test.js:162:14)
            process.processTicksAndRejections (node:internal/process/task_queues:95:5)
            async Test.run (node:internal/test_runner/test:797:9)
            async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
          ...
        # Subtest: Search endpoints support query parameters
        not ok 6 - Search endpoints support query parameters
          ---
          duration_ms: 25.279387
          location: '/app/__tests__/ai/braidToolExecution.test.js:166:5'
          failureType: 'testCodeFailure'
          error: |-
            Expected values to be strictly equal:
            
            401 !== 200
            
          code: 'ERR_ASSERTION'
          name: 'AssertionError'
          expected: 200
          actual: 401
          operator: 'strictEqual'
          stack: |-
            TestContext.<anonymous> (file:///app/__tests__/ai/braidToolExecution.test.js:170:14)
            process.processTicksAndRejections (node:internal/process/task_queues:95:5)
            async Test.run (node:internal/test_runner/test:797:9)
            async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
          ...
        1..6
    not ok 2 - Retrieval Functions
      ---
      duration_ms: 405.590337
      type: 'suite'
      location: '/app/__tests__/ai/braidToolExecution.test.js:120:3'
      failureType: 'subtestsFailed'
      error: '5 subtests failed'
      code: 'ERR_TEST_FAILURE'
      ...
    # Subtest: Navigation Functions
        # Subtest: AI routes are accessible
        ok 1 - AI routes are accessible
          ---
          duration_ms: 229.166442
          ...
        # Subtest: Braid graph endpoint is accessible
        ok 2 - Braid graph endpoint is accessible
          ---
          duration_ms: 28.648922
          ...
        1..2
    ok 3 - Navigation Functions
      ---
      duration_ms: 258.363371
      type: 'suite'
      ...
    # Subtest: Update Functions
        # Subtest: POST /api/leads creates a new lead
        ok 1 - POST /api/leads creates a new lead
          ---
          duration_ms: 84.466491
          ...
        # Subtest: PUT /api/leads/:id updates a lead
        ok 2 - PUT /api/leads/:id updates a lead
          ---
          duration_ms: 0.792481
          ...
        # Subtest: DELETE /api/leads/:id removes a lead
        ok 3 - DELETE /api/leads/:id removes a lead
          ---
          duration_ms: 9.681097
          ...
        1..3
    ok 4 - Update Functions
      ---
      duration_ms: 95.543037
      type: 'suite'
      ...
    # Subtest: Braid Metrics API
        # Subtest: GET /api/braid/metrics/tools returns tool metrics
        ok 1 - GET /api/braid/metrics/tools returns tool metrics
          ---
          duration_ms: 29.620251
          ...
        # Subtest: GET /api/braid/metrics/timeseries returns time series data
        ok 2 - GET /api/braid/metrics/timeseries returns time series data
          ---
          duration_ms: 16.55064
          ...
        1..2
    ok 5 - Braid Metrics API
      ---
      duration_ms: 46.865119
      type: 'suite'
      ...
    # Subtest: Braid Integration Module
        # Subtest: TOOL_CATEGORIES are properly defined
        ok 1 - TOOL_CATEGORIES are properly defined
          ---
          duration_ms: 0.714008
          ...
        # Subtest: TOOL_GRAPH contains tool definitions
        not ok 2 - TOOL_GRAPH contains tool definitions
          ---
          duration_ms: 0.528908
          location: '/app/__tests__/ai/braidToolExecution.test.js:318:5'
          failureType: 'testCodeFailure'
          error: 'Should have create_lead tool'
          code: 'ERR_ASSERTION'
          name: 'AssertionError'
          expected: true
          operator: '=='
          stack: |-
            TestContext.<anonymous> (file:///app/__tests__/ai/braidToolExecution.test.js:325:14)
            Test.runInAsyncScope (node:async_hooks:206:9)
            Test.run (node:internal/test_runner/test:796:25)
            async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
          ...
        # Subtest: getToolDependencies returns dependency object
        ok 3 - getToolDependencies returns dependency object
          ---
          duration_ms: 0.314405
          ...
        # Subtest: getToolDependents returns dependents object
        ok 4 - getToolDependents returns dependents object
          ---
          duration_ms: 0.361508
          ...
        # Subtest: getToolsByCategory returns tools in category
        ok 5 - getToolsByCategory returns tools in category
          ---
          duration_ms: 1.083951
          ...
        # Subtest: detectCircularDependencies returns validation result
        ok 6 - detectCircularDependencies returns validation result
          ---
          duration_ms: 1.081331
          ...
        # Subtest: getToolImpactAnalysis returns analysis for valid tool
        ok 7 - getToolImpactAnalysis returns analysis for valid tool
          ---
          duration_ms: 1.152973
          ...
        1..7
    not ok 6 - Braid Integration Module
      ---
      duration_ms: 919.002283
      type: 'suite'
      location: '/app/__tests__/ai/braidToolExecution.test.js:294:3'
      failureType: 'subtestsFailed'
      error: '1 subtest failed'
      code: 'ERR_TEST_FAILURE'
      ...
    1..6
not ok 16 - Braid Tool Execution
  ---
  duration_ms: 2339.055308
  type: 'suite'
  location: '/app/__tests__/ai/braidToolExecution.test.js:20:1'
  failureType: 'subtestsFailed'
  error: '2 subtests failed'
  code: 'ERR_TEST_FAILURE'
  ...
# Subtest: Conversation Context Tests
    # Subtest: System Prompt Enhancements
        # Subtest: BRAID_SYSTEM_PROMPT includes conversation continuity section
        not ok 1 - BRAID_SYSTEM_PROMPT includes conversation continuity section
          ---
          duration_ms: 1184.052846
          location: '/app/__tests__/ai/conversationContext.test.js:19:5'
          failureType: 'testCodeFailure'
          error: 'System prompt should include conversation continuity section'
          code: 'ERR_ASSERTION'
          name: 'AssertionError'
          expected: true
          actual: false
          operator: '=='
          stack: |-
            TestContext.<anonymous> (file:///app/__tests__/ai/conversationContext.test.js:23:14)
            async Test.run (node:internal/test_runner/test:797:9)
            async Promise.all (index 0)
            async Suite.run (node:internal/test_runner/test:1135:7)
            async Promise.all (index 0)
            async Suite.run (node:internal/test_runner/test:1135:7)
            async Test.processPendingSubtests (node:internal/test_runner/test:526:7)
          ...
        # Subtest: System prompt includes suggest_next_actions trigger patterns
        not ok 2 - System prompt includes suggest_next_actions trigger patterns
          ---
          duration_ms: 7.562016
          location: '/app/__tests__/ai/conversationContext.test.js:44:5'
          failureType: 'testCodeFailure'
          error: 'System prompt should include trigger pattern: "What should I do next?"'
          code: 'ERR_ASSERTION'
          name: 'AssertionError'
          expected: true
          actual: false
          operator: '=='
          stack: |-
            TestContext.<anonymous> (file:///app/__tests__/ai/conversationContext.test.js:57:16)
            async Test.run (node:internal/test_runner/test:797:9)
            async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
          ...
        # Subtest: System prompt includes implicit reference handling examples
        not ok 3 - System prompt includes implicit reference handling examples
          ---
          duration_ms: 1.218947
          location: '/app/__tests__/ai/conversationContext.test.js:64:5'
          failureType: 'testCodeFailure'
          error: 'Should include warm leads example'
          code: 'ERR_ASSERTION'
          name: 'AssertionError'
          expected: true
          actual: false
          operator: '=='
          stack: |-
            TestContext.<anonymous> (file:///app/__tests__/ai/conversationContext.test.js:68:14)
            async Test.run (node:internal/test_runner/test:797:9)
            async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
          ...
        1..3
    not ok 1 - System Prompt Enhancements
      ---
      duration_ms: 1200.714276
      type: 'suite'
      location: '/app/__tests__/ai/conversationContext.test.js:17:3'
      failureType: 'subtestsFailed'
      error: '3 subtests failed'
      code: 'ERR_TEST_FAILURE'
      stack: |-
        async Promise.all (index 0)
      ...
    # Subtest: Session Context Injection
        # Subtest: Session entities format includes all required fields
        ok 1 - Session entities format includes all required fields
          ---
          duration_ms: 0.827649
          ...
        # Subtest: Conversation summary format includes role and content preview
        ok 2 - Conversation summary format includes role and content preview
          ---
          duration_ms: 5.606015
          ...
        1..2
    ok 2 - Session Context Injection
      ---
      duration_ms: 7.143306
      type: 'suite'
      ...
    # Subtest: Suggest Next Actions Tool
        # Subtest: suggest_next_actions tool is properly defined
        ok 1 - suggest_next_actions tool is properly defined
          ---
          duration_ms: 355.969741
          ...
        # Subtest: suggest_next_actions analyzes entity state correctly
        ok 2 - suggest_next_actions analyzes entity state correctly
          ---
          duration_ms: 10.124214
          ...
        1..2
    ok 3 - Suggest Next Actions Tool
      ---
      duration_ms: 366.730997
      type: 'suite'
      ...
    # Subtest: Expected Behavior with Problem Statement Scenario
        # Subtest: System prompt should prevent "I'm not sure" responses
        not ok 1 - System prompt should prevent "I'm not sure" responses
          ---
          duration_ms: 9.072116
          location: '/app/__tests__/ai/conversationContext.test.js:208:5'
          failureType: 'testCodeFailure'
          error: `System prompt should explicitly forbid "I'm not sure" responses`
          code: 'ERR_ASSERTION'
          name: 'AssertionError'
          expected: true
          actual: false
          operator: '=='
          stack: |-
            TestContext.<anonymous> (file:///app/__tests__/ai/conversationContext.test.js:229:14)
            async Test.run (node:internal/test_runner/test:797:9)
            async Promise.all (index 0)
            async Suite.run (node:internal/test_runner/test:1135:7)
            async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
          ...
        # Subtest: System prompt should mandate suggest_next_actions for "next steps" questions
        not ok 2 - System prompt should mandate suggest_next_actions for "next steps" questions
          ---
          duration_ms: 0.981407
          location: '/app/__tests__/ai/conversationContext.test.js:235:5'
          failureType: 'testCodeFailure'
          error: 'System prompt should use mandatory language'
          code: 'ERR_ASSERTION'
          name: 'AssertionError'
          expected: true
          actual: false
          operator: '=='
          stack: |-
            TestContext.<anonymous> (file:///app/__tests__/ai/conversationContext.test.js:241:14)
            async Test.run (node:internal/test_runner/test:797:9)
            async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
          ...
        # Subtest: Implicit reference "I think I only have 1" should be handleable
        not ok 3 - Implicit reference "I think I only have 1" should be handleable
          ---
          duration_ms: 5.986978
          location: '/app/__tests__/ai/conversationContext.test.js:257:5'
          failureType: 'testCodeFailure'
          error: 'Should include the exact example from problem statement'
          code: 'ERR_ASSERTION'
          name: 'AssertionError'
          expected: true
          actual: false
          operator: '=='
          stack: |-
            TestContext.<anonymous> (file:///app/__tests__/ai/conversationContext.test.js:266:14)
            async Test.run (node:internal/test_runner/test:797:9)
            async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
          ...
        1..3
    not ok 4 - Expected Behavior with Problem Statement Scenario
      ---
      duration_ms: 16.534937
      type: 'suite'
      location: '/app/__tests__/ai/conversationContext.test.js:206:3'
      failureType: 'subtestsFailed'
      error: '3 subtests failed'
      code: 'ERR_TEST_FAILURE'
      ...
    1..4
not ok 17 - Conversation Context Tests
  ---
  duration_ms: 1594.471419
  type: 'suite'
  location: '/app/__tests__/ai/conversationContext.test.js:15:1'
  failureType: 'subtestsFailed'
  error: '2 subtests failed'
  code: 'ERR_TEST_FAILURE'
  ...
# Subtest: Entity Context Extraction Tests
    # Subtest: extractEntityContext Helper Function
        # Subtest: extracts lead_id from tool arguments
        ok 1 - extracts lead_id from tool arguments
          ---
          duration_ms: 3.684503
          ...
        # Subtest: extracts contact_id from tool with id argument and name pattern
        ok 2 - extracts contact_id from tool with id argument and name pattern
          ---
          duration_ms: 1.093412
          ...
        # Subtest: extracts multiple entity types from multiple tools
        ok 3 - extracts multiple entity types from multiple tools
          ---
          duration_ms: 1.079784
          ...
        # Subtest: returns empty object for empty tool interactions
        ok 4 - returns empty object for empty tool interactions
          ---
          duration_ms: 2.032578
          ...
        # Subtest: handles tools without entity IDs gracefully
        ok 5 - handles tools without entity IDs gracefully
          ---
          duration_ms: 0.762978
          ...
        1..5
    ok 1 - extractEntityContext Helper Function
      ---
      duration_ms: 15.906789
      type: 'suite'
      ...
    # Subtest: Metadata Structure
        # Subtest: expected metadata structure includes entity IDs at top level
        ok 1 - expected metadata structure includes entity IDs at top level
          ---
          duration_ms: 0.875299
          ...
        # Subtest: metadata does not include null or undefined entity IDs
        ok 2 - metadata does not include null or undefined entity IDs
          ---
          duration_ms: 0.671279
          ...
        1..2
    ok 2 - Metadata Structure
      ---
      duration_ms: 2.202103
      type: 'suite'
      ...
    # Subtest: Context Carry-Forward Logic
        # Subtest: extracts most recent entity context from message history
        ok 1 - extracts most recent entity context from message history
          ---
          duration_ms: 1.167581
          ...
        # Subtest: handles empty message history gracefully
        ok 2 - handles empty message history gracefully
          ---
          duration_ms: 0.755407
          ...
        1..2
    ok 3 - Context Carry-Forward Logic
      ---
      duration_ms: 2.443224
      type: 'suite'
      ...
    1..3
ok 18 - Entity Context Extraction Tests
  ---
  duration_ms: 23.435835
  type: 'suite'
  ...
# Subtest: Entity Context Integration Tests
    # Subtest: End-to-End Entity Context Flow
        # Subtest: Simulates conversation with lead context extraction and persistence
        ok 1 - Simulates conversation with lead context extraction and persistence
          ---
          duration_ms: 3.280482
          ...
        # Subtest: Simulates multi-turn conversation with context switching
        ok 2 - Simulates multi-turn conversation with context switching
          ---
          duration_ms: 4.076377
          ...
        # Subtest: Verifies entity extraction from create operations
        ok 3 - Verifies entity extraction from create operations
          ---
          duration_ms: 2.347317
          ...
        # Subtest: Handles mixed entity operations in single turn
        ok 4 - Handles mixed entity operations in single turn
          ---
          duration_ms: 1.76475
          ...
        1..4
    ok 1 - End-to-End Entity Context Flow
      ---
      duration_ms: 13.058596
      type: 'suite'
      ...
    # Subtest: Query Pattern Examples
        # Subtest: Demonstrates JSONB query patterns enabled by top-level entity IDs
        ok 1 - Demonstrates JSONB query patterns enabled by top-level entity IDs
          ---
          duration_ms: 0.688001
          ...
        1..1
    ok 2 - Query Pattern Examples
      ---
      duration_ms: 1.041445
      type: 'suite'
      ...
    1..2
ok 19 - Entity Context Integration Tests
  ---
  duration_ms: 17.407045
  type: 'suite'
  ...
# Subtest: Intent Classifier
    # Subtest: AI_SUGGEST_NEXT_ACTIONS intent
        # Subtest: matches direct "what should I do next" queries
        ok 1 - matches direct "what should I do next" queries
          ---
          duration_ms: 5.892065
          ...
        # Subtest: matches "what do you recommend/suggest" queries
        ok 2 - matches "what do you recommend/suggest" queries
          ---
          duration_ms: 1.231547
          ...
        # Subtest: matches "how should I/we proceed" queries
        ok 3 - matches "how should I/we proceed" queries
          ---
          duration_ms: 1.270351
          ...
        # Subtest: matches "next step" queries
        ok 4 - matches "next step" queries
          ---
          duration_ms: 1.182117
          ...
        # Subtest: matches "suggest/recommend action/step" queries
        ok 5 - matches "suggest/recommend action/step" queries
          ---
          duration_ms: 2.602803
          ...
        # Subtest: matches "what are my/our next steps" queries
        ok 6 - matches "what are my/our next steps" queries
          ---
          duration_ms: 0.96867
          ...
        # Subtest: matches specific "what do you think about" queries (with plan/strategy context)
        ok 7 - matches specific "what do you think about" queries (with plan/strategy context)
          ---
          duration_ms: 1.852211
          ...
        # Subtest: matches specific "what would you" queries (with entity/action context)
        ok 8 - matches specific "what would you" queries (with entity/action context)
          ---
          duration_ms: 2.100285
          ...
        # Subtest: matches "any suggestions/recommendations" queries
        ok 9 - matches "any suggestions/recommendations" queries
          ---
          duration_ms: 4.945586
          ...
        # Subtest: matches "how should/can/do I approach/handle" queries
        ok 10 - matches "how should/can/do I approach/handle" queries
          ---
          duration_ms: 1.169092
          ...
        # Subtest: matches "what is the/my best next move/action/step" queries
        ok 11 - matches "what is the/my best next move/action/step" queries
          ---
          duration_ms: 1.018357
          ...
        # Subtest: False positives prevention (negative test cases)
            # Subtest: does NOT match general "what do you think" without action context
            ok 1 - does NOT match general "what do you think" without action context
              ---
              duration_ms: 43.182904
              ...
            # Subtest: does NOT match general "what would you" without entity/action context
            ok 2 - does NOT match general "what would you" without entity/action context
              ---
              duration_ms: 3.946221
              ...
            # Subtest: does NOT match informational queries about entities
            ok 3 - does NOT match informational queries about entities
              ---
              duration_ms: 1.189191
              ...
            1..3
        ok 12 - False positives prevention (negative test cases)
          ---
          duration_ms: 49.145179
          type: 'suite'
          ...
        1..12
    ok 1 - AI_SUGGEST_NEXT_ACTIONS intent
      ---
      duration_ms: 77.679337
      type: 'suite'
      ...
    # Subtest: NOTE_LIST_FOR_RECORD intent
        # Subtest: matches "show/get/display/read notes" queries
        ok 1 - matches "show/get/display/read notes" queries
          ---
          duration_ms: 3.922769
          ...
        # Subtest: matches "show/get/display notes for/on/about" queries
        ok 2 - matches "show/get/display notes for/on/about" queries
          ---
          duration_ms: 0.982713
          ...
        # Subtest: matches "what are the notes" queries
        ok 3 - matches "what are the notes" queries
          ---
          duration_ms: 0.706281
          ...
        # Subtest: matches "last/latest/most recent note" queries
        ok 4 - matches "last/latest/most recent note" queries
          ---
          duration_ms: 1.260411
          ...
        # Subtest: matches "are there any notes" queries
        ok 5 - matches "are there any notes" queries
          ---
          duration_ms: 2.885372
          ...
        # Subtest: matches "check/see/view notes" queries
        ok 6 - matches "check/see/view notes" queries
          ---
          duration_ms: 1.351679
          ...
        # Subtest: Edge cases - pattern conflict prevention
            # Subtest: does NOT match NOTE_SEARCH patterns
            ok 1 - does NOT match NOTE_SEARCH patterns
              ---
              duration_ms: 0.938721
              ...
            # Subtest: does NOT match NOTE_CREATE patterns
            ok 2 - does NOT match NOTE_CREATE patterns
              ---
              duration_ms: 6.06573
              ...
            1..2
        ok 7 - Edge cases - pattern conflict prevention
          ---
          duration_ms: 7.367206
          type: 'suite'
          ...
        1..7
    ok 2 - NOTE_LIST_FOR_RECORD intent
      ---
      duration_ms: 19.641773
      type: 'suite'
      ...
    # Subtest: Edge cases and special scenarios
        # Subtest: handles null/undefined/empty input gracefully
        ok 1 - handles null/undefined/empty input gracefully
          ---
          duration_ms: 0.630726
          ...
        # Subtest: handles non-string input gracefully
        ok 2 - handles non-string input gracefully
          ---
          duration_ms: 0.34212
          ...
        # Subtest: returns null for unmatched patterns
        ok 3 - returns null for unmatched patterns
          ---
          duration_ms: 0.719708
          ...
        # Subtest: case insensitive matching
        ok 4 - case insensitive matching
          ---
          duration_ms: 1.066368
          ...
        # Subtest: handles messages with extra whitespace
        ok 5 - handles messages with extra whitespace
          ---
          duration_ms: 8.552031
          ...
        1..5
    ok 3 - Edge cases and special scenarios
      ---
      duration_ms: 11.856997
      type: 'suite'
      ...
    # Subtest: Priority ordering
        # Subtest: AI_SUGGEST_NEXT_ACTIONS has highest priority
        ok 1 - AI_SUGGEST_NEXT_ACTIONS has highest priority
          ---
          duration_ms: 0.461717
          ...
        1..1
    ok 4 - Priority ordering
      ---
      duration_ms: 2.630517
      type: 'suite'
      ...
    1..4
ok 20 - Intent Classifier
  ---
  duration_ms: 114.636856
  type: 'suite'
  ...
# Subtest: AI Memory System (RAG) - Phase 7
    # Subtest: Redaction Module
        # Subtest: should redact API keys and tokens
        ok 1 - should redact API keys and tokens
          ---
          duration_ms: 24.282917
          ...
        # Subtest: should preserve CRM data while redacting secrets
        ok 2 - should preserve CRM data while redacting secrets
          ---
          duration_ms: 1.241227
          ...
        1..2
    ok 1 - Redaction Module
      ---
      duration_ms: 28.655104
      type: 'suite'
      ...
    # Subtest: Chunker Module
        # Subtest: should split long text into chunks
        ok 1 - should split long text into chunks
          ---
          duration_ms: 10.664689
          ...
        # Subtest: should not chunk text shorter than maxChars
        ok 2 - should not chunk text shorter than maxChars
          ---
          duration_ms: 1.123741
          ...
        # Subtest: should create chunks with overlap
        ok 3 - should create chunks with overlap
          ---
          duration_ms: 0.682148
          ...
        1..3
    ok 2 - Chunker Module
      ---
      duration_ms: 13.571874
      type: 'suite'
      ...
    # Subtest: Memory Store - Tenant Isolation
        # Subtest: should prevent cross-tenant memory leakage
        ok 1 - should prevent cross-tenant memory leakage
          ---
          duration_ms: 1.059614
          ...
        # Subtest: should enforce RLS policies on ai_memory_chunks table
        ok 2 - should enforce RLS policies on ai_memory_chunks table
          ---
          duration_ms: 0.463311
          ...
        1..2
    ok 3 - Memory Store - Tenant Isolation
      ---
      duration_ms: 2.555833
      type: 'suite'
      ...
    # Subtest: Security - Prompt Injection Defense
        # Subtest: should inject memory with UNTRUSTED boundary marker
        ok 1 - should inject memory with UNTRUSTED boundary marker
          ---
          duration_ms: 12.321772
          ...
        # Subtest: should not execute malicious commands from stored memory
        ok 2 - should not execute malicious commands from stored memory
          ---
          duration_ms: 1.177168
          ...
        1..2
    ok 4 - Security - Prompt Injection Defense
      ---
      duration_ms: 14.334938
      type: 'suite'
      ...
    # Subtest: Retrieval Quality
        # Subtest: should return top-K most relevant memories
        ok 1 - should return top-K most relevant memories
          ---
          duration_ms: 1.091377
          ...
        # Subtest: should filter memories below similarity threshold
        ok 2 - should filter memories below similarity threshold
          ---
          duration_ms: 3.459945
          ...
        1..2
    ok 5 - Retrieval Quality
      ---
      duration_ms: 4.926489
      type: 'suite'
      ...
    # Subtest: Conversation Summaries
        # Subtest: should generate summaries for conversations
        ok 1 - should generate summaries for conversations
          ---
          duration_ms: 384.151216
          ...
        # Subtest: should extract key information in summaries
        ok 2 - should extract key information in summaries
          ---
          duration_ms: 0.779699
          ...
        # Subtest: should update summaries incrementally
        ok 3 - should update summaries incrementally
          ---
          duration_ms: 1.230081
          ...
        1..3
    ok 6 - Conversation Summaries
      ---
      duration_ms: 386.734392
      type: 'suite'
      ...
    # Subtest: Performance
        # Subtest: should retrieve memory in < 100ms for topK=8
        ok 1 - should retrieve memory in < 100ms for topK=8
          ---
          duration_ms: 0.736993
          ...
        # Subtest: should not block note/activity creation
        ok 2 - should not block note/activity creation
          ---
          duration_ms: 0.655768
          ...
        1..2
    ok 7 - Performance
      ---
      duration_ms: 1.827151
      type: 'suite'
      ...
# ✓ Supabase DB client initialized with performance tracking
    # Subtest: Environment Configuration
        # Subtest: should disable memory when MEMORY_ENABLED=false
        ok 1 - should disable memory when MEMORY_ENABLED=false
          ---
          duration_ms: 47.138277
          ...
        # Subtest: should use default config values when env vars missing
        not ok 2 - should use default config values when env vars missing
          ---
          duration_ms: 6.804469
          location: '/app/__tests__/ai/memory.test.js:212:5'
          failureType: 'testCodeFailure'
          error: |-
            Default maxChunkChars should be 2000
            
            3500 !== 2000
            
          code: 'ERR_ASSERTION'
          name: 'AssertionError'
          expected: 2000
          actual: 3500
          operator: 'strictEqual'
          stack: |-
            TestContext.<anonymous> (file:///app/__tests__/ai/memory.test.js:225:14)
            async Test.run (node:internal/test_runner/test:797:9)
            async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
          ...
        # Subtest: should override config values from environment
        ok 3 - should override config values from environment
          ---
          duration_ms: 1.008939
          ...
        1..3
    not ok 8 - Environment Configuration
      ---
      duration_ms: 55.660858
      type: 'suite'
      location: '/app/__tests__/ai/memory.test.js:195:3'
      failureType: 'subtestsFailed'
      error: '1 subtest failed'
      code: 'ERR_TEST_FAILURE'
      ...
    # Subtest: Integration Tests - Cross-Tenant Isolation
        # Subtest: should not leak memory between tenants (mock test)
        ok 1 - should not leak memory between tenants (mock test)
          ---
          duration_ms: 0.969988
          ...
        # Subtest: should enforce tenant_id filter in all queries
        ok 2 - should enforce tenant_id filter in all queries
          ---
          duration_ms: 1.000503
          ...
        1..2
    ok 9 - Integration Tests - Cross-Tenant Isolation
      ---
      duration_ms: 4.187669
      type: 'suite'
      ...
    # Subtest: Integration Tests - Prompt Injection Mitigation
        # Subtest: should wrap memory content with UNTRUSTED boundary
        ok 1 - should wrap memory content with UNTRUSTED boundary
          ---
          duration_ms: 0.523846
          ...
        # Subtest: should redact sensitive content before storage
        ok 2 - should redact sensitive content before storage
          ---
          duration_ms: 0.515789
          ...
        1..2
    ok 10 - Integration Tests - Prompt Injection Mitigation
      ---
      duration_ms: 1.283458
      type: 'suite'
      ...
    # Subtest: Integration Tests - Performance Requirements
        # Subtest: should complete memory config retrieval in < 1ms
        ok 1 - should complete memory config retrieval in < 1ms
          ---
          duration_ms: 9.103831
          ...
        # Subtest: should chunk text efficiently
        ok 2 - should chunk text efficiently
          ---
          duration_ms: 0.818079
          ...
        1..2
    ok 11 - Integration Tests - Performance Requirements
      ---
      duration_ms: 10.183021
      type: 'suite'
      ...
    # Subtest: Integration Tests - Conversation Summaries
        # Subtest: should export summary functions
        ok 1 - should export summary functions
          ---
          duration_ms: 0.569606
          ...
        # Subtest: should return null for non-existent conversation
        ok 2 - should return null for non-existent conversation
          ---
          duration_ms: 531.779555
          ...
        # Subtest: should require conversationId and tenantId
        ok 3 - should require conversationId and tenantId
          ---
          duration_ms: 6.286775
          ...
        1..3
    ok 12 - Integration Tests - Conversation Summaries
      ---
      duration_ms: 545.164825
      type: 'suite'
      ...
    1..12
not ok 21 - AI Memory System (RAG) - Phase 7
  ---
  duration_ms: 1084.682285
  type: 'suite'
  location: '/app/__tests__/ai/memory.test.js:19:1'
  failureType: 'subtestsFailed'
  error: '1 subtest failed'
  code: 'ERR_TEST_FAILURE'
  ...
# Subtest: Memory Gating
    # Subtest: shouldUseMemory
        # Subtest: default behavior (OFF unless triggered)
            # Subtest: should return false for generic questions
            ok 1 - should return false for generic questions
              ---
              duration_ms: 4.977102
              ...
            # Subtest: should return true for "last time" patterns
            ok 2 - should return true for "last time" patterns
              ---
              duration_ms: 0.979607
              ...
            # Subtest: should return true for "previous" patterns
            ok 3 - should return true for "previous" patterns
              ---
              duration_ms: 0.858849
              ...
            # Subtest: should return true for "remind me" patterns
            ok 4 - should return true for "remind me" patterns
              ---
              duration_ms: 0.734821
              ...
            # Subtest: should return true for "what did we" patterns
            ok 5 - should return true for "what did we" patterns
              ---
              duration_ms: 0.707595
              ...
            # Subtest: should return true for "recap" patterns
            ok 6 - should return true for "recap" patterns
              ---
              duration_ms: 0.715501
              ...
            # Subtest: should return true for "history" patterns
            ok 7 - should return true for "history" patterns
              ---
              duration_ms: 0.687209
              ...
            # Subtest: should return true for "follow up" patterns
            ok 8 - should return true for "follow up" patterns
              ---
              duration_ms: 0.450833
              ...
            # Subtest: should return true for "mentioned" patterns
            ok 9 - should return true for "mentioned" patterns
              ---
              duration_ms: 0.571462
              ...
            # Subtest: should return true for "earlier" patterns
            ok 10 - should return true for "earlier" patterns
              ---
              duration_ms: 0.685276
              ...
            # Subtest: should return true for "before" patterns
            ok 11 - should return true for "before" patterns
              ---
              duration_ms: 0.449947
              ...
            1..11
        ok 1 - default behavior (OFF unless triggered)
          ---
          duration_ms: 13.692003
          type: 'suite'
          ...
        # Subtest: environment overrides
            # Subtest: should return true when AI_MEMORY_ALWAYS_ON=true (with MEMORY_ENABLED)
            ok 1 - should return true when AI_MEMORY_ALWAYS_ON=true (with MEMORY_ENABLED)
              ---
              duration_ms: 1.013813
              ...
            # Subtest: should return false when AI_MEMORY_ALWAYS_ON=true but MEMORY_ENABLED=false
            ok 2 - should return false when AI_MEMORY_ALWAYS_ON=true but MEMORY_ENABLED=false
              ---
              duration_ms: 2.916738
              ...
            # Subtest: should return false when AI_MEMORY_ALWAYS_OFF=true
            ok 3 - should return false when AI_MEMORY_ALWAYS_OFF=true
              ---
              duration_ms: 0.781081
              ...
            # Subtest: should prioritize ALWAYS_OFF over everything
            ok 4 - should prioritize ALWAYS_OFF over everything
              ---
              duration_ms: 0.530379
              ...
            1..4
        ok 2 - environment overrides
          ---
          duration_ms: 5.674319
          type: 'suite'
          ...
        # Subtest: edge cases
            # Subtest: should handle empty string
            ok 1 - should handle empty string
              ---
              duration_ms: 0.540407
              ...
            # Subtest: should handle null/undefined
            ok 2 - should handle null/undefined
              ---
              duration_ms: 6.382145
              ...
            # Subtest: should be case-insensitive
            ok 3 - should be case-insensitive
              ---
              duration_ms: 0.694069
              ...
            1..3
        ok 3 - edge cases
          ---
          duration_ms: 8.067093
          type: 'suite'
          ...
        1..3
    ok 1 - shouldUseMemory
      ---
      duration_ms: 28.256103
      type: 'suite'
      ...
    # Subtest: shouldInjectConversationSummary
        # Subtest: should return false for short conversations
        ok 1 - should return false for short conversations
          ---
          duration_ms: 0.750734
          ...
        # Subtest: should return true for long conversations with trigger
        ok 2 - should return true for long conversations with trigger
          ---
          duration_ms: 0.75555
          ...
        # Subtest: should respect custom minMessages threshold
        ok 3 - should respect custom minMessages threshold
          ---
          duration_ms: 0.836835
          ...
        # Subtest: should return false without trigger even for long conversations
        ok 4 - should return false without trigger even for long conversations
          ---
          duration_ms: 0.592377
          ...
        1..4
    ok 2 - shouldInjectConversationSummary
      ---
      duration_ms: 3.28103
      type: 'suite'
      ...
    # Subtest: getMemoryConfig
        # Subtest: should return reduced defaults
        not ok 1 - should return reduced defaults
          ---
          duration_ms: 15.365168
          location: '/app/__tests__/ai/memoryGating.test.js:198:5'
          failureType: 'testCodeFailure'
          error: |-
            Expected values to be strictly equal:
            
            3500 !== 2000
            
          code: 'ERR_ASSERTION'
          name: 'AssertionError'
          expected: 2000
          actual: 3500
          operator: 'strictEqual'
          stack: |-
            TestContext.<anonymous> (file:///app/__tests__/ai/memoryGating.test.js:205:14)
            Test.runInAsyncScope (node:async_hooks:206:9)
            Test.run (node:internal/test_runner/test:796:25)
            async Promise.all (index 0)
            async Suite.run (node:internal/test_runner/test:1135:7)
            async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
          ...
        # Subtest: should respect environment overrides
        ok 2 - should respect environment overrides
          ---
          duration_ms: 7.248222
          ...
        1..2
    not ok 3 - getMemoryConfig
      ---
      duration_ms: 23.343026
      type: 'suite'
      location: '/app/__tests__/ai/memoryGating.test.js:197:3'
      failureType: 'subtestsFailed'
      error: '1 subtest failed'
      code: 'ERR_TEST_FAILURE'
      ...
    1..3
not ok 22 - Memory Gating
  ---
  duration_ms: 57.693708
  type: 'suite'
  location: '/app/__tests__/ai/memoryGating.test.js:19:1'
  failureType: 'subtestsFailed'
  error: '1 subtest failed'
  code: 'ERR_TEST_FAILURE'
  ...
# ✓ Supabase DB client initialized with performance tracking
# ✓ Supabase DB client initialized (using centralized factory)
# [R2 Artifact] Supabase client initialized
# [R2 Artifact] R2 module imported, configured: false
# [R2 Artifact] Could not create test conversation: Could not find the 'user_id' column of 'conversations' in the schema cache
# [Skip] R2 not configured or module unavailable
# [Skip] R2 not configured or module unavailable
# [Skip] R2 not configured, Supabase unavailable, or R2 module missing
# Subtest: R2 Artifact Offload Tests
    # Subtest: R2 Module Functions
        # Subtest: buildTenantKey generates valid tenant-scoped key
        ok 1 - buildTenantKey generates valid tenant-scoped key
          ---
          duration_ms: 2.183146
          ...
        # Subtest: putObject uploads to R2 (skips if not configured)
        ok 2 - putObject uploads to R2 (skips if not configured)
          ---
          duration_ms: 1.48125
          ...
        # Subtest: getObject retrieves from R2 (skips if not configured)
        ok 3 - getObject retrieves from R2 (skips if not configured)
          ---
          duration_ms: 1.234689
          ...
        1..3
    ok 1 - R2 Module Functions
      ---
      duration_ms: 20.711806
      type: 'suite'
      ...
    # Subtest: artifact_refs Database Operations
        # Subtest: writeArtifactRef stores pointer and uploads to R2 (skips if not configured)
        ok 1 - writeArtifactRef stores pointer and uploads to R2 (skips if not configured)
          ---
          duration_ms: 1.790966
          ...
# [Skip] R2 not configured, Supabase unavailable, or no test conversation
# [Skip] R2 not configured, Supabase unavailable, or no test conversation
# [Expected] R2 not configured - offloading would be skipped
        # Subtest: artifact_refs enforces tenant isolation via RLS
        ok 2 - artifact_refs enforces tenant isolation via RLS
          ---
          duration_ms: 97.667854
          ...
        1..2
    ok 2 - artifact_refs Database Operations
      ---
      duration_ms: 100.223485
      type: 'suite'
      ...
    # Subtest: Metadata Offload Logic
        # Subtest: maybeOffloadMetadata offloads tool_interactions array (mock)
        ok 1 - maybeOffloadMetadata offloads tool_interactions array (mock)
          ---
          duration_ms: 4.379046
          ...
        # Subtest: maybeOffloadMetadata offloads oversized metadata (mock)
        ok 2 - maybeOffloadMetadata offloads oversized metadata (mock)
          ---
          duration_ms: 10.138849
          ...
        1..2
    ok 3 - Metadata Offload Logic
      ---
      duration_ms: 15.405674
      type: 'suite'
      ...
    # Subtest: insertAssistantMessage Integration
        # Subtest: insertAssistantMessage with tool_interactions stores ref (requires R2)
        ok 1 - insertAssistantMessage with tool_interactions stores ref (requires R2)
          ---
          duration_ms: 1.714428
          ...
        # Subtest: Tool context message stores tool_results_ref (requires R2)
        ok 2 - Tool context message stores tool_results_ref (requires R2)
          ---
          duration_ms: 17.512192
          ...
        1..2
    ok 4 - insertAssistantMessage Integration
      ---
      duration_ms: 19.73891
      type: 'suite'
      ...
    # Subtest: Error Handling & Graceful Degradation
        # Subtest: Offload failures should not break chat flow
        ok 1 - Offload failures should not break chat flow
          ---
          duration_ms: 5.875097
          ...
        # Subtest: Missing tenant_id should skip offload gracefully
        ok 2 - Missing tenant_id should skip offload gracefully
          ---
          duration_ms: 7.357553
          ...
        # Subtest: R2 not configured should log warning but not fail
        ok 3 - R2 not configured should log warning but not fail
          ---
          duration_ms: 14.644941
          ...
        1..3
    ok 5 - Error Handling & Graceful Degradation
      ---
      duration_ms: 28.454446
      type: 'suite'
      ...
    1..5
ok 23 - R2 Artifact Offload Tests
  ---
  duration_ms: 1252.417916
  type: 'suite'
  ...
# ✓ Supabase DB client initialized with performance tracking
# ✓ Supabase DB client initialized (using centralized factory)
# Subtest: Suggestions Routes
    # Subtest: GET /api/ai/suggestions returns 200
    ok 1 - GET /api/ai/suggestions returns 200
      ---
      duration_ms: 726.564582
      ...
    # Subtest: GET /api/ai/suggestions requires tenant_id
    ok 2 - GET /api/ai/suggestions requires tenant_id
      ---
      duration_ms: 107.399427
      ...
    # Subtest: GET /api/ai/suggestions/:id returns single suggestion
    ok 3 - GET /api/ai/suggestions/:id returns single suggestion
      ---
      duration_ms: 276.810054
      ...
    # Subtest: GET /api/ai/suggestions/stats returns statistics
    ok 4 - GET /api/ai/suggestions/stats returns statistics
      ---
      duration_ms: 137.866435
      ...
    # Subtest: POST /api/ai/suggestions/trigger triggers detection
    ok 5 - POST /api/ai/suggestions/trigger triggers detection
      ---
      duration_ms: 4246.668359
      ...
    # Subtest: GET /api/ai/suggestions supports status filter
    ok 6 - GET /api/ai/suggestions supports status filter
      ---
      duration_ms: 185.392056
      ...
    # Subtest: GET /api/ai/suggestions supports trigger_id filter
    ok 7 - GET /api/ai/suggestions supports trigger_id filter
      ---
      duration_ms: 297.036412
      ...
    # Subtest: GET /api/ai/suggestions supports priority filter
    ok 8 - GET /api/ai/suggestions supports priority filter
      ---
      duration_ms: 270.226286
      ...
    # Subtest: GET /api/ai/suggestions supports record_type filter
    ok 9 - GET /api/ai/suggestions supports record_type filter
      ---
      duration_ms: 210.449883
      ...
    # Subtest: GET /api/ai/suggestions supports pagination with limit and offset
    ok 10 - GET /api/ai/suggestions supports pagination with limit and offset
      ---
      duration_ms: 302.047784
      ...
    1..10
ok 24 - Suggestions Routes
  ---
  duration_ms: 7038.572887
  type: 'suite'
  ...
# Subtest: Suggestion Actions
    # Subtest: POST /api/ai/suggestions/:id/approve returns appropriate response
    ok 1 - POST /api/ai/suggestions/:id/approve returns appropriate response
      ---
      duration_ms: 263.845562
      ...
    # Subtest: POST /api/ai/suggestions/:id/reject returns appropriate response
    ok 2 - POST /api/ai/suggestions/:id/reject returns appropriate response
      ---
      duration_ms: 286.487558
      ...
    # Subtest: POST /api/ai/suggestions/:id/apply returns appropriate response
    ok 3 - POST /api/ai/suggestions/:id/apply returns appropriate response
      ---
      duration_ms: 307.43484
      ...
    # Subtest: POST /api/ai/suggestions/:id/approve returns 404 for invalid ID
    ok 4 - POST /api/ai/suggestions/:id/approve returns 404 for invalid ID
      ---
      duration_ms: 118.512091
      ...
    1..4
ok 25 - Suggestion Actions
  ---
  duration_ms: 977.721011
  type: 'suite'
  ...
# Subtest: Metrics Endpoints
    # Subtest: GET /api/ai/suggestions/metrics returns metrics data
    ok 1 - GET /api/ai/suggestions/metrics returns metrics data
      ---
      duration_ms: 209.504224
      ...
    # Subtest: GET /api/ai/suggestions/metrics supports date range
    ok 2 - GET /api/ai/suggestions/metrics supports date range
      ---
      duration_ms: 221.259446
      ...
    1..2
ok 26 - Metrics Endpoints
  ---
  duration_ms: 431.802771
  type: 'suite'
  ...
# [TenantContextDictionary] Error resolving tenant: Cannot read properties of null (reading 'query')
# Subtest: Tenant Context Dictionary
    # Subtest: V3_WORKFLOW_DEFINITIONS
        # Subtest: should have three main workflows
        ok 1 - should have three main workflows
          ---
          duration_ms: 9.430802
          ...
        # Subtest: bizdev_to_lead workflow should have correct stages
        ok 2 - bizdev_to_lead workflow should have correct stages
          ---
          duration_ms: 10.456094
          ...
        # Subtest: lead_to_conversion workflow should have correct stages
        ok 3 - lead_to_conversion workflow should have correct stages
          ---
          duration_ms: 0.719007
          ...
        # Subtest: opportunity_pipeline workflow should have standard sales stages
        ok 4 - opportunity_pipeline workflow should have standard sales stages
          ---
          duration_ms: 0.584261
          ...
        1..4
    ok 1 - V3_WORKFLOW_DEFINITIONS
      ---
      duration_ms: 23.36555
      type: 'suite'
      ...
    # Subtest: DEFAULT_STATUS_CARDS
        # Subtest: should have status cards for all main entities
        ok 1 - should have status cards for all main entities
          ---
          duration_ms: 0.945792
          ...
        # Subtest: leads should have standard v3.0.0 statuses
        ok 2 - leads should have standard v3.0.0 statuses
          ---
          duration_ms: 1.036125
          ...
        # Subtest: activities should have status-based cards
        ok 3 - activities should have status-based cards
          ---
          duration_ms: 0.599603
          ...
        1..3
    ok 2 - DEFAULT_STATUS_CARDS
      ---
      duration_ms: 3.744075
      type: 'suite'
      ...
    # Subtest: generateContextDictionaryPrompt()
        # Subtest: should handle error dictionary gracefully
        ok 1 - should handle error dictionary gracefully
          ---
          duration_ms: 1.526514
          ...
        # Subtest: should generate prompt with tenant information
        ok 2 - should generate prompt with tenant information
          ---
          duration_ms: 1.7163
          ...
        # Subtest: should not include custom terminology section if no customizations
        ok 3 - should not include custom terminology section if no customizations
          ---
          duration_ms: 1.468525
          ...
        1..3
    ok 3 - generateContextDictionaryPrompt()
      ---
      duration_ms: 5.638083
      type: 'suite'
      ...
    # Subtest: buildTenantContextDictionary()
        # Subtest: should require a database pool
        ok 1 - should require a database pool
          ---
          duration_ms: 7.45224
          ...
        # Subtest: should return error for non-existent tenant
        ok 2 - should return error for non-existent tenant
          ---
          duration_ms: 1.022187
          ...
        1..2
    ok 4 - buildTenantContextDictionary()
      ---
      duration_ms: 9.118398
      type: 'suite'
      ...
    1..4
ok 27 - Tenant Context Dictionary
  ---
  duration_ms: 797.821154
  type: 'suite'
  ...
# [TokenBudget] Enforced tool schema cap: { original: 20, capped: 6, tokensEstimate: 468, cap: 500 }
# [TokenBudget] Enforced tool schema cap: { original: 20, capped: 5, tokensEstimate: 256, cap: 300 }
# [Budget] total=750, system=100, tools=300, memory=50, history=200
# [Budget] total=700, system=100, tools=300, memory=0, history=200, actions=cleared_memory,dropped_5_tools
# Subtest: TokenBudgetManager
    # Subtest: estimateTokens
        # Subtest: should estimate tokens at ~4 chars per token
        ok 1 - should estimate tokens at ~4 chars per token
          ---
          duration_ms: 3.959924
          ...
        # Subtest: should handle empty string
        ok 2 - should handle empty string
          ---
          duration_ms: 0.613067
          ...
        # Subtest: should handle null/undefined
        ok 3 - should handle null/undefined
          ---
          duration_ms: 0.534909
          ...
        # Subtest: should handle long strings
        ok 4 - should handle long strings
          ---
          duration_ms: 0.477357
          ...
        1..4
    ok 1 - estimateTokens
      ---
      duration_ms: 8.939512
      type: 'suite'
      ...
    # Subtest: estimateMessagesTokens
        # Subtest: should estimate tokens for simple messages
        ok 1 - should estimate tokens for simple messages
          ---
          duration_ms: 1.621022
          ...
        # Subtest: should handle empty messages array
        ok 2 - should handle empty messages array
          ---
          duration_ms: 0.707377
          ...
        # Subtest: should account for tool_calls
        ok 3 - should account for tool_calls
          ---
          duration_ms: 0.627958
          ...
        1..3
    ok 2 - estimateMessagesTokens
      ---
      duration_ms: 3.990054
      type: 'suite'
      ...
    # Subtest: estimateToolsTokens
        # Subtest: should estimate tokens for tool schemas
        ok 1 - should estimate tokens for tool schemas
          ---
          duration_ms: 0.977757
          ...
        # Subtest: should handle empty tools array
        ok 2 - should handle empty tools array
          ---
          duration_ms: 0.384715
          ...
        1..2
    ok 3 - estimateToolsTokens
      ---
      duration_ms: 4.573038
      type: 'suite'
      ...
    # Subtest: buildBudgetReport
        # Subtest: should build a complete budget report
        ok 1 - should build a complete budget report
          ---
          duration_ms: 1.225193
          ...
        # Subtest: should correctly identify when over budget
        ok 2 - should correctly identify when over budget
          ---
          duration_ms: 0.528548
          ...
        1..2
    ok 4 - buildBudgetReport
      ---
      duration_ms: 2.126123
      type: 'suite'
      ...
    # Subtest: applyBudgetCaps
        # Subtest: should return unchanged data when within budget
        ok 1 - should return unchanged data when within budget
          ---
          duration_ms: 1.105806
          ...
        # Subtest: should drop memory first when over budget
        ok 2 - should drop memory first when over budget
          ---
          duration_ms: 0.439965
          ...
        # Subtest: should preserve forced tool when dropping tools
        ok 3 - should preserve forced tool when dropping tools
          ---
          duration_ms: 1.086059
          ...
        1..3
    ok 5 - applyBudgetCaps
      ---
      duration_ms: 3.183625
      type: 'suite'
      ...
    # Subtest: enforceToolSchemaCap
        # Subtest: should limit tools by token count
        ok 1 - should limit tools by token count
          ---
          duration_ms: 9.643783
          ...
        # Subtest: should preserve forced tool
        ok 2 - should preserve forced tool
          ---
          duration_ms: 1.195762
          ...
        # Subtest: should handle empty tools array
        ok 3 - should handle empty tools array
          ---
          duration_ms: 1.853887
          ...
        1..3
    ok 6 - enforceToolSchemaCap
      ---
      duration_ms: 13.297069
      type: 'suite'
      ...
    # Subtest: logBudgetSummary
        # Subtest: should log budget summary without throwing
        ok 1 - should log budget summary without throwing
          ---
          duration_ms: 1.851248
          ...
        # Subtest: should log actions taken
        ok 2 - should log actions taken
          ---
          duration_ms: 1.170943
          ...
        1..2
    ok 7 - logBudgetSummary
      ---
      duration_ms: 3.392111
      type: 'suite'
      ...
    # Subtest: TOKEN_CAPS constants
        # Subtest: should have expected caps defined
        ok 1 - should have expected caps defined
          ---
          duration_ms: 2.104048
          ...
        # Subtest: should have reasonable default values
        ok 2 - should have reasonable default values
          ---
          duration_ms: 0.701418
          ...
        1..2
    ok 8 - TOKEN_CAPS constants
      ---
      duration_ms: 3.173496
      type: 'suite'
      ...
    # Subtest: Integration: Full budget enforcement pipeline
        # Subtest: should produce a valid request payload under budget from oversized inputs
        ok 1 - should produce a valid request payload under budget from oversized inputs
          ---
          duration_ms: 3.339864
          ...
        # Subtest: should not modify inputs that are already within budget
        ok 2 - should not modify inputs that are already within budget
          ---
          duration_ms: 0.730101
          ...
        1..2
    ok 9 - Integration: Full budget enforcement pipeline
      ---
      duration_ms: 4.382863
      type: 'suite'
      ...
    1..9
ok 28 - TokenBudgetManager
  ---
  duration_ms: 52.488208
  type: 'suite'
  ...
# Subtest: BUG-AUTH-002: Login Authentication
    # Subtest: POST /api/auth/login
        # Subtest: should reject login with missing email
        ok 1 - should reject login with missing email
          ---
          duration_ms: 338.423785
          ...
        # Subtest: should reject login with missing password
        ok 2 - should reject login with missing password
          ---
          duration_ms: 159.837542
          ...
        # Subtest: should reject login with invalid credentials
        ok 3 - should reject login with invalid credentials
          ---
          duration_ms: 395.380786
          ...
        # Subtest: should reject login for disabled account
        ok 4 - should reject login for disabled account
          ---
          duration_ms: 284.395804
          ...
        # Subtest: should normalize email to lowercase
        ok 5 - should normalize email to lowercase
          ---
          duration_ms: 366.06813
          ...
        # Subtest: should handle whitespace in email
        ok 6 - should handle whitespace in email
          ---
          duration_ms: 274.41663
          ...
        1..6
    ok 1 - POST /api/auth/login
      ---
      duration_ms: 1821.645584
      type: 'suite'
      ...
    # Subtest: POST /api/auth/verify-token
        # Subtest: should reject request with missing token
        ok 1 - should reject request with missing token
          ---
          duration_ms: 114.591426
          ...
        # Subtest: should reject invalid token
        ok 2 - should reject invalid token
          ---
          duration_ms: 112.258466
          ...
        1..2
    ok 2 - POST /api/auth/verify-token
      ---
      duration_ms: 228.220431
      type: 'suite'
      ...
    # Subtest: GET /api/auth/me
        # Subtest: should return 401 without auth cookie
        ok 1 - should return 401 without auth cookie
          ---
          duration_ms: 112.619783
          ...
        1..1
    ok 3 - GET /api/auth/me
      ---
      duration_ms: 113.045961
      type: 'suite'
      ...
    # Subtest: POST /api/auth/logout
        # Subtest: should successfully logout even without session
        ok 1 - should successfully logout even without session
          ---
          duration_ms: 110.609899
          ...
        1..1
    ok 4 - POST /api/auth/logout
      ---
      duration_ms: 111.211608
      type: 'suite'
      ...
    1..4
ok 29 - BUG-AUTH-002: Login Authentication
  ---
  duration_ms: 2782.832467
  type: 'suite'
  ...
# Subtest: BUG-AUTH-002: Complete Login Flow
    # Subtest: should successfully login with valid credentials
    ok 1 - should successfully login with valid credentials # SKIP
      ---
      duration_ms: 0.757832
      ...
    # Subtest: should be able to access /me after login
    ok 2 - should be able to access /me after login # SKIP
      ---
      duration_ms: 0.664521
      ...
    1..2
ok 30 - BUG-AUTH-002: Complete Login Flow
  ---
  duration_ms: 2.954655
  type: 'suite'
  ...
# Subtest: Superadmin Cross-Tenant Access
    # Subtest: GET /api/v2/opportunities with tenant_id returns data
    not ok 1 - GET /api/v2/opportunities with tenant_id returns data
      ---
      duration_ms: 267.836475
      location: '/app/__tests__/auth/superadminCrossTenantAccess.test.js:27:3'
      failureType: 'testCodeFailure'
      error: |-
        Expected 200, got 401
        
        401 !== 200
        
      code: 'ERR_ASSERTION'
      name: 'AssertionError'
      expected: 200
      actual: 401
      operator: 'strictEqual'
      stack: |-
        TestContext.<anonymous> (file:///app/__tests__/auth/superadminCrossTenantAccess.test.js:30:12)
        process.processTicksAndRejections (node:internal/process/task_queues:95:5)
        async Test.run (node:internal/test_runner/test:797:9)
        async Promise.all (index 0)
        async Suite.run (node:internal/test_runner/test:1135:7)
        async Test.processPendingSubtests (node:internal/test_runner/test:526:7)
      ...
    # Subtest: GET /api/v2/leads with tenant_id returns data
    ok 2 - GET /api/v2/leads with tenant_id returns data
      ---
      duration_ms: 163.973085
      ...
    # Subtest: GET /api/v2/accounts with tenant_id returns data
    not ok 3 - GET /api/v2/accounts with tenant_id returns data
      ---
      duration_ms: 14.310225
      location: '/app/__tests__/auth/superadminCrossTenantAccess.test.js:45:3'
      failureType: 'testCodeFailure'
      error: |-
        Expected 200, got 401
        
        401 !== 200
        
      code: 'ERR_ASSERTION'
      name: 'AssertionError'
      expected: 200
      actual: 401
      operator: 'strictEqual'
      stack: |-
        TestContext.<anonymous> (file:///app/__tests__/auth/superadminCrossTenantAccess.test.js:48:12)
        process.processTicksAndRejections (node:internal/process/task_queues:95:5)
        async Test.run (node:internal/test_runner/test:797:9)
        async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
      ...
    # Subtest: POST /api/v2/opportunities without tenant_id is rejected
    ok 4 - POST /api/v2/opportunities without tenant_id is rejected
      ---
      duration_ms: 49.848566
      ...
    # Subtest: Tenant-scoped routes require tenant_id
    ok 5 - Tenant-scoped routes require tenant_id
      ---
      duration_ms: 37.754991
      ...
    1..5
not ok 31 - Superadmin Cross-Tenant Access
  ---
  duration_ms: 549.312828
  type: 'suite'
  location: '/app/__tests__/auth/superadminCrossTenantAccess.test.js:25:1'
  failureType: 'subtestsFailed'
  error: '2 subtests failed'
  code: 'ERR_TEST_FAILURE'
  ...
# node:internal/modules/cjs/loader:1210
#   throw err;
#   ^
# Error: Cannot find module '/app/scripts/maintenance/emit_viz_test_events.js'
#     at Module._resolveFilename (node:internal/modules/cjs/loader:1207:15)
#     at Module._load (node:internal/modules/cjs/loader:1038:27)
#     at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:164:12)
#     at node:internal/main/run_main_module:28:49 {
#   code: 'MODULE_NOT_FOUND',
#   requireStack: []
# }
# Node.js v20.20.0
# Subtest: office-viz ingests backoffice agent telemetry (timeout-protected)
not ok 32 - office-viz ingests backoffice agent telemetry (timeout-protected) # SKIP office-viz not reachable on /health
  ---
  duration_ms: 227.56394
  location: '/app/__tests__/integration/agentOffice.viz.test.js:59:1'
  failureType: 'testCodeFailure'
  error: |-
    Command failed: node scripts/maintenance/emit_viz_test_events.js --count 1 --complete 1 --assignee ops_manager:dev --tenant dev --interval-ms 10
    node:internal/modules/cjs/loader:1210
      throw err;
      ^
    
    Error: Cannot find module '/app/scripts/maintenance/emit_viz_test_events.js'
        at Module._resolveFilename (node:internal/modules/cjs/loader:1207:15)
        at Module._load (node:internal/modules/cjs/loader:1038:27)
        at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:164:12)
        at node:internal/main/run_main_module:28:49 {
      code: 'MODULE_NOT_FOUND',
      requireStack: []
    }
    
    Node.js v20.20.0
    
  code: 'ERR_TEST_FAILURE'
  stack: |-
    Module._resolveFilename (node:internal/modules/cjs/loader:1207:15)
    Module._load (node:internal/modules/cjs/loader:1038:27)
    Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:164:12)
    node:internal/main/run_main_module:28:49 {
    genericNodeError (node:internal/errors:984:15)
    wrappedFn (node:internal/errors:538:14)
    checkExecSyncError (node:child_process:891:11)
    execSync (node:child_process:963:15)
    injectTestEvents (file:///app/__tests__/integration/agentOffice.viz.test.js:31:18)
    TestContext.<anonymous> (file:///app/__tests__/integration/agentOffice.viz.test.js:65:3)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async Test.run (node:internal/test_runner/test:797:9)
    async Test.processPendingSubtests (node:internal/test_runner/test:526:7)
  ...
# Subtest: AI Token Optimization
    # Subtest: should limit incoming messages to MAX_INCOMING (8)
    ok 1 - should limit incoming messages to MAX_INCOMING (8)
      ---
      duration_ms: 2.095423
      ...
    # Subtest: should truncate message content to MAX_CHARS (1500)
    ok 2 - should truncate message content to MAX_CHARS (1500)
      ---
      duration_ms: 9.388667
      ...
    # Subtest: should truncate tool summary to 1200 chars
    ok 3 - should truncate tool summary to 1200 chars
      ---
      duration_ms: 1.070224
      ...
    # Subtest: should handle empty or null summaries gracefully
    ok 4 - should handle empty or null summaries gracefully
      ---
      duration_ms: 0.932461
      ...
    # Subtest: should preserve message structure after optimization
    ok 5 - should preserve message structure after optimization
      ---
      duration_ms: 0.414778
      ...
    # Subtest: should only send last user and last assistant in frontend optimization
    ok 6 - should only send last user and last assistant in frontend optimization
      ---
      duration_ms: 0.412207
      ...
    # Subtest: should handle conversation with only user messages
    ok 7 - should handle conversation with only user messages
      ---
      duration_ms: 1.12341
      ...
    1..7
ok 33 - AI Token Optimization
  ---
  duration_ms: 22.968049
  type: 'suite'
  ...
# ✅ Health Monitoring System tests completed
# ✓ Supabase DB client initialized with performance tracking
# Subtest: Health Monitoring System
    # Subtest: should create health alerts table and views
    ok 1 - should create health alerts table and views
      ---
      duration_ms: 404.947224
      ...
    # Subtest: should create deduplication function
    ok 2 - should create deduplication function
      ---
      duration_ms: 198.196719
      ...
    # Subtest: should create a health alert
    ok 3 - should create a health alert
      ---
      duration_ms: 116.453139
      ...
    # Subtest: should prevent duplicate alerts
    ok 4 - should prevent duplicate alerts
      ---
      duration_ms: 266.071312
      ...
    # Subtest: should get active alerts
    ok 5 - should get active alerts
      ---
      duration_ms: 90.134635
      ...
    # Subtest: should get health stats
    not ok 6 - should get health stats
      ---
      duration_ms: 86.091165
      location: '/app/__tests__/integration/healthMonitoring.test.js:116:3'
      failureType: 'testCodeFailure'
      error: 'Should include critical_alerts'
      code: 'ERR_ASSERTION'
      name: 'AssertionError'
      expected: true
      actual: false
      operator: '=='
      stack: |-
        TestContext.<anonymous> (file:///app/__tests__/integration/healthMonitoring.test.js:121:12)
        process.processTicksAndRejections (node:internal/process/task_queues:95:5)
        async Test.run (node:internal/test_runner/test:797:9)
        async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
      ...
# [Health Monitor] ✅ Alert resolved: Test Error Spike
# [Health Monitor] Manual health check triggered
# [Health Monitor] Running health checks...
    # Subtest: should resolve an alert
    ok 7 - should resolve an alert
      ---
      duration_ms: 178.539203
      ...
# [Health Monitor] Docker check skipped (docker CLI not available in container)
# [Health Monitor] Check complete in 219ms - All systems healthy
    # Subtest: should trigger manual health check
    ok 8 - should trigger manual health check
      ---
      duration_ms: 220.884511
      ...
# [Health Monitor] Failed to resolve alert: Cannot coerce the result to a single JSON object
    # Subtest: should handle invalid alert ID gracefully
    ok 9 - should handle invalid alert ID gracefully
      ---
      duration_ms: 92.155427
      ...
    # Subtest: should clean up test alerts
    ok 10 - should clean up test alerts
      ---
      duration_ms: 79.509611
      ...
    1..10
not ok 34 - Health Monitoring System
  ---
  duration_ms: 1743.821315
  type: 'suite'
  location: '/app/__tests__/integration/healthMonitoring.test.js:16:1'
  failureType: 'subtestsFailed'
  error: '1 subtest failed'
  code: 'ERR_TEST_FAILURE'
  ...
# Subtest: Log Pattern Analysis
    # Subtest: should detect error spikes in logs
    not ok 1 - should detect error spikes in logs
      ---
      duration_ms: 141.86346
      location: '/app/__tests__/integration/healthMonitoring.test.js:169:3'
      failureType: 'testCodeFailure'
      error: 'readLogs function should exist'
      code: 'ERR_ASSERTION'
      name: 'AssertionError'
      expected: true
      actual: false
      operator: '=='
      stack: |-
        TestContext.<anonymous> (file:///app/__tests__/integration/healthMonitoring.test.js:187:12)
        async Test.run (node:internal/test_runner/test:797:9)
        async Promise.all (index 0)
        async Suite.run (node:internal/test_runner/test:1135:7)
        async Test.processPendingSubtests (node:internal/test_runner/test:526:7)
      ...
    1..1
not ok 35 - Log Pattern Analysis
  ---
  duration_ms: 142.666062
  type: 'suite'
  location: '/app/__tests__/integration/healthMonitoring.test.js:168:1'
  failureType: 'subtestsFailed'
  error: '1 subtest failed'
  code: 'ERR_TEST_FAILURE'
  ...
# Subtest: Health Alerts API Endpoints
    # Subtest: should have health alerts endpoints defined
    not ok 1 - should have health alerts endpoints defined
      ---
      duration_ms: 1.292838
      location: '/app/__tests__/integration/healthMonitoring.test.js:192:3'
      failureType: 'testCodeFailure'
      error: "Cannot find module '/app/__tests__/routes/devaiHealthAlerts.js' imported from /app/__tests__/integration/healthMonitoring.test.js"
      code: 'ERR_MODULE_NOT_FOUND'
      stack: |-
        finalizeResolution (node:internal/modules/esm/resolve:283:11)
        moduleResolve (node:internal/modules/esm/resolve:952:10)
        defaultResolve (node:internal/modules/esm/resolve:1188:11)
        ModuleLoader.defaultResolve (node:internal/modules/esm/loader:708:12)
        #cachedDefaultResolve (node:internal/modules/esm/loader:657:25)
        ModuleLoader.resolve (node:internal/modules/esm/loader:640:38)
        ModuleLoader.getModuleJobForImport (node:internal/modules/esm/loader:264:38)
        ModuleLoader.import (node:internal/modules/esm/loader:605:34)
        defaultImportModuleDynamicallyForModule (node:internal/modules/esm/utils:221:31)
        importModuleDynamicallyCallback (node:internal/modules/esm/utils:260:12)
      ...
    1..1
not ok 36 - Health Alerts API Endpoints
  ---
  duration_ms: 1.482877
  type: 'suite'
  location: '/app/__tests__/integration/healthMonitoring.test.js:191:1'
  failureType: 'subtestsFailed'
  error: '1 subtest failed'
  code: 'ERR_TEST_FAILURE'
  ...
# Internet access to Wikipedia: available
# ✓ Supabase DB client initialized with performance tracking
# ✓ Supabase DB client initialized (using centralized factory)
# [ModelRouter] Module loaded - LLM_PROVIDER=undefined
# Subtest: MCP Routes
    # Subtest: POST /api/mcp/run-proxy - Web Adapter Fallback
        # Subtest: web search should return success (fallback only if MCP unreachable)
        ok 1 - web search should return success (fallback only if MCP unreachable)
          ---
          duration_ms: 619.21743
          ...
        # Subtest: web page fetch should return success (fallback only if MCP unreachable)
        ok 2 - web page fetch should return success (fallback only if MCP unreachable)
          ---
          duration_ms: 247.474574
          ...
        # Subtest: should return error for missing query parameter in Wikipedia search
        ok 3 - should return error for missing query parameter in Wikipedia search
          ---
          duration_ms: 25.718672
          ...
        # Subtest: should return error for missing pageid parameter in Wikipedia page fetch
        ok 4 - should return error for missing pageid parameter in Wikipedia page fetch
          ---
          duration_ms: 34.724172
          ...
        # Subtest: github adapter returns success when MCP reachable (502 if unreachable)
        ok 5 - github adapter returns success when MCP reachable (502 if unreachable)
          ---
          duration_ms: 28.081309
          ...
        1..5
    ok 1 - POST /api/mcp/run-proxy - Web Adapter Fallback
      ---
      duration_ms: 962.258075
      type: 'suite'
      ...
    # Subtest: GET /api/mcp/servers
        # Subtest: should return list of available MCP servers
        ok 1 - should return list of available MCP servers
          ---
          duration_ms: 11.305522
          ...
        1..1
    ok 2 - GET /api/mcp/servers
      ---
      duration_ms: 12.106442
      type: 'suite'
      ...
    # Subtest: POST /api/mcp/execute-tool - Web Tools
        # Subtest: should handle web.search_wikipedia tool directly (success with internet, error without)
        ok 1 - should handle web.search_wikipedia tool directly (success with internet, error without)
          ---
          duration_ms: 534.371994
          ...
        # Subtest: should handle web.get_wikipedia_page tool directly (success with internet, error without)
        ok 2 - should handle web.get_wikipedia_page tool directly (success with internet, error without)
          ---
          duration_ms: 124.634792
          ...
        1..2
    ok 3 - POST /api/mcp/execute-tool - Web Tools
      ---
      duration_ms: 659.740436
      type: 'suite'
      ...
    1..3
ok 37 - MCP Routes
  ---
  duration_ms: 3279.32452
  type: 'suite'
  ...
# ✓ Supabase Admin client initialized
# ✓ Supabase Admin client initialized
# ✓ Supabase DB client initialized with performance tracking
# ✓ Supabase DB client initialized with performance tracking
# ✓ Supabase Admin client initialized
# ✓ Supabase DB client initialized with performance tracking
# ✓ Supabase Admin client initialized
# ✓ Supabase Admin client initialized
# Subtest: supabaseFactory
    # Subtest: getSupabaseAdmin()
        # Subtest: should create admin client with correct configuration
        ok 1 - should create admin client with correct configuration
          ---
          duration_ms: 73.571018
          ...
        # Subtest: should return same instance on subsequent calls (singleton)
        ok 2 - should return same instance on subsequent calls (singleton)
          ---
          duration_ms: 6.006404
          ...
        # Subtest: should throw error when SUPABASE_URL is missing (default behavior)
        ok 3 - should throw error when SUPABASE_URL is missing (default behavior)
          ---
          duration_ms: 1.801692
          ...
        # Subtest: should return null when SUPABASE_URL is missing and throwOnMissing=false
        ok 4 - should return null when SUPABASE_URL is missing and throwOnMissing=false
          ---
          duration_ms: 4.163734
          ...
        # Subtest: should throw error when SUPABASE_SERVICE_ROLE_KEY is missing (default behavior)
        ok 5 - should throw error when SUPABASE_SERVICE_ROLE_KEY is missing (default behavior)
          ---
          duration_ms: 1.131534
          ...
        1..5
    ok 1 - getSupabaseAdmin()
      ---
      duration_ms: 88.962625
      type: 'suite'
      ...
    # Subtest: getSupabaseDB()
        # Subtest: should create DB client with performance tracking
        ok 1 - should create DB client with performance tracking
          ---
          duration_ms: 14.614003
          ...
        # Subtest: should return same instance on subsequent calls (singleton)
        ok 2 - should return same instance on subsequent calls (singleton)
          ---
          duration_ms: 4.857088
          ...
        # Subtest: should be different from admin client
        ok 3 - should be different from admin client
          ---
          duration_ms: 5.630267
          ...
        # Subtest: should throw error when SUPABASE_URL is missing
        ok 4 - should throw error when SUPABASE_URL is missing
          ---
          duration_ms: 2.90771
          ...
        # Subtest: should throw error when SUPABASE_SERVICE_ROLE_KEY is missing
        ok 5 - should throw error when SUPABASE_SERVICE_ROLE_KEY is missing
          ---
          duration_ms: 1.20711
          ...
        1..5
    ok 2 - getSupabaseDB()
      ---
      duration_ms: 30.747798
      type: 'suite'
      ...
    # Subtest: getBucketName()
        # Subtest: should return configured bucket name
        ok 1 - should return configured bucket name
          ---
          duration_ms: 1.057168
          ...
        # Subtest: should return default bucket name when not configured
        ok 2 - should return default bucket name when not configured
          ---
          duration_ms: 4.066877
          ...
        1..2
    ok 3 - getBucketName()
      ---
      duration_ms: 5.782236
      type: 'suite'
      ...
    # Subtest: _resetClients()
        # Subtest: should reset singleton state
        ok 1 - should reset singleton state
          ---
          duration_ms: 9.345989
          ...
        1..1
    ok 4 - _resetClients()
      ---
      duration_ms: 10.325317
      type: 'suite'
      ...
    1..4
ok 38 - supabaseFactory
  ---
  duration_ms: 138.980606
  type: 'suite'
  ...
# ✓ Supabase DB client initialized with performance tracking
# ✓ Supabase DB client initialized (using centralized factory)
# Subtest: tenantCanonicalResolver
    # Subtest: isUuid()
        # Subtest: should return true for valid UUIDs
        ok 1 - should return true for valid UUIDs
          ---
          duration_ms: 2.608485
          ...
        # Subtest: should return false for invalid UUIDs
        ok 2 - should return false for invalid UUIDs
          ---
          duration_ms: 0.646285
          ...
        # Subtest: should handle trimmed whitespace
        ok 3 - should handle trimmed whitespace
          ---
          duration_ms: 0.474068
          ...
        1..3
    ok 1 - isUuid()
      ---
      duration_ms: 5.362082
      type: 'suite'
      ...
    # Subtest: resolveCanonicalTenant() - Unit Tests
        # Subtest: should return empty result for null/empty identifier
        ok 1 - should return empty result for null/empty identifier
          ---
          duration_ms: 1.290866
          ...
        # Subtest: should handle system tenant with env var
        ok 2 - should handle system tenant with env var
          ---
          duration_ms: 0.952966
          ...
        # Subtest: should handle system tenant without env var
        ok 3 - should handle system tenant without env var
          ---
          duration_ms: 0.807846
          ...
        1..3
    ok 2 - resolveCanonicalTenant() - Unit Tests
      ---
      duration_ms: 3.901051
      type: 'suite'
      ...
    # Subtest: Cache Behavior
        # Subtest: should cache tenant resolution results
        ok 1 - should cache tenant resolution results
          ---
          duration_ms: 1.186082
          ...
        # Subtest: should report accurate cache statistics
        ok 2 - should report accurate cache statistics
          ---
          duration_ms: 399.312313
          ...
        # Subtest: should clear cache on demand
        ok 3 - should clear cache on demand
          ---
          duration_ms: 165.196637
          ...
        1..3
    ok 3 - Cache Behavior
      ---
      duration_ms: 566.405813
      type: 'suite'
      ...
    # Subtest: Integration Tests (Supabase)
        # Subtest: should resolve known UUID tenant from database
        ok 1 - should resolve known UUID tenant from database
          ---
          duration_ms: 75.964079
          ...
        # Subtest: should resolve known slug tenant from database
        ok 2 - should resolve known slug tenant from database
          ---
          duration_ms: 167.434969
          ...
        # Subtest: should handle unknown UUID gracefully
        ok 3 - should handle unknown UUID gracefully
          ---
          duration_ms: 155.860248
          ...
        # Subtest: should handle unknown slug gracefully
        ok 4 - should handle unknown slug gracefully
          ---
          duration_ms: 147.61895
          ...
        1..4
    ok 4 - Integration Tests (Supabase)
      ---
      duration_ms: 547.78474
      type: 'suite'
      ...
    # Subtest: Edge Cases
        # Subtest: should handle whitespace in identifiers
        ok 1 - should handle whitespace in identifiers
          ---
          duration_ms: 0.61482
          ...
        # Subtest: should distinguish UUID from slug correctly
        ok 2 - should distinguish UUID from slug correctly
          ---
          duration_ms: 169.680537
          ...
        # Subtest: should handle case sensitivity in UUIDs
        ok 3 - should handle case sensitivity in UUIDs
          ---
          duration_ms: 1.360461
          ...
        1..3
    ok 5 - Edge Cases
      ---
      duration_ms: 172.248275
      type: 'suite'
      ...
    1..5
ok 39 - tenantCanonicalResolver
  ---
  duration_ms: 1375.192227
  type: 'suite'
  ...
# [UUID Validator] Invalid UUID rejected: "system"
# [UUID Validator] Invalid UUID rejected: "not-a-uuid"
# [UUID Validator] Invalid UUID rejected: "local-tenant-001"
# [UUID Validator] Invalid UUID rejected: "12345"
# [UUID Validator] Invalid UUID rejected: "invalid-uuid"
# [UUID Validator] Invalid UUID rejected: "invalid-uuid"
# [UUID Validator] Invalid UUID rejected: "invalid"
# [UUID Validator] Invalid UUID rejected: "invalid-uuid"
# Subtest: uuidValidator
    # Subtest: isValidUUID()
        # Subtest: should return true for valid UUIDs
        ok 1 - should return true for valid UUIDs
          ---
          duration_ms: 5.001971
          ...
        # Subtest: should return false for invalid UUIDs
        ok 2 - should return false for invalid UUIDs
          ---
          duration_ms: 0.399389
          ...
        # Subtest: should return false for non-string inputs
        ok 3 - should return false for non-string inputs
          ---
          duration_ms: 0.243828
          ...
        1..3
    ok 1 - isValidUUID()
      ---
      duration_ms: 8.543146
      type: 'suite'
      ...
    # Subtest: sanitizeUuidInput()
        # Subtest: should return valid UUIDs unchanged
        ok 1 - should return valid UUIDs unchanged
          ---
          duration_ms: 0.48038
          ...
        # Subtest: should return null for null/undefined/empty with allowNull
        ok 2 - should return null for null/undefined/empty with allowNull
          ---
          duration_ms: 0.266605
          ...
        # Subtest: should return undefined for null/undefined with allowNull:false
        ok 3 - should return undefined for null/undefined with allowNull:false
          ---
          duration_ms: 0.305075
          ...
        # Subtest: should convert system aliases to null
        ok 4 - should convert system aliases to null
          ---
          duration_ms: 0.375885
          ...
        # Subtest: should handle custom system aliases
        ok 5 - should handle custom system aliases
          ---
          duration_ms: 1.952994
          ...
        # Subtest: should return null for invalid UUIDs
        ok 6 - should return null for invalid UUIDs
          ---
          duration_ms: 1.173788
          ...
        1..6
    ok 2 - sanitizeUuidInput()
      ---
      duration_ms: 5.432575
      type: 'suite'
      ...
    # Subtest: sanitizeUuidFilter()
        # Subtest: should sanitize UUID columns in simple filter
        ok 1 - should sanitize UUID columns in simple filter
          ---
          duration_ms: 1.655705
          ...
        # Subtest: should preserve operator objects
        ok 2 - should preserve operator objects
          ---
          duration_ms: 2.413787
          ...
        # Subtest: should sanitize $or conditions recursively
        ok 3 - should sanitize $or conditions recursively
          ---
          duration_ms: 4.804458
          ...
        # Subtest: should sanitize $and conditions recursively
        ok 4 - should sanitize $and conditions recursively
          ---
          duration_ms: 0.61172
          ...
        # Subtest: should handle nested $or/$and combinations
        ok 5 - should handle nested $or/$and combinations
          ---
          duration_ms: 0.700953
          ...
        # Subtest: should return filter unchanged for non-object input
        ok 6 - should return filter unchanged for non-object input
          ---
          duration_ms: 0.507071
          ...
        # Subtest: should create new object (not mutate original)
        ok 7 - should create new object (not mutate original)
          ---
          duration_ms: 0.813566
          ...
        1..7
    ok 3 - sanitizeUuidFilter()
      ---
      duration_ms: 13.636701
      type: 'suite'
      ...
    # Subtest: validateUuidParams() middleware
        # Subtest: should pass for valid UUID params
        ok 1 - should pass for valid UUID params
          ---
          duration_ms: 5.021409
          ...
        # Subtest: should return 400 for invalid UUID params
        ok 2 - should return 400 for invalid UUID params
          ---
          duration_ms: 5.451736
          ...
        # Subtest: should validate multiple params and report all invalid ones
        ok 3 - should validate multiple params and report all invalid ones
          ---
          duration_ms: 1.412589
          ...
        1..3
    ok 4 - validateUuidParams() middleware
      ---
      duration_ms: 12.486468
      type: 'suite'
      ...
    # Subtest: validateUuidQuery() middleware
        # Subtest: should pass for valid UUID query params
        ok 1 - should pass for valid UUID query params
          ---
          duration_ms: 1.164863
          ...
        # Subtest: should allow "null" string for query params
        ok 2 - should allow "null" string for query params
          ---
          duration_ms: 1.754018
          ...
        # Subtest: should return 400 for invalid UUID query params
        ok 3 - should return 400 for invalid UUID query params
          ---
          duration_ms: 0.56456
          ...
        1..3
    ok 5 - validateUuidQuery() middleware
      ---
      duration_ms: 3.891649
      type: 'suite'
      ...
    1..5
ok 40 - uuidValidator
  ---
  duration_ms: 46.433159
  type: 'suite'
  ...
# Subtest: Deprecation Middleware Unit Tests
    # Subtest: Request path detection
        # Subtest: should detect v1 API paths
        ok 1 - should detect v1 API paths
          ---
          duration_ms: 11.170686
          ...
        # Subtest: should skip v2 API paths
        ok 2 - should skip v2 API paths
          ---
          duration_ms: 0.80396
          ...
        # Subtest: should skip non-API paths
        ok 3 - should skip non-API paths
          ---
          duration_ms: 0.822225
          ...
        1..3
    ok 1 - Request path detection
      ---
      duration_ms: 15.781062
      type: 'suite'
      ...
    # Subtest: Before sunset date (current behavior)
        # Subtest: should add deprecation headers for v1 endpoints
        ok 1 - should add deprecation headers for v1 endpoints
          ---
          duration_ms: 1.096323
          ...
        1..1
    ok 2 - Before sunset date (current behavior)
      ---
      duration_ms: 5.308209
      type: 'suite'
      ...
    # Subtest: V2 endpoint mapping
        # Subtest: should correctly map v1 paths to v2
        ok 1 - should correctly map v1 paths to v2
          ---
          duration_ms: 6.708277
          ...
        1..1
    ok 3 - V2 endpoint mapping
      ---
      duration_ms: 7.098599
      type: 'suite'
      ...
    # Subtest: Routes without v2 alternatives
        # Subtest: should not add full deprecation headers for non-migrated routes
        ok 1 - should not add full deprecation headers for non-migrated routes
          ---
          duration_ms: 1.0622
          ...
        1..1
    ok 4 - Routes without v2 alternatives
      ---
      duration_ms: 1.624617
      type: 'suite'
      ...
    1..4
ok 41 - Deprecation Middleware Unit Tests
  ---
  duration_ms: 31.506611
  type: 'suite'
  ...
# Subtest: Deprecation Middleware - After Sunset Simulation
    # Subtest: should return 410 Gone with correct error structure
    ok 1 - should return 410 Gone with correct error structure
      ---
      duration_ms: 0.874485
      ...
    # Subtest: should include all required fields in 410 response
    ok 2 - should include all required fields in 410 response
      ---
      duration_ms: 0.768534
      ...
    1..2
ok 42 - Deprecation Middleware - After Sunset Simulation
  ---
  duration_ms: 1.912863
  type: 'suite'
  ...
# [ModelRouter] Module loaded - LLM_PROVIDER=undefined
# Subtest: Section A: Trigger Engine Verification
    # Subtest: A1: Trigger Worker Integrity
        # Subtest: Worker module exports required functions
        ok 1 - Worker module exports required functions
          ---
          duration_ms: 1289.520802
          ...
        # Subtest: Worker respects AI_TRIGGERS_WORKER_ENABLED environment variable
        ok 2 - Worker respects AI_TRIGGERS_WORKER_ENABLED environment variable
          ---
          duration_ms: 1.73029
          ...
        # Subtest: Worker exports TRIGGER_TYPES constant for structured logging
        ok 3 - Worker exports TRIGGER_TYPES constant for structured logging
          ---
          duration_ms: 0.825078
          ...
        # Subtest: Worker logs with tenant_id context
        ok 4 - Worker logs with tenant_id context
          ---
          duration_ms: 1.073747
          ...
        1..4
    ok 1 - A1: Trigger Worker Integrity
      ---
      duration_ms: 1294.596586
      type: 'suite'
      ...
    # Subtest: A2: Supabase Query Policy Compliance
        # Subtest: aiTriggersWorker.js has no prohibited SQL patterns
        ok 1 - aiTriggersWorker.js has no prohibited SQL patterns
          ---
          duration_ms: 3.430862
          ...
        # Subtest: Worker uses Supabase JS client for data retrieval
        ok 2 - Worker uses Supabase JS client for data retrieval
          ---
          duration_ms: 1.014461
          ...
        # Subtest: Complex logic done in JavaScript, not SQL
        ok 3 - Complex logic done in JavaScript, not SQL
          ---
          duration_ms: 1.144537
          ...
        1..3
    ok 2 - A2: Supabase Query Policy Compliance
      ---
      duration_ms: 6.307302
      type: 'suite'
      ...
    # Subtest: A3: Trigger Output Format
        # Subtest: Trigger format includes required fields
        ok 1 - Trigger format includes required fields
          ---
          duration_ms: 0.598659
          ...
        # Subtest: Worker creates suggestions with proper JSON structure
        ok 2 - Worker creates suggestions with proper JSON structure
          ---
          duration_ms: 0.99209
          ...
        1..2
    ok 3 - A3: Trigger Output Format
      ---
      duration_ms: 1.88261
      type: 'suite'
      ...
    1..3
ok 43 - Section A: Trigger Engine Verification
  ---
  duration_ms: 1304.623656
  type: 'suite'
  ...
# Subtest: Section B: Suggestion Engine Verification
    # Subtest: B1: AI Brain (Braid) Integration
        # Subtest: Worker uses propose_actions mode for suggestions
        ok 1 - Worker uses propose_actions mode for suggestions
          ---
          duration_ms: 4.374647
          ...
        # Subtest: No direct database writes from suggestion generation
        ok 2 - No direct database writes from suggestion generation
          ---
          duration_ms: 2.664011
          ...
        # Subtest: Suggestion actions match allowed Braid tools
        ok 3 - Suggestion actions match allowed Braid tools
          ---
          duration_ms: 0.663799
          ...
        1..3
    ok 1 - B1: AI Brain (Braid) Integration
      ---
      duration_ms: 9.665931
      type: 'suite'
      ...
    # Subtest: B2: Suggestion JSON Format
        # Subtest: Sample suggestion structure is valid
        ok 1 - Sample suggestion structure is valid
          ---
          duration_ms: 0.696101
          ...
        # Subtest: Missing action field is detected
        ok 2 - Missing action field is detected
          ---
          duration_ms: 0.597205
          ...
        # Subtest: Missing confidence field is detected
        ok 3 - Missing confidence field is detected
          ---
          duration_ms: 0.528267
          ...
        # Subtest: Confidence out of range is detected
        ok 4 - Confidence out of range is detected
          ---
          duration_ms: 0.439537
          ...
        # Subtest: Empty reasoning is detected
        ok 5 - Empty reasoning is detected
          ---
          duration_ms: 0.510538
          ...
        # Subtest: Unknown action/tool is detected
        ok 6 - Unknown action/tool is detected
          ---
          duration_ms: 0.492489
          ...
        1..6
    ok 2 - B2: Suggestion JSON Format
      ---
      duration_ms: 4.492072
      type: 'suite'
      ...
    # Subtest: B3: Deduplication
        # Subtest: Worker checks for existing pending suggestions
        ok 1 - Worker checks for existing pending suggestions
          ---
          duration_ms: 1.245503
          ...
        # Subtest: Worker excludes already-processed records
        ok 2 - Worker excludes already-processed records
          ---
          duration_ms: 1.186278
          ...
        1..2
    ok 3 - B3: Deduplication
      ---
      duration_ms: 2.727333
      type: 'suite'
      ...
    1..3
ok 44 - Section B: Suggestion Engine Verification
  ---
  duration_ms: 20.052693
  type: 'suite'
  ...
# ✓ Supabase DB client initialized with performance tracking
# ✓ Supabase DB client initialized (using centralized factory)
# Subtest: Section C: Suggestion Queue Verification
    # Subtest: C1: Database Table Validity
        # Subtest: ai_suggestions table exists and is accessible
        ok 1 - ai_suggestions table exists and is accessible
          ---
          duration_ms: 258.140099
          ...
        # Subtest: Suggestions list returns expected structure
        ok 2 - Suggestions list returns expected structure
          ---
          duration_ms: 203.23155
          ...
        # Subtest: API response format matches frontend contract
        ok 3 - API response format matches frontend contract
          ---
          duration_ms: 187.84267
          ...
        # Subtest: Stats endpoint returns aggregated data
        ok 4 - Stats endpoint returns aggregated data
          ---
          duration_ms: 202.918882
          ...
        1..4
    ok 1 - C1: Database Table Validity
      ---
      duration_ms: 855.930297
      type: 'suite'
      ...
    # Subtest: C2: API Verification
        # Subtest: GET /api/ai/suggestions requires tenant_id
        ok 1 - GET /api/ai/suggestions requires tenant_id
          ---
          duration_ms: 12.386066
          ...
        # Subtest: GET /api/ai/suggestions/:id returns single suggestion or 404
        ok 2 - GET /api/ai/suggestions/:id returns single suggestion or 404
          ---
          duration_ms: 394.909089
          ...
        # Subtest: POST /api/ai/suggestions/:id/approve requires tenant_id
        ok 3 - POST /api/ai/suggestions/:id/approve requires tenant_id
          ---
          duration_ms: 21.845619
          ...
        # Subtest: POST /api/ai/suggestions/:id/reject requires tenant_id
        ok 4 - POST /api/ai/suggestions/:id/reject requires tenant_id
          ---
          duration_ms: 9.154422
          ...
        # Subtest: Tenant isolation - cross-tenant access blocked
        ok 5 - Tenant isolation - cross-tenant access blocked
          ---
          duration_ms: 154.814419
          ...
        # Subtest: Suggestions list supports filtering by status
        ok 6 - Suggestions list supports filtering by status
          ---
          duration_ms: 1241.748258
          ...
        # Subtest: Suggestions list supports pagination
        ok 7 - Suggestions list supports pagination
          ---
          duration_ms: 204.07457
          ...
        1..7
    ok 2 - C2: API Verification
      ---
      duration_ms: 2040.979058
      type: 'suite'
      ...
    1..2
ok 45 - Section C: Suggestion Queue Verification
  ---
  duration_ms: 3109.925113
  type: 'suite'
  ...
# Subtest: Section D: Review UI Verification
ok 46 - Section D: Review UI Verification # SKIP
  ---
  duration_ms: 2.049665
  type: 'suite'
  ...
# Subtest: Section E: Safe Apply Engine Verification
    # Subtest: E1: Apply Pipeline Integrity
        # Subtest: Braid integration module exists
        ok 1 - Braid integration module exists
          ---
          duration_ms: 5.07059
          ...
        # Subtest: Apply route validates tenant ownership
        ok 2 - Apply route validates tenant ownership
          ---
          duration_ms: 1.054008
          ...
        # Subtest: Apply route uses executeBraidTool
        ok 3 - Apply route uses executeBraidTool
          ---
          duration_ms: 0.400239
          ...
        # Subtest: No direct Supabase writes to CRM tables from apply
        ok 4 - No direct Supabase writes to CRM tables from apply
          ---
          duration_ms: 0.381199
          ...
        1..4
    ok 1 - E1: Apply Pipeline Integrity
      ---
      duration_ms: 8.637419
      type: 'suite'
      ...
    # Subtest: E2: Post-Apply Status
        # Subtest: Apply endpoint updates suggestion status
        ok 1 - Apply endpoint updates suggestion status
          ---
          duration_ms: 751.096691
          ...
        # Subtest: Apply stores apply_result on success or failure
        ok 2 - Apply stores apply_result on success or failure
          ---
          duration_ms: 0.4368
          ...
        1..2
    ok 2 - E2: Post-Apply Status
      ---
      duration_ms: 751.912275
      type: 'suite'
      ...
    # Subtest: E3: Audit Logging
        # Subtest: Apply operations are logged
        not ok 1 - Apply operations are logged
          ---
          duration_ms: 1.27941
          location: '/app/__tests__/phase3/section-e-safe-apply.test.js:151:5'
          failureType: 'testCodeFailure'
          error: 'Apply should have logging'
          code: 'ERR_ASSERTION'
          name: 'AssertionError'
          expected: true
          actual: false
          operator: '=='
          stack: |-
            TestContext.<anonymous> (file:///app/__tests__/phase3/section-e-safe-apply.test.js:156:14)
            Test.runInAsyncScope (node:async_hooks:206:9)
            Test.run (node:internal/test_runner/test:796:25)
            Test.start (node:internal/test_runner/test:702:17)
            node:internal/test_runner/test:1133:71
            node:internal/per_context/primordials:482:82
            new Promise (<anonymous>)
            new SafePromise (node:internal/per_context/primordials:450:29)
            node:internal/per_context/primordials:482:9
            Array.map (<anonymous>)
          ...
        # Subtest: Errors are captured and logged
        ok 2 - Errors are captured and logged
          ---
          duration_ms: 0.412165
          ...
        1..2
    not ok 3 - E3: Audit Logging
      ---
      duration_ms: 2.040991
      type: 'suite'
      location: '/app/__tests__/phase3/section-e-safe-apply.test.js:149:3'
      failureType: 'subtestsFailed'
      error: '1 subtest failed'
      code: 'ERR_TEST_FAILURE'
      ...
    1..3
not ok 47 - Section E: Safe Apply Engine Verification
  ---
  duration_ms: 763.974688
  type: 'suite'
  location: '/app/__tests__/phase3/section-e-safe-apply.test.js:24:1'
  failureType: 'subtestsFailed'
  error: '1 subtest failed'
  code: 'ERR_TEST_FAILURE'
  ...
# Subtest: Section F: Integration Layers Verification
    # Subtest: F1: Workflow Canvas
        # Subtest: Workflow routes exist
        ok 1 - Workflow routes exist
          ---
          duration_ms: 3.675536
          ...
        # Subtest: Workflow can emit triggers (if implemented)
        ok 2 - Workflow can emit triggers (if implemented)
          ---
          duration_ms: 0.946988
          ...
        1..2
    ok 1 - F1: Workflow Canvas
      ---
      duration_ms: 6.392576
      type: 'suite'
      ...
    # Subtest: F2: Email Integration
        # Subtest: Email-related routes or handlers exist
        ok 1 - Email-related routes or handlers exist
          ---
          duration_ms: 0.441506
          ...
        # Subtest: Email sending uses tools, not direct SMTP
        ok 2 - Email sending uses tools, not direct SMTP
          ---
          duration_ms: 0.396916
          ...
        1..2
    ok 2 - F2: Email Integration
      ---
      duration_ms: 1.128188
      type: 'suite'
      ...
    # Subtest: F3: CallFluent Integration
        # Subtest: Telephony routes exist
        ok 1 - Telephony routes exist
          ---
          duration_ms: 0.758682
          ...
        # Subtest: Call webhooks can trigger AI suggestions
        ok 2 - Call webhooks can trigger AI suggestions
          ---
          duration_ms: 1.024975
          ...
        # Subtest: Call summaries can feed into trigger detection
        ok 3 - Call summaries can feed into trigger detection
          ---
          duration_ms: 1.969318
          ...
        1..3
    ok 3 - F3: CallFluent Integration
      ---
      duration_ms: 4.643932
      type: 'suite'
      ...
    # Subtest: F4: Thoughtly Integration
        # Subtest: No PII leakage across tenants in context
        ok 1 - No PII leakage across tenants in context
          ---
          duration_ms: 1.90925
          ...
        # Subtest: Behavioral insights remain tenant-isolated
        ok 2 - Behavioral insights remain tenant-isolated
          ---
          duration_ms: 2.044899
          ...
        1..2
    ok 4 - F4: Thoughtly Integration
      ---
      duration_ms: 6.432527
      type: 'suite'
      ...
    1..4
ok 48 - Section F: Integration Layers Verification
  ---
  duration_ms: 21.897192
  type: 'suite'
  ...
# Subtest: Section G: Telemetry & Observability Verification
    # Subtest: G1: Telemetry Logging
        # Subtest: Worker logs trigger events
        not ok 1 - Worker logs trigger events
          ---
          duration_ms: 6.343275
          location: '/app/__tests__/phase3/section-g-telemetry.test.js:31:5'
          failureType: 'testCodeFailure'
          error: 'Worker should log events'
          code: 'ERR_ASSERTION'
          name: 'AssertionError'
          expected: true
          actual: false
          operator: '=='
          stack: |-
            TestContext.<anonymous> (file:///app/__tests__/phase3/section-g-telemetry.test.js:36:14)
            Test.runInAsyncScope (node:async_hooks:206:9)
            Test.run (node:internal/test_runner/test:796:25)
            Test.start (node:internal/test_runner/test:702:17)
            node:internal/test_runner/test:1133:71
            node:internal/per_context/primordials:482:82
            new Promise (<anonymous>)
            new SafePromise (node:internal/per_context/primordials:450:29)
            node:internal/per_context/primordials:482:9
            Array.map (<anonymous>)
          ...
        # Subtest: Suggestion routes log approval/rejection
        ok 2 - Suggestion routes log approval/rejection
          ---
          duration_ms: 0.892445
          ...
        # Subtest: Apply operations log success/failure
        ok 3 - Apply operations log success/failure
          ---
          duration_ms: 0.649095
          ...
        # Subtest: Logs include tenant context
        ok 4 - Logs include tenant context
          ---
          duration_ms: 1.640817
          ...
        1..4
    not ok 1 - G1: Telemetry Logging
      ---
      duration_ms: 11.744463
      type: 'suite'
      location: '/app/__tests__/phase3/section-g-telemetry.test.js:29:3'
      failureType: 'subtestsFailed'
      error: '1 subtest failed'
      code: 'ERR_TEST_FAILURE'
      stack: |-
        async Promise.all (index 0)
      ...
    # Subtest: G2: Telemetry JSON Format
        # Subtest: Metrics endpoint returns structured data
        ok 1 - Metrics endpoint returns structured data
          ---
          duration_ms: 488.320602
          ...
        # Subtest: Metrics include required fields
        ok 2 - Metrics include required fields
          ---
          duration_ms: 219.129449
          ...
        # Subtest: Feedback endpoint accepts telemetry data
        ok 3 - Feedback endpoint accepts telemetry data
          ---
          duration_ms: 539.582283
          ...
        1..3
    ok 2 - G2: Telemetry JSON Format
      ---
      duration_ms: 1248.538791
      type: 'suite'
      ...
    # Subtest: G3: Log Structure Validation
        # Subtest: Worker logs are parseable
        ok 1 - Worker logs are parseable
          ---
          duration_ms: 0.811968
          ...
        # Subtest: Timestamps are included in processing logs
        ok 2 - Timestamps are included in processing logs
          ---
          duration_ms: 0.5972
          ...
        1..2
    ok 3 - G3: Log Structure Validation
      ---
      duration_ms: 1.619309
      type: 'suite'
      ...
    1..3
not ok 49 - Section G: Telemetry & Observability Verification
  ---
  duration_ms: 1263.795452
  type: 'suite'
  location: '/app/__tests__/phase3/section-g-telemetry.test.js:27:1'
  failureType: 'subtestsFailed'
  error: '1 subtest failed'
  code: 'ERR_TEST_FAILURE'
  ...
# Subtest: Section H: End-to-End Flow Verification
    # Subtest: H.1: E2E Flow - Happy Path
        # Subtest: Step 1: Trigger endpoint is accessible and returns valid response
        ok 1 - Step 1: Trigger endpoint is accessible and returns valid response
          ---
          duration_ms: 177.141118
          ...
# Note: Suggestion creation returned: 404 {
#   status: 'error',
#   code: 'NOT_FOUND',
#   message: 'Route POST /api/ai/suggestions not found'
# }
# Skipping: No test suggestion was created
# Skipping: No test suggestion was created
# Skipping: No test suggestion was created
        # Subtest: Step 2: Create a test suggestion to simulate trigger output
        ok 2 - Step 2: Create a test suggestion to simulate trigger output
          ---
          duration_ms: 50.352465
          ...
        # Subtest: Step 3: Suggestion appears in queue with pending status
        ok 3 - Step 3: Suggestion appears in queue with pending status
          ---
          duration_ms: 1.192102
          ...
        # Subtest: Step 4: Review and approve the suggestion
        ok 4 - Step 4: Review and approve the suggestion
          ---
          duration_ms: 0.806071
          ...
        # Subtest: Step 5: Apply endpoint handles approved suggestion
        ok 5 - Step 5: Apply endpoint handles approved suggestion
          ---
          duration_ms: 0.987832
          ...
        1..5
    ok 1 - H.1: E2E Flow - Happy Path
      ---
      duration_ms: 233.501819
      type: 'suite'
      ...
# Skipping state test: Could not create suggestion
    # Subtest: H.2: State Machine Verification
        # Subtest: Pending → Approved transition is valid
        ok 1 - Pending → Approved transition is valid
          ---
          duration_ms: 24.681018
          ...
# Skipping state test: Could not create suggestion
        # Subtest: Pending → Rejected transition is valid
        ok 2 - Pending → Rejected transition is valid
          ---
          duration_ms: 13.590044
          ...
# Skipping state test: Could not create suggestion
        # Subtest: Invalid transition (Rejected → Applied) should fail or be prevented
        ok 3 - Invalid transition (Rejected → Applied) should fail or be prevented
          ---
          duration_ms: 14.952279
          ...
        1..3
    ok 2 - H.2: State Machine Verification
      ---
      duration_ms: 54.633077
      type: 'suite'
      ...
    # Subtest: H.3: Telemetry Emission Verification
        # Subtest: Telemetry endpoint captures events during flow
        ok 1 - Telemetry endpoint captures events during flow
          ---
          duration_ms: 11.115712
          ...
        # Subtest: System logs endpoint accessible for audit trail
        ok 2 - System logs endpoint accessible for audit trail
          ---
          duration_ms: 135.094991
          ...
        1..2
    ok 3 - H.3: Telemetry Emission Verification
      ---
      duration_ms: 146.968103
      type: 'suite'
      ...
    # Subtest: H.4: Error Handling & Edge Cases
        # Subtest: Trigger with invalid payload is handled gracefully
        ok 1 - Trigger with invalid payload is handled gracefully
          ---
          duration_ms: 10.752695
          ...
        # Subtest: Apply on non-existent suggestion returns 404
        ok 2 - Apply on non-existent suggestion returns 404
          ---
          duration_ms: 11.298293
          ...
        # Subtest: Missing tenant header is handled appropriately
        ok 3 - Missing tenant header is handled appropriately
          ---
          duration_ms: 8.017819
          ...
        1..3
    ok 4 - H.4: Error Handling & Edge Cases
      ---
      duration_ms: 30.731442
      type: 'suite'
      ...
    # Subtest: H.5: Performance & Timing
        # Subtest: Trigger endpoint responds within 5 seconds
        ok 1 - Trigger endpoint responds within 5 seconds
          ---
          duration_ms: 21.750392
          ...
        # Subtest: Suggestion list query responds within 2 seconds
        ok 2 - Suggestion list query responds within 2 seconds
          ---
          duration_ms: 8.686898
          ...
# Skipping timing test: Could not create suggestion
        # Subtest: Apply operation responds within 10 seconds
        ok 3 - Apply operation responds within 10 seconds
          ---
          duration_ms: 10.362512
          ...
        1..3
    ok 5 - H.5: Performance & Timing
      ---
      duration_ms: 41.551732
      type: 'suite'
      ...
    1..5
ok 50 - Section H: End-to-End Flow Verification
  ---
  duration_ms: 515.389211
  type: 'suite'
  ...
# ✅ Phase 6: Developer AI Safety Tests
# Subtest: Phase 6: Command Safety Classification
    # Subtest: Safe Commands (Auto-Execute)
        # Subtest: should allow docker ps
        ok 1 - should allow docker ps
          ---
          duration_ms: 10.507512
          ...
        # Subtest: should allow docker logs with tail
        ok 2 - should allow docker logs with tail
          ---
          duration_ms: 2.253909
          ...
        # Subtest: should allow systemctl status
        ok 3 - should allow systemctl status
          ---
          duration_ms: 1.451218
          ...
        # Subtest: should allow health check curl
        ok 4 - should allow health check curl
          ---
          duration_ms: 0.979884
          ...
        # Subtest: should allow safe file reads
        ok 5 - should allow safe file reads
          ---
          duration_ms: 3.725404
          ...
        # Subtest: should allow git status
        ok 6 - should allow git status
          ---
          duration_ms: 0.90852
          ...
        1..6
    ok 1 - Safe Commands (Auto-Execute)
      ---
      duration_ms: 25.542719
      type: 'suite'
      ...
    # Subtest: Blocked Commands
        # Subtest: should block rm -rf
        ok 1 - should block rm -rf
          ---
          duration_ms: 0.549114
          ...
        # Subtest: should block sudo commands
        ok 2 - should block sudo commands
          ---
          duration_ms: 0.572129
          ...
        # Subtest: should block ssh
        ok 3 - should block ssh
          ---
          duration_ms: 0.710858
          ...
        # Subtest: should block env variable access
        ok 4 - should block env variable access
          ---
          duration_ms: 0.422779
          ...
        # Subtest: should block reading .env files
        ok 5 - should block reading .env files
          ---
          duration_ms: 0.362242
          ...
        1..5
    ok 2 - Blocked Commands
      ---
      duration_ms: 3.45248
      type: 'suite'
      ...
    # Subtest: Approval-Required Commands
        # Subtest: should require approval for chmod
        ok 1 - should require approval for chmod
          ---
          duration_ms: 0.478641
          ...
        # Subtest: should require approval for npm install
        ok 2 - should require approval for npm install
          ---
          duration_ms: 0.26084
          ...
        # Subtest: should require approval for unknown commands
        ok 3 - should require approval for unknown commands
          ---
          duration_ms: 0.566324
          ...
        1..3
    ok 3 - Approval-Required Commands
      ---
      duration_ms: 1.554391
      type: 'suite'
      ...
    # Subtest: File Operations
        # Subtest: should allow read operations on safe files
        ok 1 - should allow read operations on safe files
          ---
          duration_ms: 1.379944
          ...
        # Subtest: should block reading .env files
        ok 2 - should block reading .env files
          ---
          duration_ms: 0.286673
          ...
        # Subtest: should require approval for write operations
        ok 3 - should require approval for write operations
          ---
          duration_ms: 0.312588
          ...
        # Subtest: should block delete operations
        ok 4 - should block delete operations
          ---
          duration_ms: 0.327357
          ...
        1..4
    ok 4 - File Operations
      ---
      duration_ms: 2.627675
      type: 'suite'
      ...
    1..4
ok 51 - Phase 6: Command Safety Classification
  ---
  duration_ms: 34.643141
  type: 'suite'
  ...
# Subtest: Phase 6: Secret Redaction
    # Subtest: should redact JWT tokens
    ok 1 - should redact JWT tokens
      ---
      duration_ms: 2.108265
      ...
    # Subtest: should redact Bearer tokens
    ok 2 - should redact Bearer tokens
      ---
      duration_ms: 0.580393
      ...
    # Subtest: should redact API keys
    ok 3 - should redact API keys
      ---
      duration_ms: 0.296411
      ...
    # Subtest: should redact Supabase keys
    ok 4 - should redact Supabase keys
      ---
      duration_ms: 0.558839
      ...
    # Subtest: should redact secrets from objects
    ok 5 - should redact secrets from objects
      ---
      duration_ms: 0.727125
      ...
    # Subtest: should handle nested objects
    ok 6 - should handle nested objects
      ---
      duration_ms: 0.564205
      ...
    1..6
ok 52 - Phase 6: Secret Redaction
  ---
  duration_ms: 5.914888
  type: 'suite'
  ...
# Subtest: Phase 6: Path Safety Validation
    # Subtest: should allow safe paths
    ok 1 - should allow safe paths
      ---
      duration_ms: 1.37061
      ...
    # Subtest: should block path traversal
    ok 2 - should block path traversal
      ---
      duration_ms: 0.195049
      ...
    # Subtest: should block .env files
    ok 3 - should block .env files
      ---
      duration_ms: 0.137167
      ...
    # Subtest: should block key files
    ok 4 - should block key files
      ---
      duration_ms: 0.114557
      ...
    # Subtest: should block secrets directories
    ok 5 - should block secrets directories
      ---
      duration_ms: 0.111814
      ...
    # Subtest: Export Safety
        # Subtest: should allow exportable source files
        ok 1 - should allow exportable source files
          ---
          duration_ms: 0.812658
          ...
        # Subtest: should block node_modules
        ok 2 - should block node_modules
          ---
          duration_ms: 2.764076
          ...
        # Subtest: should block build artifacts
        ok 3 - should block build artifacts
          ---
          duration_ms: 0.311338
          ...
        # Subtest: should block log files
        ok 4 - should block log files
          ---
          duration_ms: 0.179151
          ...
        1..4
    ok 6 - Export Safety
      ---
      duration_ms: 4.245014
      type: 'suite'
      ...
    1..6
ok 53 - Phase 6: Path Safety Validation
  ---
  duration_ms: 6.458083
  type: 'suite'
  ...
# Subtest: Phase 6: Integration Tests
    # Subtest: should create approval record in database
    ok 1 - should create approval record in database # SKIP
      ---
      duration_ms: 1.088869
      ...
    # Subtest: should execute approved action
    ok 2 - should execute approved action # SKIP
      ---
      duration_ms: 0.412298
      ...
    # Subtest: should create export bundle with manifest
    ok 3 - should create export bundle with manifest # SKIP
      ---
      duration_ms: 0.314159
      ...
    1..3
ok 54 - Phase 6: Integration Tests
  ---
  duration_ms: 2.364978
  type: 'suite'
  ...
# Subtest: Accounts Routes
    # Subtest: GET /api/accounts returns 200 with tenant_id
    not ok 1 - GET /api/accounts returns 200 with tenant_id
      ---
      duration_ms: 0
      location: '/app/__tests__/routes/accounts.route.test.js:75:3'
      failureType: 'cancelledByParent'
      error: 'test did not finish before its parent and was cancelled'
      code: 'ERR_TEST_FAILURE'
      ...
    # Subtest: GET /api/accounts/:id returns specific account
    not ok 2 - GET /api/accounts/:id returns specific account
      ---
      duration_ms: 0
      location: '/app/__tests__/routes/accounts.route.test.js:84:3'
      failureType: 'cancelledByParent'
      error: 'test did not finish before its parent and was cancelled'
      code: 'ERR_TEST_FAILURE'
      ...
    # Subtest: GET /api/accounts/:id enforces tenant scoping
    not ok 3 - GET /api/accounts/:id enforces tenant scoping
      ---
      duration_ms: 0
      location: '/app/__tests__/routes/accounts.route.test.js:98:3'
      failureType: 'cancelledByParent'
      error: 'test did not finish before its parent and was cancelled'
      code: 'ERR_TEST_FAILURE'
      ...
    # Subtest: PUT /api/accounts/:id updates account
    not ok 4 - PUT /api/accounts/:id updates account
      ---
      duration_ms: 0
      location: '/app/__tests__/routes/accounts.route.test.js:108:3'
      failureType: 'cancelledByParent'
      error: 'test did not finish before its parent and was cancelled'
      code: 'ERR_TEST_FAILURE'
      ...
    # Subtest: DELETE /api/accounts/:id removes account
    not ok 5 - DELETE /api/accounts/:id removes account
      ---
      duration_ms: 0
      location: '/app/__tests__/routes/accounts.route.test.js:126:3'
      failureType: 'cancelledByParent'
      error: 'test did not finish before its parent and was cancelled'
      code: 'ERR_TEST_FAILURE'
      ...
    # Subtest: GET /api/accounts supports type filter
    not ok 6 - GET /api/accounts supports type filter
      ---
      duration_ms: 0
      location: '/app/__tests__/routes/accounts.route.test.js:145:3'
      failureType: 'cancelledByParent'
      error: 'test did not finish before its parent and was cancelled'
      code: 'ERR_TEST_FAILURE'
      ...
    # Subtest: POST /api/accounts requires tenant_id
    not ok 7 - POST /api/accounts requires tenant_id
      ---
      duration_ms: 0
      location: '/app/__tests__/routes/accounts.route.test.js:158:3'
      failureType: 'cancelledByParent'
      error: 'test did not finish before its parent and was cancelled'
      code: 'ERR_TEST_FAILURE'
      ...
    # Subtest: POST /api/accounts creates account with metadata
    not ok 8 - POST /api/accounts creates account with metadata
      ---
      duration_ms: 0
      location: '/app/__tests__/routes/accounts.route.test.js:169:3'
      failureType: 'cancelledByParent'
      error: 'test did not finish before its parent and was cancelled'
      code: 'ERR_TEST_FAILURE'
      ...
    # Subtest: GET /api/accounts/search returns matching accounts
    not ok 9 - GET /api/accounts/search returns matching accounts
      ---
      duration_ms: 0
      location: '/app/__tests__/routes/accounts.route.test.js:191:3'
      failureType: 'cancelledByParent'
      error: 'test did not finish before its parent and was cancelled'
      code: 'ERR_TEST_FAILURE'
      ...
    # Subtest: GET /api/accounts/search requires q parameter
    not ok 10 - GET /api/accounts/search requires q parameter
      ---
      duration_ms: 0
      location: '/app/__tests__/routes/accounts.route.test.js:200:3'
      failureType: 'cancelledByParent'
      error: 'test did not finish before its parent and was cancelled'
      code: 'ERR_TEST_FAILURE'
      ...
    # Subtest: GET /api/accounts/search requires tenant_id
    not ok 11 - GET /api/accounts/search requires tenant_id
      ---
      duration_ms: 0
      location: '/app/__tests__/routes/accounts.route.test.js:207:3'
      failureType: 'cancelledByParent'
      error: 'test did not finish before its parent and was cancelled'
      code: 'ERR_TEST_FAILURE'
      ...
    1..11
not ok 55 - Accounts Routes
  ---
  duration_ms: 172.344068
  type: 'suite'
  location: '/app/__tests__/routes/accounts.route.test.js:42:1'
  failureType: 'hookFailed'
  error: 'create account A failed: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    SuiteContext.<anonymous> (file:///app/__tests__/routes/accounts.route.test.js:52:12)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
    async Suite.runHook (node:internal/test_runner/test:723:9)
    async Suite.run (node:internal/test_runner/test:1129:7)
    async Test.processPendingSubtests (node:internal/test_runner/test:526:7)
  ...
# Subtest: Accounts V2 - tenant_id validation for GET by ID
    # Subtest: GET /api/v2/accounts/:id WITH tenant_id returns 200
    not ok 1 - GET /api/v2/accounts/:id WITH tenant_id returns 200
      ---
      duration_ms: 0
      location: '/app/__tests__/routes/accounts.v2.tenant-validation.test.js:57:3'
      failureType: 'cancelledByParent'
      error: 'test did not finish before its parent and was cancelled'
      code: 'ERR_TEST_FAILURE'
      ...
    # Subtest: GET /api/v2/accounts/:id WITHOUT tenant_id returns 400
    not ok 2 - GET /api/v2/accounts/:id WITHOUT tenant_id returns 400
      ---
      duration_ms: 0
      location: '/app/__tests__/routes/accounts.v2.tenant-validation.test.js:66:3'
      failureType: 'cancelledByParent'
      error: 'test did not finish before its parent and was cancelled'
      code: 'ERR_TEST_FAILURE'
      ...
    # Subtest: GET /api/v2/accounts/:id with WRONG tenant_id returns 404
    not ok 3 - GET /api/v2/accounts/:id with WRONG tenant_id returns 404
      ---
      duration_ms: 0
      location: '/app/__tests__/routes/accounts.v2.tenant-validation.test.js:75:3'
      failureType: 'cancelledByParent'
      error: 'test did not finish before its parent and was cancelled'
      code: 'ERR_TEST_FAILURE'
      ...
    # Subtest: GET /api/v2/accounts/:id with empty tenant_id returns 400
    not ok 4 - GET /api/v2/accounts/:id with empty tenant_id returns 400
      ---
      duration_ms: 0
      location: '/app/__tests__/routes/accounts.v2.tenant-validation.test.js:84:3'
      failureType: 'cancelledByParent'
      error: 'test did not finish before its parent and was cancelled'
      code: 'ERR_TEST_FAILURE'
      ...
    1..4
not ok 56 - Accounts V2 - tenant_id validation for GET by ID
  ---
  duration_ms: 197.167596
  type: 'suite'
  location: '/app/__tests__/routes/accounts.v2.tenant-validation.test.js:41:1'
  failureType: 'hookFailed'
  error: 'Failed to create test account'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    SuiteContext.<anonymous> (file:///app/__tests__/routes/accounts.v2.tenant-validation.test.js:45:12)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
    async Suite.runHook (node:internal/test_runner/test:723:9)
    async Suite.run (node:internal/test_runner/test:1129:7)
    async Test.processPendingSubtests (node:internal/test_runner/test:526:7)
  ...
# Failed to create Activity A: { status: 'error', message: 'Authentication required' }
# Test cleanup complete.
# Subtest: GET /api/v2/activities returns list with tenant_id
not ok 57 - GET /api/v2/activities returns list with tenant_id
  ---
  duration_ms: 66.517071
  location: '/app/__tests__/routes/activities.filters.test.js:112:32'
  failureType: 'hookFailed'
  error: 'Expected 200 or 201, got 401: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/activities.filters.test.js:83:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: Filter by status=scheduled returns scheduled activities
not ok 58 - Filter by status=scheduled returns scheduled activities
  ---
  duration_ms: 3.02929
  location: '/app/__tests__/routes/activities.filters.test.js:123:32'
  failureType: 'hookFailed'
  error: 'Expected 200 or 201, got 401: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/activities.filters.test.js:83:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: Filter by is_test_data=true returns test activities
not ok 59 - Filter by is_test_data=true returns test activities
  ---
  duration_ms: 0.184558
  location: '/app/__tests__/routes/activities.filters.test.js:139:32'
  failureType: 'hookFailed'
  error: 'Expected 200 or 201, got 401: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/activities.filters.test.js:83:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: Filter by is_test_data=false excludes test activities
not ok 60 - Filter by is_test_data=false excludes test activities
  ---
  duration_ms: 0.149166
  location: '/app/__tests__/routes/activities.filters.test.js:161:32'
  failureType: 'hookFailed'
  error: 'Expected 200 or 201, got 401: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/activities.filters.test.js:83:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: Pagination with limit and offset works
not ok 61 - Pagination with limit and offset works
  ---
  duration_ms: 0.297645
  location: '/app/__tests__/routes/activities.filters.test.js:177:32'
  failureType: 'hookFailed'
  error: 'Expected 200 or 201, got 401: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/activities.filters.test.js:83:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: AI timezone inputs retain local components and capture original ISO
not ok 62 - AI timezone inputs retain local components and capture original ISO
  ---
  duration_ms: 0.119011
  location: '/app/__tests__/routes/activities.filters.test.js:208:32'
  failureType: 'hookFailed'
  error: 'Expected 200 or 201, got 401: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/activities.filters.test.js:83:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/v2/activities/:id returns single activity
not ok 63 - GET /api/v2/activities/:id returns single activity
  ---
  duration_ms: 0.109296
  location: '/app/__tests__/routes/activities.filters.test.js:233:32'
  failureType: 'hookFailed'
  error: 'Expected 200 or 201, got 401: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/activities.filters.test.js:83:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: Filter by type=task returns task activities
not ok 64 - Filter by type=task returns task activities
  ---
  duration_ms: 0.119308
  location: '/app/__tests__/routes/activities.filters.test.js:252:32'
  failureType: 'hookFailed'
  error: 'Expected 200 or 201, got 401: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/activities.filters.test.js:83:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: include_stats=true returns activity counts
not ok 65 - include_stats=true returns activity counts
  ---
  duration_ms: 0.60103
  location: '/app/__tests__/routes/activities.filters.test.js:265:32'
  failureType: 'hookFailed'
  error: 'Expected 200 or 201, got 401: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/activities.filters.test.js:83:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: Filter with $or and $regex operators works correctly
not ok 66 - Filter with $or and $regex operators works correctly
  ---
  duration_ms: 0.303501
  location: '/app/__tests__/routes/activities.filters.test.js:282:32'
  failureType: 'hookFailed'
  error: 'Expected 200 or 201, got 401: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/activities.filters.test.js:83:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: Filter with special characters in $regex pattern
not ok 67 - Filter with special characters in $regex pattern
  ---
  duration_ms: 0.25984
  location: '/app/__tests__/routes/activities.filters.test.js:321:32'
  failureType: 'hookFailed'
  error: 'Expected 200 or 201, got 401: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/activities.filters.test.js:83:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/v2/activities returns 200 with tenant_id and includes total
not ok 68 - GET /api/v2/activities returns 200 with tenant_id and includes total
  ---
  duration_ms: 93.272354
  location: '/app/__tests__/routes/activities.route.test.js:47:32'
  failureType: 'hookFailed'
  error: 'create activity A failed: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/activities.route.test.js:32:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/v2/activities supports search query param
not ok 69 - GET /api/v2/activities supports search query param
  ---
  duration_ms: 7.830211
  location: '/app/__tests__/routes/activities.route.test.js:57:32'
  failureType: 'hookFailed'
  error: 'create activity A failed: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/activities.route.test.js:32:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/v2/activities supports status filter
not ok 70 - GET /api/v2/activities supports status filter
  ---
  duration_ms: 0.581018
  location: '/app/__tests__/routes/activities.route.test.js:65:32'
  failureType: 'hookFailed'
  error: 'create activity A failed: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/activities.route.test.js:32:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/v2/activities requires tenant_id
not ok 71 - GET /api/v2/activities requires tenant_id
  ---
  duration_ms: 1.107401
  location: '/app/__tests__/routes/activities.route.test.js:72:32'
  failureType: 'hookFailed'
  error: 'create activity A failed: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/activities.route.test.js:32:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: AI Routes
    # Subtest: GET /api/ai/assistants returns list of assistants
    ok 1 - GET /api/ai/assistants returns list of assistants
      ---
      duration_ms: 150.254996
      ...
    # Subtest: GET /api/ai/conversations returns conversations list
    not ok 2 - GET /api/ai/conversations returns conversations list
      ---
      duration_ms: 23.216155
      location: '/app/__tests__/routes/ai.route.test.js:26:3'
      failureType: 'testCodeFailure'
      error: 'expected 200 or 500, got 401'
      code: 'ERR_ASSERTION'
      name: 'AssertionError'
      expected: true
      actual: false
      operator: '=='
      stack: |-
        TestContext.<anonymous> (file:///app/__tests__/routes/ai.route.test.js:28:12)
        process.processTicksAndRejections (node:internal/process/task_queues:95:5)
        async Test.run (node:internal/test_runner/test:797:9)
        async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
      ...
    # Subtest: POST /api/ai/chat returns 400 without message
    ok 3 - POST /api/ai/chat returns 400 without message
      ---
      duration_ms: 35.931478
      ...
    # Subtest: POST /api/ai/summarize handles missing text
    ok 4 - POST /api/ai/summarize handles missing text
      ---
      duration_ms: 15.280427
      ...
    # Subtest: POST /api/ai/sentiment handles missing text
    ok 5 - POST /api/ai/sentiment handles missing text
      ---
      duration_ms: 25.037878
      ...
    # Subtest: GET /api/ai/context returns context info
    ok 6 - GET /api/ai/context returns context info
      ---
      duration_ms: 20.427113
      ...
    # Subtest: GET /api/ai/tools returns available tools or 404
    ok 7 - GET /api/ai/tools returns available tools or 404
      ---
      duration_ms: 11.828101
      ...
    # Subtest: POST /api/ai/brain-test requires auth key
    ok 8 - POST /api/ai/brain-test requires auth key
      ---
      duration_ms: 16.13581
      ...
    # Subtest: DELETE /api/ai/conversations/:id validates conversation exists
    not ok 9 - DELETE /api/ai/conversations/:id validates conversation exists
      ---
      duration_ms: 14.80997
      location: '/app/__tests__/routes/ai.route.test.js:102:3'
      failureType: 'testCodeFailure'
      error: 'expected 200 or 404, got 401'
      code: 'ERR_ASSERTION'
      name: 'AssertionError'
      expected: true
      actual: false
      operator: '=='
      stack: |-
        TestContext.<anonymous> (file:///app/__tests__/routes/ai.route.test.js:108:12)
        process.processTicksAndRejections (node:internal/process/task_queues:95:5)
        async Test.run (node:internal/test_runner/test:797:9)
        async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
      ...
    1..9
not ok 72 - AI Routes
  ---
  duration_ms: 320.257773
  type: 'suite'
  location: '/app/__tests__/routes/ai.route.test.js:9:1'
  failureType: 'subtestsFailed'
  error: '2 subtests failed'
  code: 'ERR_TEST_FAILURE'
  ...
# Subtest: AI Realtime Routes
    # Subtest: GET /api/ai/realtime-token requires authentication
    ok 1 - GET /api/ai/realtime-token requires authentication
      ---
      duration_ms: 136.323726
      ...
    # Subtest: POST /api/ai/realtime-session requires authentication
    ok 2 - POST /api/ai/realtime-session requires authentication
      ---
      duration_ms: 32.678407
      ...
    # Subtest: POST /api/ai/realtime-session with invalid data returns 400
    ok 3 - POST /api/ai/realtime-session with invalid data returns 400
      ---
      duration_ms: 12.198313
      ...
    # Subtest: GET /api/ai/realtime-config returns config or 404
    ok 4 - GET /api/ai/realtime-config returns config or 404
      ---
      duration_ms: 17.996195
      ...
    # Subtest: POST /api/ai/realtime-event validates event format
    ok 5 - POST /api/ai/realtime-event validates event format
      ---
      duration_ms: 22.508371
      ...
    1..5
ok 73 - AI Realtime Routes
  ---
  duration_ms: 234.406452
  type: 'suite'
  ...
# Subtest: AI Settings Routes
    # Subtest: GET /api/ai-settings returns AI settings
    ok 1 - GET /api/ai-settings returns AI settings
      ---
      duration_ms: 280.146161
      ...
    # Subtest: PUT /api/ai-settings/:id updates AI settings
    ok 2 - PUT /api/ai-settings/:id updates AI settings
      ---
      duration_ms: 384.661719
      ...
    # Subtest: GET /api/ai-settings/categories returns categories
    ok 3 - GET /api/ai-settings/categories returns categories
      ---
      duration_ms: 45.389305
      ...
    # Subtest: POST /api/ai-settings/reset resets to defaults
    ok 4 - POST /api/ai-settings/reset resets to defaults
      ---
      duration_ms: 149.91995
      ...
    # Subtest: POST /api/ai-settings/clear-cache clears cache
    ok 5 - POST /api/ai-settings/clear-cache clears cache
      ---
      duration_ms: 40.264517
      ...
    1..5
ok 74 - AI Settings Routes
  ---
  duration_ms: 904.84219
  type: 'suite'
  ...
# Subtest: AI Campaigns Routes
    # Subtest: GET /api/aicampaigns returns 200 with tenant_id
    not ok 1 - GET /api/aicampaigns returns 200 with tenant_id
      ---
      duration_ms: 48.250929
      location: '/app/__tests__/routes/aicampaigns.route.test.js:49:3'
      failureType: 'testCodeFailure'
      error: |-
        expected 200 from campaigns list
        
        401 !== 200
        
      code: 'ERR_ASSERTION'
      name: 'AssertionError'
      expected: 200
      actual: 401
      operator: 'strictEqual'
      stack: |-
        TestContext.<anonymous> (file:///app/__tests__/routes/aicampaigns.route.test.js:51:12)
        process.processTicksAndRejections (node:internal/process/task_queues:95:5)
        async Test.run (node:internal/test_runner/test:797:9)
        async Promise.all (index 0)
        async Suite.run (node:internal/test_runner/test:1135:7)
        async Test.processPendingSubtests (node:internal/test_runner/test:526:7)
      ...
    # Subtest: POST /api/aicampaigns creates new campaign
    not ok 2 - POST /api/aicampaigns creates new campaign
      ---
      duration_ms: 12.817615
      location: '/app/__tests__/routes/aicampaigns.route.test.js:57:3'
      failureType: 'testCodeFailure'
      error: 'expected 200 or 201, got 401: {"status":"error","message":"Authentication required"}'
      code: 'ERR_ASSERTION'
      name: 'AssertionError'
      expected: true
      actual: false
      operator: '=='
      stack: |-
        TestContext.<anonymous> (file:///app/__tests__/routes/aicampaigns.route.test.js:70:12)
        process.processTicksAndRejections (node:internal/process/task_queues:95:5)
        async Test.run (node:internal/test_runner/test:797:9)
        async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
      ...
    # Subtest: POST /api/aicampaigns requires name
    not ok 3 - POST /api/aicampaigns requires name
      ---
      duration_ms: 19.344245
      location: '/app/__tests__/routes/aicampaigns.route.test.js:76:3'
      failureType: 'testCodeFailure'
      error: 'expected 400, 422, or 500, got 401'
      code: 'ERR_ASSERTION'
      name: 'AssertionError'
      expected: true
      actual: false
      operator: '=='
      stack: |-
        TestContext.<anonymous> (file:///app/__tests__/routes/aicampaigns.route.test.js:83:12)
        process.processTicksAndRejections (node:internal/process/task_queues:95:5)
        async Test.run (node:internal/test_runner/test:797:9)
        async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
      ...
    # Subtest: GET /api/aicampaigns/:id returns specific campaign
    ok 4 - GET /api/aicampaigns/:id returns specific campaign
      ---
      duration_ms: 0.893086
      ...
    # Subtest: PUT /api/aicampaigns/:id updates campaign
    ok 5 - PUT /api/aicampaigns/:id updates campaign
      ---
      duration_ms: 0.469003
      ...
    # Subtest: POST /api/aicampaigns/:id/start initiates campaign
    ok 6 - POST /api/aicampaigns/:id/start initiates campaign
      ---
      duration_ms: 0.325694
      ...
    # Subtest: POST /api/aicampaigns/:id/pause pauses campaign
    ok 7 - POST /api/aicampaigns/:id/pause pauses campaign
      ---
      duration_ms: 0.307539
      ...
    # Subtest: GET /api/aicampaigns/:id/stats returns campaign statistics
    ok 8 - GET /api/aicampaigns/:id/stats returns campaign statistics
      ---
      duration_ms: 4.957001
      ...
    1..8
not ok 75 - AI Campaigns Routes
  ---
  duration_ms: 263.122304
  type: 'suite'
  location: '/app/__tests__/routes/aicampaigns.route.test.js:26:1'
  failureType: 'subtestsFailed'
  error: '3 subtests failed'
  code: 'ERR_TEST_FAILURE'
  ...
# Subtest: Announcements Routes
    # Subtest: GET /api/announcements returns announcements list
    ok 1 - GET /api/announcements returns announcements list
      ---
      duration_ms: 266.661996
      ...
    # Subtest: POST /api/announcements without required fields returns error
    ok 2 - POST /api/announcements without required fields returns error
      ---
      duration_ms: 44.099722
      ...
    # Subtest: POST /api/announcements with valid data creates announcement
    ok 3 - POST /api/announcements with valid data creates announcement
      ---
      duration_ms: 148.289794
      ...
    # Subtest: GET /api/announcements/:id returns specific announcement
    not ok 4 - GET /api/announcements/:id returns specific announcement
      ---
      duration_ms: 24.872632
      location: '/app/__tests__/routes/announcements.route.test.js:49:3'
      failureType: 'testCodeFailure'
      error: 'expected 200/401/404, got 400'
      code: 'ERR_ASSERTION'
      name: 'AssertionError'
      expected: true
      actual: false
      operator: '=='
      stack: |-
        TestContext.<anonymous> (file:///app/__tests__/routes/announcements.route.test.js:52:12)
        process.processTicksAndRejections (node:internal/process/task_queues:95:5)
        async Test.run (node:internal/test_runner/test:797:9)
        async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
      ...
    # Subtest: PUT /api/announcements/:id updates announcement
    not ok 5 - PUT /api/announcements/:id updates announcement
      ---
      duration_ms: 19.408711
      location: '/app/__tests__/routes/announcements.route.test.js:55:3'
      failureType: 'testCodeFailure'
      error: 'expected update response, got 400'
      code: 'ERR_ASSERTION'
      name: 'AssertionError'
      expected: true
      actual: false
      operator: '=='
      stack: |-
        TestContext.<anonymous> (file:///app/__tests__/routes/announcements.route.test.js:62:12)
        process.processTicksAndRejections (node:internal/process/task_queues:95:5)
        async Test.run (node:internal/test_runner/test:797:9)
        async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
      ...
    # Subtest: DELETE /api/announcements/:id requires auth
    not ok 6 - DELETE /api/announcements/:id requires auth
      ---
      duration_ms: 21.879221
      location: '/app/__tests__/routes/announcements.route.test.js:65:3'
      failureType: 'testCodeFailure'
      error: 'expected delete response, got 400'
      code: 'ERR_ASSERTION'
      name: 'AssertionError'
      expected: true
      actual: false
      operator: '=='
      stack: |-
        TestContext.<anonymous> (file:///app/__tests__/routes/announcements.route.test.js:70:12)
        process.processTicksAndRejections (node:internal/process/task_queues:95:5)
        async Test.run (node:internal/test_runner/test:797:9)
        async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
      ...
    # Subtest: POST /api/announcements/:id/dismiss marks announcement as dismissed
    ok 7 - POST /api/announcements/:id/dismiss marks announcement as dismissed
      ---
      duration_ms: 27.057803
      ...
    # Subtest: GET /api/announcements/active returns active announcements
    not ok 8 - GET /api/announcements/active returns active announcements
      ---
      duration_ms: 11.838776
      location: '/app/__tests__/routes/announcements.route.test.js:83:3'
      failureType: 'testCodeFailure'
      error: 'expected 200/401/404, got 400'
      code: 'ERR_ASSERTION'
      name: 'AssertionError'
      expected: true
      actual: false
      operator: '=='
      stack: |-
        TestContext.<anonymous> (file:///app/__tests__/routes/announcements.route.test.js:85:12)
        process.processTicksAndRejections (node:internal/process/task_queues:95:5)
        async Test.run (node:internal/test_runner/test:797:9)
        async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
      ...
    1..8
not ok 76 - Announcements Routes
  ---
  duration_ms: 572.978786
  type: 'suite'
  location: '/app/__tests__/routes/announcements.route.test.js:13:1'
  failureType: 'subtestsFailed'
  error: '4 subtests failed'
  code: 'ERR_TEST_FAILURE'
  ...
# Subtest: API Keys Routes
    # Subtest: GET /api/apikeys returns API keys list
    ok 1 - GET /api/apikeys returns API keys list
      ---
      duration_ms: 306.678329
      ...
    # Subtest: POST /api/apikeys without required fields returns error
    ok 2 - POST /api/apikeys without required fields returns error
      ---
      duration_ms: 37.251971
      ...
    # Subtest: POST /api/apikeys with valid data creates key
    not ok 3 - POST /api/apikeys with valid data creates key
      ---
      duration_ms: 143.441533
      location: '/app/__tests__/routes/apikeys.route.test.js:36:3'
      failureType: 'testCodeFailure'
      error: 'expected key data in response'
      code: 'ERR_ASSERTION'
      name: 'AssertionError'
      expected: true
      operator: '=='
      stack: |-
        TestContext.<anonymous> (file:///app/__tests__/routes/apikeys.route.test.js:51:14)
        process.processTicksAndRejections (node:internal/process/task_queues:95:5)
        async Test.run (node:internal/test_runner/test:797:9)
        async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
      ...
    # Subtest: GET /api/apikeys/:id returns specific API key
    not ok 4 - GET /api/apikeys/:id returns specific API key
      ---
      duration_ms: 40.856357
      location: '/app/__tests__/routes/apikeys.route.test.js:55:3'
      failureType: 'testCodeFailure'
      error: 'expected 200/401/404, got 400'
      code: 'ERR_ASSERTION'
      name: 'AssertionError'
      expected: true
      actual: false
      operator: '=='
      stack: |-
        TestContext.<anonymous> (file:///app/__tests__/routes/apikeys.route.test.js:58:12)
        process.processTicksAndRejections (node:internal/process/task_queues:95:5)
        async Test.run (node:internal/test_runner/test:797:9)
        async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
      ...
    # Subtest: PUT /api/apikeys/:id updates API key
    ok 5 - PUT /api/apikeys/:id updates API key
      ---
      duration_ms: 53.328718
      ...
    # Subtest: DELETE /api/apikeys/:id requires auth
    not ok 6 - DELETE /api/apikeys/:id requires auth
      ---
      duration_ms: 23.111765
      location: '/app/__tests__/routes/apikeys.route.test.js:74:3'
      failureType: 'testCodeFailure'
      error: 'expected delete response, got 400'
      code: 'ERR_ASSERTION'
      name: 'AssertionError'
      expected: true
      actual: false
      operator: '=='
      stack: |-
        TestContext.<anonymous> (file:///app/__tests__/routes/apikeys.route.test.js:79:12)
        process.processTicksAndRejections (node:internal/process/task_queues:95:5)
        async Test.run (node:internal/test_runner/test:797:9)
        async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
      ...
    1..6
not ok 77 - API Keys Routes
  ---
  duration_ms: 620.134584
  type: 'suite'
  location: '/app/__tests__/routes/apikeys.route.test.js:13:1'
  failureType: 'subtestsFailed'
  error: '3 subtests failed'
  code: 'ERR_TEST_FAILURE'
  ...
# Subtest: Audit Logs Routes
    # Subtest: GET /api/audit-logs returns audit logs list
    ok 1 - GET /api/audit-logs returns audit logs list
      ---
      duration_ms: 187.413602
      ...
    # Subtest: GET /api/audit-logs/:id returns specific audit log
    ok 2 - GET /api/audit-logs/:id returns specific audit log
      ---
      duration_ms: 53.117909
      ...
    # Subtest: GET /api/audit-logs with filters returns filtered results
    ok 3 - GET /api/audit-logs with filters returns filtered results
      ---
      duration_ms: 11.649747
      ...
    # Subtest: GET /api/audit-logs with date range filters
    ok 4 - GET /api/audit-logs with date range filters
      ---
      duration_ms: 19.719115
      ...
    # Subtest: GET /api/audit-logs with user filter
    ok 5 - GET /api/audit-logs with user filter
      ---
      duration_ms: 47.47089
      ...
    # Subtest: GET /api/audit-logs/export returns export data
    ok 6 - GET /api/audit-logs/export returns export data
      ---
      duration_ms: 16.702878
      ...
    # Subtest: GET /api/audit-logs/stats returns statistics
    ok 7 - GET /api/audit-logs/stats returns statistics
      ---
      duration_ms: 43.398955
      ...
    # Subtest: DELETE /api/audit-logs requires admin auth
    ok 8 - DELETE /api/audit-logs requires admin auth
      ---
      duration_ms: 51.023407
      ...
    1..8
ok 78 - Audit Logs Routes
  ---
  duration_ms: 436.996849
  type: 'suite'
  ...
# Subtest: Auth Routes
    # Subtest: POST /api/auth/verify-token returns 400 without token
    ok 1 - POST /api/auth/verify-token returns 400 without token
      ---
      duration_ms: 260.619418
      ...
    # Subtest: POST /api/auth/verify-token validates invalid token
    ok 2 - POST /api/auth/verify-token validates invalid token
      ---
      duration_ms: 100.333547
      ...
    # Subtest: POST /api/auth/login returns 400 without credentials
    ok 3 - POST /api/auth/login returns 400 without credentials
      ---
      duration_ms: 70.779076
      ...
    # Subtest: POST /api/auth/login returns error for invalid credentials
    ok 4 - POST /api/auth/login returns error for invalid credentials
      ---
      duration_ms: 199.718288
      ...
    # Subtest: POST /api/auth/forgot-password returns 400 without email
    ok 5 - POST /api/auth/forgot-password returns 400 without email
      ---
      duration_ms: 27.55264
      ...
    # Subtest: POST /api/auth/forgot-password handles non-existent email gracefully
    ok 6 - POST /api/auth/forgot-password handles non-existent email gracefully
      ---
      duration_ms: 21.542184
      ...
    # Subtest: POST /api/auth/logout clears cookies
    ok 7 - POST /api/auth/logout clears cookies
      ---
      duration_ms: 49.194596
      ...
    # Subtest: GET /api/auth/me without auth returns 401
    ok 8 - GET /api/auth/me without auth returns 401
      ---
      duration_ms: 7.524005
      ...
    # Subtest: POST /api/auth/refresh without cookie returns 401
    ok 9 - POST /api/auth/refresh without cookie returns 401
      ---
      duration_ms: 17.644874
      ...
    1..9
ok 79 - Auth Routes
  ---
  duration_ms: 766.099661
  type: 'suite'
  ...
# Subtest: GET /api/contacts returns 200 with tenant_id
not ok 80 - GET /api/contacts returns 200 with tenant_id
  ---
  duration_ms: 111.856613
  location: '/app/__tests__/routes/contacts.route.test.js:76:32'
  failureType: 'hookFailed'
  error: 'create contact A failed: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/contacts.route.test.js:52:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/contacts/:id returns specific contact
not ok 81 - GET /api/contacts/:id returns specific contact
  ---
  duration_ms: 1.428605
  location: '/app/__tests__/routes/contacts.route.test.js:85:32'
  failureType: 'hookFailed'
  error: 'create contact A failed: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/contacts.route.test.js:52:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/contacts/:id enforces tenant scoping
not ok 82 - GET /api/contacts/:id enforces tenant scoping
  ---
  duration_ms: 0.149065
  location: '/app/__tests__/routes/contacts.route.test.js:98:32'
  failureType: 'hookFailed'
  error: 'create contact A failed: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/contacts.route.test.js:52:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: PUT /api/contacts/:id updates contact
not ok 83 - PUT /api/contacts/:id updates contact
  ---
  duration_ms: 0.733284
  location: '/app/__tests__/routes/contacts.route.test.js:108:32'
  failureType: 'hookFailed'
  error: 'create contact A failed: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/contacts.route.test.js:52:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: DELETE /api/contacts/:id removes contact
not ok 84 - DELETE /api/contacts/:id removes contact
  ---
  duration_ms: 0.209275
  location: '/app/__tests__/routes/contacts.route.test.js:126:32'
  failureType: 'hookFailed'
  error: 'create contact A failed: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/contacts.route.test.js:52:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/contacts supports status filter
not ok 85 - GET /api/contacts supports status filter
  ---
  duration_ms: 0.402118
  location: '/app/__tests__/routes/contacts.route.test.js:146:32'
  failureType: 'hookFailed'
  error: 'create contact A failed: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/contacts.route.test.js:52:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: POST /api/contacts requires tenant_id
not ok 86 - POST /api/contacts requires tenant_id
  ---
  duration_ms: 0.110954
  location: '/app/__tests__/routes/contacts.route.test.js:159:32'
  failureType: 'hookFailed'
  error: 'create contact A failed: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/contacts.route.test.js:52:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/contacts/search returns matching contacts
not ok 87 - GET /api/contacts/search returns matching contacts
  ---
  duration_ms: 0.116871
  location: '/app/__tests__/routes/contacts.route.test.js:170:32'
  failureType: 'hookFailed'
  error: 'create contact A failed: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/contacts.route.test.js:52:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/contacts/search requires q parameter
not ok 88 - GET /api/contacts/search requires q parameter
  ---
  duration_ms: 0.629198
  location: '/app/__tests__/routes/contacts.route.test.js:179:32'
  failureType: 'hookFailed'
  error: 'create contact A failed: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/contacts.route.test.js:52:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/contacts/search requires tenant_id
not ok 89 - GET /api/contacts/search requires tenant_id
  ---
  duration_ms: 0.403378
  location: '/app/__tests__/routes/contacts.route.test.js:186:32'
  failureType: 'hookFailed'
  error: 'create contact A failed: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/contacts.route.test.js:52:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/cron/jobs returns 200 with tenant_id
ok 90 - GET /api/cron/jobs returns 200 with tenant_id
  ---
  duration_ms: 371.332467
  ...
# Subtest: GET /api/cron/jobs supports tenant_id filter
ok 91 - GET /api/cron/jobs supports tenant_id filter
  ---
  duration_ms: 17.996937
  ...
# Subtest: GET /api/cron/jobs supports is_active filter
ok 92 - GET /api/cron/jobs supports is_active filter
  ---
  duration_ms: 120.272409
  ...
# Subtest: POST /api/cron/jobs creates new cron job
ok 93 - POST /api/cron/jobs creates new cron job
  ---
  duration_ms: 110.012075
  ...
# Subtest: POST /api/cron/jobs requires name, schedule, function_name
ok 94 - POST /api/cron/jobs requires name, schedule, function_name
  ---
  duration_ms: 20.00399
  ...
# Subtest: GET /api/cron/jobs/:id returns specific job
ok 95 - GET /api/cron/jobs/:id returns specific job
  ---
  duration_ms: 107.695478
  ...
# Subtest: GET /api/cron/jobs/:id returns 404 for non-existent job
ok 96 - GET /api/cron/jobs/:id returns 404 for non-existent job
  ---
  duration_ms: 80.823701
  ...
# Subtest: PUT /api/cron/jobs/:id updates job
ok 97 - PUT /api/cron/jobs/:id updates job
  ---
  duration_ms: 123.081566
  ...
# Subtest: DELETE /api/cron/jobs/:id removes job
ok 98 - DELETE /api/cron/jobs/:id removes job
  ---
  duration_ms: 304.630135
  ...
# Subtest: POST /api/cron/jobs/:id/run triggers job execution
ok 99 - POST /api/cron/jobs/:id/run triggers job execution
  ---
  duration_ms: 178.256469
  ...
# Subtest: GET /api/cron/status returns system status
ok 100 - GET /api/cron/status returns system status
  ---
  duration_ms: 7.913086
  ...
# Subtest: V1 API Deprecation Enforcement
    # Subtest: Before Sunset Date (current behavior)
        # Subtest: v1 endpoints should include deprecation headers
        not ok 1 - v1 endpoints should include deprecation headers
          ---
          duration_ms: 197.548975
          location: '/app/__tests__/routes/deprecation.enforcement.test.js:36:5'
          failureType: 'testCodeFailure'
          error: 'v1 endpoint should still work before sunset'
          code: 'ERR_ASSERTION'
          name: 'AssertionError'
          expected: true
          actual: false
          operator: '=='
          stack: |-
            TestContext.<anonymous> (file:///app/__tests__/routes/deprecation.enforcement.test.js:40:14)
            process.processTicksAndRejections (node:internal/process/task_queues:95:5)
            async Test.run (node:internal/test_runner/test:797:9)
            async Promise.all (index 0)
            async Suite.run (node:internal/test_runner/test:1135:7)
            async Promise.all (index 0)
            async Suite.run (node:internal/test_runner/test:1135:7)
            async Test.processPendingSubtests (node:internal/test_runner/test:526:7)
          ...
        # Subtest: v2 endpoints should not have deprecation headers
        not ok 2 - v2 endpoints should not have deprecation headers
          ---
          duration_ms: 17.842888
          location: '/app/__tests__/routes/deprecation.enforcement.test.js:50:5'
          failureType: 'testCodeFailure'
          error: 'v2 endpoint should work'
          code: 'ERR_ASSERTION'
          name: 'AssertionError'
          expected: true
          actual: false
          operator: '=='
          stack: |-
            TestContext.<anonymous> (file:///app/__tests__/routes/deprecation.enforcement.test.js:54:14)
            process.processTicksAndRejections (node:internal/process/task_queues:95:5)
            async Test.run (node:internal/test_runner/test:797:9)
            async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)
          ...
        1..2
    not ok 1 - Before Sunset Date (current behavior)
      ---
      duration_ms: 220.052307
      type: 'suite'
      location: '/app/__tests__/routes/deprecation.enforcement.test.js:35:3'
      failureType: 'subtestsFailed'
      error: '2 subtests failed'
      code: 'ERR_TEST_FAILURE'
      stack: |-
        async Promise.all (index 0)
      ...
    # Subtest: After Sunset Date (enforcement behavior)
        # Subtest: v1 endpoints should return 410 Gone
        ok 1 - v1 endpoints should return 410 Gone # SKIP
          ---
          duration_ms: 0.651901
          ...
        # Subtest: all v1 endpoints with v2 alternatives should return 410
        ok 2 - all v1 endpoints with v2 alternatives should return 410 # SKIP
          ---
          duration_ms: 0.387894
          ...
        # Subtest: v2 endpoints should continue working normally
        ok 3 - v2 endpoints should continue working normally # SKIP
          ---
          duration_ms: 0.366002
          ...
        # Subtest: v1 endpoints without v2 alternatives should still work
        ok 4 - v1 endpoints without v2 alternatives should still work # SKIP
          ---
          duration_ms: 0.557634
          ...
        1..4
    ok 2 - After Sunset Date (enforcement behavior)
      ---
      duration_ms: 4.482293
      type: 'suite'
      ...
    # Subtest: Error Response Format
        # Subtest: 410 response should have all required fields
        ok 1 - 410 response should have all required fields # SKIP
          ---
          duration_ms: 1.007824
          ...
        1..1
    ok 3 - Error Response Format
      ---
      duration_ms: 1.861421
      type: 'suite'
      ...
    # Subtest: Endpoint Path Mapping
        # Subtest: nested v1 paths should map to nested v2 paths
        ok 1 - nested v1 paths should map to nested v2 paths # SKIP
          ---
          duration_ms: 0.204434
          ...
        1..1
    ok 4 - Endpoint Path Mapping
      ---
      duration_ms: 0.516233
      type: 'suite'
      ...
    1..4
not ok 101 - V1 API Deprecation Enforcement
  ---
  duration_ms: 229.772042
  type: 'suite'
  location: '/app/__tests__/routes/deprecation.enforcement.test.js:22:1'
  failureType: 'subtestsFailed'
  error: '1 subtest failed'
  code: 'ERR_TEST_FAILURE'
  ...
# Subtest: Employee Routes
    # Subtest: GET /api/employees returns 200 with tenant_id
    ok 1 - GET /api/employees returns 200 with tenant_id
      ---
      duration_ms: 164.567768
      ...
    # Subtest: POST /api/employees creates new employee
    ok 2 - POST /api/employees creates new employee
      ---
      duration_ms: 196.550739
      ...
    # Subtest: POST /api/employees requires first_name and last_name
    ok 3 - POST /api/employees requires first_name and last_name
      ---
      duration_ms: 9.073936
      ...
    # Subtest: GET /api/employees/:id returns specific employee
    ok 4 - GET /api/employees/:id returns specific employee
      ---
      duration_ms: 222.577652
      ...
    # Subtest: PUT /api/employees/:id updates employee
    ok 5 - PUT /api/employees/:id updates employee
      ---
      duration_ms: 206.379728
      ...
    # Subtest: GET /api/employees/:id returns 404 for non-existent
    ok 6 - GET /api/employees/:id returns 404 for non-existent
      ---
      duration_ms: 155.295213
      ...
    1..6
ok 102 - Employee Routes
  ---
  duration_ms: 1383.113923
  type: 'suite'
  ...
# Subtest: Entity Labels Routes
    # Subtest: GET /api/entity-labels/:tenant_id returns labels with UUID
    ok 1 - GET /api/entity-labels/:tenant_id returns labels with UUID
      ---
      duration_ms: 268.168277
      ...
    # Subtest: GET /api/entity-labels/:tenant_id works with text slug (resolves to UUID)
    ok 2 - GET /api/entity-labels/:tenant_id works with text slug (resolves to UUID)
      ---
      duration_ms: 123.963532
      ...
    # Subtest: GET /api/entity-labels/:tenant_id returns defaults for non-existent tenant
    ok 3 - GET /api/entity-labels/:tenant_id returns defaults for non-existent tenant
      ---
      duration_ms: 97.212881
      ...
    # Subtest: GET /api/entity-labels/:tenant_id returns 400 without tenant_id
    ok 4 - GET /api/entity-labels/:tenant_id returns 400 without tenant_id
      ---
      duration_ms: 5.085778
      ...
    # Subtest: PUT /api/entity-labels/:tenant_id requires authentication (or dev mode)
    ok 5 - PUT /api/entity-labels/:tenant_id requires authentication (or dev mode)
      ---
      duration_ms: 19.124731
      ...
    # Subtest: DELETE /api/entity-labels/:tenant_id requires authentication (or dev mode)
    ok 6 - DELETE /api/entity-labels/:tenant_id requires authentication (or dev mode)
      ---
      duration_ms: 6.514645
      ...
    # Subtest: Entity label response includes customized array
    ok 7 - Entity label response includes customized array
      ---
      duration_ms: 155.810945
      ...
    # Subtest: Entity labels have correct structure
    ok 8 - Entity labels have correct structure
      ---
      duration_ms: 104.527019
      ...
    1..8
ok 103 - Entity Labels Routes
  ---
  duration_ms: 787.434871
  type: 'suite'
  ...
# Subtest: Leads pagination: limit & offset yield distinct pages
not ok 104 - Leads pagination: limit & offset yield distinct pages
  ---
  duration_ms: 77.205208
  location: '/app/__tests__/routes/leads.pagination.test.js:45:32'
  failureType: 'hookFailed'
  error: |-
    create lead failed: {"status":"error","message":"Authentication required"}
    
    401 !== 201
    
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: 201
  actual: 401
  operator: 'strictEqual'
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/leads.pagination.test.js:34:12)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/leads returns 200 with tenant_id
not ok 105 - GET /api/leads returns 200 with tenant_id
  ---
  duration_ms: 110.650802
  location: '/app/__tests__/routes/leads.route.test.js:45:32'
  failureType: 'hookFailed'
  error: |-
    create lead A failed: {"status":"error","message":"Authentication required"}
    
    401 !== 201
    
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: 201
  actual: 401
  operator: 'strictEqual'
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/leads.route.test.js:30:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/leads supports status $nin (NOT IN)
not ok 106 - GET /api/leads supports status $nin (NOT IN)
  ---
  duration_ms: 3.82821
  location: '/app/__tests__/routes/leads.route.test.js:53:32'
  failureType: 'hookFailed'
  error: |-
    create lead A failed: {"status":"error","message":"Authentication required"}
    
    401 !== 201
    
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: 201
  actual: 401
  operator: 'strictEqual'
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/leads.route.test.js:30:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/leads/search returns matching leads
not ok 107 - GET /api/leads/search returns matching leads
  ---
  duration_ms: 0.483639
  location: '/app/__tests__/routes/leads.route.test.js:67:32'
  failureType: 'hookFailed'
  error: |-
    create lead A failed: {"status":"error","message":"Authentication required"}
    
    401 !== 201
    
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: 201
  actual: 401
  operator: 'strictEqual'
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/leads.route.test.js:30:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/leads/search requires q parameter
not ok 108 - GET /api/leads/search requires q parameter
  ---
  duration_ms: 0.297691
  location: '/app/__tests__/routes/leads.route.test.js:76:32'
  failureType: 'hookFailed'
  error: |-
    create lead A failed: {"status":"error","message":"Authentication required"}
    
    401 !== 201
    
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: 201
  actual: 401
  operator: 'strictEqual'
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/leads.route.test.js:30:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/leads/search requires tenant_id
not ok 109 - GET /api/leads/search requires tenant_id
  ---
  duration_ms: 0.47807
  location: '/app/__tests__/routes/leads.route.test.js:83:32'
  failureType: 'hookFailed'
  error: |-
    create lead A failed: {"status":"error","message":"Authentication required"}
    
    401 !== 201
    
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: 201
  actual: 401
  operator: 'strictEqual'
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/leads.route.test.js:30:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: Memory Routes (AI Agent Memory)
    # Subtest: GET /api/memory/sessions returns memory sessions
    ok 1 - GET /api/memory/sessions returns memory sessions
      ---
      duration_ms: 165.644455
      ...
    # Subtest: GET /api/memory/events returns memory events
    ok 2 - GET /api/memory/events returns memory events
      ---
      duration_ms: 14.022373
      ...
    # Subtest: POST /api/memory/sessions creates new session
    ok 3 - POST /api/memory/sessions creates new session
      ---
      duration_ms: 26.643286
      ...
    # Subtest: POST /api/memory/events stores memory event
    ok 4 - POST /api/memory/events stores memory event
      ---
      duration_ms: 8.789063
      ...
    # Subtest: GET /api/memory/archive returns archived memories
    ok 5 - GET /api/memory/archive returns archived memories
      ---
      duration_ms: 6.812121
      ...
    # Subtest: POST /api/memory/archive archives old memories
    ok 6 - POST /api/memory/archive archives old memories
      ---
      duration_ms: 11.037766
      ...
    1..6
ok 110 - Memory Routes (AI Agent Memory)
  ---
  duration_ms: 237.216382
  type: 'suite'
  ...
# Subtest: MCP Routes (Model Context Protocol)
    # Subtest: GET /api/mcp/status returns MCP server status
    ok 1 - GET /api/mcp/status returns MCP server status
      ---
      duration_ms: 17.017236
      ...
    # Subtest: GET /api/mcp/tools returns available MCP tools
    ok 2 - GET /api/mcp/tools returns available MCP tools
      ---
      duration_ms: 9.774314
      ...
    # Subtest: POST /api/mcp/execute requires tool_name
    ok 3 - POST /api/mcp/execute requires tool_name
      ---
      duration_ms: 7.492615
      ...
    # Subtest: GET /api/mcp/resources returns MCP resources
    ok 4 - GET /api/mcp/resources returns MCP resources
      ---
      duration_ms: 4.956465
      ...
    1..4
ok 111 - MCP Routes (Model Context Protocol)
  ---
  duration_ms: 41.342144
  type: 'suite'
  ...
# Subtest: Metrics Routes
    # Subtest: GET /api/metrics returns system metrics
    ok 1 - GET /api/metrics returns system metrics
      ---
      duration_ms: 137.901319
      ...
    # Subtest: GET /api/metrics/health returns health status
    ok 2 - GET /api/metrics/health returns health status
      ---
      duration_ms: 41.102905
      ...
    # Subtest: GET /api/metrics/tenant/:id returns tenant-specific metrics
    ok 3 - GET /api/metrics/tenant/:id returns tenant-specific metrics
      ---
      duration_ms: 18.690936
      ...
    # Subtest: GET /api/metrics/performance returns performance metrics
    ok 4 - GET /api/metrics/performance returns performance metrics
      ---
      duration_ms: 491.548107
      ...
    # Subtest: GET /api/metrics/database returns database metrics
    ok 5 - GET /api/metrics/database returns database metrics
      ---
      duration_ms: 10.667702
      ...
    # Subtest: GET /api/metrics/cache returns cache metrics
    ok 6 - GET /api/metrics/cache returns cache metrics
      ---
      duration_ms: 4.540365
      ...
    # Subtest: GET /api/metrics/api returns API usage metrics
    ok 7 - GET /api/metrics/api returns API usage metrics
      ---
      duration_ms: 9.758082
      ...
    1..7
ok 112 - Metrics Routes
  ---
  duration_ms: 720.107406
  type: 'suite'
  ...
# Subtest: GET /api/notes returns 200 with tenant_id
not ok 113 - GET /api/notes returns 200 with tenant_id
  ---
  duration_ms: 240.656023
  location: '/app/__tests__/routes/notes.route.test.js:79:32'
  failureType: 'hookFailed'
  error: 'create note A failed: {"status":"error","message":"function pg_catalog.coalesce(note, note) does not exist"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/notes.route.test.js:55:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/notes/:id returns specific note
not ok 114 - GET /api/notes/:id returns specific note
  ---
  duration_ms: 5.396286
  location: '/app/__tests__/routes/notes.route.test.js:88:32'
  failureType: 'hookFailed'
  error: 'create note A failed: {"status":"error","message":"function pg_catalog.coalesce(note, note) does not exist"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/notes.route.test.js:55:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/notes/:id enforces tenant scoping when tenant_id provided
not ok 115 - GET /api/notes/:id enforces tenant scoping when tenant_id provided
  ---
  duration_ms: 0.516875
  location: '/app/__tests__/routes/notes.route.test.js:102:32'
  failureType: 'hookFailed'
  error: 'create note A failed: {"status":"error","message":"function pg_catalog.coalesce(note, note) does not exist"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/notes.route.test.js:55:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: PUT /api/notes/:id updates note
not ok 116 - PUT /api/notes/:id updates note
  ---
  duration_ms: 1.548631
  location: '/app/__tests__/routes/notes.route.test.js:112:32'
  failureType: 'hookFailed'
  error: 'create note A failed: {"status":"error","message":"function pg_catalog.coalesce(note, note) does not exist"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/notes.route.test.js:55:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: DELETE /api/notes/:id removes note
not ok 117 - DELETE /api/notes/:id removes note
  ---
  duration_ms: 0.200425
  location: '/app/__tests__/routes/notes.route.test.js:130:32'
  failureType: 'hookFailed'
  error: 'create note A failed: {"status":"error","message":"function pg_catalog.coalesce(note, note) does not exist"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/notes.route.test.js:55:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/notes supports related_type filter
not ok 118 - GET /api/notes supports related_type filter
  ---
  duration_ms: 0.113956
  location: '/app/__tests__/routes/notes.route.test.js:149:32'
  failureType: 'hookFailed'
  error: 'create note A failed: {"status":"error","message":"function pg_catalog.coalesce(note, note) does not exist"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/notes.route.test.js:55:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/notes supports related_id filter
not ok 119 - GET /api/notes supports related_id filter
  ---
  duration_ms: 0.548078
  location: '/app/__tests__/routes/notes.route.test.js:162:32'
  failureType: 'hookFailed'
  error: 'create note A failed: {"status":"error","message":"function pg_catalog.coalesce(note, note) does not exist"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/notes.route.test.js:55:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: POST /api/notes requires tenant_id and content
not ok 120 - POST /api/notes requires tenant_id and content
  ---
  duration_ms: 0.158379
  location: '/app/__tests__/routes/notes.route.test.js:174:32'
  failureType: 'hookFailed'
  error: 'create note A failed: {"status":"error","message":"function pg_catalog.coalesce(note, note) does not exist"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/notes.route.test.js:55:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: POST /api/notes can create note with metadata
not ok 121 - POST /api/notes can create note with metadata
  ---
  duration_ms: 0.845688
  location: '/app/__tests__/routes/notes.route.test.js:192:32'
  failureType: 'hookFailed'
  error: 'create note A failed: {"status":"error","message":"function pg_catalog.coalesce(note, note) does not exist"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/notes.route.test.js:55:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/opportunities returns 200 with tenant_id
not ok 122 - GET /api/opportunities returns 200 with tenant_id
  ---
  duration_ms: 65.32839
  location: '/app/__tests__/routes/opportunities.route.test.js:77:32'
  failureType: 'hookFailed'
  error: 'create opportunity A failed: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/opportunities.route.test.js:52:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/opportunities/:id returns specific opportunity
not ok 123 - GET /api/opportunities/:id returns specific opportunity
  ---
  duration_ms: 2.407642
  location: '/app/__tests__/routes/opportunities.route.test.js:86:32'
  failureType: 'hookFailed'
  error: 'create opportunity A failed: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/opportunities.route.test.js:52:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/opportunities/:id enforces tenant scoping
not ok 124 - GET /api/opportunities/:id enforces tenant scoping
  ---
  duration_ms: 0.130645
  location: '/app/__tests__/routes/opportunities.route.test.js:101:32'
  failureType: 'hookFailed'
  error: 'create opportunity A failed: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/opportunities.route.test.js:52:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: PUT /api/opportunities/:id updates opportunity
not ok 125 - PUT /api/opportunities/:id updates opportunity
  ---
  duration_ms: 1.044194
  location: '/app/__tests__/routes/opportunities.route.test.js:111:32'
  failureType: 'hookFailed'
  error: 'create opportunity A failed: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/opportunities.route.test.js:52:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: DELETE /api/opportunities/:id removes opportunity
not ok 126 - DELETE /api/opportunities/:id removes opportunity
  ---
  duration_ms: 0.355514
  location: '/app/__tests__/routes/opportunities.route.test.js:131:32'
  failureType: 'hookFailed'
  error: 'create opportunity A failed: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/opportunities.route.test.js:52:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: POST /api/opportunities requires tenant_id
not ok 127 - POST /api/opportunities requires tenant_id
  ---
  duration_ms: 0.276792
  location: '/app/__tests__/routes/opportunities.route.test.js:151:32'
  failureType: 'hookFailed'
  error: 'create opportunity A failed: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/opportunities.route.test.js:52:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: POST /api/opportunities validates amount as number
not ok 128 - POST /api/opportunities validates amount as number
  ---
  duration_ms: 0.32633
  location: '/app/__tests__/routes/opportunities.route.test.js:162:32'
  failureType: 'hookFailed'
  error: 'create opportunity A failed: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/opportunities.route.test.js:52:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: PUT /api/opportunities can advance stage
not ok 129 - PUT /api/opportunities can advance stage
  ---
  duration_ms: 0.252827
  location: '/app/__tests__/routes/opportunities.route.test.js:183:32'
  failureType: 'hookFailed'
  error: 'create opportunity A failed: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/opportunities.route.test.js:52:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/opportunities/search returns matching opportunities
not ok 130 - GET /api/opportunities/search returns matching opportunities
  ---
  duration_ms: 0.880961
  location: '/app/__tests__/routes/opportunities.route.test.js:199:32'
  failureType: 'hookFailed'
  error: 'create opportunity A failed: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/opportunities.route.test.js:52:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/opportunities/search requires q parameter
not ok 131 - GET /api/opportunities/search requires q parameter
  ---
  duration_ms: 0.569951
  location: '/app/__tests__/routes/opportunities.route.test.js:208:32'
  failureType: 'hookFailed'
  error: 'create opportunity A failed: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/opportunities.route.test.js:52:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/opportunities/search requires tenant_id
not ok 132 - GET /api/opportunities/search requires tenant_id
  ---
  duration_ms: 0.260863
  location: '/app/__tests__/routes/opportunities.route.test.js:215:32'
  failureType: 'hookFailed'
  error: 'create opportunity A failed: {"status":"error","message":"Authentication required"}'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/opportunities.route.test.js:52:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: GET /api/v2/opportunities returns 200 with tenant_id
not ok 133 - GET /api/v2/opportunities returns 200 with tenant_id
  ---
  duration_ms: 296.060808
  location: '/app/__tests__/routes/opportunities.v2.route.test.js:78:32'
  failureType: 'testCodeFailure'
  error: |-
    expected 200 from v2 opportunities list
    
    401 !== 200
    
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: 200
  actual: 401
  operator: 'strictEqual'
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/opportunities.v2.route.test.js:80:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async Test.run (node:internal/test_runner/test:797:9)
    async Test.processPendingSubtests (node:internal/test_runner/test:526:7)
  ...
# Subtest: GET /api/v2/opportunities supports single sort field
not ok 134 - GET /api/v2/opportunities supports single sort field
  ---
  duration_ms: 9.523849
  location: '/app/__tests__/routes/opportunities.v2.route.test.js:88:32'
  failureType: 'testCodeFailure'
  error: |-
    expected 200 from v2 opportunities list with single sort
    
    401 !== 200
    
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: 200
  actual: 401
  operator: 'strictEqual'
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/opportunities.v2.route.test.js:90:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async Test.run (node:internal/test_runner/test:797:9)
    async Test.processPendingSubtests (node:internal/test_runner/test:526:7)
  ...
# Subtest: GET /api/v2/opportunities supports multi-field sort (descending)
not ok 135 - GET /api/v2/opportunities supports multi-field sort (descending)
  ---
  duration_ms: 6.599487
  location: '/app/__tests__/routes/opportunities.v2.route.test.js:97:32'
  failureType: 'testCodeFailure'
  error: |-
    expected 200 from v2 opportunities list with multi-field sort
    
    401 !== 200
    
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: 200
  actual: 401
  operator: 'strictEqual'
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/opportunities.v2.route.test.js:99:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async Test.run (node:internal/test_runner/test:797:9)
    async Test.processPendingSubtests (node:internal/test_runner/test:526:7)
  ...
# Subtest: GET /api/v2/opportunities supports multi-field sort (ascending)
not ok 136 - GET /api/v2/opportunities supports multi-field sort (ascending)
  ---
  duration_ms: 5.312782
  location: '/app/__tests__/routes/opportunities.v2.route.test.js:107:32'
  failureType: 'testCodeFailure'
  error: |-
    expected 200 from v2 opportunities list with ascending multi-field sort
    
    401 !== 200
    
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: 200
  actual: 401
  operator: 'strictEqual'
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/opportunities.v2.route.test.js:109:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async Test.run (node:internal/test_runner/test:797:9)
    async Test.processPendingSubtests (node:internal/test_runner/test:526:7)
  ...
# Subtest: GET /api/v2/opportunities supports mixed sort directions
not ok 137 - GET /api/v2/opportunities supports mixed sort directions
  ---
  duration_ms: 5.249698
  location: '/app/__tests__/routes/opportunities.v2.route.test.js:116:32'
  failureType: 'testCodeFailure'
  error: |-
    expected 200 from v2 opportunities list with mixed sort directions
    
    401 !== 200
    
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: 200
  actual: 401
  operator: 'strictEqual'
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/opportunities.v2.route.test.js:118:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async Test.run (node:internal/test_runner/test:797:9)
    async Test.processPendingSubtests (node:internal/test_runner/test:526:7)
  ...
# Subtest: GET /api/v2/opportunities handles invalid sort gracefully
not ok 138 - GET /api/v2/opportunities handles invalid sort gracefully
  ---
  duration_ms: 10.095596
  location: '/app/__tests__/routes/opportunities.v2.route.test.js:138:32'
  failureType: 'testCodeFailure'
  error: |-
    expected 200 even with invalid sort (should use default)
    
    401 !== 200
    
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: 200
  actual: 401
  operator: 'strictEqual'
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/opportunities.v2.route.test.js:141:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async Test.run (node:internal/test_runner/test:797:9)
    async Test.processPendingSubtests (node:internal/test_runner/test:526:7)
  ...
# Subtest: GET /api/v2/opportunities rejects invalid field names
not ok 139 - GET /api/v2/opportunities rejects invalid field names
  ---
  duration_ms: 12.084182
  location: '/app/__tests__/routes/opportunities.v2.route.test.js:147:32'
  failureType: 'testCodeFailure'
  error: |-
    expected 200 (invalid fields should be ignored)
    
    401 !== 200
    
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: 200
  actual: 401
  operator: 'strictEqual'
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/opportunities.v2.route.test.js:150:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async Test.run (node:internal/test_runner/test:797:9)
    async Test.processPendingSubtests (node:internal/test_runner/test:526:7)
  ...
# Subtest: GET /api/v2/opportunities with pagination and sort
not ok 140 - GET /api/v2/opportunities with pagination and sort
  ---
  duration_ms: 11.375289
  location: '/app/__tests__/routes/opportunities.v2.route.test.js:157:32'
  failureType: 'testCodeFailure'
  error: |-
    expected 200 from v2 opportunities with pagination and sort
    
    401 !== 200
    
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: 200
  actual: 401
  operator: 'strictEqual'
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/opportunities.v2.route.test.js:159:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async Test.run (node:internal/test_runner/test:797:9)
    async Test.processPendingSubtests (node:internal/test_runner/test:526:7)
  ...
# Failed to create test opportunity: { status: 'error', message: 'Authentication required' }
# Subtest: Stage update from prospecting to qualification persists
not ok 141 - Stage update from prospecting to qualification persists
  ---
  duration_ms: 55.70933
  location: '/app/__tests__/routes/opportunityStageUpdate.test.js:65:32'
  failureType: 'hookFailed'
  error: 'Expected 201 creating opp, got 401'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/opportunityStageUpdate.test.js:43:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# Subtest: Stage update from qualification to proposal persists
not ok 142 - Stage update from qualification to proposal persists
  ---
  duration_ms: 1.462632
  location: '/app/__tests__/routes/opportunityStageUpdate.test.js:89:32'
  failureType: 'hookFailed'
  error: 'Expected 201 creating opp, got 401'
  code: 'ERR_ASSERTION'
  name: 'AssertionError'
  expected: true
  actual: false
  operator: '=='
  stack: |-
    TestContext.<anonymous> (file:///app/__tests__/routes/opportunityStageUpdate.test.js:43:10)
    process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    async TestHook.run (node:internal/test_runner/test:797:9)
  ...
# ✓ Supabase DB client initialized with performance tracking
# ✓ Supabase DB client initialized (using centralized factory)
# [18:32:48.384] [34mDEBUG[39m: [36mundefined - [dashboard-bundle] Cache MISS key=dashboard:bundle:t1:include=true (compute from db)[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [18:32:48.387] [34mDEBUG[39m: [36mundefined - [dashboard-bundle] Falling back to individual queries[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [18:32:48.407] [34mDEBUG[39m: [36mundefined - [dashboard-bundle] Fetching lead sources for tenant:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [18:32:48.885] [31mERROR[39m: [36mundefined - [dashboard-bundle] Lead sources query error:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# Subtest: Reports Routes
    # Subtest: GET /dashboard-bundle returns success bundle
    ok 1 - GET /dashboard-bundle returns success bundle
      ---
      duration_ms: 811.261919
      ...
    # Subtest: GET /dashboard-stats requires tenant_id when no db pool
    ok 2 - GET /dashboard-stats requires tenant_id when no db pool
      ---
      duration_ms: 22.386791
      ...
    1..2
ok 143 - Reports Routes
  ---
  duration_ms: 1679.111748
  type: 'suite'
  ...
# [18:32:49.058] [34mDEBUG[39m: [36mundefined - [dashboard-bundle] Bundle stats.leadsBySource:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# [18:32:49.092] [34mDEBUG[39m: [36mundefined - [dashboard-stats] Received tenant_id:[39m
#     [35menv[39m: "development"
#     [35mservice[39m: "aishacrm-backend"
# Subtest: Security Routes
    # Subtest: GET /api/security/audit-log returns audit entries
    ok 1 - GET /api/security/audit-log returns audit entries
      ---
      duration_ms: 117.338051
      ...
    # Subtest: GET /api/security/permissions returns permissions list
    ok 2 - GET /api/security/permissions returns permissions list
      ---
      duration_ms: 25.933264
      ...
    # Subtest: GET /api/apikeys returns API keys list
    ok 3 - GET /api/apikeys returns API keys list
      ---
      duration_ms: 250.351733
      ...
    # Subtest: POST /api/apikeys requires name
    ok 4 - POST /api/apikeys requires name
      ---
      duration_ms: 23.580857
      ...
    # Subtest: DELETE /api/apikeys/:id validates key exists
    ok 5 - DELETE /api/apikeys/:id validates key exists
      ---
      duration_ms: 10.903939
      ...
    # Subtest: GET /api/security/settings returns security settings
    ok 6 - GET /api/security/settings returns security settings
      ---
      duration_ms: 7.589753
      ...
    1..6
ok 144 - Security Routes
  ---
  duration_ms: 442.669575
  type: 'suite'
  ...
# Subtest: System Routes
    # Subtest: GET /api/system/health returns health status
    ok 1 - GET /api/system/health returns health status
      ---
      duration_ms: 15.310319
      ...
    # Subtest: GET /api/system/status returns system status
    ok 2 - GET /api/system/status returns system status
      ---
      duration_ms: 102.046962
      ...
    # Subtest: GET /health returns health check
    ok 3 - GET /health returns health check
      ---
      duration_ms: 10.834417
      ...
    # Subtest: GET /api/system-settings returns settings
    ok 4 - GET /api/system-settings returns settings
      ---
      duration_ms: 99.019176
      ...
    # Subtest: GET /api/system-logs returns system logs
    ok 5 - GET /api/system-logs returns system logs
      ---
      duration_ms: 121.339403
      ...
    # Subtest: GET /api/cron/status returns cron job status
    ok 6 - GET /api/cron/status returns cron job status
      ---
      duration_ms: 27.348488
      ...
    # Subtest: GET /api/metrics returns metrics data
    ok 7 - GET /api/metrics returns metrics data
      ---
      duration_ms: 22.807109
      ...
    1..7
ok 145 - System Routes
  ---
  duration_ms: 402.052246
  type: 'suite'
  ...
# Subtest: POST /api/storage/upload requires file
ok 146 - POST /api/storage/upload requires file
  ---
  duration_ms: 155.21654
  ...
# Subtest: POST /api/storage/upload accepts multipart form data
ok 147 - POST /api/storage/upload accepts multipart form data
  ---
  duration_ms: 537.08526
  ...
# Subtest: GET /api/storage/files lists files
ok 148 - GET /api/storage/files lists files
  ---
  duration_ms: 22.414473
  ...
# Subtest: GET /api/storage/file/:path returns file info
ok 149 - GET /api/storage/file/:path returns file info
  ---
  duration_ms: 24.673523
  ...
# Subtest: DELETE /api/storage/file/:path requires authentication
ok 150 - DELETE /api/storage/file/:path requires authentication
  ---
  duration_ms: 15.67798
  ...
# Subtest: GET /api/storage/signed-url generates signed URL
ok 151 - GET /api/storage/signed-url generates signed URL
  ---
  duration_ms: 20.88987
  ...
# Subtest: Storage routes handle missing Supabase config gracefully
ok 152 - Storage routes handle missing Supabase config gracefully
  ---
  duration_ms: 33.218523
  ...
# Subtest: POST /api/storage/upload respects tenant isolation
ok 153 - POST /api/storage/upload respects tenant isolation
  ---
  duration_ms: 432.117348
  ...
# Subtest: GET /api/storage/buckets lists available buckets
ok 154 - GET /api/storage/buckets lists available buckets
  ---
  duration_ms: 16.607984
  ...
# Subtest: GET /api/storage/r2/check returns R2 config status
ok 155 - GET /api/storage/r2/check returns R2 config status
  ---
  duration_ms: 304.838035
  ...
# Subtest: POST /api/storage/artifacts requires tenant_id
ok 156 - POST /api/storage/artifacts requires tenant_id
  ---
  duration_ms: 21.386168
  ...
# Subtest: POST /api/storage/artifacts requires kind parameter
ok 157 - POST /api/storage/artifacts requires kind parameter
  ---
  duration_ms: 12.81272
  ...
# Subtest: POST /api/storage/artifacts requires payload parameter
ok 158 - POST /api/storage/artifacts requires payload parameter
  ---
  duration_ms: 10.534451
  ...
# Subtest: POST /api/storage/artifacts stores and retrieves artifact (if R2 configured)
ok 159 - POST /api/storage/artifacts stores and retrieves artifact (if R2 configured)
  ---
  duration_ms: 1268.614678
  ...
# Subtest: GET /api/storage/artifacts/:id enforces tenant isolation
ok 160 - GET /api/storage/artifacts/:id enforces tenant isolation
  ---
  duration_ms: 91.234955
  ...
# Subtest: GET /api/storage/artifacts/:id requires tenant_id
ok 161 - GET /api/storage/artifacts/:id requires tenant_id
  ---
  duration_ms: 4.600435
  ...
# Subtest: POST /api/storage/upload completes within reasonable time
ok 162 - POST /api/storage/upload completes within reasonable time
  ---
  duration_ms: 505.801241
  ...
# Subtest: POST /api/storage/upload handles public URL validation gracefully
ok 163 - POST /api/storage/upload handles public URL validation gracefully
  ---
  duration_ms: 330.511978
  ...
# Subtest: POST /api/storage/signed-url completes within reasonable time
ok 164 - POST /api/storage/signed-url completes within reasonable time
  ---
  duration_ms: 432.03349
  ...
# Subtest: Telephony Routes
    # Subtest: GET /api/telephony/config returns telephony configuration
    ok 1 - GET /api/telephony/config returns telephony configuration
      ---
      duration_ms: 151.212558
      ...
    # Subtest: GET /api/telephony/status returns status
    ok 2 - GET /api/telephony/status returns status
      ---
      duration_ms: 22.399273
      ...
    # Subtest: POST /api/telephony/webhook/twilio/inbound accepts Twilio webhook format
    ok 3 - POST /api/telephony/webhook/twilio/inbound accepts Twilio webhook format
      ---
      duration_ms: 29.893823
      ...
    # Subtest: POST /api/telephony/webhook/signalwire/inbound accepts SignalWire webhook format
    ok 4 - POST /api/telephony/webhook/signalwire/inbound accepts SignalWire webhook format
      ---
      duration_ms: 6.332325
      ...
    # Subtest: POST /api/telephony/webhook/callfluent accepts CallFluent webhook
    ok 5 - POST /api/telephony/webhook/callfluent accepts CallFluent webhook
      ---
      duration_ms: 18.851051
      ...
    # Subtest: POST /api/telephony/webhook/thoughtly accepts Thoughtly webhook
    ok 6 - POST /api/telephony/webhook/thoughtly accepts Thoughtly webhook
      ---
      duration_ms: 16.528775
      ...
    # Subtest: POST /api/telephony/initiate-call requires phone number
    ok 7 - POST /api/telephony/initiate-call requires phone number
      ---
      duration_ms: 11.510665
      ...
    # Subtest: GET /api/telephony/providers lists available providers
    ok 8 - GET /api/telephony/providers lists available providers
      ---
      duration_ms: 7.34893
      ...
    1..8
ok 165 - Telephony Routes
  ---
  duration_ms: 269.450044
  type: 'suite'
  ...
# Subtest: Tenant Routes
    # Subtest: GET /api/tenants returns tenants list
    ok 1 - GET /api/tenants returns tenants list
      ---
      duration_ms: 295.324962
      ...
    # Subtest: GET /api/tenants/:id returns specific tenant
    ok 2 - GET /api/tenants/:id returns specific tenant
      ---
      duration_ms: 131.480864
      ...
    # Subtest: GET /api/tenant-resolve resolves tenant by UUID
    ok 3 - GET /api/tenant-resolve resolves tenant by UUID
      ---
      duration_ms: 3.539456
      ...
    # Subtest: GET /api/tenant-resolve returns 400 without identifier
    ok 4 - GET /api/tenant-resolve returns 400 without identifier
      ---
      duration_ms: 7.092778
      ...
    # Subtest: POST /api/tenants requires name
    ok 5 - POST /api/tenants requires name
      ---
      duration_ms: 22.082814
      ...
    # Subtest: PUT /api/tenants/:id validates tenant exists
    ok 6 - PUT /api/tenants/:id validates tenant exists
      ---
      duration_ms: 122.582477
      ...
    # Subtest: GET /api/tenants/:id/settings returns tenant settings
    ok 7 - GET /api/tenants/:id/settings returns tenant settings
      ---
      duration_ms: 13.533813
      ...
    # Subtest: GET /api/tenants/:id/stats returns tenant statistics
    ok 8 - GET /api/tenants/:id/stats returns tenant statistics
      ---
      duration_ms: 16.833491
      ...
    1..8
ok 166 - Tenant Routes
  ---
  duration_ms: 618.567042
  type: 'suite'
  ...
# Subtest: Testing Routes
    # Subtest: GET /api/testing/ping
        # Subtest: should return pong with timestamp
        ok 1 - should return pong with timestamp
          ---
          duration_ms: 268.302957
          ...
        1..1
    ok 1 - GET /api/testing/ping
      ---
      duration_ms: 274.585863
      type: 'suite'
      ...
    # Subtest: GET /api/testing/suites
        # Subtest: should return available test suites
        ok 1 - should return available test suites
          ---
          duration_ms: 27.095287
          ...
        1..1
    ok 2 - GET /api/testing/suites
      ---
      duration_ms: 27.524392
      type: 'suite'
      ...
    # Subtest: POST /api/testing/trigger-e2e
        # Subtest: should dispatch workflow with valid suite
        ok 1 - should dispatch workflow with valid suite
          ---
          duration_ms: 62.219064
          ...
        # Subtest: should handle GitHub API errors
        ok 2 - should handle GitHub API errors
          ---
          duration_ms: 12.139861
          ...
        1..2
    ok 3 - POST /api/testing/trigger-e2e
      ---
      duration_ms: 74.938786
      type: 'suite'
      ...
    # Subtest: GET /api/testing/workflow-status
        # Subtest: should return workflow runs from GitHub
        ok 1 - should return workflow runs from GitHub
          ---
          duration_ms: 35.662619
          ...
        # Subtest: should filter runs by created_after
        ok 2 - should filter runs by created_after
          ---
          duration_ms: 25.574084
          ...
        # Subtest: should return error when GITHUB_TOKEN is missing
        ok 3 - should return error when GITHUB_TOKEN is missing
          ---
          duration_ms: 7.01727
          ...
        1..3
    ok 4 - GET /api/testing/workflow-status
      ---
      duration_ms: 69.534074
      type: 'suite'
      ...
    1..4
ok 167 - Testing Routes
  ---
  duration_ms: 716.204338
  type: 'suite'
  ...
# Subtest: users.js - Section 2.3: Authentication Endpoints
    # Subtest: POST /api/users/login - User authentication
        # Subtest: should require email parameter
        ok 1 - should require email parameter
          ---
          duration_ms: 219.139833
          ...
# ✓ Supabase DB client initialized with performance tracking
        # Subtest: should return 401 for non-existent user
        ok 2 - should return 401 for non-existent user
          ---
          duration_ms: 477.744299
          ...
        # Subtest: should handle case-insensitive email lookup
        ok 3 - should handle case-insensitive email lookup
          ---
          duration_ms: 9.419899
          ...
        # Subtest: should handle users table lookup first
        ok 4 - should handle users table lookup first
          ---
          duration_ms: 12.676632
          ...
        # Subtest: should handle employees table lookup as fallback
        ok 5 - should handle employees table lookup as fallback
          ---
          duration_ms: 11.395706
          ...
        # Subtest: should block disabled accounts
        ok 6 - should block disabled accounts
          ---
          duration_ms: 16.390448
          ...
        # Subtest: should update user status on successful login
        ok 7 - should update user status on successful login
          ---
          duration_ms: 10.966734
          ...
        # Subtest: should generate JWT token on successful login
        ok 8 - should generate JWT token on successful login
          ---
          duration_ms: 12.277049
          ...
        # Subtest: should handle metadata expansion
        ok 9 - should handle metadata expansion
          ---
          duration_ms: 13.323049
          ...
        # Subtest: should handle database errors gracefully
        ok 10 - should handle database errors gracefully
          ---
          duration_ms: 9.646996
          ...
        1..10
    ok 1 - POST /api/users/login - User authentication
      ---
      duration_ms: 796.051951
      type: 'suite'
      ...
    # Subtest: POST /api/users/heartbeat - Session validation
        # Subtest: should require authorization or email
        ok 1 - should require authorization or email
          ---
          duration_ms: 14.306679
          ...
        # Subtest: should accept JWT token in Authorization header
        ok 2 - should accept JWT token in Authorization header
          ---
          duration_ms: 14.819964
          ...
        # Subtest: should accept email in request body
        ok 3 - should accept email in request body
          ---
          duration_ms: 183.150905
          ...
        # Subtest: should accept email in query parameters
        ok 4 - should accept email in query parameters
          ---
          duration_ms: 177.909914
          ...
        # Subtest: should prioritize JWT over email
        ok 5 - should prioritize JWT over email
          ---
          duration_ms: 169.633287
          ...
        # Subtest: should handle invalid JWT tokens gracefully
        ok 6 - should handle invalid JWT tokens gracefully
          ---
          duration_ms: 6.291383
          ...
        # Subtest: should update user metadata on heartbeat
        ok 7 - should update user metadata on heartbeat
          ---
          duration_ms: 171.51064
          ...
        # Subtest: should handle users table lookup by ID
        ok 8 - should handle users table lookup by ID
          ---
          duration_ms: 6.829827
          ...
        # Subtest: should handle employees table lookup by ID
        ok 9 - should handle employees table lookup by ID
          ---
          duration_ms: 6.783001
          ...
        # Subtest: should handle email lookup for users
        ok 10 - should handle email lookup for users
          ---
          duration_ms: 159.665631
          ...
        # Subtest: should handle email lookup for employees
        ok 11 - should handle email lookup for employees
          ---
          duration_ms: 155.401527
          ...
        # Subtest: should create user from auth as fallback
        ok 12 - should create user from auth as fallback
          ---
          duration_ms: 217.493062
          ...
        # Subtest: should return 404 for user not found
        ok 13 - should return 404 for user not found
          ---
          duration_ms: 150.27819
          ...
        # Subtest: should return success with user data
        ok 14 - should return success with user data
          ---
          duration_ms: 159.503965
          ...
        1..14
    ok 2 - POST /api/users/heartbeat - Session validation
      ---
      duration_ms: 1595.890755
      type: 'suite'
      ...
# {"level":50,"time":"2026-02-04T18:32:51.441Z","env":"test","service":"aishacrm-backend","msg":"Error getting user:"}
    # Subtest: GET /api/users/heartbeat - Heartbeat checks
        # Subtest: should return online status and timestamp
        ok 1 - should return online status and timestamp
          ---
          duration_ms: 101.491187
          ...
# {"level":50,"time":"2026-02-04T18:32:51.521Z","env":"test","service":"aishacrm-backend","msg":"Error getting user:"}
        # Subtest: should handle query parameters
        ok 2 - should handle query parameters
          ---
          duration_ms: 79.09461
          ...
# {"level":50,"time":"2026-02-04T18:32:51.599Z","env":"test","service":"aishacrm-backend","msg":"Error getting user:"}
# {"level":50,"time":"2026-02-04T18:32:51.679Z","env":"test","service":"aishacrm-backend","msg":"Error getting user:"}
        # Subtest: should be read-only (no mutations)
        ok 3 - should be read-only (no mutations)
          ---
          duration_ms: 158.041287
          ...
# {"level":50,"time":"2026-02-04T18:32:51.765Z","env":"test","service":"aishacrm-backend","msg":"Error getting user:"}
        # Subtest: should work without authentication
        ok 4 - should work without authentication
          ---
          duration_ms: 87.110245
          ...
        1..4
    ok 3 - GET /api/users/heartbeat - Heartbeat checks
      ---
      duration_ms: 426.270542
      type: 'suite'
      ...
    # Subtest: JWT token validation
        # Subtest: should handle valid JWT structure
        ok 1 - should handle valid JWT structure
          ---
          duration_ms: 21.924225
          ...
        # Subtest: should extract user_id from JWT payload
        ok 2 - should extract user_id from JWT payload
          ---
          duration_ms: 9.061808
          ...
        # Subtest: should handle missing user_id in JWT
        ok 3 - should handle missing user_id in JWT
          ---
          duration_ms: 4.460867
          ...
        1..3
    ok 4 - JWT token validation
      ---
      duration_ms: 36.003483
      type: 'suite'
      ...
    # Subtest: Authentication flow integration
        # Subtest: should support login to heartbeat flow
        ok 1 - should support login to heartbeat flow
          ---
          duration_ms: 168.691661
          ...
# {"level":50,"time":"2026-02-04T18:32:52.137Z","env":"test","service":"aishacrm-backend","msg":"Error getting user:"}
        # Subtest: should handle concurrent heartbeat requests
        ok 2 - should handle concurrent heartbeat requests
          ---
          duration_ms: 264.186372
          ...
        1..2
    ok 5 - Authentication flow integration
      ---
      duration_ms: 433.265916
      type: 'suite'
      ...
    # Subtest: Error handling and edge cases
        # Subtest: should handle malformed Authorization header
        ok 1 - should handle malformed Authorization header
          ---
          duration_ms: 8.295464
          ...
        # Subtest: should handle empty Authorization header
        ok 2 - should handle empty Authorization header
          ---
          duration_ms: 6.193686
          ...
        # Subtest: should handle database connection errors
        ok 3 - should handle database connection errors
          ---
          duration_ms: 222.25414
          ...
        # Subtest: should handle JWT verification errors
        ok 4 - should handle JWT verification errors
          ---
          duration_ms: 5.191987
          ...
        # Subtest: should handle metadata update failures gracefully
        ok 5 - should handle metadata update failures gracefully
          ---
          duration_ms: 202.422616
          ...
        1..5
    ok 6 - Error handling and edge cases
      ---
      duration_ms: 445.013698
      type: 'suite'
      ...
    1..6
ok 168 - users.js - Section 2.3: Authentication Endpoints
  ---
  duration_ms: 4691.004992
  type: 'suite'
  ...
# Subtest: users.js - Section 2.4: User Creation & Registration
    # Subtest: POST /api/users - Create new user
        # Subtest: should require email and first_name
        ok 1 - should require email and first_name
          ---
          duration_ms: 222.288552
          ...
# {"level":40,"time":"2026-02-04T18:32:49.306Z","env":"test","service":"aishacrm-backend","msg":"[POST /api/users] BLOCKED test email pattern: test@example.com"}
        # Subtest: should require first_name
        ok 2 - should require first_name
          ---
          duration_ms: 21.018966
          ...
# {"level":40,"time":"2026-02-04T18:32:49.321Z","env":"test","service":"aishacrm-backend","msg":"[POST /api/users] BLOCKED test email pattern: audit.test.user@example.com"}
# {"level":40,"time":"2026-02-04T18:32:49.338Z","env":"test","service":"aishacrm-backend","msg":"[POST /api/users] BLOCKED test email pattern: e2e.temp.user@example.com"}
# {"level":40,"time":"2026-02-04T18:32:49.346Z","env":"test","service":"aishacrm-backend","msg":"[POST /api/users] BLOCKED test email pattern: user@playwright.test"}
        # Subtest: should block test email patterns
        ok 3 - should block test email patterns
          ---
          duration_ms: 46.524176
          ...
        # Subtest: should reject duplicate emails across users and employees
        ok 4 - should reject duplicate emails across users and employees
          ---
          duration_ms: 6.552393
          ...
        # Subtest: should create tenant admin user
        ok 5 - should create tenant admin user
          ---
          duration_ms: 6.71219
          ...
        # Subtest: should create tenant employee user
        ok 6 - should create tenant employee user
          ---
          duration_ms: 30.568997
          ...
        # Subtest: should require tenant_id for employee creation
        ok 7 - should require tenant_id for employee creation
          ---
          duration_ms: 14.468941
          ...
        # Subtest: should handle metadata expansion
        ok 8 - should handle metadata expansion
          ---
          duration_ms: 19.591207
          ...
        # Subtest: should handle database errors gracefully
        ok 9 - should handle database errors gracefully
          ---
          duration_ms: 10.753731
          ...
        # Subtest: should create audit log for user creation
        ok 10 - should create audit log for user creation
          ---
          duration_ms: 10.01202
          ...
        1..10
    ok 1 - POST /api/users - Create new user
      ---
      duration_ms: 393.006716
      type: 'suite'
      ...
    # Subtest: POST /api/users/register - User registration
        # Subtest: should require tenant_id and email
        ok 1 - should require tenant_id and email
          ---
          duration_ms: 11.975053
          ...
        # Subtest: should require tenant_id
        ok 2 - should require tenant_id
          ---
          duration_ms: 9.204596
          ...
        # Subtest: should require email
        ok 3 - should require email
          ---
          duration_ms: 5.624747
          ...
        # Subtest: should reject duplicate email registration
        ok 4 - should reject duplicate email registration
          ---
          duration_ms: 4.959149
          ...
        # Subtest: should register new user successfully
        ok 5 - should register new user successfully
          ---
          duration_ms: 9.384511
          ...
        # Subtest: should default role to user if not specified
        ok 6 - should default role to user if not specified
          ---
          duration_ms: 7.856361
          ...
        # Subtest: should accept custom role
        ok 7 - should accept custom role
          ---
          duration_ms: 7.638442
          ...
        # Subtest: should handle optional last_name
        ok 8 - should handle optional last_name
          ---
          duration_ms: 10.026487
          ...
        # Subtest: should handle database errors gracefully
        ok 9 - should handle database errors gracefully
          ---
          duration_ms: 7.17407
          ...
        1..9
    ok 2 - POST /api/users/register - User registration
      ---
      duration_ms: 76.40533
      type: 'suite'
      ...
    # Subtest: Integration between creation and registration
        # Subtest: should allow registration after creation
        ok 1 - should allow registration after creation
          ---
          duration_ms: 16.087068
          ...
        # Subtest: should handle concurrent registration attempts
        ok 2 - should handle concurrent registration attempts
          ---
          duration_ms: 23.733644
          ...
        1..2
    ok 3 - Integration between creation and registration
      ---
      duration_ms: 40.207142
      type: 'suite'
      ...
    # Subtest: Rate limiting for creation endpoints
        # Subtest: should apply rate limiting to POST /users
        ok 1 - should apply rate limiting to POST /users
          ---
          duration_ms: 45.738669
          ...
        # Subtest: should apply rate limiting to POST /register
        ok 2 - should apply rate limiting to POST /register
          ---
          duration_ms: 13.095356
          ...
        1..2
    ok 4 - Rate limiting for creation endpoints
      ---
      duration_ms: 59.291475
      type: 'suite'
      ...
    1..4
ok 169 - users.js - Section 2.4: User Creation & Registration
  ---
  duration_ms: 1533.09885
  type: 'suite'
  ...
# ✓ Supabase DB client initialized with performance tracking
# {"level":50,"time":"2026-02-04T18:32:49.712Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Supabase query error:"}
# {"level":50,"time":"2026-02-04T18:32:49.794Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Employees query error:"}
# Subtest: users.js - Section 2.6: User Deletion
    # Subtest: DELETE /api/users/:id - Delete user
        # Subtest: should require valid user ID
        ok 1 - should require valid user ID
          ---
          duration_ms: 504.160931
          ...
# {"level":50,"time":"2026-02-04T18:32:49.895Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Supabase query error:"}
# {"level":50,"time":"2026-02-04T18:32:49.993Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Employees query error:"}
        # Subtest: should delete user from users table
        ok 2 - should delete user from users table
          ---
          duration_ms: 196.509008
          ...
# {"level":50,"time":"2026-02-04T18:32:50.094Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Supabase query error:"}
# {"level":50,"time":"2026-02-04T18:32:50.184Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Employees query error:"}
        # Subtest: should delete user from employees table
        ok 3 - should delete user from employees table
          ---
          duration_ms: 185.387255
          ...
# {"level":50,"time":"2026-02-04T18:32:50.289Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Supabase query error:"}
# {"level":50,"time":"2026-02-04T18:32:50.366Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Employees query error:"}
        # Subtest: should handle tenant-scoped employee deletion
        ok 4 - should handle tenant-scoped employee deletion
          ---
          duration_ms: 182.45687
          ...
# {"level":50,"time":"2026-02-04T18:32:50.458Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Supabase query error:"}
# {"level":50,"time":"2026-02-04T18:32:50.538Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Employees query error:"}
        # Subtest: should delete from Supabase Auth when user exists
        ok 5 - should delete from Supabase Auth when user exists
          ---
          duration_ms: 172.28419
          ...
# {"level":50,"time":"2026-02-04T18:32:50.628Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Supabase query error:"}
# {"level":50,"time":"2026-02-04T18:32:50.710Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Employees query error:"}
        # Subtest: should handle auth deletion failures gracefully
        ok 6 - should handle auth deletion failures gracefully
          ---
          duration_ms: 170.42281
          ...
# {"level":50,"time":"2026-02-04T18:32:50.786Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Supabase query error:"}
# {"level":50,"time":"2026-02-04T18:32:50.920Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Employees query error:"}
        # Subtest: should create audit log for user deletion
        ok 7 - should create audit log for user deletion
          ---
          duration_ms: 212.108908
          ...
# {"level":50,"time":"2026-02-04T18:32:51.086Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Supabase query error:"}
# {"level":50,"time":"2026-02-04T18:32:51.171Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Employees query error:"}
        # Subtest: should handle database errors gracefully
        ok 8 - should handle database errors gracefully
          ---
          duration_ms: 248.301149
          ...
# {"level":50,"time":"2026-02-04T18:32:51.264Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Supabase query error:"}
# {"level":50,"time":"2026-02-04T18:32:51.343Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Employees query error:"}
# {"level":50,"time":"2026-02-04T18:32:51.485Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Supabase query error:"}
# {"level":50,"time":"2026-02-04T18:32:51.566Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Employees query error:"}
        # Subtest: should return 404 for already deleted users
        ok 9 - should return 404 for already deleted users
          ---
          duration_ms: 396.161854
          ...
        1..9
    ok 1 - DELETE /api/users/:id - Delete user
      ---
      duration_ms: 2270.949377
      type: 'suite'
      ...
# {"level":50,"time":"2026-02-04T18:32:51.646Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Supabase query error:"}
# {"level":50,"time":"2026-02-04T18:32:51.807Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Employees query error:"}
    # Subtest: Immutable superadmin protection
        # Subtest: should block deletion of immutable superadmin accounts
        ok 1 - should block deletion of immutable superadmin accounts
          ---
          duration_ms: 239.478848
          ...
        1..1
    ok 2 - Immutable superadmin protection
      ---
      duration_ms: 240.161718
      type: 'suite'
      ...
# {"level":50,"time":"2026-02-04T18:32:51.900Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Supabase query error:"}
# {"level":50,"time":"2026-02-04T18:32:51.984Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Employees query error:"}
    # Subtest: Last superadmin protection
        # Subtest: should prevent deletion of the last superadmin
        ok 1 - should prevent deletion of the last superadmin
          ---
          duration_ms: 175.451228
          ...
        1..1
    ok 3 - Last superadmin protection
      ---
      duration_ms: 175.806969
      type: 'suite'
      ...
# {"level":50,"time":"2026-02-04T18:32:52.132Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Supabase query error:"}
# {"level":50,"time":"2026-02-04T18:32:52.231Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Employees query error:"}
    # Subtest: Cross-table user deletion
        # Subtest: should prioritize users table over employees table
        ok 1 - should prioritize users table over employees table
          ---
          duration_ms: 247.388882
          ...
# {"level":50,"time":"2026-02-04T18:32:52.319Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Supabase query error:"}
# {"level":50,"time":"2026-02-04T18:32:52.396Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Employees query error:"}
        # Subtest: should fall back to employees table if not in users
        ok 2 - should fall back to employees table if not in users
          ---
          duration_ms: 164.822067
          ...
        1..2
    ok 4 - Cross-table user deletion
      ---
      duration_ms: 412.661266
      type: 'suite'
      ...
# {"level":50,"time":"2026-02-04T18:32:52.499Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Supabase query error:"}
# {"level":50,"time":"2026-02-04T18:32:52.582Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Employees query error:"}
    # Subtest: Rate limiting for user deletion
        # Subtest: should apply rate limiting to DELETE /users/:id
        ok 1 - should apply rate limiting to DELETE /users/:id
          ---
          duration_ms: 184.920818
          ...
        1..1
    ok 5 - Rate limiting for user deletion
      ---
      duration_ms: 185.243363
      type: 'suite'
      ...
# {"level":50,"time":"2026-02-04T18:32:52.738Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Supabase query error:"}
# {"level":50,"time":"2026-02-04T18:32:52.818Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Employees query error:"}
    # Subtest: Auth integration for deletion
        # Subtest: should attempt auth deletion for users with auth accounts
        ok 1 - should attempt auth deletion for users with auth accounts
          ---
          duration_ms: 234.269512
          ...
# {"level":50,"time":"2026-02-04T18:32:52.907Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Supabase query error:"}
# {"level":50,"time":"2026-02-04T18:32:52.985Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Employees query error:"}
        # Subtest: should skip auth deletion for users without auth accounts
        ok 2 - should skip auth deletion for users without auth accounts
          ---
          duration_ms: 167.09252
          ...
        1..2
    ok 6 - Auth integration for deletion
      ---
      duration_ms: 401.608565
      type: 'suite'
      ...
# {"level":50,"time":"2026-02-04T18:32:53.081Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Supabase query error:"}
# {"level":50,"time":"2026-02-04T18:32:53.166Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Employees query error:"}
    # Subtest: Audit logging for deletions
        # Subtest: should log user deletion with proper details
        ok 1 - should log user deletion with proper details
          ---
          duration_ms: 181.625229
          ...
# {"level":50,"time":"2026-02-04T18:32:53.250Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Supabase query error:"}
# {"level":50,"time":"2026-02-04T18:32:53.384Z","env":"test","service":"aishacrm-backend","msg":"[DELETE /api/users/:id] Employees query error:"}
        # Subtest: should handle audit logging failures gracefully
        ok 2 - should handle audit logging failures gracefully
          ---
          duration_ms: 217.72268
          ...
        1..2
    ok 7 - Audit logging for deletions
      ---
      duration_ms: 400.368996
      type: 'suite'
      ...
    1..7
ok 170 - users.js - Section 2.6: User Deletion
  ---
  duration_ms: 5051.522143
  type: 'suite'
  ...
# ✓ Supabase DB client initialized with performance tracking
# {"level":40,"time":"2026-02-04T18:32:49.877Z","env":"test","service":"aishacrm-backend","msg":"[User Invite] users select error:"}
# {"level":40,"time":"2026-02-04T18:32:50.040Z","env":"test","service":"aishacrm-backend","msg":"[User Invite] employees select error:"}
# Subtest: users.js - Section 2.8: User Invitations
    # Subtest: POST /api/users/:id/invite - Send invitation to user
        # Subtest: should return 404 for non-existent user
        ok 1 - should return 404 for non-existent user
          ---
          duration_ms: 653.889405
          ...
        # Subtest: should send password reset for existing auth user
        ok 2 - should send password reset for existing auth user
          ---
          duration_ms: 0.557434
          ...
        # Subtest: should send invitation for new auth user
        ok 3 - should send invitation for new auth user
          ---
          duration_ms: 0.511073
          ...
        # Subtest: should handle invitation errors gracefully
        ok 4 - should handle invitation errors gracefully
          ---
          duration_ms: 0.570136
          ...
        # Subtest: should handle password reset errors gracefully
        ok 5 - should handle password reset errors gracefully
          ---
          duration_ms: 0.772625
          ...
        # Subtest: should support optional redirect_url parameter
        ok 6 - should support optional redirect_url parameter
          ---
          duration_ms: 0.563574
          ...
        1..6
    ok 1 - POST /api/users/:id/invite - Send invitation to user
      ---
      duration_ms: 659.533472
      type: 'suite'
      ...
    # Subtest: POST /api/users/:id/invite - Employee invitations
        # Subtest: should send password reset for existing employee auth user
        ok 1 - should send password reset for existing employee auth user
          ---
          duration_ms: 0.79963
          ...
        # Subtest: should send invitation for new employee auth user
        ok 2 - should send invitation for new employee auth user
          ---
          duration_ms: 0.847438
          ...
        1..2
    ok 2 - POST /api/users/:id/invite - Employee invitations
      ---
      duration_ms: 2.204572
      type: 'suite'
      ...
# {"level":40,"time":"2026-02-04T18:32:50.250Z","env":"test","service":"aishacrm-backend","msg":"[User Invite] users select error:"}
# {"level":40,"time":"2026-02-04T18:32:50.271Z","env":"test","service":"aishacrm-backend","msg":"[User Invite] users select error:"}
# {"level":40,"time":"2026-02-04T18:32:50.315Z","env":"test","service":"aishacrm-backend","msg":"[User Invite] users select error:"}
# {"level":40,"time":"2026-02-04T18:32:50.327Z","env":"test","service":"aishacrm-backend","msg":"[User Invite] users select error:"}
# {"level":40,"time":"2026-02-04T18:32:50.388Z","env":"test","service":"aishacrm-backend","msg":"[User Invite] employees select error:"}
# {"level":40,"time":"2026-02-04T18:32:50.397Z","env":"test","service":"aishacrm-backend","msg":"[User Invite] employees select error:"}
# {"level":40,"time":"2026-02-04T18:32:50.423Z","env":"test","service":"aishacrm-backend","msg":"[User Invite] employees select error:"}
# {"level":40,"time":"2026-02-04T18:32:50.470Z","env":"test","service":"aishacrm-backend","msg":"[User Invite] employees select error:"}
    # Subtest: Rate limiting for invitation endpoint
        # Subtest: should apply rate limiting to POST /:id/invite
        ok 1 - should apply rate limiting to POST /:id/invite
          ---
          duration_ms: 404.985716
          ...
        1..1
    ok 3 - Rate limiting for invitation endpoint
      ---
      duration_ms: 405.377473
      type: 'suite'
      ...
    # Subtest: POST /api/users/:id/resend-invite - Alias endpoint for backward compatibility
        # Subtest: should work identically to /invite endpoint and not return 404
        ok 1 - should work identically to /invite endpoint and not return 404
          ---
          duration_ms: 5.520981
          ...
        # Subtest: should apply rate limiting to POST /:id/resend-invite
        ok 2 - should apply rate limiting to POST /:id/resend-invite
          ---
          duration_ms: 50.198204
          ...
        1..2
    ok 4 - POST /api/users/:id/resend-invite - Alias endpoint for backward compatibility
      ---
      duration_ms: 56.175096
      type: 'suite'
      ...
    1..4
ok 171 - users.js - Section 2.8: User Invitations
  ---
  duration_ms: 2071.022432
  type: 'suite'
  ...
# ✓ Supabase DB client initialized with performance tracking
# Subtest: users.js - Section 2.2: User Listing & Retrieval Endpoints
    # Subtest: GET /api/users/ - List users endpoint
        # Subtest: should return empty array when no users exist
        ok 1 - should return empty array when no users exist
          ---
          duration_ms: 578.440262
          ...
        # Subtest: should handle email parameter case insensitively
        ok 2 - should handle email parameter case insensitively
          ---
          duration_ms: 259.878011
          ...
        # Subtest: should accept limit and offset parameters
        ok 3 - should accept limit and offset parameters
          ---
          duration_ms: 178.160978
          ...
        # Subtest: should handle tenant_id filtering
        ok 4 - should handle tenant_id filtering
          ---
          duration_ms: 171.106959
          ...
        # Subtest: should support debug mode
        ok 5 - should support debug mode
          ---
          duration_ms: 178.843732
          ...
        # Subtest: should handle strict_email parameter
        ok 6 - should handle strict_email parameter
          ---
          duration_ms: 219.777341
          ...
        1..6
    ok 1 - GET /api/users/ - List users endpoint
      ---
      duration_ms: 1587.960119
      type: 'suite'
      ...
    # Subtest: GET /api/users/profiles - User profiles endpoint
        # Subtest: should return user profiles with default pagination
        ok 1 - should return user profiles with default pagination
          ---
          duration_ms: 101.584706
          ...
# {"level":50,"time":"2026-02-04T18:32:51.233Z","env":"test","service":"aishacrm-backend","msg":"[Users.profiles] query error:"}
        # Subtest: should filter profiles by tenant_id
        ok 2 - should filter profiles by tenant_id
          ---
          duration_ms: 89.222221
          ...
# {"level":50,"time":"2026-02-04T18:32:51.317Z","env":"test","service":"aishacrm-backend","msg":"[Users.profiles] query error:"}
        # Subtest: should handle custom limit and offset
        ok 3 - should handle custom limit and offset
          ---
          duration_ms: 84.730799
          ...
        # Subtest: should transform profile data correctly
        ok 4 - should transform profile data correctly
          ---
          duration_ms: 98.96031
          ...
        1..4
    ok 2 - GET /api/users/profiles - User profiles endpoint
      ---
      duration_ms: 375.268788
      type: 'suite'
      ...
# {"level":50,"time":"2026-02-04T18:32:51.553Z","env":"test","service":"aishacrm-backend","msg":"Error getting user:"}
    # Subtest: GET /api/users/:id - Single user retrieval
        # Subtest: should return 404 for non-existent user
        ok 1 - should return 404 for non-existent user
          ---
          duration_ms: 136.962764
          ...
# {"level":50,"time":"2026-02-04T18:32:51.631Z","env":"test","service":"aishacrm-backend","msg":"Error getting user:"}
        # Subtest: should handle tenant_id filtering for user lookup
        ok 2 - should handle tenant_id filtering for user lookup
          ---
          duration_ms: 76.900127
          ...
# {"level":50,"time":"2026-02-04T18:32:51.720Z","env":"test","service":"aishacrm-backend","msg":"Error getting user:"}
        # Subtest: should allow lookup without tenant_id
        ok 3 - should allow lookup without tenant_id
          ---
          duration_ms: 90.802105
          ...
# {"level":50,"time":"2026-02-04T18:32:51.810Z","env":"test","service":"aishacrm-backend","msg":"Error getting user:"}
        # Subtest: should expand user metadata correctly
        ok 4 - should expand user metadata correctly
          ---
          duration_ms: 89.647501
          ...
        1..4
    ok 3 - GET /api/users/:id - Single user retrieval
      ---
      duration_ms: 395.30955
      type: 'suite'
      ...
    # Subtest: POST /api/users/sync-from-auth - Auth synchronization
        # Subtest: should require email parameter
        ok 1 - should require email parameter
          ---
          duration_ms: 47.29926
          ...
# {"level":50,"time":"2026-02-04T18:32:51.956Z","env":"test","service":"aishacrm-backend","msg":"Error syncing from auth:"}
        # Subtest: should accept email in request body
        ok 2 - should accept email in request body
          ---
          duration_ms: 95.913728
          ...
# {"level":50,"time":"2026-02-04T18:32:52.059Z","env":"test","service":"aishacrm-backend","msg":"Error syncing from auth:"}
        # Subtest: should accept email in query parameters
        ok 3 - should accept email in query parameters
          ---
          duration_ms: 104.028786
          ...
# {"level":50,"time":"2026-02-04T18:32:52.148Z","env":"test","service":"aishacrm-backend","msg":"Error syncing from auth:"}
        # Subtest: should handle existing user case
        ok 4 - should handle existing user case
          ---
          duration_ms: 87.932615
          ...
# {"level":50,"time":"2026-02-04T18:32:52.245Z","env":"test","service":"aishacrm-backend","msg":"Error syncing from auth:"}
        # Subtest: should handle auth user not found
        ok 5 - should handle auth user not found
          ---
          duration_ms: 97.812866
          ...
# {"level":50,"time":"2026-02-04T18:32:52.333Z","env":"test","service":"aishacrm-backend","msg":"Error syncing from auth:"}
        # Subtest: should create user from auth metadata
        ok 6 - should create user from auth metadata
          ---
          duration_ms: 87.037249
          ...
# {"level":50,"time":"2026-02-04T18:32:52.473Z","env":"test","service":"aishacrm-backend","msg":"Error syncing from auth:"}
        # Subtest: should handle different user roles
        ok 7 - should handle different user roles
          ---
          duration_ms: 138.919373
          ...
# {"level":50,"time":"2026-02-04T18:32:52.587Z","env":"test","service":"aishacrm-backend","msg":"Error syncing from auth:"}
        # Subtest: should validate tenant_id for non-admin users
        ok 8 - should validate tenant_id for non-admin users
          ---
          duration_ms: 114.781105
          ...
        1..8
    ok 4 - POST /api/users/sync-from-auth - Auth synchronization
      ---
      duration_ms: 775.540056
      type: 'suite'
      ...
    # Subtest: Query parameter validation
        # Subtest: should handle malformed limit parameter
        ok 1 - should handle malformed limit parameter
          ---
          duration_ms: 179.221954
          ...
        # Subtest: should handle malformed offset parameter
        ok 2 - should handle malformed offset parameter
          ---
          duration_ms: 168.017004
          ...
        # Subtest: should handle empty email parameter
        ok 3 - should handle empty email parameter
          ---
          duration_ms: 200.136086
          ...
        # Subtest: should handle special characters in email
        ok 4 - should handle special characters in email
          ---
          duration_ms: 150.612568
          ...
        1..4
    ok 5 - Query parameter validation
      ---
      duration_ms: 698.778646
      type: 'suite'
      ...
    # Subtest: Error handling
        # Subtest: should handle database connection errors gracefully
        ok 1 - should handle database connection errors gracefully
          ---
          duration_ms: 166.129383
          ...
        # Subtest: should handle malformed JSON in request body
        ok 2 - should handle malformed JSON in request body
          ---
          duration_ms: 9.398079
          ...
        # Subtest: should handle missing route parameters
        ok 3 - should handle missing route parameters
          ---
          duration_ms: 349.18873
          ...
        1..3
    ok 6 - Error handling
      ---
      duration_ms: 525.132772
      type: 'suite'
      ...
    1..6
ok 172 - users.js - Section 2.2: User Listing & Retrieval Endpoints
  ---
  duration_ms: 5308.636951
  type: 'suite'
  ...
