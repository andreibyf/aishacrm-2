# Session Journal — 2026-02-26

## Session Summary

BizDev Sources UI enhancements, data cleanup, and Team-based visibility filtering (Phase 1).

---

## Completed Tasks

### 1. "Assigned To" Field — Detail Panel

- **File:** `src/components/bizdev/BizDevSourceDetailPanel.jsx`
- Added always-visible "Assigned To" field in Record Details card
- Shows employee name, "Assigned" fallback, or "Unassigned" in italic gray
- No database changes needed — `assigned_to` column already exists

### 2. Production Data Cleanup — Labor Depot Source Values

- **Environment:** Production only
- 89 dirty `source` values in `bizdev_sources` for Labor Depot tenant (spreadsheet import artifacts)
- Updated all to "Den Business Directory" — now 3,736 records consistent

### 3. "Assigned To" Field — Grid Cards

- **File:** `src/components/bizdev/BizDevSourceCard.jsx`
- Made assignment always visible in card footer (was conditional on `assigned_to_name`)
- Added `useEffect` to resolve `assigned_to` UUID → employee name via `Employee.get()`
- Shows "Unassigned" in italic gray when no assignment
- Added dot separators (`·`) between status, assigned to, batch, and source fields

### 4. Notes Section — Increased Height

- **File:** `src/components/bizdev/BizDevSourceCard.jsx`
- Changed from `min-h-[120px] max-h-[180px]` → `min-h-[160px] max-h-[280px]`

### 5. Team-Based Visibility Filtering (Phase 1 — BizDev Sources)

#### Schema (both prod and dev)

- **`teams`** table: id, tenant_id, name, description, parent_team_id, is_active
- **`team_members`** table: id, team_id, employee_id, role (member/manager/director), unique(team_id, employee_id)
- RLS enabled, indexes on tenant_id, team_id, employee_id, role

#### Test Data (dev only — Dev Playground tenant)

- 6 test employees: Sarah (director), Mike (Team A mgr), Jane (Team B mgr), Tom & Amy (Team A reps), Bob (Team B rep)
- 2 teams: Sales Team A, Sales Team B
- 10 test bizdev_sources with mixed assignments + 2 unassigned

#### Backend Filtering

- **File:** `backend/routes/bizdevsources.js`
- Added `resolveTeamVisibility()` helper function
- Logic: user email → employee lookup → team_members → role-based visible IDs
- Applied in GET `/` via Supabase `.or()` filter: `assigned_to.in.(ids),assigned_to.is.null`

#### Visibility Rules

| Role               | Sees                                    |
| ------------------ | --------------------------------------- |
| Superadmin / Admin | Everything (no filter)                  |
| Director           | All records on their teams + unassigned |
| Manager            | All records on their teams + unassigned |
| Member             | Only own records + unassigned           |
| No team membership | Everything (opt-in, no breaking change) |

#### Validated Scenarios (SQL on dev)

- Tom (member): 4 records ✅
- Mike (Team A mgr): 7 records ✅
- Jane (Team B mgr): 6 records ✅
- Sarah (director, both): 10 records ✅

---

## Next Steps

- [ ] End-to-end testing with actual user logins on dev
- [ ] Teams admin UI (CRUD for teams and member assignments)
- [ ] Extend team filtering to Leads module
- [ ] Consider caching team visibility lookups (currently 2-3 extra queries per request)

---

## Follow-up Patch — 2026-02-27 (AiSHA Visibility Enforcement)

### Security hardening

- Internal JWT auth fallback was tightened from implicit `superadmin` to `employee` when `user_role` is missing.
- This prevents privilege escalation in edge cases where an internal token is missing role metadata.
- Updated both execution and auth chain defaults to align on `employee`.

### API filtering consistency

- Normalized `assigned_to=unassigned` handling in `opportunities.v2` for list/count/stats endpoints.
- `unassigned`, `null`, and empty-string assignment filters now consistently map to `assigned_to IS NULL`.

### Team assignment design notes (next phase)

- Keep CRM role (`employee/admin/superadmin`) separate from team role (`member/manager/director`).
- Continue deriving visibility from team membership graph, not from CRM role alone.
- Preserve `req.user.id` as employee UUID through AiSHA internal token chain for `team_members.employee_id` lookups.
- Add route-level assignment filter parity checks for future v2 endpoints to avoid drift.
