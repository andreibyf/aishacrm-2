// Executive Assistant Tools - Notes Management
// Create, read, update, search notes

import { Result, Note, CRMError } from "../../spec/types.braid"

@policy(WRITE_OPERATIONS)
fn createNote(
  tenant_id: String,
  title: String,
  content: String,
  entity_type: String,
  entity_id: String,
  note_type: String
) -> Result<Note, CRMError> !net {
  let url = "/api/notes";
  let body = {
    tenant_id: tenant_id,
    title: title,
    content: content,
    related_type: entity_type,
    related_id: entity_id,
    note_type: note_type
  };
  
  let response = http.post(url, { body: body });
  
  return match response {
    Ok{value} => Ok(value.data),
    Err{error} => Err({ tag: "NetworkError", url: url, code: error.status }),
    _ => Err({ tag: "NetworkError", url: url, code: 500 })
  };
}

@policy(WRITE_OPERATIONS)
fn updateNote(
  tenant_id: String,
  note_id: String,
  updates: Object
) -> Result<Note, CRMError> !net {
  let url = "/api/notes/" + note_id;
  
  let response = http.put(url, { body: updates });
  
  return match response {
    Ok{value} => Ok(value.data),
    Err{error} => Err({ tag: "NetworkError", url: url, code: error.status }),
    _ => Err({ tag: "NetworkError", url: url, code: 500 })
  };
}

@policy(READ_ONLY)
fn searchNotes(
  tenant_id: String,
  query: String,
  limit: Number
) -> Result<Array, CRMError> !net {
  // Use list endpoint - notes doesn't have dedicated search
  let url = "/api/notes";
  let params = {
    tenant_id: tenant_id,
    limit: limit
  };
  
  let response = http.get(url, { params: params });
  
  return match response {
    Ok{value} => Ok(value.data),
    Err{error} => Err({ tag: "NetworkError", url: url, code: error.status }),
    _ => Err({ tag: "NetworkError", url: url, code: 500 })
  };
}

@policy(READ_ONLY)
fn getNotesForRecord(
  tenant_id: String,
  entity_type: String,
  entity_id: String
) -> Result<Array, CRMError> !net {
  let url = "/api/notes";
  let params = {
    tenant_id: tenant_id,
    related_type: entity_type,
    related_id: entity_id
  };
  
  let response = http.get(url, { params: params });
  
  return match response {
    Ok{value} => Ok(value.data),
    Err{error} => Err({ tag: "NetworkError", url: url, code: error.status }),
    _ => Err({ tag: "NetworkError", url: url, code: 500 })
  };
}

@policy(READ_ONLY)
fn getNoteDetails(
  tenant_id: String,
  note_id: String
) -> Result<Note, CRMError> !net {
  let url = "/api/notes/" + note_id;
  let params = {
    tenant_id: tenant_id
  };
  
  let response = http.get(url, { params: params });
  
  return match response {
    Ok{value} => Ok(value.data),
    Err{error} => Err({ tag: "NetworkError", url: url, code: error.status }),
    _ => Err({ tag: "NetworkError", url: url, code: 500 })
  };
}

@policy(DELETE_OPERATIONS)
fn deleteNote(
  tenant_id: String,
  note_id: String
) -> Result<Boolean, CRMError> !net {
  let url = "/api/notes/" + note_id;
  
  let response = http.delete(url, {});
  
  return match response {
    Ok{value} => Ok(true),
    Err{error} => Err({ tag: "NetworkError", url: url, code: error.status }),
    _ => Err({ tag: "NetworkError", url: url, code: 500 })
  };
}
