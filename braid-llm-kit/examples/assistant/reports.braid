// Executive Assistant Tools - Reports & Analytics
// Generate dashboards, analytics, and business intelligence

import { Result, Report, CRMError } from "../../spec/types.braid"

// Reports V2 API endpoints: /api/v2/reports
// Supports: dashboard-bundle, health-summary, clear-cache

/// ðŸš¨ USE THIS TOOL FOR ALL COUNT QUERIES! Returns pre-aggregated dashboard metrics.
/// When user asks "how many leads/accounts/contacts/opportunities" â†’ ALWAYS call this FIRST.
/// DO NOT use list_leads/list_accounts just to count - this is 100x faster.
/// Returns: totalLeads, totalAccounts, totalContacts, totalOpportunities, openLeads, wonOpportunities, etc.
@policy(READ_ONLY)
fn getDashboardBundle(
  tenant_id: String,
  time_range: String,
  include_forecasts: Boolean
) -> Result<Object, CRMError> !net {
  let url = "/api/v2/reports/dashboard-bundle";
  let params = {
    tenant_id: tenant_id,
    time_range: time_range,
    include_forecasts: include_forecasts
  };
  
  let response = http.get(url, { params: params });
  
  return match response {
    Ok{value} => Ok(value.data),
    Err{error} => Err({ tag: "APIError", url: url, code: error.status, operation: "get_dashboard_bundle" }),
    _ => Err({ tag: "NetworkError", url: url, code: 500 })
  };
}

@policy(READ_ONLY)
fn getHealthSummary(
  tenant_id: String
) -> Result<Object, CRMError> !net {
  let url = "/api/v2/reports/health-summary";
  let params = { tenant_id: tenant_id };
  
  let response = http.get(url, { params: params });
  
  return match response {
    Ok{value} => Ok(value.data),
    Err{error} => Err({ tag: "APIError", url: url, code: error.status, operation: "get_health_summary" }),
    _ => Err({ tag: "NetworkError", url: url, code: 500 })
  };
}

@policy(READ_ONLY)
fn getSalesReport(
  tenant_id: String,
  start_date: String,
  end_date: String,
  group_by: String
) -> Result<Object, CRMError> !net {
  let url = "/api/reports/sales";
  let params = {
    tenant_id: tenant_id,
    start_date: start_date,
    end_date: end_date,
    group_by: group_by
  };
  
  let response = http.get(url, { params: params });
  
  return match response {
    Ok{value} => Ok(value.data),
    Err{error} => Err({ tag: "APIError", url: url, code: error.status, operation: "get_sales_report" }),
    _ => Err({ tag: "NetworkError", url: url, code: 500 })
  };
}

@policy(READ_ONLY)
fn getPipelineReport(
  tenant_id: String,
  include_history: Boolean
) -> Result<Object, CRMError> !net {
  let url = "/api/reports/pipeline";
  let params = {
    tenant_id: tenant_id,
    include_history: include_history
  };
  
  let response = http.get(url, { params: params });
  
  return match response {
    Ok{value} => Ok(value.data),
    Err{error} => Err({ tag: "APIError", url: url, code: error.status, operation: "get_pipeline_report" }),
    _ => Err({ tag: "NetworkError", url: url, code: 500 })
  };
}

@policy(READ_ONLY)
fn getActivityReport(
  tenant_id: String,
  start_date: String,
  end_date: String,
  employee_id: String
) -> Result<Object, CRMError> !net {
  let url = "/api/reports/activities";
  let params = {
    tenant_id: tenant_id,
    start_date: start_date,
    end_date: end_date,
    employee_id: employee_id
  };
  
  let response = http.get(url, { params: params });
  
  return match response {
    Ok{value} => Ok(value.data),
    Err{error} => Err({ tag: "APIError", url: url, code: error.status, operation: "get_activity_report" }),
    _ => Err({ tag: "NetworkError", url: url, code: 500 })
  };
}

@policy(READ_ONLY)
fn getLeadConversionReport(
  tenant_id: String,
  start_date: String,
  end_date: String
) -> Result<Object, CRMError> !net {
  let url = "/api/reports/lead-conversion";
  let params = {
    tenant_id: tenant_id,
    start_date: start_date,
    end_date: end_date
  };
  
  let response = http.get(url, { params: params });
  
  return match response {
    Ok{value} => Ok(value.data),
    Err{error} => Err({ tag: "APIError", url: url, code: error.status, operation: "get_lead_conversion_report" }),
    _ => Err({ tag: "NetworkError", url: url, code: 500 })
  };
}

@policy(READ_ONLY)
fn getRevenueForecasts(
  tenant_id: String,
  months_ahead: Number
) -> Result<Object, CRMError> !net {
  let url = "/api/reports/forecasts";
  let params = {
    tenant_id: tenant_id,
    months_ahead: months_ahead
  };
  
  let response = http.get(url, { params: params });
  
  return match response {
    Ok{value} => Ok(value.data),
    Err{error} => Err({ tag: "APIError", url: url, code: error.status, operation: "get_revenue_forecasts" }),
    _ => Err({ tag: "NetworkError", url: url, code: 500 })
  };
}

@policy(DELETE_OPERATIONS)
fn clearReportCache(
  tenant_id: String,
  report_type: String
) -> Result<Boolean, CRMError> !net {
  let url = "/api/v2/reports/clear-cache";
  let body = {
    tenant_id: tenant_id,
    report_type: report_type
  };
  
  let response = http.post(url, { body: body });
  
  return match response {
    Ok{value} => Ok(true),
    Err{error} => Err({ tag: "APIError", url: url, code: error.status, operation: "clear_report_cache" }),
    _ => Err({ tag: "NetworkError", url: url, code: 500 })
  };
}
