// Executive Assistant Tools - Account Management
// Create, read, update accounts with full CRM data

import { Result, Account, CRMError } from "../../spec/types.braid"

// Error handling: HTTP errors return CRMError with APIError tag and status code.
// The backend interprets status codes to determine error type:
// - 400 = ValidationError, 401/403 = PermissionDenied, 404 = NotFound, 5xx = NetworkError

fn createAccount(
  tenant: String,
  name: String,
  industry: String,
  annual_revenue: Number,
  website: String,
  assigned_to: String
) -> Result<Account, CRMError> !net {
  let url = "/api/v2/accounts";
  let body = {
    tenant_id: tenant,
    name: name,
    industry: industry,
    annual_revenue: annual_revenue,
    website: website,
    assigned_to: assigned_to,
    metadata: {}
  };
  
  let response = http.post(url, { body: body });
  
  return match response {
    Ok{value} => Ok(value.data),
    Err{error} => Err({ tag: "APIError", url: url, code: error.status, operation: "create_account" }),
    _ => Err({ tag: "NetworkError", url: url, code: 500 })
  };
}

fn updateAccount(
  tenant: String,
  account_id: String,
  updates: Object
) -> Result<Account, CRMError> !net {
  let url = "/api/v2/accounts/" + account_id;
  
  let response = http.put(url, { body: updates });
  
  return match response {
    Ok{value} => Ok(value.data),
    Err{error} => Err({ tag: "APIError", url: url, code: error.status, operation: "update_account", entity: "Account", id: account_id }),
    _ => Err({ tag: "NetworkError", url: url, code: 500 })
  };
}

fn getAccountDetails(
  tenant: String,
  account_id: String
) -> Result<Account, CRMError> !net {
  let url = "/api/v2/accounts/" + account_id;
  let params = { tenant_id: tenant };
  
  let response = http.get(url, { params: params });
  
  return match response {
    Ok{value} => Ok(value.data),
    Err{error} => Err({ tag: "APIError", url: url, code: error.status, operation: "get_account", entity: "Account", id: account_id }),
    _ => Err({ tag: "NetworkError", url: url, code: 500 })
  };
}

fn listAccounts(
  tenant: String,
  limit: Number,
  offset: Number
) -> Result<Array, CRMError> !net {
  let url = "/api/v2/accounts";
  let params = {
    tenant_id: tenant,
    limit: limit,
    offset: offset
  };
  
  let response = http.get(url, { params: params });
  
  // Note: Empty array is a VALID result (no accounts), not an error
  return match response {
    Ok{value} => Ok(value.data),
    Err{error} => Err({ tag: "APIError", url: url, code: error.status, operation: "list_accounts" }),
    _ => Err({ tag: "NetworkError", url: url, code: 500 })
  };
}

fn searchAccounts(
  tenant: String,
  query: String,
  limit: Number
) -> Result<Array, CRMError> !net {
  // Use the list endpoint with search parameter instead of a separate search endpoint
  let url = "/api/v2/accounts";
  let params = {
    tenant_id: tenant,
    search: query,
    limit: limit
  };
  
  let response = http.get(url, { params: params });
  
  // Note: Empty array is a VALID result (no matches found), not an error
  return match response {
    Ok{value} => Ok(value.data.accounts),
    Err{error} => Err({ tag: "APIError", url: url, code: error.status, operation: "search_accounts", query: query }),
    _ => Err({ tag: "NetworkError", url: url, code: 500 })
  };
}

// Search accounts by status - returns full account details for accounts matching a specific status
// Use this when user asks about accounts with a specific status (e.g. "active accounts", "inactive accounts")
// Status values: active, inactive, prospect, churned
fn searchAccountsByStatus(
  tenant: String,
  status: String,
  limit: Number
) -> Result<Array, CRMError> !net {
  let url = "/api/v2/accounts";
  let params = {
    tenant_id: tenant,
    status: status,
    limit: limit
  };
  
  let response = http.get(url, { params: params });
  
  // Returns full account details including name, industry, revenue, etc.
  return match response {
    Ok{value} => Ok(value.data),
    Err{error} => Err({ tag: "APIError", url: url, code: error.status, operation: "search_accounts_by_status", status: status }),
    _ => Err({ tag: "NetworkError", url: url, code: 500 })
  };
}

fn deleteAccount(
  tenant: String,
  account_id: String
) -> Result<Boolean, CRMError> !net {
  let url = "/api/v2/accounts/" + account_id;
  
  let response = http.delete(url, {});
  
  return match response {
    Ok{value} => Ok(true),
    Err{error} => Err({ tag: "APIError", url: url, code: error.status, operation: "delete_account", entity: "Account", id: account_id }),
    _ => Err({ tag: "NetworkError", url: url, code: 500 })
  };
}
