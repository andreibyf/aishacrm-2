// Executive Assistant Tools - Documents Management
// Manage document metadata, attachments, and analysis

import { Result, Document, CRMError } from "../../spec/types.braid"

// Documents V2 API endpoints: /api/v2/documents
// Supports: list, get, create, update, delete, analyze

@policy(READ_ONLY)
fn listDocuments(
  tenant: String,
  entity_type: String,
  entity_id: String,
  limit: Number
) -> Result<Array, CRMError> !net {
  let url = "/api/v2/documents";
  let params = {
    tenant_id: tenant,
    entity_type: entity_type,
    entity_id: entity_id,
    limit: limit
  };
  
  let response = http.get(url, { params: params });
  
  return match response {
    Ok{value} => Ok(value.data),
    Err{error} => CRMError.fromHTTP(url, error.status, "list_documents"),
    _ => CRMError.network(url, 500, "unknown")
  };
}

@policy(READ_ONLY)
fn getDocumentDetails(
  tenant: String,
  document_id: String
) -> Result<Document, CRMError> !net {
  let url = "/api/v2/documents/" + document_id;
  let params = { tenant_id: tenant };
  
  let response = http.get(url, { params: params });
  
  return match response {
    Ok{value} => Ok(value.data),
    Err{error} => CRMError.notFound("Document", document_id, "get"),
    _ => CRMError.network(url, 500, "unknown")
  };
}

@policy(WRITE_OPERATIONS)
fn createDocument(
  tenant: String,
  name: String,
  description: String,
  entity_type: String,
  entity_id: String,
  file_url: String,
  file_type: String
) -> Result<Document, CRMError> !net {
  let url = "/api/v2/documents";
  let body = {
    tenant_id: tenant,
    name: name,
    description: description,
    entity_type: entity_type,
    entity_id: entity_id,
    file_url: file_url,
    file_type: file_type,
    metadata: {}
  };
  
  let response = http.post(url, { body: body });
  
  return match response {
    Ok{value} => Ok(value.data),
    Err{error} => CRMError.fromHTTP(url, error.status, "create_document"),
    _ => CRMError.network(url, 500, "unknown")
  };
}

@policy(WRITE_OPERATIONS)
fn updateDocument(
  tenant: String,
  document_id: String,
  updates: Object
) -> Result<Document, CRMError> !net {
  let url = "/api/v2/documents/" + document_id;
  
  let response = http.put(url, { body: updates });
  
  return match response {
    Ok{value} => Ok(value.data),
    Err{error} => CRMError.fromHTTP(url, error.status, "update_document"),
    _ => CRMError.network(url, 500, "unknown")
  };
}

@policy(WRITE_OPERATIONS)
fn deleteDocument(
  tenant: String,
  document_id: String
) -> Result<Boolean, CRMError> !net {
  let url = "/api/v2/documents/" + document_id;
  let params = { tenant_id: tenant };
  
  let response = http.delete(url, { params: params });
  
  return match response {
    Ok{value} => Ok(true),
    Err{error} => CRMError.fromHTTP(url, error.status, "delete_document"),
    _ => CRMError.network(url, 500, "unknown")
  };
}

@policy(READ_ONLY)
fn analyzeDocument(
  tenant: String,
  document_id: String,
  analysis_type: String
) -> Result<Object, CRMError> !net {
  let url = "/api/v2/documents/analyze";
  let body = {
    tenant_id: tenant,
    document_id: document_id,
    analysis_type: analysis_type
  };
  
  let response = http.post(url, { body: body });
  
  return match response {
    Ok{value} => Ok(value.data),
    Err{error} => CRMError.fromHTTP(url, error.status, "analyze_document"),
    _ => CRMError.network(url, 500, "unknown")
  };
}

@policy(READ_ONLY)
fn searchDocuments(
  tenant: String,
  query: String,
  limit: Number
) -> Result<Array, CRMError> !net {
  let url = "/api/v2/documents";
  let params = {
    tenant_id: tenant,
    search: query,
    limit: limit
  };
  
  let response = http.get(url, { params: params });
  
  return match response {
    Ok{value} => Ok(value.data),
    Err{error} => CRMError.fromHTTP(url, error.status, "search_documents"),
    _ => CRMError.network(url, 500, "unknown")
  };
}
