// Executive Assistant Tools - Contacts Management
// Manage business contacts, roles, relationships

import { Result, Contact, CRMError } from "../../spec/types.braid"

// Error handling: HTTP errors return CRMError with APIError tag and status code.
// The backend interprets status codes to determine error type.

@policy(WRITE_OPERATIONS)
fn createContact(
  tenant: String,
  first_name: String,
  last_name: String,
  email: String,
  phone: String,
  job_title: String,
  account_id: String,
  assigned_to: String
) -> Result<Contact, CRMError> !net {
  let url = "/api/v2/contacts";
  let body = {
    tenant_id: tenant,
    first_name: first_name,
    last_name: last_name,
    email: email,
    phone: phone,
    job_title: job_title,
    account_id: account_id,
    assigned_to: assigned_to,
    metadata: {}
  };
  
  let response = http.post(url, { body: body });
  
  return match response {
    Ok{value} => Ok(value.data),
    Err{error} => CRMError.fromHTTP(url, error.status, "create_contact"),
    _ => CRMError.network(url, 500, "unknown")
  };
}

@policy(WRITE_OPERATIONS)
fn updateContact(
  tenant: String,
  contact_id: String,
  updates: Object
) -> Result<Contact, CRMError> !net {
  let url = "/api/v2/contacts/" + contact_id;
  
  let response = http.put(url, { body: updates });
  
  return match response {
    Ok{value} => Ok(value.data),
    Err{error} => CRMError.fromHTTP(url, error.status, "update_contact"),
    _ => CRMError.network(url, 500, "unknown")
  };
}

@policy(READ_ONLY)
fn listContactsForAccount(
  tenant: String,
  account_id: String,
  limit: Number
) -> Result<Array, CRMError> !net {
  let url = "/api/v2/contacts";
  let params = {
    tenant_id: tenant,
    account_id: account_id,
    limit: limit
  };
  
  let response = http.get(url, { params: params });
  
  // Note: Empty array is a VALID result (account has no contacts), not an error
  return match response {
    Ok{value} => Ok(value.data.contacts),
    Err{error} => CRMError.fromHTTP(url, error.status, "list_contacts"),
    _ => CRMError.network(url, 500, "unknown")
  };
}

@policy(READ_ONLY)
fn searchContacts(
  tenant: String,
  query: String,
  limit: Number
) -> Result<Array, CRMError> !net {
  // Search contacts by name using the search parameter
  let url = "/api/v2/contacts";
  let params = {
    tenant_id: tenant,
    search: query,
    limit: limit
  };
  
  let response = http.get(url, { params: params });
  
  // Returns FULL contact details including: first_name, last_name, email, phone, mobile, job_title, etc.
  // IMPORTANT: This tool ALWAYS returns an array. Check array length to determine if contacts were found.
  // - If array.length > 0: Contacts found! Use the data to answer the user's question.
  // - If array.length === 0: No contacts match the search query.
  return match response {
    Ok{value} => Ok(value.data.contacts),
    Err{error} => CRMError.fromHTTP(url, error.status, "search_contacts"),
    _ => CRMError.network(url, 500, "unknown")
  };
}

// Get a specific contact by name - searches for contact and returns full details
// Use this when user asks for details about a specific contact by name
@policy(READ_ONLY)
fn getContactByName(
  tenant: String,
  name: String
) -> Result<Contact, CRMError> !net {
  let url = "/api/v2/contacts";
  let params = {
    tenant_id: tenant,
    search: name,
    limit: 1
  };
  
  let response = http.get(url, { params: params });
  
  // Returns FULL contact details: first_name, last_name, email, phone, mobile, job_title, address, etc.
  // If no contact found, returns empty array - AI should inform user
  return match response {
    Ok{value} => Ok(value.data.contacts),
    Err{error} => CRMError.fromHTTP(url, error.status, "get_contact_by_name"),
    _ => CRMError.network(url, 500, "unknown")
  };
}

// List all contacts with full details - returns complete contact information
// Use this when user asks about contacts without specifying an account
@policy(READ_ONLY)
fn listAllContacts(
  tenant: String,
  limit: Number
) -> Result<Array, CRMError> !net {
  let url = "/api/v2/contacts";
  let params = {
    tenant_id: tenant,
    limit: limit
  };
  
  let response = http.get(url, { params: params });
  
  // Returns full contact details including name, email, phone, job title, etc.
  return match response {
    Ok{value} => Ok(value.data.contacts),
    Err{error} => CRMError.fromHTTP(url, error.status, "list_all_contacts"),
    _ => CRMError.network(url, 500, "unknown")
  };
}

// Search contacts by status - returns full contact details for contacts matching a specific status
// Use this when user asks about contacts with a specific status (e.g. "active contacts", "inactive contacts")
// Status values: active, inactive, pending, archived
@policy(READ_ONLY)
fn searchContactsByStatus(
  tenant: String,
  status: String,
  limit: Number
) -> Result<Array, CRMError> !net {
  let url = "/api/v2/contacts";
  let params = {
    tenant_id: tenant,
    status: status,
    limit: limit
  };
  
  let response = http.get(url, { params: params });
  
  // Returns full contact details including name, email, phone, job title, etc.
  return match response {
    Ok{value} => Ok(value.data.contacts),
    Err{error} => CRMError.fromHTTP(url, error.status, "search_contacts_by_status"),
    _ => CRMError.network(url, 500, "unknown")
  };
}

@policy(WRITE_OPERATIONS)
fn deleteContact(
  tenant: String,
  contact_id: String
) -> Result<Boolean, CRMError> !net {
  let url = "/api/v2/contacts/" + contact_id;
  let response = http.delete(url, {});
  return match response {
    Ok{value} => Ok(true),
    Err{error} => CRMError.fromHTTP(url, error.status, "delete_contact"),
    _ => CRMError.network(url, 500, "unknown")
  };
}

@policy(READ_ONLY)
fn getContactDetails(
  tenant: String,
  contact_id: String
) -> Result<Contact, CRMError> !net {
  let url = "/api/v2/contacts/" + contact_id;
  let params = { tenant_id: tenant };
  
  let response = http.get(url, { params: params });
  
  return match response {
    Ok{value} => Ok(value.data.contact),
    Err{error} => CRMError.fromHTTP(url, error.status, "get_contact"),
    _ => CRMError.network(url, 500, "unknown")
  };
}
