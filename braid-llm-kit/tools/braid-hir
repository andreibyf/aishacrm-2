#!/usr/bin/env node
import fs from "fs";
import { parse } from "./braid-parse.js";

const file = process.argv[2];
if (!file) {
  console.error("usage: braid-hir <file.braid>");
  process.exit(2);
}
const src = fs.readFileSync(file, "utf8");

// Parse AST using PEG parser
let ast;
try {
  ast = parse(src, file);
} catch (err) {
  process.stderr.write(err.message + "\n");
  process.exit(1);
}

// Extract HIR from AST
const functions = [];
const actors = [];
const attributes = [];
const routes = [];

for (const item of ast.items) {
  if (item.type === 'FnDecl') {
    functions.push({
      kind: "fn",
      name: item.name,
      params: item.params.map(p => `${p.name}: ${formatType(p.type)}`).join(', '),
      ret: formatType(item.ret),
      effects: item.effects,
      attributes: item.attributes
    });
    
    // Extract @route attributes
    for (const attr of item.attributes) {
      if (attr.name === 'route') {
        routes.push({
          function: item.name,
          method: attr.args.method || 'GET',
          path: attr.args.path || '/'
        });
      }
    }
    
    // Collect all attributes
    attributes.push(...item.attributes.map(a => ({ 
      target: item.name, 
      name: a.name, 
      args: a.args 
    })));
  }
  
  if (item.type === 'ActorDecl') {
    actors.push({
      kind: "actor",
      name: item.name,
      state: item.state.map(f => ({ name: f.name, type: formatType(f.type) })),
      attributes: item.attributes
    });
    
    attributes.push(...item.attributes.map(a => ({ 
      target: item.name, 
      name: a.name, 
      args: a.args 
    })));
  }
}

function formatType(type) {
  if (typeof type === 'string') return type;
  if (type.type === 'RecordType') {
    return `{${type.fields.map(f => `${f.name}:${formatType(f.type)}`).join(',')}}`;
  }
  if (type.base && type.generics) {
    return `${type.base}[${type.generics.map(formatType).join(',')}]`;
  }
  return JSON.stringify(type);
}

const hir = { file, functions, actors, attributes, routes };
process.stdout.write(JSON.stringify(hir, null, 2) + "\n");
