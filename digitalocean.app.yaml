# DigitalOcean App Platform spec for Aisha CRM Backend
# Deploy with:
#   doctl apps create --spec digitalocean.app.yaml
# Update env values (secrets) in this file or in the DO dashboard after initial create.

name: aishacrm-backend
region: nyc # change to your preferred region (nyc, sfo, fra, etc.)

services:
  - name: backend
    source_dir: ./backend
    dockerfile_path: ./Dockerfile
    http_port: 3001
    instance_count: 1
    instance_size_slug: basic-xxs # adjust as needed (basic-xxs, basic-xs, basic-s, ...)
    routes:
      - path: /
    health_check:
      http_path: /health
    envs:
      # Runtime
      - key: NODE_ENV
        value: production
        scope: RUN_AND_BUILD_TIME
      - key: NODE_OPTIONS
        value: --dns-result-order=ipv4first
        scope: RUN_AND_BUILD_TIME
      - key: PORT
        value: "3001"
        scope: RUN_TIME

      # CORS allowlist (comma-separated). Example: "https://your-frontend.com, http://localhost:5173"
      - key: ALLOWED_ORIGINS
        value: "*"
        scope: RUN_TIME

      # Toggle to use discrete Supabase connection variables instead of DATABASE_URL
      - key: USE_SUPABASE_PROD
        value: "true"
        scope: RUN_TIME

      # Discrete Supabase DB connection (recommended for App Platform)
      - key: SUPABASE_DB_HOST
        value: db.ehjlenywplgyiahgxkfj.supabase.co
        scope: RUN_TIME
      - key: SUPABASE_DB_PORT
        value: "5432"
        scope: RUN_TIME
      - key: SUPABASE_DB_NAME
        value: postgres
        scope: RUN_TIME
      - key: SUPABASE_DB_USER
        value: postgres
        scope: RUN_TIME
      - key: SUPABASE_DB_PASSWORD
        scope: RUN_TIME
        type: SECRET
        value: "" # paste in DO dashboard or here before running doctl

      # Supabase project API (non-DB) - used for storage bucket provisioning and admin helpers
      - key: SUPABASE_URL
        value: https://ehjlenywplgyiahgxkfj.supabase.co
        scope: RUN_TIME
      - key: SUPABASE_ANON_KEY
        scope: RUN_TIME
        type: SECRET
        value: ""
      - key: SUPABASE_SERVICE_ROLE_KEY
        scope: RUN_TIME
        type: SECRET
        value: ""

      # Optional: Name of storage bucket to ensure at startup
      - key: SUPABASE_STORAGE_BUCKET
        value: tenant-assets
        scope: RUN_TIME

      # DB logging toggle (false enables logging to system_logs table)
      - key: DISABLE_DB_LOGGING
        value: "false"
        scope: RUN_TIME

      # Optional: allow Railway preview domains (kept for compatibility; can be left default)
      - key: ALLOW_RAILWAY_ORIGINS
        value: "false"
        scope: RUN_TIME
