# Testing Supabase Authentication

## ✅ Implementation Complete

The User entity in `src/api/entities.js` has been updated to use **Supabase Auth** with automatic fallbacks.

---

## 🔐 Authentication Flow

### Priority Order:
1. **Local Dev Mode** → Returns mock user (no credentials needed)
2. **Supabase Auth** → Uses Supabase authentication (production)
3. **Base44 Fallback** → Uses Base44 SDK if Supabase not configured

---

## 📋 Before Testing

### 1. Get Your Supabase Publishable Key

1. Go to https://supabase.com/dashboard
2. Select your project: **ehjlenywplgyiahgxkfj**
3. Go to **Settings** → **API**
4. Copy the **anon** **public** key (NOT the service_role key!)

### 2. Add to .env File

```env
VITE_SUPABASE_URL=https://ehjlenywplgyiahgxkfj.supabase.co
VITE_SUPABASE_ANON_KEY=your-anon-key-here
```

### 3. Restart Dev Server

```powershell
.\stop-all.ps1
.\start-all.ps1
```

---

## 🧪 Testing Authentication

### Test 1: Check Configuration

Open browser console and check for Supabase warnings:

```
[Supabase] Missing credentials...  ❌ Not configured
(No warning)                       ✅ Configured
```

### Test 2: Local Dev Mode (Default)

The app should work immediately with mock users. Check console:

```
[Local Dev Mode] Using mock user
```

### Test 3: Create Test User in Supabase

#### Option A: Via Supabase Dashboard
1. Go to **Authentication** → **Users**
2. Click **Add User**
3. Email: `test@aishacrm.com`
4. Password: (set a password)
5. User Metadata (JSON):
   ```json
   {
     "tenant_id": "local-tenant-001",
     "name": "Test User"
   }
   ```

#### Option B: Via Sign Up Flow (if enabled)
Use the app's sign-up form (if you have one).

### Test 4: Test Sign In

1. Open your app
2. Try to sign in with: `test@aishacrm.com`
3. Check console for:
   ```
   [Supabase Auth] Sign in successful: test@aishacrm.com
   ```

### Test 5: Test Session Persistence

1. Sign in successfully
2. Refresh the page
3. User should stay logged in (session in localStorage)

### Test 6: Test Sign Out

1. Click sign out
2. Check console for:
   ```
   [Supabase Auth] Sign out successful
   ```

---

## 🔍 Troubleshooting

### Problem: "Missing credentials" warning

**Solution:** Add `VITE_SUPABASE_ANON_KEY` to `.env` file and restart dev server.

### Problem: Sign in fails with "Invalid login credentials"

**Solutions:**
1. Verify user exists in Supabase Dashboard → Authentication → Users
2. Check email/password are correct
3. Verify email is confirmed (auto-confirm in dev: Settings → Auth → Email Auth → Confirm email = OFF)

### Problem: User signed in but app doesn't recognize it

**Solutions:**
1. Check browser console for `User.me()` result
2. Verify `user_metadata` includes `tenant_id`
3. Check session in localStorage: `supabase.auth.session`

### Problem: Still using Base44

**Solution:** 
1. Check `.env` has both `VITE_SUPABASE_URL` and `VITE_SUPABASE_ANON_KEY`
2. Look for console warning: `[Auth] Supabase not configured, falling back to Base44`

---

## 📊 User Object Structure

After successful authentication, `User.me()` returns:

```javascript
{
  id: "uuid-from-supabase",
  email: "user@example.com",
  tenant_id: "local-tenant-001",  // from user_metadata
  name: "User Name",              // from user_metadata
  user_metadata: {
    tenant_id: "local-tenant-001",
    name: "User Name",
    // ... any other custom fields
  },
  created_at: "2025-10-26T...",
  updated_at: "2025-10-26T...",
  session: { /* Supabase session object */ }
}
```

---

## 🎯 Next Steps After Testing

Once authentication works:

1. ✅ Test user sign up flow
2. ✅ Test password reset (Supabase has built-in email templates)
3. ✅ Add MFA/2FA (Supabase supports TOTP, SMS, email)
4. ✅ Customize email templates in Supabase Dashboard
5. ✅ Set up OAuth providers (Google, GitHub, etc.) if needed

---

## 🔧 Available Methods

```javascript
// Get current user
const user = await User.me();

// Sign in
const user = await User.signIn('email@example.com', 'password');

// Sign out
await User.signOut();

// Sign up
const user = await User.signUp('email@example.com', 'password', {
  tenant_id: 'tenant-123',
  name: 'John Doe'
});

// Update current user
const updated = await User.updateMyUserData({ name: 'New Name' });

// List users (admin - uses backend API)
const users = await User.list({ tenant_id: 'tenant-123' });

// Update user by ID (admin - uses backend API)
const updated = await User.update('user-id', { name: 'Updated Name' });
```

---

## 🚀 Auto-Disable Email Confirmation (Dev Only)

For easier testing, disable email confirmation:

1. Supabase Dashboard → **Authentication** → **Providers**
2. **Email** → Toggle OFF "Confirm email"
3. Now users can sign in immediately without email verification

**NOTE:** Re-enable this in production!

---

Ready to test? Add your `VITE_SUPABASE_ANON_KEY` to `.env` and restart the app!
